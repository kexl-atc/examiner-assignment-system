const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./excel-C2s3b8zA.js","./utils-ZMqNovHY.js"])))=>i.map(i=>d[i]);
import{_ as e}from"./index-zMH_pf55.js";import{y as t,r as a,c as n,j as s,z as i,L as r,A as l,B as o,W as d,R as c,O as u,u as p,P as m,E as h,Q as g,a6 as v,K as f,aj as y,D as x,I as b,M as w,h as D,U as k,J as S,T as $,l as C,aD as E,n as _,S as T,al as I,ay as P,ag as R,ax as M}from"./vendor-BDY1VVdw.js";import{c as A,a as O,U as N,b as z,_ as j,C as F,H as L}from"./_plugin-vue_export-helper-C_eiSiqI.js";import{storageService as U}from"./storageService-D0OTCPkh.js";import{F as B,a as H,b as W,c as V,d as q}from"./dutyRotationService-BRNNznq2.js";import{D as J}from"./dateUtils-D_6usupf.js";import{a as G,n as Y,S as X}from"./departmentNormalizer-3p5zR7gw.js";import{u as K,C as Z,P as Q}from"./useResponsive-Bp-XFVFf.js";import{z as ee}from"./utils-ZMqNovHY.js";import{S as te,U as ae,T as ne}from"./upload-CaKLp6sl.js";import{U as se}from"./user-BCPPRZCI.js";import{X as ie}from"./x-C-vOU4IE.js";import{S as re}from"./search-CnUzOAgR.js";import{C as le,T as oe}from"./trending-up-DwAoyw8n.js";import{E as de}from"./excel-C2s3b8zA.js";import{R as ce}from"./refresh-cw-BHDjJkTd.js";import{D as ue}from"./download-D4BHcBUS.js";import{a as pe,b as me}from"./ui-XhJlTBKO.js";
/**
 * @license lucide-vue-next v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=A("AwardIcon",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]),ge=A("BuildingIcon",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]),ve=A("CircleXIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),fe=A("ClockIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]),ye=A("EyeIcon",[["path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z",key:"rwhkz3"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),xe=A("GripVerticalIcon",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]),be=A("LightbulbIcon",[["path",{d:"M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5",key:"1gvzjb"}],["path",{d:"M9 18h6",key:"x1upvd"}],["path",{d:"M10 22h4",key:"ceow96"}]]),we=A("PinIcon",[["path",{d:"M12 17v5",key:"bb1du9"}],["path",{d:"M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z",key:"1nkz8b"}]]),De=A("ShieldIcon",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]),ke=A("StarIcon",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]),Se=A("TargetIcon",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]]),$e=A("TriangleAlertIcon",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),Ce=A("ZapIcon",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);
/**
 * @license lucide-vue-next v0.400.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function Ee(e){if(!e)return"";const t=e.trim(),a={1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"七",8:"八",9:"九",10:"十"};if(/^区域[一二三四五六七八九十]室$/.test(t))return t.substring(2,3);if(/^[一二三四五六七八九十]室$/.test(t))return t.substring(0,1);if(/^[一二三四五六七八九十]$/.test(t))return t;if(/^\d+室$/.test(t)){return a[t.replace("室","")]||t}return/^\d+$/.test(t)&&a[t]||t}function _e(e,t){var a,n;null==(n=null==(a=import.meta)?void 0:a.env)||n.DEV,e&&Array.isArray(e)||(e=[]),t&&Array.isArray(t)||(t=[]);const s=new Map;e.forEach(e=>{const t=e.department||"未知",a=Ee(t);s.has(a)||s.set(a,[]),s.get(a).push({name:e.name,rawDept:t})});const i=new Map;t.forEach(e=>{const t=e.department||"未知",a=Ee(t);i.has(a)||i.set(a,[]),i.get(a).push({name:e.name,rawDept:t,group:e.group,available:e.available})}),s.forEach((e,t)=>{}),i.forEach((e,t)=>{});let r=!1;const l=[];return s.forEach((e,t)=>{let a=i.get(t)||[];if("三"===t||"七"===t){const e="三"===t?"七":"三",n=i.get(e)||[];a=[...a,...n]}const n=e.length,s=a.length,o=Math.max(1,Math.ceil(.5*n));0===s?(r=!0,l.push(`科室"${t}": 没有考官`)):s<o&&(r=!0,l.push(`科室"${t}": ${s}名考官 < ${o}名推荐（学员${n}名）`))}),r&&l.forEach(e=>{}),fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"dataDebugger.ts:debugDepartmentDistribution",message:"资源分布诊断结果",data:{studentDepts:Object.fromEntries(Array.from(s.entries()).map(([e,t])=>[e,t.length])),teacherDepts:Object.fromEntries(Array.from(i.entries()).map(([e,t])=>[e,t.length])),hasIssue:r,resourceIssues:l},timestamp:Date.now(),sessionId:"debug-session",runId:"resource-check",hypothesisId:"H1-ResourceShortage"})}).catch(()=>{}),{studentDeptMap:Object.fromEntries(Array.from(s.entries()).map(([e,t])=>[e,t.map(e=>e.name)])),teacherDeptMap:Object.fromEntries(Array.from(i.entries()).map(([e,t])=>[e,t.map(e=>e.name)])),hasIssue:r,resourceIssues:l}}function Te(e,t){var a,n;null==(n=null==(a=import.meta)?void 0:a.env)||n.DEV,e&&Array.isArray(e)||(e=[]),t&&Array.isArray(t)||(t=[]);const s=new Map;e.forEach(e=>{const t=e.group||"未知";s.has(t)||s.set(t,[]),s.get(t).push(e.name)});const i=new Map;return t.forEach(e=>{const t=e.group||"未知";i.has(t)||i.set(t,[]),i.get(t).push(e.name)}),s.forEach((e,t)=>{}),i.forEach((e,t)=>{}),{studentGroupMap:Object.fromEntries(s),teacherGroupMap:Object.fromEntries(i)}}function Ie(e,t){var a,n;if(null==(n=null==(a=import.meta)?void 0:a.env)||n.DEV,e&&Array.isArray(e)||(e=[]),t&&Array.isArray(t)||(t=[]),0===e.length&&0===t.length)return{students:{total:0,departments:{},groups:{}},teachers:{total:0,departments:{},groups:{}},hasIssue:!1,resourceIssues:[]};const s=_e(e,t),i=Te(e,t);return s.hasIssue&&s.resourceIssues&&s.resourceIssues.length>0&&s.resourceIssues.forEach(e=>{}),fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"dataDebugger.ts:debugScheduleData",message:"完整诊断结果",data:{studentCount:e.length,teacherCount:t.length,hasIssue:s.hasIssue,resourceIssues:s.resourceIssues||[],studentDepts:s.studentDeptMap,teacherDepts:s.teacherDeptMap},timestamp:Date.now(),sessionId:"debug-session",runId:"full-diagnosis",hypothesisId:"H1-ResourceShortage"})}).catch(()=>{}),{students:{total:e.length,departments:s.studentDeptMap,groups:i.studentGroupMap},teachers:{total:t.length,departments:s.teacherDeptMap,groups:i.teacherGroupMap},hasIssue:s.hasIssue,resourceIssues:s.resourceIssues||[]}}function Pe(e,t,a=2){if(!e||0===e.length)return{minDays:1,recommendedDays:1,bottleneck:"无学员数据",details:{totalExams:0,maxExamsPerDay:0,deptBottlenecks:[]}};if(!t||0===t.length)return{minDays:999,recommendedDays:999,bottleneck:"无考官数据，无法排班",details:{totalExams:e.length*a,maxExamsPerDay:0,deptBottlenecks:[]}};const n=e.reduce((e,t)=>e+(t.examDays||a),0),s=new Map,i=new Map;e.forEach(e=>{const t=Ee(e.department||"未知");s.set(t,(s.get(t)||0)+1)}),t.forEach(e=>{const t=Ee(e.department||"未知");i.set(t,(i.get(t)||0)+1)});const r=Math.floor(t.length/2),l=r>0?Math.ceil(n/r):999,o=[];s.forEach((e,t)=>{let n=i.get(t)||0;if("三"===t||"七"===t){const e="三"===t?"七":"三";n+=i.get(e)||0}const s=Math.max(1,n),r=e*a,d=Math.ceil(r/s);d>l&&o.push({dept:t,minDays:d,reason:`${e}名学员需${r}场考试，${n}名考官每天最多${s}场`})});let d=l,c=`总体容量：${n}场考试 / ${r}场每天`;o.forEach(e=>{e.minDays>d&&(d=e.minDays,c=`科室"${e.dept}"资源受限：${e.reason}`)});const u=Math.max(d+1,Math.ceil(1.15*d));return{minDays:d,recommendedDays:u,bottleneck:c,details:{totalExams:n,maxExamsPerDay:r,deptBottlenecks:o}}}"undefined"!=typeof window&&(window.debugScheduleData=Ie,window.debugDepartmentDistribution=_e,window.debugGroupDistribution=Te,window.calculateOptimalExamDays=Pe);var Re=Object.defineProperty,Me=(e,t,a)=>((e,t,a)=>t in e?Re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a);async function Ae(e=8081,t=8090){for(let n=e;n<=t;n++)try{const e=new Promise((e,t)=>{setTimeout(()=>t(new Error("Timeout")),1e3)}),t=fetch(`http://127.0.0.1:${n}/q/health`,{method:"GET"}),a=await Promise.race([t,e]);if(a&&a.ok)return n}catch(a){continue}return null}async function Oe(){var e,t;let a="诊断信息：\n";if(!(window.electronAPI&&window.electronAPI.isElectron))return a+="⚠️ 非Electron环境，可能无法连接到后端服务\n",a;try{if(null==(e=window.electronAPI)?void 0:e.getBackendPort){const e=await window.electronAPI.getBackendPort();if(e&&e>0){a+=`✅ 获取到后端端口: ${e}\n`;try{const t=await fetch(`http://127.0.0.1:${e}/q/health`,{method:"GET",signal:AbortSignal.timeout(2e3)});t.ok?a+="✅ 后端服务健康检查通过\n":a+=`⚠️ 后端服务健康检查失败: ${t.status}\n`}catch(s){a+=`❌ 后端服务健康检查失败: ${s.message}\n`}}else a+=`⚠️ 后端端口无效: ${e}\n`}else a+="⚠️ 无法获取后端端口（electronAPI.getBackendPort不存在）\n"}catch(i){a+=`❌ 获取后端端口失败: ${i.message}\n`}try{if(null==(t=window.electronAPI)?void 0:t.getBackendStatus){const e=await window.electronAPI.getBackendStatus();e&&(a+="\n后端状态：\n",a+=`- 端口: ${e.port||"未知"}\n`,a+=`- 运行中: ${e.isRunning?"是":"否"}\n`,a+=`- 启动时间: ${e.startTime?new Date(e.startTime).toLocaleString():"未知"}\n`,a+=`- 运行时长: ${e.elapsed?(e.elapsed/1e3).toFixed(2)+"秒":"未知"}\n`,e.error&&(a+="\n❌ 检测到错误：\n",a+=`- 错误类型: ${e.error.type}\n`,a+=`- 错误信息: ${e.error.message}\n`),e.recentLogs&&e.recentLogs.length>0&&(a+="\n最近日志（最后5条）：\n",e.recentLogs.slice(-5).forEach((e,t)=>{a+=`${t+1}. ${e}\n`})))}}catch(r){a+=`⚠️ 获取后端状态失败: ${r.message}\n`}a+="\n端口扫描结果：\n";const n=await Ae(8081,8090);return n?a+=`✅ 自动发现后端服务在端口 ${n}\n`:(a+="❌ 未发现运行中的后端服务（已扫描8081-8090）\n",a+="\n可能原因：\n",a+="1. 后端服务未启动\n",a+="2. 后端服务启动失败（退出代码1）\n",a+="3. 后端服务启动时间过长\n",a+="4. 防火墙阻止连接\n",a+="5. 端口被其他程序占用\n"),a+="\n建议操作：\n",a+="1. 检查应用日志文件: %APPDATA%\\examiner-assignment-system\\logs\\backend.log\n",a+="2. 重启应用程序\n",a+="3. 检查系统防火墙设置\n",a+="4. 检查端口占用情况\n",a}const Ne=async()=>await(async()=>{var e;const t=window.electronAPI;if(t&&t.isElectron){try{if(t.onBackendReady)try{const a=await(null==(e=t.getBackendStatus)?void 0:e.call(t));if(a&&a.isRunning&&a.port)return`http://127.0.0.1:${a.port}/api/schedule`}catch(a){await new Promise(e=>{t.onBackendReady(async()=>{try{await t.getBackendPort(),e()}catch(a){e()}})})}if(t.getBackendPort){const e=await t.getBackendPort();if(e&&e>0)return`http://127.0.0.1:${e}/api/schedule`}}catch(n){}try{const e=await Ae(8081,8090);if(e)return`http://127.0.0.1:${e}/api/schedule`}catch(n){}}return"/api/schedule"})(),ze=class e{constructor(){Me(this,"logs",[])}static getInstance(){return e.instance||(e.instance=new e),e.instance}log(e,t,a){const n={timestamp:(new Date).toISOString(),level:e,message:t,data:a?JSON.stringify(a,null,2):void 0};this.logs.push(n),this.logs.length>100&&(this.logs=this.logs.slice(-50))}getLogs(){return[...this.logs]}clearLogs(){this.logs=[]}};Me(ze,"instance");let je=ze;const Fe=new class{constructor(e){Me(this,"baseUrl"),Me(this,"logger",je.getInstance()),Me(this,"initialized",!1),e||(e="/api/schedule"),this.baseUrl=e,this.logger.log("INFO",`OptaPlanner服务初始化，基础URL: ${this.baseUrl}`),this.initializeBaseUrl()}async initializeBaseUrl(){if(!this.initialized)try{this.baseUrl=await Ne(),this.initialized=!0,this.logger.log("INFO",`OptaPlanner服务URL已更新: ${this.baseUrl}`)}catch(e){this.logger.log("WARN","OptaPlanner服务URL初始化失败，使用默认值",e)}}async getLatestBaseUrl(){try{const e=await Ne();return e!==this.baseUrl&&(this.logger.log("INFO",`检测到端口变化: ${this.baseUrl} -> ${e}`),this.baseUrl=e),e}catch(e){return this.logger.log("WARN","获取最新URL失败，使用缓存值",e),this.baseUrl}}async ensureInitialized(){var e;try{const a=await Ne();this.baseUrl=a;if(window.electronAPI&&window.electronAPI.isElectron&&(null==(e=window.electronAPI)?void 0:e.getBackendStatus))try{const e=await window.electronAPI.getBackendStatus();if(e&&!e.isRunning){this.logger.log("WARN","后端服务未运行",e),await new Promise(e=>setTimeout(e,2e3));const t=await window.electronAPI.getBackendStatus();if(t&&!t.isRunning)throw new Error("后端服务未运行，请重启应用程序")}}catch(t){this.logger.log("WARN","检查后端状态失败",t)}this.initialized||(this.initialized=!0,this.logger.log("INFO",`OptaPlanner服务已初始化，使用URL: ${this.baseUrl}`))}catch(a){this.initialized||(this.baseUrl="/api/schedule",this.initialized=!0,this.logger.log("WARN","OptaPlanner服务初始化失败，使用默认URL",a))}}async checkHealth(){try{const e=await this.getLatestBaseUrl();this.logger.log("DEBUG","开始检查OptaPlanner服务健康状态",{baseUrl:e});const t=e.replace("/api/schedule","/q/health/ready"),a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}}),n=a.ok;return this.logger.log(n?"INFO":"ERROR","OptaPlanner服务健康检查"+(n?"成功":"失败"),{status:a.status,statusText:a.statusText,url:`${e.replace("/api/schedule","/q/health/ready")}`}),n}catch(e){return this.logger.log("ERROR","OptaPlanner服务健康检查异常",{error:e.message,stack:e.stack,url:`${await this.getLatestBaseUrl()}/health`}),!1}}validateRequest(e){const t=[];return e.students&&Array.isArray(e.students)?0===e.students.length&&t.push("学员列表为空"):t.push("学员数据无效或为空"),e.teachers&&Array.isArray(e.teachers)?0===e.teachers.length&&t.push("考官列表为空"):t.push("考官数据无效或为空"),e.startDate||t.push("开始日期未设置"),e.endDate||t.push("结束日期未设置"),e.startDate&&e.endDate&&new Date(e.startDate)>=new Date(e.endDate)&&t.push("开始日期必须早于结束日期"),{valid:0===t.length,errors:t}}async generateSchedule(e,t){var a,n,s,i,r,l,o,d,c,u,p;const m=`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;await this.ensureInitialized();try{this.logger.log("INFO",`开始生成排班计划 [${m}]`,{studentsCount:(null==(a=e.students)?void 0:a.length)||0,teachersCount:(null==(n=e.teachers)?void 0:n.length)||0,dateRange:`${e.startDate} ~ ${e.endDate}`,hasProgressCallback:!!t});const u=this.validateRequest(e);if(!u.valid){const e=`请求数据验证失败: ${u.errors.join(", ")}`;throw this.logger.log("ERROR",e,{requestId:m,errors:u.errors}),new Error(e)}if(this.logger.log("DEBUG",`请求数据验证通过 [${m}]`),t)return this.logger.log("DEBUG",`使用进度回调模式 [${m}]`),await this.generateScheduleWithProgress(e,t,m);const p=await this.getLatestBaseUrl();this.logger.log("DEBUG",`发送排班请求 [${m}]`,{url:`${p}/solve`,method:"POST",requestData:{studentsCount:e.students.length,teachersCount:e.teachers.length,startDate:e.startDate,endDate:e.endDate,constraints:e.constraints,solverConfig:e.solverConfig}});const v=`${p}/solve`;fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"optaplanner-service.ts:generateSchedule",message:"Preparing fetch request",data:{currentUrl:p,requestUrl:v,isElectron:!!(null==(s=window.electronAPI)?void 0:s.isElectron),requestId:m,timestamp:Date.now()},sessionId:"debug-session",runId:"fetch-request",hypothesisId:"A"})}).catch(()=>{});const f=e.teachers.filter(e=>e.unavailablePeriods&&e.unavailablePeriods.length>0);f.length>0?this.logger.log("INFO",`发送 ${f.length} 个考官的不可用期数据`,{teachers:f.map(e=>({name:e.name,periods:e.unavailablePeriods}))}):this.logger.log("WARN","没有考官设置不可用期！");let y=window.__opta_session_id;const x={"Content-Type":"application/json","X-Request-ID":m};if(!y){const e=window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36).slice(2);window.__opta_session_id=e,y=e}let b;y&&(x["X-Session-Id"]=y);let w=p;try{fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"optaplanner-service.ts:generateSchedule",message:"Starting fetch request",data:{url:`${p}/solve`,method:"POST",headers:Object.keys(x),requestId:m,timestamp:Date.now()},sessionId:"debug-session",runId:"fetch-request",hypothesisId:"B"})}).catch(()=>{}),b=await fetch(`${p}/solve`,{method:"POST",headers:x,body:JSON.stringify({...e,solverConfig:{...e.solverConfig||{},mode:(null==(i=e.solverConfig)?void 0:i.mode)||"adaptive"}})}),fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"optaplanner-service.ts:generateSchedule",message:"Fetch request completed",data:{url:`${p}/solve`,status:b.status,statusText:b.statusText,ok:b.ok,requestId:m,timestamp:Date.now()},sessionId:"debug-session",runId:"fetch-request",hypothesisId:"B"})}).catch(()=>{})}catch(h){if(fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"optaplanner-service.ts:generateSchedule",message:"Fetch request failed",data:{url:`${p}/solve`,errorName:null==h?void 0:h.name,errorMessage:null==h?void 0:h.message,errorStack:null==h?void 0:h.stack,isTypeError:"TypeError"===(null==h?void 0:h.name),includesFetch:null==(r=null==h?void 0:h.message)?void 0:r.includes("fetch"),requestId:m,timestamp:Date.now()},sessionId:"debug-session",runId:"fetch-error",hypothesisId:"C"})}).catch(()=>{}),!(null==(l=null==h?void 0:h.message)?void 0:l.includes("fetch"))&&"TypeError"!==(null==h?void 0:h.name))throw h;{this.logger.log("WARN",`连接失败，尝试自动发现后端端口 [${m}]`,h),fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"optaplanner-service.ts:generateSchedule",message:"Starting port discovery",data:{currentUrl:p,requestId:m,timestamp:Date.now()},sessionId:"debug-session",runId:"port-discovery",hypothesisId:"C"})}).catch(()=>{});const t=await Ae(8081,8090);if(fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"optaplanner-service.ts:generateSchedule",message:"Port discovery result",data:{discoveredPort:t,requestId:m,timestamp:Date.now()},sessionId:"debug-session",runId:"port-discovery",hypothesisId:"C"})}).catch(()=>{}),!t){const e=await Oe(),t=`无法连接到后端服务\n\n${e}\n\n原始错误: ${h.message}`;throw this.logger.log("ERROR",t,{requestId:m,diagnosis:e}),new Error(t)}{const a=!(null==(o=window.electronAPI)?void 0:o.isElectron);w=a?"/api/schedule":`http://127.0.0.1:${t}/api/schedule`,this.baseUrl=w,this.logger.log("INFO",`自动发现端口成功，使用端口 ${t} [${m}]`),fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"optaplanner-service.ts:generateSchedule",message:"Retrying fetch with discovered port",data:{finalUrl:w,isWebEnv:a,requestId:m,timestamp:Date.now()},sessionId:"debug-session",runId:"retry-fetch",hypothesisId:"C"})}).catch(()=>{}),b=await fetch(`${w}/solve`,{method:"POST",headers:x,body:JSON.stringify({...e,solverConfig:{...e.solverConfig||{},mode:(null==(d=e.solverConfig)?void 0:d.mode)||"adaptive"}})})}}}if(this.logger.log("DEBUG",`收到响应 [${m}]`,{url:w,status:b.status,statusText:b.statusText,headers:Object.fromEntries(b.headers.entries())}),!b.ok){let e="";try{e=await b.text()}catch(g){e="无法读取错误详情"}const t=`OptaPlanner服务请求失败: ${b.status} ${b.statusText}`;throw this.logger.log("ERROR",t,{requestId:m,status:b.status,statusText:b.statusText,errorDetails:e,url:`${this.baseUrl}/solve`}),new Error(`${t} - ${e}`)}const D=await b.json();return this.logger.log("INFO",`排班计算完成 [${m}]`,{success:D.success,assignmentsCount:(null==(c=D.assignments)?void 0:c.length)||0,executionTime:D.executionTime,algorithmUsed:D.algorithmUsed,statistics:D.statistics}),D.conflicts&&D.conflicts.length>0&&this.logger.log("WARN",`发现冲突 [${m}]`,{conflictsCount:D.conflicts.length,conflicts:D.conflicts}),D.warnings&&D.warnings.length>0&&this.logger.log("WARN",`发现警告 [${m}]`,{warningsCount:D.warnings.length,warnings:D.warnings}),D}catch(v){const t=v.message;if(this.logger.log("ERROR",`排班计算异常 [${m}]`,{error:t,stack:v.stack,requestData:{studentsCount:(null==(u=e.students)?void 0:u.length)||0,teachersCount:(null==(p=e.teachers)?void 0:p.length)||0,dateRange:`${e.startDate} ~ ${e.endDate}`}}),t.includes("Failed to fetch")||t.includes("无法连接到后端服务"))try{const e=await Oe();throw new Error(`排班服务调用失败: ${t}\n\n${e}`)}catch(f){throw new Error(`排班服务调用失败: ${t}`)}throw new Error(`排班服务调用失败: ${t}`)}}async generateScheduleWithProgress(e,t,a){var n,s,i,r;const l=e.students,o=e.teachers;await this.getLatestBaseUrl(),this.logger.log("DEBUG",`开始进度模式排班 [${a}]`,{studentsCount:l.length,teachersCount:o.length});const d=[{percentage:10,message:"正在初始化排班问题...",delay:100},{percentage:20,message:"正在生成初始解...",delay:150},{percentage:35,message:"正在优化硬约束...",delay:200},{percentage:50,message:"正在优化软约束...",delay:250},{percentage:65,message:"正在平衡工作负载...",delay:200},{percentage:80,message:"正在最终优化...",delay:150},{percentage:95,message:"正在生成最终结果...",delay:100}];let c=0,u=null;const p=()=>{if(c>=d.length)return;const e=d[c];this.logger.log("DEBUG",`进度更新 [${a}]`,{percentage:e.percentage,message:e.message,step:c+1,totalSteps:d.length}),t({percentage:e.percentage,message:e.message}),c+=1,c<d.length&&(u=setTimeout(p,e.delay))};u=setTimeout(p,50);try{this.logger.log("INFO",`调用同步排班API [${a}]`);let l=window.__opta_session_id;const o={"Content-Type":"application/json",Accept:"application/json","X-Request-ID":a};if(!l){const e=window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36).slice(2);window.__opta_session_id=e,l=e}l&&(o["X-Session-Id"]=l);const d=await this.getLatestBaseUrl(),c=await fetch(`${d}/solve`,{method:"POST",headers:o,credentials:"same-origin",mode:"cors",body:JSON.stringify({...e,solverConfig:{...e.solverConfig||{},mode:(null==(n=e.solverConfig)?void 0:n.mode)||"adaptive"}})});if(u&&clearTimeout(u),this.logger.log("DEBUG",`同步API响应 [${a}]`,{status:c.status,statusText:c.statusText,headers:Object.fromEntries(c.headers.entries())}),!c.ok){let e="";try{e=await c.text()}catch(m){e="无法读取错误详情"}const t=`OptaPlanner服务请求失败: ${c.status} ${c.statusText}`;throw this.logger.log("ERROR",t,{requestId:a,status:c.status,statusText:c.statusText,errorDetails:e,url:`${this.baseUrl}/solve`}),new Error(`${t} - ${e}`)}const p=await c.json();return t({percentage:100,currentSolution:p,message:"排班完成！",score:"object"==typeof(null==(s=p.statistics)?void 0:s.finalScore)?p.statistics.finalScore:void 0}),this.logger.log("INFO",`进度模式排班完成 [${a}]`,{success:p.success,assignmentsCount:(null==(i=p.assignments)?void 0:i.length)||0,executionTime:p.executionTime,finalScore:null==(r=p.statistics)?void 0:r.finalScore}),p}catch(h){throw u&&clearTimeout(u),this.logger.log("ERROR",`进度模式排班异常 [${a}]`,{error:h.message,stack:h.stack}),new Error(`排班服务调用失败: ${h.message}`)}}async getOptimalTimeSlotRecommendations(e){var t,a,n;const s=`timeslot_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{this.logger.log("INFO",`获取智能时间段推荐 [${s}]`,{studentsCount:(null==(t=e.students)?void 0:t.length)||0,teachersCount:(null==(a=e.teachers)?void 0:a.length)||0,dateRange:`${e.startDate} ~ ${e.endDate}`});const r=await fetch(`${this.baseUrl}/recommend-timeslots`,{method:"POST",headers:{"Content-Type":"application/json","X-Request-ID":s},body:JSON.stringify(e)});if(this.logger.log("DEBUG",`时间段推荐响应 [${s}]`,{status:r.status,statusText:r.statusText}),!r.ok){let e="";try{e=await r.text()}catch(i){e="无法读取错误详情"}const t=`智能推荐请求失败: ${r.status} ${r.statusText}`;throw this.logger.log("ERROR",t,{requestId:s,status:r.status,statusText:r.statusText,errorDetails:e}),new Error(`${t} - ${e}`)}const l=await r.json();return this.logger.log("INFO",`智能时间段推荐完成 [${s}]`,{success:l.success,recommendationsCount:(null==(n=l.recommendations)?void 0:n.length)||0}),l}catch(r){throw this.logger.log("ERROR",`智能时间段推荐异常 [${s}]`,{error:r.message,stack:r.stack}),new Error(`智能推荐服务调用失败: ${r.message}`)}}async getStudentPersonalizedRecommendations(e){var t,a;const n=`student_rec_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;try{this.logger.log("INFO",`获取学员个性化推荐 [${n}]`,{studentsCount:(null==(t=e.students)?void 0:t.length)||0,teachersCount:(null==(a=e.teachers)?void 0:a.length)||0});const i=await fetch(`${this.baseUrl}/recommend-student-timeslots`,{method:"POST",headers:{"Content-Type":"application/json","X-Request-ID":n},body:JSON.stringify(e)});if(this.logger.log("DEBUG",`学员推荐响应 [${n}]`,{status:i.status,statusText:i.statusText}),!i.ok){let e="";try{e=await i.text()}catch(s){e="无法读取错误详情"}const t=`学员个性化推荐请求失败: ${i.status} ${i.statusText}`;throw this.logger.log("ERROR",t,{requestId:n,status:i.status,statusText:i.statusText,errorDetails:e}),new Error(`${t} - ${e}`)}const r=await i.json();return this.logger.log("INFO",`学员个性化推荐完成 [${n}]`,{success:r.success,studentsWithRecommendations:Object.keys(r.studentRecommendations||{}).length}),r}catch(i){throw this.logger.log("ERROR",`学员个性化推荐异常 [${n}]`,{error:i.message,stack:i.stack}),new Error(`学员个性化推荐服务调用失败: ${i.message}`)}}async generateScheduleAsync(e){var t,a;const n=`async_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;await this.ensureInitialized();try{this.logger.log("INFO",`异步排班请求 [${n}]`,{studentsCount:(null==(t=e.students)?void 0:t.length)||0,teachersCount:(null==(a=e.teachers)?void 0:a.length)||0,dateRange:`${e.startDate} ~ ${e.endDate}`});let i=window.__opta_session_id;if(!i){const e=window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():Date.now().toString(36)+Math.random().toString(36).slice(2);window.__opta_session_id=e,i=e}const r=await fetch(`${this.baseUrl}/solve-async`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-Request-ID":n,"X-Session-Id":i},credentials:"same-origin",mode:"cors",body:JSON.stringify(e)});if(this.logger.log("DEBUG",`异步排班响应 [${n}]`,{status:r.status,statusText:r.statusText}),!r.ok){let e="";try{e=await r.text()}catch(s){e="无法读取错误详情"}const t=`OptaPlanner异步服务请求失败: ${r.status} ${r.statusText}`;throw this.logger.log("ERROR",t,{requestId:n,status:r.status,statusText:r.statusText,errorDetails:e}),new Error(`${t} - ${e}`)}const l=await r.json();return this.logger.log("INFO",`异步排班任务提交成功 [${n}]`,{success:l.success,problemId:l.problemId}),l}catch(i){throw this.logger.log("ERROR",`异步排班请求异常 [${n}]`,{error:i.message,stack:i.stack}),new Error(`异步排班服务调用失败: ${i.message}`)}}async getScheduleResult(e){var t;try{await this.ensureInitialized(),this.logger.log("DEBUG","获取排班结果",{problemId:e});const n=await fetch(`${this.baseUrl}/result/${e}`);if(this.logger.log("DEBUG","排班结果响应",{problemId:e,status:n.status,statusText:n.statusText}),!n.ok){let t="";try{t=await n.text()}catch(a){t="无法读取错误详情"}const s=`获取排班结果失败: ${n.status} ${n.statusText}`;throw this.logger.log("ERROR",s,{problemId:e,status:n.status,statusText:n.statusText,errorDetails:t}),new Error(`${s} - ${t}`)}const s=await n.json();return this.logger.log("INFO","排班结果获取成功",{problemId:e,success:s.success,assignmentsCount:(null==(t=s.assignments)?void 0:t.length)||0}),s}catch(n){throw this.logger.log("ERROR","获取排班结果异常",{problemId:e,error:n.message,stack:n.stack}),new Error(`获取排班结果失败: ${n.message}`)}}async cancelSchedule(e){try{this.logger.log("DEBUG","取消排班任务",{problemId:e});const t=await fetch(`${this.baseUrl}/cancel/${e}`,{method:"DELETE"}),a=t.ok;return this.logger.log(a?"INFO":"WARN","排班任务取消"+(a?"成功":"失败"),{problemId:e,status:t.status,statusText:t.statusText}),a}catch(t){return this.logger.log("ERROR","取消排班任务异常",{problemId:e,error:t.message}),!1}}async getServiceStatus(){try{await this.ensureInitialized(),this.logger.log("DEBUG","获取服务状态");const e=await fetch(`${this.baseUrl}/status`);if(this.logger.log("DEBUG","服务状态响应",{status:e.status,statusText:e.statusText}),!e.ok){const t=`获取服务状态失败: ${e.status}`;throw this.logger.log("ERROR",t,{status:e.status,statusText:e.statusText}),new Error(t)}const t=await e.json();return this.logger.log("INFO","服务状态获取成功",t),t}catch(e){throw this.logger.log("ERROR","获取服务状态异常",{error:e.message,stack:e.stack}),e}}getServiceLogs(){return this.logger.getLogs()}clearServiceLogs(){this.logger.clearLogs()}async diagnoseConnection(){const e={healthy:!1,baseUrl:this.baseUrl,endpoints:[]},t=["/health","/status","/generate","/solve"];this.logger.log("INFO","开始诊断服务连接",{baseUrl:this.baseUrl,endpoints:t});for(const n of t){const t=Date.now();try{const a=await fetch(`${this.baseUrl}${n}`,{method:"/generate"===n||"/solve"===n?"POST":"GET",headers:{"Content-Type":"application/json"},body:"/generate"===n||"/solve"===n?JSON.stringify({students:[],teachers:[],startDate:"2025-01-01",endDate:"2025-01-02"}):void 0,signal:AbortSignal.timeout(5e3)}),s=Date.now()-t;e.endpoints.push({path:n,status:a.ok?"ok":"error",responseTime:s,error:a.ok?void 0:`${a.status} ${a.statusText}`}),a.ok&&"/health"===n&&(e.healthy=!0)}catch(a){const s=Date.now()-t;e.endpoints.push({path:n,status:s>4900?"timeout":"error",responseTime:s,error:a.message})}}return this.logger.log("INFO","服务连接诊断完成",e),e}};class Le{static fixTeacherNameMapping(e,t){const a=new Map;return t.forEach(e=>{e&&e.id&&e.name&&a.set(e.id,e.name)}),e.map(e=>{const t={...e};return e.examiner1&&(t.examiner1=this.extractTeacherName(e.examiner1,a)),e.examiner2&&(t.examiner2=this.extractTeacherName(e.examiner2,a)),e.backupExaminer&&(t.backupExaminer=this.extractTeacherName(e.backupExaminer,a)),t})}static extractTeacherName(e,t){if(!e)return"未分配";if("object"==typeof e&&null!==e){if(e.name&&"string"==typeof e.name)return e.name.trim();if(e.id)return t.get(e.id)||`考官${e.id}`}if("string"==typeof e){const a=e.trim();return/^\d+$/.test(a)?t.get(a)||`考官${a}`:a}return"未知考官"}static fixDateSorting(e){return e.sort((e,t)=>{const a=new Date(e.examDate),n=new Date(t.examDate);return a.getTime()-n.getTime()})}static validateScheduleResult(e){const t=[];return e&&e.assignments?(e.assignments.forEach((e,a)=>{e.studentId&&e.studentName||t.push(`第${a+1}个assignment缺少学员信息`),e.examDate||t.push(`第${a+1}个assignment缺少考试日期`),e.examiner1===e.examiner2&&t.push(`第${a+1}个assignment考官1和考官2相同`),e.examiner1===e.backupExaminer&&t.push(`第${a+1}个assignment考官1和备份考官相同`),e.examiner2===e.backupExaminer&&t.push(`第${a+1}个assignment考官2和备份考官相同`)}),{isValid:0===t.length,errors:t}):(t.push("排班结果为空或缺少assignments字段"),{isValid:!1,errors:t})}static fixScheduleResultDisplay(e,t){if(!e||!e.assignments)return e;const a=this.fixTeacherNameMapping(e.assignments,t),n=this.fixDateSorting(a);return{...e,assignments:n}}static fixTableDataDisplay(e,t){const a=new Map;return t.forEach(e=>{e&&e.id&&e.name&&a.set(e.id,e.name)}),e.map(e=>{const t={...e};return["examiner1_1","examiner1_2","backup1","examiner2_1","examiner2_2","backup2"].forEach(n=>{e[n]&&(t[n]=this.extractTeacherName(e[n],a))}),t})}static checkAndFixDataConsistency(e,t,a){const n=[];let s=!0;e.assignments&&e.assignments.length!==t.length&&(n.push(`数据量不一致：后端${e.assignments.length}条，前端${t.length}条`),s=!1);return{isConsistent:s,fixedDisplay:this.fixTableDataDisplay(t,a),issues:n}}}class Ue{static validateScheduleResult(e){const t=[],a=[];let n=JSON.parse(JSON.stringify(e));if(!e||!e.assignments)return t.push({type:"error",code:"MISSING_DATA",message:"排班结果数据缺失"}),{isValid:!1,errors:t,warnings:a};for(let s=0;s<n.assignments.length;s++){const i=n.assignments[s],r=e.assignments[s];this.validateSingleAssignment(i,r,t,a,n)}return{isValid:0===t.length,errors:t,warnings:a,fixedData:0===t.length?n:e}}static validateSingleAssignment(e,t,a,n,s){const i=e.studentName||"未知学员",r=e.studentId||e.id;if(e.examiner1&&e.examiner2){const t=this.getExaminerName(e.examiner1),a=this.getExaminerName(e.examiner2);t===a&&"未分配"!==t&&(e.examiner2="未分配",n.push({type:"warning",code:"DATA_FIXED",message:`已修复${i}的重复考官问题，考官2已设为未分配`,studentId:r,studentName:i,details:{originalExaminer1:t,originalExaminer2:a}}))}e.examiner1&&"未分配"!==this.getExaminerName(e.examiner1)||n.push({type:"warning",code:"MISSING_EXAMINER1",message:`学员${i}缺少考官1`,studentId:r,studentName:i}),e.examiner2&&"未分配"!==this.getExaminerName(e.examiner2)||n.push({type:"warning",code:"MISSING_EXAMINER2",message:`学员${i}缺少考官2`,studentId:r,studentName:i}),e.examDate||a.push({type:"error",code:"MISSING_EXAM_DATE",message:`学员${i}缺少考试日期`,studentId:r,studentName:i})}static getExaminerName(e){return e?"string"==typeof e?e:e.name?e.name:"未分配":"未分配"}static validateStudentData(e){const t=[],a=[];return Array.isArray(e)&&0!==e.length?(e.forEach((e,n)=>{e.name&&e.name.trim()||t.push({type:"error",code:"MISSING_STUDENT_NAME",message:`第${n+1}个学员缺少姓名`,studentId:e.id}),e.department||a.push({type:"warning",code:"MISSING_STUDENT_DEPARTMENT",message:`学员${e.name||"未知"}缺少科室信息`,studentId:e.id,studentName:e.name})}),{isValid:0===t.length,errors:t,warnings:a}):(t.push({type:"error",code:"NO_STUDENTS",message:"没有学员数据"}),{isValid:!1,errors:t,warnings:a})}static validateTeacherData(e){const t=[],a=[];if(!Array.isArray(e)||0===e.length)return t.push({type:"error",code:"NO_TEACHERS",message:"没有考官数据"}),{isValid:!1,errors:t,warnings:a};const n=new Set,s=new Set;return e.forEach((e,i)=>{e.name&&e.name.trim()?(n.has(e.name)?s.add(e.name):n.add(e.name),e.department||a.push({type:"warning",code:"MISSING_TEACHER_DEPARTMENT",message:`考官${e.name}缺少科室信息`})):t.push({type:"error",code:"MISSING_TEACHER_NAME",message:`第${i+1}个考官缺少姓名`})}),s.forEach(e=>{a.push({type:"warning",code:"DUPLICATE_TEACHER_NAME",message:`考官姓名重复: ${e}`})}),{isValid:0===t.length,errors:t,warnings:a}}static generateValidationReport(e){let t="=== 数据验证报告 ===\n";return t+=`验证状态: ${e.isValid?"✅ 通过":"❌ 失败"}\n`,t+=`错误数量: ${e.errors.length}\n`,t+=`警告数量: ${e.warnings.length}\n\n`,e.errors.length>0&&(t+="错误详情:\n",e.errors.forEach((e,a)=>{t+=`${a+1}. [${e.code}] ${e.message}\n`}),t+="\n"),e.warnings.length>0&&(t+="警告详情:\n",e.warnings.forEach((e,a)=>{t+=`${a+1}. [${e.code}] ${e.message}\n`})),t}}var Be=Object.defineProperty,He=(e,t,a)=>((e,t,a)=>t in e?Be(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a);const We=class e{constructor(){He(this,"holidayCache",new Map),He(this,"workdayCache",new Set),He(this,"holidays2025",[{date:"2025-01-01",name:"元旦",type:"national",description:"元旦节"},{date:"2025-01-28",name:"春节",type:"national",description:"除夕"},{date:"2025-01-29",name:"春节",type:"national",description:"春节初一"},{date:"2025-01-30",name:"春节",type:"national",description:"春节初二"},{date:"2025-01-31",name:"春节",type:"national",description:"春节初三"},{date:"2025-02-01",name:"春节",type:"national",description:"春节初四"},{date:"2025-02-02",name:"春节",type:"national",description:"春节初五"},{date:"2025-02-03",name:"春节",type:"national",description:"春节初六"},{date:"2025-04-05",name:"清明节",type:"national",description:"清明节"},{date:"2025-04-06",name:"清明节",type:"national",description:"清明节假期"},{date:"2025-04-07",name:"清明节",type:"national",description:"清明节假期"},{date:"2025-05-01",name:"劳动节",type:"national",description:"劳动节"},{date:"2025-05-02",name:"劳动节",type:"national",description:"劳动节假期"},{date:"2025-05-03",name:"劳动节",type:"national",description:"劳动节假期"},{date:"2025-05-04",name:"劳动节",type:"national",description:"劳动节假期"},{date:"2025-05-05",name:"劳动节",type:"national",description:"劳动节假期"},{date:"2025-05-31",name:"端午节",type:"national",description:"端午节"},{date:"2025-06-01",name:"端午节",type:"national",description:"端午节假期"},{date:"2025-06-02",name:"端午节",type:"national",description:"端午节假期"},{date:"2025-10-01",name:"国庆节",type:"national",description:"国庆节"},{date:"2025-10-02",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2025-10-03",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2025-10-04",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2025-10-05",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2025-10-06",name:"中秋节",type:"national",description:"中秋节（与国庆合并）"},{date:"2025-10-07",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2025-10-08",name:"国庆节",type:"national",description:"国庆节假期"}]),He(this,"holidays2026",[{date:"2026-01-01",name:"元旦",type:"national",description:"元旦节"},{date:"2026-02-15",name:"春节",type:"national",description:"春节假期第一天"},{date:"2026-02-16",name:"春节",type:"national",description:"除夕"},{date:"2026-02-17",name:"春节",type:"national",description:"春节初一"},{date:"2026-02-18",name:"春节",type:"national",description:"春节初二"},{date:"2026-02-19",name:"春节",type:"national",description:"春节初三"},{date:"2026-02-20",name:"春节",type:"national",description:"春节初四"},{date:"2026-02-21",name:"春节",type:"national",description:"春节初五"},{date:"2026-02-22",name:"春节",type:"national",description:"春节初六"},{date:"2026-02-23",name:"春节",type:"national",description:"春节假期最后一天"},{date:"2026-04-05",name:"清明节",type:"national",description:"清明节"},{date:"2026-04-06",name:"清明节",type:"national",description:"清明节假期"},{date:"2026-04-07",name:"清明节",type:"national",description:"清明节假期"},{date:"2026-05-01",name:"劳动节",type:"national",description:"劳动节"},{date:"2026-05-02",name:"劳动节",type:"national",description:"劳动节假期"},{date:"2026-05-03",name:"劳动节",type:"national",description:"劳动节假期"},{date:"2026-05-04",name:"劳动节",type:"national",description:"劳动节假期"},{date:"2026-05-05",name:"劳动节",type:"national",description:"劳动节假期"},{date:"2026-06-19",name:"端午节",type:"national",description:"端午节"},{date:"2026-06-20",name:"端午节",type:"national",description:"端午节假期"},{date:"2026-06-21",name:"端午节",type:"national",description:"端午节假期"},{date:"2026-09-25",name:"中秋节",type:"national",description:"中秋节"},{date:"2026-09-26",name:"中秋节",type:"national",description:"中秋节假期"},{date:"2026-09-27",name:"中秋节",type:"national",description:"中秋节假期"},{date:"2026-10-01",name:"国庆节",type:"national",description:"国庆节"},{date:"2026-10-02",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2026-10-03",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2026-10-04",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2026-10-05",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2026-10-06",name:"国庆节",type:"national",description:"国庆节假期"},{date:"2026-10-07",name:"国庆节",type:"national",description:"国庆节假期"}]),He(this,"workdays2025",["2025-01-26","2025-02-08","2025-04-27","2025-09-28","2025-10-11"]),He(this,"workdays2026",["2026-04-26","2026-09-27","2026-10-10"]),this.initializeCache()}static getInstance(){return e.instance||(e.instance=new e),e.instance}initializeCache(){this.holidayCache.set("2025",this.holidays2025),this.holidayCache.set("2026",this.holidays2026),this.workdays2025.forEach(e=>{this.workdayCache.add(e)}),this.workdays2026.forEach(e=>{this.workdayCache.add(e)})}getHolidays(e){const t=e.toString();return this.holidayCache.get(t)||[]}isHoliday(e){const t=new Date(e).getFullYear();return this.getHolidays(t).some(t=>t.date===e)}getHolidayInfo(e){const t=new Date(e).getFullYear();return this.getHolidays(t).find(t=>t.date===e)||null}isWorkday(e){return this.workdayCache.has(e)}isWorkingDay(e){const t=new Date(e).getDay();return!!this.isWorkday(e)||!this.isHoliday(e)&&(0!==t&&6!==t)}getHolidaysInRange(e,t){const a=new Date(e),n=new Date(t),s=[],i=new Date(a);for(;i<=n;){const e=i.toISOString().split("T")[0],t=this.getHolidayInfo(e);t&&s.push(t),i.setDate(i.getDate()+1)}return s}getHolidayViolationMessage(e){const t=this.getHolidayInfo(e);return t?`不能在${t.name}（${e}）安排考试，这是国家法定节假日。`:`${e} 不是节假日`}getMultipleHolidayViolationMessage(e){const t=e.filter(e=>this.isHoliday(e)).map(e=>{const t=this.getHolidayInfo(e);return`${e}（${(null==t?void 0:t.name)||"节假日"}）`});return 0===t.length?"":1===t.length?`不能在${t[0]}安排考试，这是国家法定节假日。`:`不能在以下日期安排考试，这些都是国家法定节假日：${t.join("、")}。`}async fetchHolidaysFromAPI(e){try{const t=2025===e?this.workdays2025:2026===e?this.workdays2026:[];return{success:!0,holidays:this.getHolidays(e),workdays:t}}catch(t){return{success:!1,holidays:[],workdays:[]}}}};He(We,"instance");const Ve=We.getInstance();function qe(e){const t=e.filter(e=>{if(!e||!e.studentName)return!1;const t=e.examiner1&&"未分配"!==e.examiner1&&"未分组"!==e.examiner1&&null!==e.examiner1&&void 0!==e.examiner1&&("string"!=typeof e.examiner1||""!==e.examiner1.trim()),a=e.examiner2&&"未分配"!==e.examiner2&&"未分组"!==e.examiner2&&null!==e.examiner2&&void 0!==e.examiner2&&("string"!=typeof e.examiner2||""!==e.examiner2.trim());return!t||!a});if(0===t.length)return{id:"no-examiner-violation",type:"other",severity:"low",title:"主考官配备完整",message:"所有学员都已配备两名主考官"};const a=t.filter(e=>{const t=e.examiner1&&"未分配"!==e.examiner1&&"未分组"!==e.examiner1,a=e.examiner2&&"未分配"!==e.examiner2&&"未分组"!==e.examiner2;return!t&&!a}),n=t.filter(e=>{const t=e.examiner1&&"未分配"!==e.examiner1&&"未分组"!==e.examiner1,a=e.examiner2&&"未分配"!==e.examiner2&&"未分组"!==e.examiner2;return t&&!a||!t&&a}),s=t.slice(0,5).map(e=>{const t=[];return(!e.examiner1||"未分配"===e.examiner1||"未分组"===e.examiner1||null===e.examiner1||void 0===e.examiner1||"string"==typeof e.examiner1&&""===e.examiner1.trim())&&t.push("考官一"),(!e.examiner2||"未分配"===e.examiner2||"未分组"===e.examiner2||null===e.examiner2||void 0===e.examiner2||"string"==typeof e.examiner2&&""===e.examiner2.trim())&&t.push("考官二"),`${e.studentName}缺少${t.join("、")}`});t.length>5&&s.push(`...还有${t.length-5}个学员存在类似问题`);const i=a.length>0?"high":"medium",r=a.length>0?"HC2约束违反：主考官严重不足":"HC2约束违反：部分主考官缺失";let l="";return l=a.length>0?`发现${a.length}个学员完全缺少主考官，${n.length}个学员部分缺少主考官`:`发现${t.length}个学员部分缺少主考官配备`,{id:"main-examiners-violation",type:"teacher",severity:i,title:r,message:l,details:s,suggestion:"请为所有学员分配足够的主考官。考官一必须与学员同科室，考官二必须与学员不同科室。",affectedStudents:t.map(e=>e.studentName||e.student),fixable:!0,stats:{total:t.length,critical:a.length,minor:n.length}}}function Je(e){const t=e.filter(e=>"high"===e.severity),a=e.filter(e=>"medium"===e.severity),n=e.filter(e=>"low"===e.severity);let s=[];t.length>0?(s=t,t.length<=2&&a.length>0&&(s=[...s,...a.slice(0,2)])):s=a.length>0?a.slice(0,3):n.slice(0,1);const i=function(e){const t=new Map;e.forEach(e=>{const a=`${e.type}-${e.severity}`;t.has(a)||t.set(a,[]),t.get(a).push(e)});const a=[];return t.forEach(e=>{if(1===e.length)a.push(e[0]);else{const t=function(e){const t=e[0],a=e.reduce((e,t)=>{var a;return e+((null==(a=t.affectedStudents)?void 0:a.length)||0)},0);return{...t,id:`merged-${t.type}-${Date.now()}`,title:`${t.title} (${e.length}个相关问题)`,message:`发现${e.length}个相关约束违反，共影响${a}个学员`,details:[`合并了${e.length}个相似的约束违反问题：`,...e.slice(0,3).map(e=>`• ${e.message}`),...e.length>3?[`• ...还有${e.length-3}个类似问题`]:[]],affectedStudents:e.reduce((e,t)=>[...e,...t.affectedStudents||[]],[])}}(e);a.push(t)}}),a}(s);return i}var Ge=Object.defineProperty,Ye=(e,t,a)=>((e,t,a)=>t in e?Ge(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,t+"",a);const Xe=async()=>{var e;return"undefined"!=typeof window&&(null==(e=window.electronAPI)?void 0:e.isElectron)?await async function(){try{const t=window.electronAPI;if(!t||!t.isElectron)return"/api/learning";if(t.getBackendStatus)try{const e=await t.getBackendStatus();if(e&&e.isRunning&&e.port)return`http://127.0.0.1:${e.port}/api/learning`}catch(e){}if(t.onBackendReady&&await new Promise(e=>{var a;null==(a=t.getBackendStatus)||a.call(t).then(a=>{a&&a.isRunning&&a.port?e():t.onBackendReady(()=>{e()})}).catch(()=>{t.onBackendReady(()=>{e()})})}),t.getBackendPort){const e=await t.getBackendPort();if("number"==typeof e&&e>0&&e<=65535)return`http://127.0.0.1:${e}/api/learning`}}catch(t){}return"/api/learning"}():"/api/learning"};const Ke=new class{constructor(){Ye(this,"pendingLogsKey","pending_edit_logs")}async getBaseUrl(){return await Xe()}async recordManualEdit(e){try{const t=await this.getBaseUrl(),a=await ee.post(`${t}/manual-edit`,e,{timeout:5e3,headers:{"Content-Type":"application/json"}});return this.sendPendingLogs(),a.data}catch(t){return this.saveToLocalStorage(e),{success:!1,message:"已保存到本地缓存，将在下次启动时重试"}}}saveToLocalStorage(e){try{const t=this.getPendingLogs();t.push({...e,timestamp:(new Date).toISOString()}),localStorage.setItem(this.pendingLogsKey,JSON.stringify(t))}catch(t){}}getPendingLogs(){try{const e=localStorage.getItem(this.pendingLogsKey);return e?JSON.parse(e):[]}catch(e){return[]}}async sendPendingLogs(){const e=this.getPendingLogs();if(0===e.length)return;const t=[],a=await this.getBaseUrl();for(let s=0;s<e.length;s++)try{const n=e[s];await ee.post(`${a}/manual-edit`,n,{timeout:3e3}),t.push(s)}catch(n){}if(t.length>0){const a=e.filter((e,a)=>!t.includes(a));localStorage.setItem(this.pendingLogsKey,JSON.stringify(a))}}async getStatistics(e=30){try{const t=await this.getBaseUrl();return(await ee.get(`${t}/statistics`,{params:{days:e},timeout:5e3})).data}catch(t){throw t}}async getHistory(e=50,t=0){try{const a=await this.getBaseUrl();return(await ee.get(`${a}/history`,{params:{limit:e,offset:t},timeout:5e3})).data}catch(a){throw a}}async healthCheck(){try{const e=await this.getBaseUrl();return"ok"===(await ee.get(`${e}/health`,{timeout:2e3})).data.status}catch(e){return!1}}async initialize(){await this.healthCheck()&&await this.sendPendingLogs()}};"undefined"!=typeof window&&setTimeout(()=>{Ke.initialize().catch(e=>{})},2e3);const Ze=new Date(2025,8,4);function Qe(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function et(e){const t=function(e){if(e instanceof Date)return isNaN(e.getTime())?e:new Date(e.getFullYear(),e.getMonth(),e.getDate());if(/^\d{1,2}\.\d{1,2}$/.test(e)){const[t,a]=e.split("."),n=(new Date).getFullYear();return new Date(n,parseInt(t,10)-1,parseInt(a,10))}if(/^\d{1,2}-\d{1,2}$/.test(e)){const[t,a]=e.split("-"),n=(new Date).getFullYear();return new Date(n,parseInt(t,10)-1,parseInt(a,10))}if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(e)){const[t,a,n]=e.split("-");return new Date(parseInt(t,10),parseInt(a,10)-1,parseInt(n,10))}if(/^\d{1,2}月\d{1,2}日$/.test(e)){const t=e.replace("月","-").replace("日",""),[a,n]=t.split("-"),s=(new Date).getFullYear();return new Date(s,parseInt(a,10)-1,parseInt(n,10))}const t=new Date(e);return isNaN(t.getTime())?new Date:new Date(t.getFullYear(),t.getMonth(),t.getDate())}(e);if(isNaN(t.getTime()))throw new Error(`Invalid date: ${e}`);const a=(Math.floor((t.getTime()-Ze.getTime())/864e5)%4+4)%4,n=[{dayShift:"二组",nightShift:"一组",restGroups:["三组","四组"]},{dayShift:"三组",nightShift:"二组",restGroups:["四组","一组"]},{dayShift:"四组",nightShift:"三组",restGroups:["一组","二组"]},{dayShift:"一组",nightShift:"四组",restGroups:["二组","三组"]}][a];return{date:Qe(t),cyclePosition:a,dayShift:n.dayShift,nightShift:n.nightShift,restGroups:n.restGroups}}function tt(e,t){if(!e.group||"无"===e.group)return 20;const a=et(t);return e.group===a.dayShift?0:e.group===a.nightShift?40:a.restGroups.includes(e.group)?30:10}function at(e,t){if(!e.group||"无"===e.group)return"admin";const a=et(t);return e.group===a.dayShift?"day":e.group===a.nightShift?"night":a.restGroups.includes(e.group)?"rest":"unknown"}function nt(e,t){if(!e.group||"无"===e.group)return"none";if(!et(t).restGroups.includes(e.group))return"none";const a=new Date("string"==typeof t?t:t.toISOString());a.setDate(a.getDate()-1);return et(a).restGroups.includes(e.group)?"second":"first"}function st(e,t){const a=e.map(e=>{const a=function(e,t){if(!e.group||"无"===e.group)return!0;const a=et(t);return e.group!==a.dayShift}(e,t),n=e.group&&"无"!==e.group?a&&!1!==e.available:!1!==e.available;return{...e,available:n,shiftType:at(e,t),nightShiftPreferred:"night"===at(e,t),restDayStatus:nt(e,t),priorityScore:tt(e,t),_originalAvailable:e.available,_shiftAvailable:a}}),n=a.filter(e=>e.available!==e._originalAvailable).length;return n>0&&fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"shiftRotationService.ts:enhanceTeachersWithShiftInfo",message:"考官可用性增强结果",data:{date:"string"==typeof t?t:t.toISOString().split("T")[0],totalTeachers:e.length,changedCount:n,beforeAvailableCount:e.filter(e=>!1!==e.available).length,afterAvailableCount:a.filter(e=>e.available).length,changedTeachers:a.filter(e=>e.available!==e._originalAvailable).slice(0,5).map(e=>({name:e.name,group:e.group,before:e._originalAvailable,after:e.available,shiftAvailable:e._shiftAvailable}))},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"C"})}).catch(()=>{}),a}function it(e,t){if(!e.group||"无"===e.group)return!1;const a=et(t);return e.group===a.dayShift}function rt(e,t,a,n,s){var i;const r=[],l=G(a.department),o=G(e.department),d=t.endsWith("_2")||"backup2"===t,c=d?a.date2:a.date1,u="examiner1_1"===t||"examiner2_1"===t||"examiner1"===t,p="examiner1_2"===t||"examiner2_2"===t||"examiner2"===t,m="backup1"===t||"backup2"===t||"backup"===t;if(u?function(e,t){const a=G(e),n=G(t);return a===n||"三"===a&&"七"===n||"七"===a&&"三"===n}(l,o)||r.push({constraintId:"HC2",type:"hard",severity:"high",title:"HC2硬约束违反：考官1科室不匹配",description:`考官1必须与学员同科室。学员${a.student}来自${a.department}，${e.name}来自${e.department}`,suggestions:[`选择${a.department}的考官`,"三"===l?"或选择区域七室的考官（三七互通）":"","七"===l?"或选择区域三室的考官（三七互通）":""].filter(e=>e)}):p&&l===o&&r.push({constraintId:"HC7",type:"hard",severity:"high",title:"HC7硬约束违反：考官2不能与学员同科室",description:`考官2必须来自不同科室。学员${a.student}来自${a.department}，不能选择同科室的${e.name}`,suggestions:["选择其他科室的考官"]}),u){const t=d?a.examiner2_2:a.examiner2_1||a.examiner2;if(t&&s){const a=s.find(e=>e.name===t);if(a){const n=G(a.department);n&&o===n&&r.push({constraintId:"HC7",type:"hard",severity:"high",title:"HC7硬约束违反：考官1和考官2不能同科室",description:`考官1 ${e.name}(${e.department}) 与考官2 ${t}(${a.department}) 来自同一科室`,suggestions:["选择其他科室的考官作为考官1","或更换考官2"]})}}}else if(p){const t=d?a.examiner1_2:a.examiner1_1||a.examiner1;if(t&&s){const a=s.find(e=>e.name===t);if(a){const n=G(a.department);n&&o===n&&r.push({constraintId:"HC7",type:"hard",severity:"high",title:"HC7硬约束违反：考官1和考官2不能同科室",description:`考官2 ${e.name}(${e.department}) 与考官1 ${t}(${a.department}) 来自同一科室`,suggestions:["选择其他科室的考官作为考官2","或更换考官1"]})}}}if(m){const t=d?a.examiner1_2:a.examiner1_1||a.examiner1,n=d?a.examiner2_2:a.examiner2_1||a.examiner2;t===e.name&&r.push({constraintId:"HC8",type:"hard",severity:"high",title:"HC8硬约束违反：备份考官不能与考官1是同一人",description:`备份考官${e.name}不能与考官1${t}是同一人`,suggestions:["选择其他考官作为备份考官"]}),n===e.name&&r.push({constraintId:"HC8",type:"hard",severity:"high",title:"HC8硬约束违反：备份考官不能与考官2是同一人",description:`备份考官${e.name}不能与考官2${n}是同一人`,suggestions:["选择其他考官作为备份考官"]})}else{[d?a.examiner1_2:a.examiner1_1,d?a.examiner2_2:a.examiner2_1,d?a.backup2:a.backup1,a.examiner1,a.examiner2,a.backup].filter(e=>e&&e!==a[t]).includes(e.name)&&r.push({constraintId:"HC8",type:"hard",severity:"high",title:"HC8硬约束违反：考官重复",description:`${e.name}已担任该学员的其他考官角色`,suggestions:["选择其他考官","或调整现有角色分配"]})}if(m&&s){const t=d?a.examiner1_2:a.examiner1_1||a.examiner1,n=d?a.examiner2_2:a.examiner2_1||a.examiner2,i=t?s.find(e=>e.name===t):null,l=n?s.find(e=>e.name===n):null;if(i){const a=G(i.department);a&&o===a&&r.push({constraintId:"HC8b",type:"hard",severity:"high",title:"HC8b硬约束违反：备份考官不能与考官1同科室",description:`备份考官${e.name}(${e.department})与考官1${t}(${i.department})来自同一科室`,suggestions:["选择其他科室的考官作为备份考官"]})}if(l){const t=G(l.department);t&&o===t&&r.push({constraintId:"HC8b",type:"hard",severity:"high",title:"HC8b硬约束违反：备份考官不能与考官2同科室",description:`备份考官${e.name}(${e.department})与考官2${n}(${l.department})来自同一科室`,suggestions:["选择其他科室的考官作为备份考官"]})}}fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"manualEditConstraintChecker.ts:HC4Check",message:"HC4约束检查数据",data:{teacherName:e.name,examDate:c,allRecordsCount:n.length,editingRecordId:a.id,editingStudent:a.student},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"D"})}).catch(()=>{});const h=n.filter(t=>{if(t.id===a.id)return!1;const n=t.date1===c&&[t.examiner1_1,t.examiner2_1,t.backup1].includes(e.name),s=t.date2===c&&[t.examiner1_2,t.examiner2_2,t.backup2].includes(e.name),i=t.examDate===c&&[t.examiner1,t.examiner2,t.backup].includes(e.name);return n||s||i});if(h.length>0&&(fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"manualEditConstraintChecker.ts:HC4Conflict",message:"HC4冲突发现",data:{teacherName:e.name,examDate:c,conflictCount:h.length,conflictStudents:h.map(e=>e.student)},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"D"})}).catch(()=>{}),r.push({constraintId:"HC4",type:"hard",severity:"high",title:"HC4硬约束违反：每名考官每天只能监考一名考生",description:`${e.name}在${c}已担任${h.length}场考试的考官`,suggestions:["选择当天没有考试安排的考官",`冲突的学员：${h.map(e=>e.student).join("、")}`]})),it(e,c)){const t=et(c);r.push({constraintId:"HC3",type:"hard",severity:"high",title:"HC3硬约束违反：白班执勤冲突",description:`${e.name}(${e.group})在${c}执勤白班(${t.dayShift})，不能担任考官`,suggestions:["选择非白班执勤的考官",`当天白班班组：${t.dayShift}`,`可选择晚班(${t.nightShift})或休息班组(${t.restGroups.join("、")})`]})}else(null==(i=e.conflictInfo)?void 0:i.includes("白班执勤"))&&r.push({constraintId:"HC3",type:"hard",severity:"high",title:"HC3硬约束违反：白班执勤冲突",description:`${e.name}在${c}执勤白班，不能担任考官`,suggestions:["选择非白班执勤的考官","或调整考试日期"]});const g=e.unavailableDates||e.unavailablePeriods;if(g&&g.length>0)try{const t=new Date(c+"T00:00:00");for(const a of g){if(!a.startDate||!a.endDate)continue;const n=new Date(a.startDate+"T00:00:00"),s=new Date(a.endDate+"T23:59:59");if(t>=n&&t<=s){r.push({constraintId:"HC9",type:"hard",severity:"high",title:"HC9硬约束违反：考官不可用",description:`${e.name}在${c}不可用（${a.reason||"未说明原因"}）`,suggestions:["选择在此日期可用的考官",`不可用期间：${a.startDate} 至 ${a.endDate}`,`原因：${a.reason||"未说明"}`]});break}}}catch(v){}return r}const lt={class:"modal-header"},ot={class:"header-content"},dt={class:"title-section"},ct={class:"modal-title"},ut={class:"edit-context"},pt={class:"context-item"},mt={class:"context-item"},ht={class:"context-item"},gt={class:"modal-body"},vt={class:"field-info-section"},ft={class:"field-info-card"},yt={class:"field-header"},xt={class:"field-label"},bt={class:"current-value"},wt={key:0,class:"recommendations-section"},Dt={class:"section-header"},kt={class:"recommendation-count"},St={class:"recommendations-list"},$t=["onClick"],Ct={class:"recommendation-header"},Et={class:"teacher-info"},_t={class:"teacher-name"},Tt={class:"teacher-dept"},It={class:"recommendation-score"},Pt={class:"score-bar"},Rt={class:"score-text"},Mt={class:"recommendation-reasons"},At={key:0,class:"recommendation-warnings"},Ot={key:1,class:"conflicts-section"},Nt={class:"section-header"},zt={class:"conflict-count"},jt={class:"conflicts-list"},Ft={class:"conflict-header"},Lt={class:"conflict-title"},Ut={class:"conflict-severity"},Bt={class:"conflict-description"},Ht={key:0,class:"conflict-suggestions"},Wt={class:"suggestions-list"},Vt={class:"manual-selection-section"},qt={class:"section-header"},Jt={class:"search-box"},Gt={class:"teachers-grid"},Yt=["onClick"],Xt={class:"teacher-header"},Kt={class:"teacher-name"},Zt={class:"teacher-status"},Qt={key:0,class:"status-badge available"},ea={key:1,class:"status-badge unavailable"},ta={key:2,class:"status-badge recommended"},aa={class:"teacher-details"},na={class:"teacher-dept"},sa={class:"teacher-workload"},ia={key:0,class:"teacher-conflicts"},ra={class:"conflict-text"},la={class:"reason-dialog-header"},oa={class:"reason-dialog-title"},da={class:"reason-dialog-body"},ca={class:"selected-teacher-info"},ua={class:"teacher-info-card"},pa={class:"teacher-name-large"},ma={class:"teacher-dept-large"},ha={key:0,class:"dialog-conflicts"},ga={key:0,class:"hard-conflict-alert"},va={key:1,class:"soft-conflict-alert"},fa={class:"conflict-list"},ya={class:"reason-selection"},xa={class:"reason-tags-dialog"},ba=["onClick"],wa={class:"reason-detail"},Da={class:"reason-dialog-footer"},ka=["disabled"],Sa=z(t({__name:"SmartManualEditModal",props:{show:{type:Boolean},editingRecord:{},editingField:{},availableTeachers:{},currentValue:{},allScheduleRecords:{},smartRecommendations:{},conflicts:{}},emits:["close","confirm"],setup(e,{emit:t}){const D=e=>e?Y(e):"-",k=e,S=t,{isMobile:$}=K(),C=a(""),E=a(""),_=a(""),T=a(""),I=a(!1),P=a([]),R=a([]),M=a(!1),A=a(null),z=["自动排班冲突","考官特殊要求","临时调整","科室协调","工作量平衡","专业匹配优化","紧急替换","其他原因"],j=n(()=>k.currentValue||""),F=n(()=>{let e=I.value?k.availableTeachers:k.availableTeachers.filter(e=>P.value.some(t=>t.teacher.id===e.id)||e.available);if(T.value){const t=T.value.toLowerCase();e=e.filter(e=>e.name.toLowerCase().includes(t)||e.department.toLowerCase().includes(t))}return e.sort((e,t)=>{const a=ee(e),n=ee(t);return a&&!n?-1:!a&&n?1:e.available&&!t.available?-1:!e.available&&t.available?1:e.name.localeCompare(t.name)})}),L=n(()=>R.value.length>0),U=n(()=>R.value.some(e=>"high"===e.severity&&(e.type.startsWith("HC")||e.title.includes("硬约束")))),H=n(()=>R.value.some(e=>"high"!==e.severity||!e.type.startsWith("HC")&&!e.title.includes("硬约束"))),W=()=>{$.value||V()},V=()=>{C.value="",E.value="",_.value="",T.value="",I.value=!1,P.value=[],R.value=[],S("close")},q=async()=>{var e,t,a,n;const s=_.value.trim()||E.value;if(!s)return void alert("请填写修改原因");if(U.value){const e=R.value.filter(e=>"error"===e.severity||"high"===e.severity||"hard"===e.type).map(e=>`• ${e.title}\n  ${e.description}`).join("\n\n");if(!confirm(`⚠️ 硬约束违反警告\n\n检测到以下硬约束冲突：\n\n${e}\n\n⚡ 人工修改权限最高，您可以选择：\n\n✅ 确认修改 - 强制保存此修改（将标记为红色）\n❌ 取消 - 重新选择其他考官\n\n是否确认强制修改？`))return}if(!A.value)return;C.value=A.value.name;try{const i=ee(A.value),r=i?P.value.findIndex(e=>e.teacher.name===A.value.name)+1:void 0,l=i?null==(e=P.value.find(e=>e.teacher.name===A.value.name))?void 0:e.score:void 0,o={editedBy:"系统用户",context:{studentName:(null==(t=k.editingRecord)?void 0:t.student)||"",department:(null==(a=k.editingRecord)?void 0:a.department)||"",examDate:(null==(n=k.editingRecord)?void 0:n.examDate)||"",fieldName:k.editingField,timeSlot:"examiner1_1"===k.editingField||"examiner1_2"===k.editingField||"backup1"===k.editingField?"day1":"day2"},original:{value:k.currentValue||null},selected:{value:A.value.name,wasRecommended:i,recommendationRank:r,recommendationScore:l},reason:{category:E.value||"其他原因",detail:_.value||s},hadConflicts:R.value.length>0,conflicts:R.value.map(e=>({type:e.type,severity:e.severity,title:e.title,description:e.description})),isForced:U.value||L.value};Ke.recordManualEdit(o).catch(e=>{})}catch(c){}const i=P.value.find(e=>e.teacher.name===A.value.name),r=i?i.score:0,l=i?i.priority:"none",o=!!i,d=[...R.value];i||L.value?i&&r<70&&"low"===l&&d.push({type:"LOW_RECOMMENDATION",severity:"low",title:"提示：推荐优先级较低",description:`${A.value.name} 的推荐评分为 ${r}%，建议考虑更高优先级的考官`,suggestions:["查看推荐列表中的高优先级选项"]}):d.push({type:"NOT_RECOMMENDED",severity:"low",title:"提示：未在推荐列表中",description:`${A.value.name} 不在智能推荐列表中，可能存在更优选择`,suggestions:["推荐使用列表顶部的推荐考官"]}),S("confirm",{teacher:A.value.name,reason:s,conflicts:d,isForced:U.value||L.value,wasRecommended:o,recommendationScore:r,recommendationPriority:l}),Q(),V()},X=()=>{Q()},Q=()=>{M.value=!1,A.value=null,E.value="",_.value=""},ee=e=>P.value.some(t=>t.teacher.id===e.id),ae=e=>e.includes("backup")?"备用考官":"主考官",ne=e=>e.includes("backup")?"backup":"main",de=e=>{const t=rt(e,k.editingField,k.editingRecord,k.allScheduleRecords||[],k.availableTeachers).map(e=>({type:e.constraintId,severity:e.severity,title:e.title,description:e.description,suggestions:e.suggestions}));t.forEach(e=>{}),R.value=t};return s(()=>k.show,e=>{if(e&&(C.value=k.currentValue||"",(()=>{if(!k.availableTeachers.length||!k.editingRecord)return;const e=[],{editingRecord:t,editingField:a}=k,n=t.examDate,s=st(k.availableTeachers,n),i="examiner1_1"===a||"examiner1_2"===a||"backup1"===a,r="examiner1_1"===a||"examiner2_1"===a,l="examiner1_2"===a||"examiner2_2"===a,o="backup1"===a||"backup2"===a,d=t.recommendedExaminer1Dept,c=t.recommendedExaminer2Dept,u=e=>{if(!e||!k.availableTeachers)return"";const t=k.availableTeachers.find(t=>t.name===e);return t?G(t.department):""},p=t.examiner1_1,m=t.examiner2_1,h=t.examiner1_2,g=t.examiner2_2,v=u(p),f=u(m),y=u(h),x=u(g);fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SmartManualEditModal.vue:generateSmartRecommendations",message:"推荐生成入口参数",data:{totalTeachers:k.availableTeachers.length,enhancedTeachersCount:s.length,availableCount:s.filter(e=>e.available).length,editingField:a,studentDept:t.department,examDate:n,examiner1RecommendedDept:d||"未设置",examiner2RecommendedDept:c||"未设置",isExaminer1:r,isExaminer2:l,isBackup:o},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"A,B"})}).catch(()=>{}),s.forEach(a=>{if(!a.available)return;const u=[],p=[];let m=50;const h=G(a.department),g=G(t.department);if(s.indexOf(a)<5&&fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SmartManualEditModal.vue:teacherLoop",message:"科室规范化检查",data:{teacherName:a.name,rawTeacherDept:a.department,normalizedTeacherDept:h,rawStudentDept:t.department,normalizedStudentDept:g,available:a.available,group:a.group,shiftType:a.shiftType},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"A"})}).catch(()=>{}),r){const e=!("三"!==g&&"七"!==g||"三"!==h&&"七"!==h);if(h===g)u.push({type:"department_match",text:"✅ 与学员同科室（HC2要求）"}),m+=30;else{if(!e)return p.push({type:"department_mismatch",text:"❌ 不与学员同科室（违反HC2）"}),void(m=0);u.push({type:"department_match",text:"✅ 三七室互通（符合HC2）"}),m+=25}const n=i?y:x;if(n){const e=G(n);if(e&&h===e)return p.push({type:"department_mismatch",text:"❌ 与考官2同科室（违反HC7）"}),void(m=0)}const s=i?t.backup1:t.backup2;if(s&&a.name===s)return p.push({type:"same_person_conflict",text:"❌ 与备份考官是同一人（违反HC8）"}),void(m=0)}else if(l){if(h===g)return p.push({type:"department_mismatch",text:"❌ 与学员同科室（违反HC7）"}),void(m=0);u.push({type:"department_match",text:"✅ 与学员不同科室（HC7要求）"}),m+=20;const e=i?v:f;if(e){const t=G(e);if(t&&h===t)return p.push({type:"department_mismatch",text:"❌ 与考官1同科室（违反HC7）"}),void(m=0)}const n=i?t.backup1:t.backup2;if(n&&a.name===n)return p.push({type:"same_person_conflict",text:"❌ 与备份考官是同一人（违反HC8）"}),void(m=0);const s=G(i?d:c);if(s&&h===s?(u.push({type:"specialty_match",text:`✅ 来自推荐科室「${s}室」（SC2优先）`}),m+=35):s&&(p.push({type:"specialty_match",text:`ℹ️ 非推荐科室（推荐: ${s}室）`}),m-=10),!i&&y){const e=G(y),t=G(d),a=G(c);(e===t||e===a)&&(h!==e?(u.push({type:"specialty_match",text:`✅ 与Day1考官二「${e}室」不同（SC14优先）`}),m+=30):(p.push({type:"specialty_match",text:"⚠️ 与Day1考官二相同科室（建议换科室）"}),m-=15))}}else if(o){const e=i?t.examiner1_1:t.examiner2_1,n=i?t.examiner1_2:t.examiner2_2;if(e&&a.name===e)return p.push({type:"same_person_conflict",text:"❌ 与考官1是同一人（违反HC8）"}),void(m=0);if(n&&a.name===n)return p.push({type:"same_person_conflict",text:"❌ 与考官2是同一人（违反HC8）"}),void(m=0);const s=i?v:f;if(s){const e=G(s);if(e&&h===e)return p.push({type:"department_mismatch",text:"❌ 与考官1同科室（违反HC8b）"}),void(m=0)}const r=i?y:x;if(r){const e=G(r);if(e&&h===e)return p.push({type:"department_mismatch",text:"❌ 与考官2同科室（违反HC8b）"}),void(m=0)}h===g?(p.push({type:"department_mismatch",text:"❌ 与学员同科室（不推荐作为备份）"}),m-=20):(u.push({type:"department_match",text:"✅ 与学员不同科室（备份要求）"}),m+=15);const l=G(i?d:c);l&&h===l?(u.push({type:"specialty_match",text:`✅ 来自推荐科室「${l}室」（SC4优先）`}),m+=30):l&&u.push({type:"specialty_match",text:"ℹ️ 非推荐科室（可用）"})}if(k.allScheduleRecords&&k.allScheduleRecords.length>0){const e=k.allScheduleRecords.filter(e=>{if(e.id===t.id)return!1;const s=e.date1===n&&[e.examiner1_1,e.examiner2_1,e.backup1].includes(a.name),i=e.date2===n&&[e.examiner1_2,e.examiner2_2,e.backup2].includes(a.name),r=e.examDate===n&&[e.examiner1,e.examiner2,e.backup].includes(a.name);return s||i||r});if(e.length>0)return p.push({type:"daily_limit_exceeded",text:`❌ 当天已监考${e.length}场（违反HC4）`}),void(m=0)}if(it(a,n))return p.push({type:"white_shift_conflict",text:"❌ 白班执勤冲突（违反HC3）"}),void(m=0);const b=a.unavailableDates||a.unavailablePeriods;if(b&&b.length>0)try{const e=new Date(n+"T00:00:00");for(const t of b){if(!t.startDate||!t.endDate)continue;const a=new Date(t.startDate+"T00:00:00"),n=new Date(t.endDate+"T23:59:59");if(e>=a&&e<=n)return p.push({type:"unavailable_date",text:`❌ 考官不可用（违反HC9）：${t.reason||"不可用期"}`}),void(m=0)}}catch(S){}const w=a.currentWorkload||0;if(w<3?(u.push({type:"workload_balance",text:`📊 工作量轻（${w}次）`}),m+=10):w>=3&&w<=5?(u.push({type:"workload_balance",text:`📊 工作量适中（${w}次）`}),m+=5):w>5&&(p.push({type:"workload_high",text:`⚠️ 工作量较重（${w}次）`}),m-=5),a.group&&"无"!==a.group){const e="night"===a.shiftType?"晚班":"rest"===a.shiftType?"休息":"day"===a.shiftType?"白班":"未知";u.push({type:"group_info",text:`👥 ${a.group}（${e}）`})}else u.push({type:"group_info",text:"👥 行政班"});a.nightShiftPreferred&&(u.push({type:"night_shift_preferred",text:"✅ 晚班考官（SC1优先）"}),m+=15),"first"===a.restDayStatus?(u.push({type:"rest_day_optimal",text:"✅ 休息第一天（SC3优先）"}),m+=12):"second"===a.restDayStatus&&(u.push({type:"rest_day_optimal",text:"✅ 休息第二天（SC5优先）"}),m+=8);let D="low";m>=80?D="high":m>=60&&(D="medium"),e.push({teacher:a,score:Math.min(m,100),priority:D,reasons:u,warnings:p})});const b=e.sort((e,t)=>t.score-e.score).slice(0,5);b.forEach((e,t)=>{}),fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SmartManualEditModal.vue:generateSmartRecommendations:output",message:"推荐结果输出",data:{totalCandidates:e.length,filteredByAvailability:s.filter(e=>!e.available).length,topRecommendations:b.map(e=>({name:e.teacher.name,dept:e.teacher.department,score:e.score,priority:e.priority,reasons:e.reasons.map(e=>e.text).join(";"),warnings:e.warnings.map(e=>e.text).join(";")}))},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"C,D,E"})}).catch(()=>{}),P.value=b})(),C.value)){const e=k.availableTeachers.find(e=>e.name===C.value);e&&de(e)}}),s(C,e=>{if(e){const t=k.availableTeachers.find(t=>t.name===e);t&&de(t)}else R.value=[]}),(e,t)=>{var a,n,s,k,S,$,L;return e.show?(l(),i("div",{key:0,class:"modal-overlay smart-edit-overlay",onClick:W},[o("div",{class:"smart-edit-modal responsive-modal",onClick:t[2]||(t[2]=d(()=>{},["stop"]))},[o("div",lt,[o("div",ot,[o("div",dt,[o("h2",ct,[c(p(te),{class:"title-icon"}),t[5]||(t[5]=u(" 智能人工修改 ",-1))]),o("div",ut,[o("span",pt,[c(p(se),{class:"context-icon"}),u(" "+m(null==(a=e.editingRecord)?void 0:a.student),1)]),o("span",mt,[c(p(ge),{class:"context-icon"}),u(" "+m(D(null==(n=e.editingRecord)?void 0:n.department)),1)]),o("span",ht,[c(p(O),{class:"context-icon"}),u(" "+m((L=null==(s=e.editingRecord)?void 0:s.examDate,L?J.toDisplayDate(L):"")),1)])])]),o("button",{class:"modal-close touch-friendly",onClick:V},[c(p(ie),{class:"w-5 h-5"})])])]),o("div",gt,[o("div",vt,[o("div",ft,[o("div",yt,[o("span",xt,m(($=e.editingField,{examiner1_1:"第一天主考官1",examiner1_2:"第一天主考官2",backup1:"第一天备用考官",examiner2_1:"第二天主考官1",examiner2_2:"第二天主考官2",backup2:"第二天备用考官"}[$]||$)),1),o("span",{class:h(["field-type",ne(e.editingField)])},m(ae(e.editingField)),3)]),o("div",bt,[t[6]||(t[6]=o("span",{class:"label"},"当前值：",-1)),o("span",{class:h(["value",{empty:!j.value}])},m(j.value||"未分配"),3)])])]),P.value.length>0?(l(),i("div",wt,[o("div",Dt,[c(p(be),{class:"section-icon"}),t[7]||(t[7]=o("h3",{class:"section-title"},"智能推荐",-1)),o("span",kt,m(P.value.length)+"个建议",1)]),o("div",St,[(l(!0),i(g,null,v(P.value,(e,t)=>(l(),i("div",{key:t,class:h(["recommendation-item",{selected:C.value===e.teacher.name,"priority-high":"high"===e.priority,"priority-medium":"medium"===e.priority,"priority-low":"low"===e.priority}]),onClick:t=>(e=>{A.value=e.teacher,de(e.teacher),M.value=!0})(e)},[o("div",Ct,[o("div",Et,[o("span",_t,m(e.teacher.name),1),o("span",Tt,m(D(e.teacher.department)),1)]),o("div",It,[o("div",Pt,[o("div",{class:"score-fill",style:x({width:e.score+"%"})},null,4)]),o("span",Rt,m(e.score)+"%",1)])]),o("div",Mt,[(l(!0),i(g,null,v(e.reasons,e=>{return l(),i("div",{key:e.type,class:h(["reason-tag",e.type])},[(l(),b(w((t=e.type,{department_match:ge,workload_balance:oe,specialty_match:he,night_shift_preferred:fe,rest_day_optimal:ke,availability:le,experience:De,performance:Se,efficiency:Ce}[t]||ke)),{class:"reason-icon"})),o("span",null,m(e.text),1)],2);var t}),128))]),e.warnings.length>0?(l(),i("div",At,[(l(!0),i(g,null,v(e.warnings,e=>(l(),i("div",{key:e.type,class:"warning-item"},[c(p($e),{class:"warning-icon"}),o("span",null,m(e.text),1)]))),128))])):r("",!0)],10,$t))),128))])])):r("",!0),R.value.length>0?(l(),i("div",Ot,[o("div",Nt,[c(p(Z),{class:"section-icon text-red-500"}),t[8]||(t[8]=o("h3",{class:"section-title text-red-600"},"冲突检测",-1)),o("span",zt,m(R.value.length)+"个冲突",1)]),o("div",jt,[(l(!0),i(g,null,v(R.value,(e,a)=>{return l(),i("div",{key:a,class:h(["conflict-item",e.severity])},[o("div",Ft,[(l(),b(w((n=e.type,{schedule_conflict:O,workload_overload:oe,department_rule:ge,availability:fe,constraint_violation:De}[n]||$e)),{class:"conflict-icon"})),o("span",Lt,m(e.title),1),o("span",Ut,m(e.severity),1)]),o("p",Bt,m(e.description),1),e.suggestions.length>0?(l(),i("div",Ht,[t[9]||(t[9]=o("span",{class:"suggestions-label"},"建议：",-1)),o("ul",Wt,[(l(!0),i(g,null,v(e.suggestions,e=>(l(),i("li",{key:e},m(e),1))),128))])])):r("",!0)],2);var n}),128))])])):r("",!0),o("div",Vt,[o("div",qt,[c(p(N),{class:"section-icon"}),t[10]||(t[10]=o("h3",{class:"section-title"},"手动选择",-1)),o("button",{class:"toggle-all-btn",onClick:t[0]||(t[0]=e=>I.value=!I.value)},m(I.value?"显示推荐":"显示全部"),1)]),o("div",Jt,[c(p(re),{class:"search-icon"}),f(o("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>T.value=e),type:"text",placeholder:"搜索考官姓名或科室...",class:"search-input"},null,512),[[y,T.value]])]),o("div",Gt,[(l(!0),i(g,null,v(F.value,e=>(l(),i("div",{key:e.id,class:h(["teacher-card",{selected:C.value===e.name,unavailable:!e.available,recommended:ee(e)}]),onClick:t=>(e=>{(e.available||ee(e))&&(A.value=e,de(e),M.value=!0)})(e)},[o("div",Xt,[o("span",Kt,m(e.name),1),o("div",Zt,[e.available?(l(),i("span",Qt," 可用 ")):(l(),i("span",ea," 不可用 ")),ee(e)?(l(),i("span",ta," 推荐 ")):r("",!0)])]),o("div",aa,[o("span",na,m(D(e.department)),1),o("span",sa,"工作量: "+m(e.currentWorkload||0),1)]),e.conflictInfo?(l(),i("div",ia,[c(p($e),{class:"conflict-icon-small"}),o("span",ra,m(e.conflictInfo),1)])):r("",!0)],10,Yt))),128))])]),t[11]||(t[11]=o("div",{class:"selection-hint"},[o("div",{class:"hint-icon"},"💡"),o("div",{class:"hint-text"},[o("strong",null,"操作提示："),u("点击推荐考官或手动选择考官后，将弹出修改原因窗口 ")])],-1))]),o("div",{class:"modal-footer"},[o("button",{class:"action-btn secondary-btn mobile-btn",onClick:V},"关闭")])]),M.value?(l(),i("div",{key:0,class:"reason-dialog-overlay",onClick:X},[o("div",{class:"reason-dialog",onClick:t[4]||(t[4]=d(()=>{},["stop"]))},[o("div",la,[o("h3",oa,[c(p(B),{class:"title-icon"}),t[12]||(t[12]=u(" 填写修改原因 ",-1))]),o("button",{class:"dialog-close",onClick:X},[c(p(ie),{class:"w-5 h-5"})])]),o("div",da,[o("div",ca,[t[13]||(t[13]=o("div",{class:"info-label"},"已选择考官",-1)),o("div",ua,[o("div",pa,m(null==(k=A.value)?void 0:k.name),1),o("div",ma,m(D(null==(S=A.value)?void 0:S.department)),1)])]),R.value.length>0?(l(),i("div",ha,[U.value?(l(),i("div",ga,[c(p(Z),{class:"alert-icon"}),t[14]||(t[14]=o("div",null,[o("div",{class:"alert-title"},"⚠️ 硬约束违反警告"),o("div",{class:"alert-desc"},[u(" 检测到硬约束冲突，但"),o("strong",{style:{color:"#ef4444"}},"人工修改权限最高"),u("。"),o("br"),u(" 您可以选择强制保存（将标记为红色）或重新选择考官。 ")])],-1))])):H.value?(l(),i("div",va,[c(p($e),{class:"alert-icon"}),o("div",null,[t[15]||(t[15]=o("div",{class:"alert-title"},"存在软约束提示",-1)),t[16]||(t[16]=o("div",{class:"alert-desc"},"建议考虑以下问题：",-1)),o("ul",fa,[(l(!0),i(g,null,v(R.value,e=>(l(),i("li",{key:e.type},m(e.title),1))),128))])])])):r("",!0)])):r("",!0),o("div",ya,[t[17]||(t[17]=o("div",{class:"info-label"},[u(" 修改原因 "),o("span",{class:"required-indicator"},"*")],-1)),o("div",xa,[(l(),i(g,null,v(z,e=>o("button",{key:e,class:h(["reason-tag-btn-dialog",{selected:E.value===e}]),onClick:t=>(e=>{E.value=E.value===e?"":e})(e)},m(e),11,ba)),64))])]),o("div",wa,[t[18]||(t[18]=o("div",{class:"info-label"},"详细说明",-1)),f(o("textarea",{"onUpdate:modelValue":t[3]||(t[3]=e=>_.value=e),placeholder:"请详细说明人工修改的具体原因...",class:"reason-textarea-dialog",rows:"4"},null,512),[[y,_.value]])])]),o("div",Da,[o("button",{class:"dialog-btn cancel-btn",onClick:X},"取消"),o("button",{class:"dialog-btn confirm-btn",onClick:q,disabled:!E.value&&!_.value.trim()},[U.value?(l(),i(g,{key:0},[u(" ⚡ 强制修改 ")],64)):H.value?(l(),i(g,{key:1},[u(" ⚠️ 强制确认 ")],64)):(l(),i(g,{key:2},[u(" ✅ 确认修改 ")],64))],8,ka)])])])):r("",!0)])):r("",!0)}}}),[["__scopeId","data-v-2ef05547"]]);var $a=Object.defineProperty,Ca=(e,t,a)=>((e,t,a)=>t in e?$a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a);const Ea=new class{constructor(){Ca(this,"baseUrl",""),Ca(this,"initialized",!1),Ca(this,"cache",[]),Ca(this,"lastFetchTime",0),Ca(this,"CACHE_TTL",5e3)}async initializeBaseUrl(){if(this.initialized)return;const e=window.electronAPI;if(e&&e.isElectron)return new Promise(t=>{e.getBackendPort().then(e=>{if(e>0)return this.baseUrl=`http://127.0.0.1:${e}`,this.initialized=!0,void t()}).catch(()=>{}),e.onBackendReady(async()=>{try{const t=await e.getBackendPort();this.baseUrl=`http://127.0.0.1:${t}`}catch(a){this.baseUrl=""}this.initialized=!0,t()})});this.baseUrl="",this.initialized=!0}async ensureInitialized(){this.initialized||await this.initializeBaseUrl()}async getRecentLogs(e=100,t="ALL",a=!0){await this.ensureInitialized();const n=Date.now();if(a&&this.cache.length>0&&n-this.lastFetchTime<this.CACHE_TTL)return this.cache.slice(0,e);try{const a=`${this.baseUrl}/api/logs/recent?limit=${e}&level=${t}`,s=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(1e4)});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const i=await s.json();if(!i.success)throw new Error(i.error||"获取日志失败");return this.cache=i.logs||[],this.lastFetchTime=n,this.cache}catch(s){return s instanceof Error&&s.message.includes("404"),this.cache.length>0?this.cache:[]}}async getLogInfo(){await this.ensureInitialized();try{const e=`${this.baseUrl}/api/logs/info`,t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.json()}catch(e){return{success:!1,logFile:"unknown",exists:!1,error:e instanceof Error?e.message:"未知错误"}}}async cleanupLogs(e=7){await this.ensureInitialized();try{const t=`${this.baseUrl}/api/logs/cleanup?days=${e}`,a=await fetch(t,{method:"DELETE",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(3e4)});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return await a.json()}catch(t){return{success:!1,message:t instanceof Error?t.message:"清理日志失败",deletedFiles:0}}}clearCache(){this.cache=[],this.lastFetchTime=0}getFallbackLogs(){const e=(new Date).toTimeString().substring(0,8);return[{time:e,message:"⚠️ 无法连接到后端日志服务，显示模拟数据",type:"warning"},{time:e,message:"📡 正在尝试重新连接后端服务...",type:"info"},{time:e,message:"🔧 请检查后端服务是否正常运行",type:"info"}]}startRealtimeLogging(e,t=2e3,a=50){let n=!0;const s=async()=>{if(n){try{const t=await this.getRecentLogs(a,"ALL",!1);e(t)}catch(i){}n&&setTimeout(s,t)}};return s(),()=>{n=!1}}formatLogMessage(e){return e.replace(/\x1b\[[0-9;]*m/g,"")}getLogIcon(e){switch(e){case"success":return"✅";case"error":return"❌";case"warning":return"⚠️";default:return"ℹ️"}}getLogColorClass(e){switch(e){case"success":return"text-green-400";case"error":return"text-red-400";case"warning":return"text-yellow-400";default:return"text-blue-400"}}},_a=Object.freeze(Object.defineProperty({__proto__:null,default:Ea,logService:Ea},Symbol.toStringTag,{value:"Module"}));var Ta=Object.defineProperty,Ia=(e,t,a)=>((e,t,a)=>t in e?Ta(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a);const Pa=new class{constructor(){Ia(this,"isDev"),Ia(this,"logHistory",[]),Ia(this,"maxHistorySize",1e3),this.isDev=!1}formatMessage(e,t,a){const n=a?`[${a}]`:"";return`${(new Date).toISOString()} ${e.toUpperCase()} ${n} ${t}`}addToHistory(e){this.logHistory.push(e),this.logHistory.length>this.maxHistorySize&&this.logHistory.shift()}devLog(e,t,a,n){this.formatMessage(e,t,a);const s={level:e,message:t,context:a,timestamp:new Date,data:n};this.addToHistory(s)}prodLog(e,t,a,n){const s={level:e,message:t,context:a,timestamp:new Date,data:n};this.addToHistory(s)}log(e,t,a,n){this.isDev?this.devLog(e,t,a,n):this.prodLog(e,t,a,n)}debug(e,t,a){this.log("debug",e,t,a)}info(e,t,a){this.log("info",e,t,a)}warn(e,t,a){this.log("warn",e,t,a)}error(e,t,a){this.log("error",e,t,a)}getHistory(e){return e?this.logHistory.filter(t=>t.level===e):[...this.logHistory]}clearHistory(){this.logHistory=[]}exportLogs(){return JSON.stringify(this.logHistory,null,2)}},Ra={class:"aviation-loader-container"},Ma={class:"main-content"},Aa={class:"progress-info"},Oa={class:"progress-title"},Na={class:"progress-percentage-large"},za={class:"linear-progress-container"},ja={class:"linear-progress-bar"},Fa={class:"assignment-stats"},La={class:"stat-item"},Ua={class:"stat-number"},Ba={class:"stat-total"},Ha={class:"status-message"},Wa={class:"message-line"},Va={key:0,class:"score-info"},qa={class:"score-item"},Ja={class:"score-item"},Ga={class:"score-value"},Ya={class:"info-panels"},Xa={class:"panel-icon"},Ka={class:"panel-content"},Za={class:"panel-value"},Qa={class:"panel-label"},en={key:0,class:"logs-container"},tn={class:"logs-list",ref:"logsContainerRef"},an={class:"log-time"},nn={class:"log-message"},sn={key:0,class:"completion-overlay"},rn={class:"completion-content"},ln={class:"final-stats"},on={class:"final-stat-card"},dn={class:"stat-card-content"},cn={class:"stat-card-value"},un={class:"final-stat-card"},pn={class:"stat-card-content"},mn={class:"stat-card-value"},hn={class:"stat-card-content"},gn={class:"stat-card-value"},vn={class:"final-stat-card"},fn={class:"stat-card-content"},yn={class:"stat-card-value"},xn={class:"completion-actions"},bn=z(t({__name:"AviationSchedulingLoader",props:{progress:{default:0},statusMessage:{default:"正在初始化排班系统..."},currentAssignments:{default:0},totalAssignments:{default:100},hardScore:{default:void 0},softScore:{default:void 0},realtimeLogs:{default:()=>[]},isCompleted:{type:Boolean,default:!1},finalStatistics:{default:()=>({})}},emits:["close","viewResult"],setup(e,{emit:t}){const d=e,p=n(()=>d.progress<10?"🛫 起飞准备中":d.progress<30?"📡 航线规划中":d.progress<50?"✈️ 航班调度中":d.progress<70?"🎯 优化排班方案":d.progress<90?"📋 完善排班细节":"🏁 即将完成"),f=n(()=>void 0!==d.hardScore||void 0!==d.softScore),y=n(()=>void 0===d.softScore||null===d.softScore?"0":Math.abs(d.softScore).toLocaleString()),b=n(()=>{var e;const t=null==(e=d.finalStatistics)?void 0:e.softConstraintScore;return null==t?"0":Math.abs(t).toLocaleString()}),w=n(()=>{const e=d.progress||0;return e%1==0?Math.round(e):Math.round(10*e)/10}),C=n(()=>{return[{icon:"👨‍✈️",value:d.currentAssignments,label:"已分配"},{icon:"📊",value:(e=d.progress||0,(e%1==0?Math.round(e):Math.round(10*e)/10)+"%"),label:"完成度"},{icon:"⚡",value:0===d.hardScore?"优秀":"计算中",label:"约束状态"}];var e}),E=a([]),_=a(null),T=n(()=>{const e=d.realtimeLogs||[],t=E.value||[];return e.length>0?e.slice(-20):t.slice(-20)}),I=async()=>{try{const e=await Ea.getRecentLogs(20,"INFO");e&&e.length>0&&(E.value=e.map(e=>{var t;return{time:e.timestamp||e.time||(new Date).toISOString(),message:e.message||"",type:(null==(t=e.level)?void 0:t.toLowerCase())||"info"}}))}catch(e){}},P=()=>{_.value&&(clearInterval(_.value),_.value=null)};return D(()=>{I(),_.value=window.setInterval(()=>{d.realtimeLogs&&0!==d.realtimeLogs.length||I()},5e3),Pa.debug("性能优化加载器已启动","Performance")}),s(()=>d.isCompleted,e=>{e&&(Pa.debug("排班完成，停止日志轮询","Performance"),P())}),k(()=>{Pa.debug("加载器卸载，清理资源","Cleanup"),P()}),(e,t)=>(l(),i("div",Ra,[o("div",Ma,[t[6]||(t[6]=o("div",{class:"simple-icon-container"},[o("svg",{class:"spinning-loader",viewBox:"0 0 24 24",width:"80",height:"80"},[o("path",{fill:"currentColor",d:"M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"})])],-1)),o("div",Aa,[o("div",Oa,[o("h2",null,m(p.value),1)]),o("div",Na,m(w.value)+"%",1),o("div",za,[o("div",ja,[o("div",{class:"linear-progress-fill",style:x({width:e.progress+"%"})},null,4)])]),o("div",Fa,[o("div",La,[o("span",Ua,m(e.currentAssignments),1),t[1]||(t[1]=o("span",{class:"stat-separator"},"/",-1)),o("span",Ba,m(e.totalAssignments),1)]),t[2]||(t[2]=o("div",{class:"stat-description"},"已分配考试",-1))]),o("div",Ha,[o("div",Wa,m(e.statusMessage),1),f.value?(l(),i("div",Va,[o("span",qa,[t[3]||(t[3]=o("span",{class:"score-label"},"硬约束:",-1)),o("span",{class:h(["score-value",{"score-good":0===e.hardScore}])},m(e.hardScore),3)]),o("span",Ja,[t[4]||(t[4]=o("span",{class:"score-label"},"软约束:",-1)),o("span",Ga,m(y.value),1)])])):r("",!0)])]),o("div",Ya,[(l(!0),i(g,null,v(C.value,(e,t)=>(l(),i("div",{class:"info-panel",key:t},[o("div",Xa,m(e.icon),1),o("div",Ka,[o("div",Za,m(e.value),1),o("div",Qa,m(e.label),1)])]))),128))]),e.realtimeLogs.length>0?(l(),i("div",en,[t[5]||(t[5]=o("div",{class:"logs-title"},"实时日志",-1)),o("div",tn,[(l(!0),i(g,null,v(T.value,(e,t)=>(l(),i("div",{key:t,class:h(["log-entry",`log-${e.type}`])},[o("span",an,"["+m(e.time)+"]",1),o("span",nn,m(e.message),1)],2))),128))],512)])):r("",!0)]),c($,{name:"completion-fade"},{default:S(()=>[e.isCompleted?(l(),i("div",sn,[o("div",rn,[t[16]||(t[16]=o("div",{class:"success-icon-container"},[o("svg",{class:"success-icon",viewBox:"0 0 24 24",width:"80",height:"80"},[o("circle",{class:"success-circle",cx:"12",cy:"12",r:"10"}),o("path",{class:"success-check",d:"M7,12L10,15L17,8"})])],-1)),t[17]||(t[17]=o("h2",{class:"completion-title"},"✈️ 排班计算完成！",-1)),t[18]||(t[18]=o("p",{class:"completion-subtitle"},"系统已为您生成最优排班方案",-1)),o("div",ln,[o("div",on,[t[8]||(t[8]=o("div",{class:"stat-card-icon"},"👥",-1)),o("div",dn,[o("div",cn,m(e.finalStatistics.assignedStudents||0)+" / "+m(e.finalStatistics.totalStudents||0),1),t[7]||(t[7]=o("div",{class:"stat-card-label"},"学员分配",-1))])]),o("div",un,[t[10]||(t[10]=o("div",{class:"stat-card-icon"},"📊",-1)),o("div",pn,[o("div",mn,m((e.finalStatistics.completionRate||0).toFixed(1))+"% ",1),t[9]||(t[9]=o("div",{class:"stat-card-label"},"完成率",-1))])]),o("div",{class:h(["final-stat-card",{"stat-success":0===e.finalStatistics.hardConstraintScore}])},[t[12]||(t[12]=o("div",{class:"stat-card-icon"},"⚡",-1)),o("div",hn,[o("div",gn,m(e.finalStatistics.hardConstraintScore||0),1),t[11]||(t[11]=o("div",{class:"stat-card-label"},"硬约束",-1))])],2),o("div",vn,[t[14]||(t[14]=o("div",{class:"stat-card-icon"},"🎯",-1)),o("div",fn,[o("div",yn,m(b.value),1),t[13]||(t[13]=o("div",{class:"stat-card-label"},"软约束",-1))])])]),o("div",xn,[o("button",{class:"view-result-btn",onClick:t[0]||(t[0]=t=>e.$emit("viewResult"))},[...t[15]||(t[15]=[o("svg",{viewBox:"0 0 24 24",width:"20",height:"20"},[o("path",{fill:"currentColor",d:"M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"})],-1),u(" 查看排班结果 ",-1)])])])])])):r("",!0)]),_:1})]))}}),[["__scopeId","data-v-310b8baf"]]);var wn=Object.defineProperty,Dn=(e,t,a)=>((e,t,a)=>t in e?wn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a);const kn=new class{constructor(){Dn(this,"constraintConfig",null),Dn(this,"teacherPerformanceData",new Map),Dn(this,"workloadCache",new Map)}setConstraintConfig(e){this.constraintConfig=e}updateWorkloadCache(e,t){this.workloadCache.set(e,t)}async generateRecommendations(e,t,a={}){const{maxRecommendations:n=5,includeUnavailable:s=!1,prioritizeExperience:i=!0,balanceWorkload:r=!0,respectPreferences:l=!0,strictDepartmentMatch:o=!1}=a;let d=s?t:t.filter(t=>this.isTeacherAvailable(t,e));const c=[];for(const u of d){const t=await this.evaluateTeacher(u,e,{prioritizeExperience:i,balanceWorkload:r,respectPreferences:l,strictDepartmentMatch:o});t.score>30&&c.push(t)}return c.sort((e,t)=>t.score-e.score).slice(0,n)}async detectConflicts(e,t){var a;const n=[];this.isTeacherAvailable(e,t)||n.push({type:"availability",severity:"high",title:"考官不可用",description:`${e.name}在${t.examDate}不可用`,suggestions:["选择其他可用考官","调整考试时间","联系考官确认可用性"],autoResolvable:!1});const s=this.workloadCache.get(e.id)||0;s>6&&n.push({type:"workload_overload",severity:"medium",title:"工作量过载",description:`${e.name}当前工作量为${s}，超过建议上限`,suggestions:["考虑工作量较轻的考官","重新分配现有工作","申请增加考官资源"],autoResolvable:!0,resolutionSteps:["分析考官当前排班","识别可调整的排班","重新分配工作量"]}),(null==(a=this.constraintConfig)?void 0:a.softConstraints.examiner1SameDept)&&e.department!==t.studentInfo.department&&t.editingField.includes("examiner")&&n.push({type:"department_rule",severity:"low",title:"科室匹配规则",description:`${e.name}来自${e.department}，与学员科室${t.studentInfo.department}不匹配`,suggestions:["优先选择同科室考官","确认跨科室安排的合理性","获取科室主任批准"],autoResolvable:!0,resolutionSteps:["搜索同科室可用考官","评估跨科室安排的影响","记录特殊安排原因"]});const i=await this.checkScheduleConflict(e,t);i&&n.push(i);const r=await this.checkConstraintViolations(e,t);return n.push(...r),n}async getManualEditSuggestions(e,t){const a=await this.generateRecommendations(e,t),n=a.filter(e=>"high"===e.priority&&0===e.warnings.length),s=a.filter(e=>"high"!==e.priority||e.warnings.length>0),i=this.generateInsights(e,a);return{quickFixes:n.slice(0,3),alternatives:s.slice(0,5),insights:i}}async evaluateTeacher(e,t,a){const n=[],s=[];let i=50,r=.7;this.isTeacherAvailable(e,t)?(n.push({type:"availability",text:"时间可用",weight:10,impact:"positive"}),i+=10,r+=.1):(s.push({type:"availability_conflict",text:"时间冲突",severity:"high"}),i-=20,r-=.2);const l=t.editingField.includes("examiner1"),o=t.editingField.includes("examiner2"),d=t.editingField.includes("backup"),c=G(t.studentInfo.department),u=G(e.department),p=c===u;if(l)if(p)n.push({type:"department_match",text:"科室匹配 (HC2)",weight:50,impact:"positive"}),i+=50,r+=.3;else{"三"===c&&"七"===u||"七"===c&&"三"===u?(n.push({type:"department_match",text:"三七室互通 (HC2)",weight:40,impact:"positive"}),i+=40,r+=.2):(s.push({type:"constraint_violation",text:"HC2硬约束违反：考官1需同科室",severity:"high"}),i-=100)}else if(o)p?(s.push({type:"constraint_violation",text:"HC7硬约束违反：考官2需不同科室",severity:"high"}),i-=100):(n.push({type:"department_match",text:"科室合规 (HC7)",weight:5,impact:"positive"}),i+=5);else if(d)p&&(s.push({type:"constraint_violation",text:"建议备份考官来自不同科室",severity:"medium"}),i-=30);else if(p)n.push({type:"department_match",text:"科室完全匹配",weight:20,impact:"positive"}),i+=20,r+=.15;else{this.getRelatedDepartments(e.department).some(e=>G(e)===c)?(n.push({type:"department_match",text:"相关科室",weight:10,impact:"positive"}),i+=10):a.strictDepartmentMatch&&(s.push({type:"department_mismatch",text:"科室不匹配",severity:"medium"}),i-=15)}const m=this.workloadCache.get(e.id)||0;if(a.balanceWorkload&&(m<3?(n.push({type:"workload_balance",text:"工作量较轻",weight:15,impact:"positive"}),i+=15):m>5&&(s.push({type:"workload_high",text:`当前工作量${m}较重`,severity:"medium"}),i-=10)),"day2"===t.scheduleContext.timeSlot&&e.nightShiftPreferred&&(n.push({type:"night_shift_preferred",text:"偏好夜班时间",weight:12,impact:"positive"}),i+=12),a.prioritizeExperience){const t=this.getTeacherExperience(e);t>5&&(n.push({type:"experience",text:`${t}年经验`,weight:10,impact:"positive"}),i+=10,r+=.05)}const h=this.getTeacherPerformance(e);h>.8?(n.push({type:"performance",text:"表现优异",weight:8,impact:"positive"}),i+=8):h<.6&&(s.push({type:"performance_issue",text:"表现需要改进",severity:"low"}),i-=5);let g="low";return i>=80&&0===s.length?g="high":i>=60&&(g="medium"),{teacher:e,score:Math.min(Math.max(i,0),100),priority:g,reasons:n,warnings:s,confidence:Math.min(Math.max(r,0),1)}}isTeacherAvailable(e,t){if(!e.available)return!1;const a=e.unavailableDates||e.unavailablePeriods;if(a&&a.length>0)try{const e=new Date(t.examDate+"T00:00:00");for(const t of a){if(!t.startDate||!t.endDate)continue;const a=new Date(t.startDate+"T00:00:00"),n=new Date(t.endDate+"T23:59:59");if(e>=a&&e<=n)return!1}}catch(n){}try{const a=new Date(t.examDate).getDay(),n=0===a||6===a,s=!e.group||"无"===e.group||""===e.group.trim();if(n&&s)return!1}catch(n){}return!t.scheduleContext.existingAssignments.find(a=>a.examDate===t.examDate&&(a.examiner1_1===e.name||a.examiner1_2===e.name||a.backup1===e.name||a.examiner2_1===e.name||a.examiner2_2===e.name||a.backup2===e.name))}async checkScheduleConflict(e,t){return t.scheduleContext.existingAssignments.filter(a=>a.examDate===t.examDate&&a.student!==t.studentInfo.name&&(a.examiner1_1===e.name||a.examiner1_2===e.name||a.backup1===e.name||a.examiner2_1===e.name||a.examiner2_2===e.name||a.backup2===e.name)).length>0?{type:"schedule_conflict",severity:"high",title:"时间冲突",description:`${e.name}在${t.examDate}已有其他考试安排`,suggestions:["选择其他时间可用的考官","调整冲突考试的时间","重新安排考官分配"],autoResolvable:!0,resolutionSteps:["识别冲突的考试安排","评估调整的可行性","执行时间重排"]}:null}async checkConstraintViolations(e,t){const a=[];return this.constraintConfig?(this.constraintConfig.softConstraints.examiner1SameDept&&t.editingField.includes("examiner1")&&e.department!==t.studentInfo.department&&a.push({type:"constraint_violation",severity:"medium",title:"科室匹配约束违规",description:"主考官应与学员同科室",suggestions:["选择同科室考官","调整约束配置","记录违规原因"],autoResolvable:!1}),!this.constraintConfig.softConstraints.allowDept37CrossUse||"三室"!==e.department&&"七室"!==e.department||"三室"!==t.studentInfo.department&&"七室"!==t.studentInfo.department||a.push({type:"constraint_violation",severity:"low",title:"备用考官科室约束违规",description:"备用考官应来自不同科室",suggestions:["选择其他科室考官","调整约束权重","确认特殊情况"],autoResolvable:!0,resolutionSteps:["搜索其他科室可用考官","评估违规影响","记录决策依据"]}),a):a}getRelatedDepartments(e){return{"内科":["心内科","消化科","呼吸科","内分泌科"],"外科":["普外科","骨科","泌尿外科","神经外科"],"妇产科":["妇科","产科"],"儿科":["新生儿科","儿童保健科"]}[e]||[]}getTeacherExperience(e){return 3}getTeacherPerformance(e){const t=this.teacherPerformanceData.get(e.id);return(null==t?void 0:t.averageScore)||.75}generateInsights(e,t){const a=[],n=t.filter(e=>e.score>80);0===n.length?a.push("当前没有高质量推荐，建议调整约束条件或考试时间"):1===n.length&&a.push(`${n[0].teacher.name}是最佳选择，匹配度${n[0].score}%`);const s=t.reduce((e,t)=>(e[t.teacher.department]=(e[t.teacher.department]||0)+1,e),{})[e.studentInfo.department]||0;0===s?a.push("没有同科室考官可用，建议确认跨科室安排的合理性"):s>3&&a.push("同科室考官选择较多，建议优先考虑工作量平衡");if(t.reduce((e,t)=>e+(this.workloadCache.get(t.teacher.id)||0),0)/t.length>5&&a.push("推荐考官工作量普遍较重，建议考虑工作量重新分配"),"day2"===e.scheduleContext.timeSlot){const e=t.filter(e=>e.teacher.nightShiftPreferred).length;e>0?a.push(`有${e}位考官偏好夜班时间，建议优先考虑`):a.push("没有考官偏好夜班时间，可能需要额外协调")}return a}};var Sn=Object.defineProperty,$n=(e,t,a)=>((e,t,a)=>t in e?Sn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,t+"",a);const Cn=new class{constructor(){$n(this,"baseUrl","/data")}async getAllTeachers(){return(await H.get(`${this.baseUrl}/teachers`)).data}async getTeachersByDepartment(e){return(await H.get(`${this.baseUrl}/teachers/department/${e}`)).data}async saveTeacher(e){if(e.id){return(await H.put(`${this.baseUrl}/teachers/${e.id}`,e)).data}return(await H.post(`${this.baseUrl}/teachers`,e)).data}async deleteTeacher(e){await H.delete(`${this.baseUrl}/teachers/${e}`)}async importTeachers(e){return(await H.post(`${this.baseUrl}/teachers/import`,e)).data}async getAllStudents(){return(await H.get(`${this.baseUrl}/students`)).data}async getStudentsByDepartment(e){return(await H.get(`${this.baseUrl}/students/department/${e}`)).data}async saveStudent(e){if(e.id){return(await H.put(`${this.baseUrl}/students/${e.id}`,e)).data}return(await H.post(`${this.baseUrl}/students`,e)).data}async deleteStudent(e){await H.delete(`${this.baseUrl}/students/${e}`)}async importStudents(e){return(await H.post(`${this.baseUrl}/students/import`,e)).data}async getAllDepartments(){return(await H.get(`${this.baseUrl}/departments`)).data}async getAllGroups(){return(await H.get(`${this.baseUrl}/groups`)).data}async getAllTimeSlots(){return(await H.get(`${this.baseUrl}/timeslots`)).data}async getDutySchedules(e,t){return(await H.get(`${this.baseUrl}/duties?startDate=${e}&endDate=${t}`)).data}async importDutySchedules(e){return(await H.post(`${this.baseUrl}/duties/import`,e)).data}async getAllAssignments(){return(await H.get(`${this.baseUrl}/assignments`)).data}async getAssignmentsByStudent(e){return(await H.get(`${this.baseUrl}/assignments/student/${e}`)).data}async getStatistics(){return(await H.get(`${this.baseUrl}/statistics`)).data}async exportTeachersAsDomainObjects(){return(await H.get(`${this.baseUrl}/export/teachers`)).data}async exportStudentsAsDomainObjects(){return(await H.get(`${this.baseUrl}/export/students`)).data}},En={class:"modal-header"},_n={class:"header-content"},Tn={class:"error-icon"},In={class:"header-text"},Pn={class:"modal-title"},Rn={class:"error-summary"},Mn={class:"modal-body"},An={key:0,class:"conflict-statistics"},On={class:"stats-grid"},Nn={key:0,class:"stat-item critical"},zn={class:"stat-value"},jn={key:1,class:"stat-item high"},Fn={class:"stat-value"},Ln={key:2,class:"stat-item medium"},Un={class:"stat-value"},Bn={key:3,class:"stat-item low"},Hn={class:"stat-value"},Wn={key:1,class:"conflicts-section"},Vn={class:"conflicts-list"},qn={class:"conflict-header"},Jn={class:"conflict-info"},Gn={class:"conflict-icon"},Yn={class:"conflict-type"},Xn={class:"conflict-severity"},Kn=["onClick"],Zn={class:"conflict-description"},Qn={key:0,class:"conflict-details"},es={key:0,class:"affected-entities"},ts={key:1,class:"suggested-solutions"},as={key:2,class:"auto-resolve"},ns=["onClick"],ss={class:"general-suggestions"},is={class:"suggestions-list"},rs={class:"suggestion-header"},ls={class:"suggestion-icon"},os={class:"suggestion-title"},ds={class:"suggestion-description"},cs={key:0,class:"suggestion-actions"},us=["onClick"],ps=z(t({__name:"EnhancedErrorFeedbackModal",props:{visible:{type:Boolean,default:!1},errorType:{default:"system_error"},errorMessage:{default:""},conflicts:{default:()=>[]}},emits:["close","autoResolve","executeAction","exportReport"],setup(e,{emit:t}){const c=e,p=t,f=a(new Set),y=n(()=>0===c.conflicts.length?c.errorMessage||"系统遇到了一个错误":`检测到 ${c.conflicts.length} 个冲突，需要您的注意`),x=n(()=>{const e={critical:0,high:0,medium:0,low:0};return c.conflicts.forEach(t=>{switch(t.severity){case"CRITICAL":e.critical++;break;case"HIGH":e.high++;break;case"MEDIUM":e.medium++;break;case"LOW":e.low++}}),e}),D=n(()=>{const e={CRITICAL:4,HIGH:3,MEDIUM:2,LOW:1};return[...c.conflicts].sort((t,a)=>e[a.severity]-e[t.severity])}),k=n(()=>{const e=[];return"constraint_violation"===c.errorType&&e.push({title:"调整约束配置",icon:"⚙️",description:"考虑放宽部分软约束的权重，或临时禁用某些非关键约束",actions:[{label:"打开约束配置",action:"open_constraint_config"},{label:"重置为默认配置",action:"reset_constraints"}]}),"resource_shortage"===c.errorType&&e.push({title:"增加资源配置",icon:"👥",description:"检查考官数量和可用时间段，考虑增加备用考官或扩展时间范围",actions:[{label:"查看考官配置",action:"view_teachers"},{label:"扩展时间范围",action:"extend_time_range"}]}),e.push({title:"联系技术支持",icon:"🛠️",description:"如果问题持续存在，请联系系统管理员获取专业技术支持",actions:[{label:"生成支持报告",action:"generate_support_report"}]}),e}),S=e=>({CRITICAL:"严重",HIGH:"高",MEDIUM:"中",LOW:"低"}[e]||e),$=()=>{const e={timestamp:(new Date).toISOString(),errorType:c.errorType,errorMessage:c.errorMessage,conflicts:c.conflicts,conflictStats:x.value};p("exportReport",e)},C=()=>{f.value.clear(),p("close")};return s(()=>c.visible,e=>{e||f.value.clear()}),(e,t)=>e.visible?(l(),i("div",{key:0,class:"error-feedback-modal-overlay",onClick:C},[o("div",{class:"error-feedback-modal",onClick:t[0]||(t[0]=d(()=>{},["stop"]))},[o("div",En,[o("div",_n,[o("div",Tn,[(l(),b(w({constraint_violation:"AlertTriangle",resource_shortage:"Users",system_error:"XCircle",validation_error:"AlertCircle"}[c.errorType]||"AlertCircle")))]),o("div",In,[o("h3",Pn,m({constraint_violation:"约束冲突检测",resource_shortage:"资源不足警告",system_error:"系统错误",validation_error:"数据验证错误"}[c.errorType]||"系统提示"),1),o("p",Rn,m(y.value),1)])]),o("button",{class:"close-button",onClick:C},[...t[1]||(t[1]=[o("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none"},[o("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1)])])]),o("div",Mn,[e.conflicts.length>0?(l(),i("div",An,[t[10]||(t[10]=o("h4",null,"冲突统计",-1)),o("div",On,[x.value.critical>0?(l(),i("div",Nn,[t[2]||(t[2]=o("span",{class:"stat-icon"},"🚨",-1)),t[3]||(t[3]=o("span",{class:"stat-label"},"严重冲突",-1)),o("span",zn,m(x.value.critical),1)])):r("",!0),x.value.high>0?(l(),i("div",jn,[t[4]||(t[4]=o("span",{class:"stat-icon"},"⚠️",-1)),t[5]||(t[5]=o("span",{class:"stat-label"},"高级冲突",-1)),o("span",Fn,m(x.value.high),1)])):r("",!0),x.value.medium>0?(l(),i("div",Ln,[t[6]||(t[6]=o("span",{class:"stat-icon"},"⚡",-1)),t[7]||(t[7]=o("span",{class:"stat-label"},"中级冲突",-1)),o("span",Un,m(x.value.medium),1)])):r("",!0),x.value.low>0?(l(),i("div",Bn,[t[8]||(t[8]=o("span",{class:"stat-icon"},"ℹ️",-1)),t[9]||(t[9]=o("span",{class:"stat-label"},"低级冲突",-1)),o("span",Hn,m(x.value.low),1)])):r("",!0)])])):r("",!0),e.conflicts.length>0?(l(),i("div",Wn,[t[15]||(t[15]=o("h4",null,"冲突详情",-1)),o("div",Vn,[(l(!0),i(g,null,v(D.value,e=>{return l(),i("div",{key:e.id,class:h(["conflict-item",e.severity.toLowerCase()])},[o("div",qn,[o("div",Jn,[o("span",Gn,m((n=e.severity,{CRITICAL:"🚨",HIGH:"⚠️",MEDIUM:"⚡",LOW:"ℹ️"}[n]||"ℹ️")),1),o("span",Yn,m((a=e.type,{hard_constraint:"硬约束冲突",soft_constraint:"软约束冲突",resource_conflict:"资源冲突",scheduling_conflict:"排班冲突",examiner_time_conflict:"考官时间冲突"}[a]||a)),1),o("span",Xn,m(S(e.severity)),1)]),o("button",{class:h(["expand-button",{expanded:f.value.has(e.id)}]),onClick:t=>{return a=e.id,void(f.value.has(a)?f.value.delete(a):f.value.add(a));var a}},[...t[11]||(t[11]=[o("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none"},[o("path",{d:"M4 6l4 4 4-4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1)])],10,Kn)]),o("div",Zn,m(e.description),1),f.value.has(e.id)?(l(),i("div",Qn,[e.affectedEntities.length>0?(l(),i("div",es,[t[12]||(t[12]=o("h5",null,"受影响的实体：",-1)),o("ul",null,[(l(!0),i(g,null,v(e.affectedEntities,e=>(l(),i("li",{key:e},m(e),1))),128))])])):r("",!0),e.suggestedSolutions.length>0?(l(),i("div",ts,[t[13]||(t[13]=o("h5",null,"建议解决方案：",-1)),o("ol",null,[(l(!0),i(g,null,v(e.suggestedSolutions,e=>(l(),i("li",{key:e},m(e),1))),128))])])):r("",!0),e.autoResolvable?(l(),i("div",as,[o("button",{class:"auto-resolve-button",onClick:t=>(e=>{p("autoResolve",e)})(e)},[...t[14]||(t[14]=[o("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none"},[o("path",{d:"M13.5 3.5L6 11l-3.5-3.5",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),u(" 自动解决此冲突 ",-1)])],8,ns)])):r("",!0)])):r("",!0)],2);var a,n}),128))])])):r("",!0),o("div",ss,[t[16]||(t[16]=o("h4",null,"通用解决建议",-1)),o("div",is,[(l(!0),i(g,null,v(k.value,e=>(l(),i("div",{key:e.title,class:"suggestion-item"},[o("div",rs,[o("span",ls,m(e.icon),1),o("span",os,m(e.title),1)]),o("p",ds,m(e.description),1),e.actions.length>0?(l(),i("div",cs,[(l(!0),i(g,null,v(e.actions,e=>(l(),i("button",{key:e.label,class:"suggestion-action-button",onClick:t=>(e=>{p("executeAction",e)})(e)},m(e.label),9,us))),128))])):r("",!0)]))),128))])])]),o("div",{class:"modal-footer"},[o("button",{class:"secondary-button",onClick:$},"导出错误报告"),o("button",{class:"primary-button",onClick:C},"我知道了")])])])):r("",!0)}}),[["__scopeId","data-v-73900707"]]);var ms=Object.defineProperty,hs=(e,t,a)=>((e,t,a)=>t in e?ms(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,t+"",a);const gs=new class{constructor(){hs(this,"state",C({isVisible:!1,errorType:"system_error",errorMessage:"",conflicts:[],isAnalyzing:!1,analysisResult:null}))}showErrorFeedback(e,t,a=[]){this.state.errorType=e,this.state.errorMessage=t,this.state.conflicts=a,this.state.isVisible=!0,a.length>0&&this.analyzeConflicts(a)}hideErrorFeedback(){this.state.isVisible=!1,this.state.conflicts=[],this.state.analysisResult=null}async analyzeConflicts(e){this.state.isAnalyzing=!0;try{const t={totalConflicts:e.length,severityDistribution:this.calculateSeverityDistribution(e),conflictTypes:this.analyzeConflictTypes(e),autoResolvableCount:e.filter(e=>e.autoResolvable).length,recommendations:this.generateRecommendations(e),estimatedResolutionTime:this.estimateResolutionTime(e)};this.state.analysisResult=t}catch(t){}finally{this.state.isAnalyzing=!1}}calculateSeverityDistribution(e){const t={CRITICAL:0,HIGH:0,MEDIUM:0,LOW:0};return e.forEach(e=>{t[e.severity]++}),t}analyzeConflictTypes(e){const t=new Map;return e.forEach(e=>{t.set(e.type,(t.get(e.type)||0)+1)}),Object.fromEntries(t)}generateRecommendations(e){const t=[],a=this.analyzeConflictTypes(e);return a.examiner_time_conflict&&(t.push("检查考官时间安排，避免同一考官在同一时间段被分配到多个考试"),t.push("考虑增加备用考官或调整考试时间安排")),a.hard_constraint&&(t.push("检查硬约束配置，确保约束条件合理且可满足"),t.push("考虑临时放宽某些非关键硬约束")),a.resource_conflict&&(t.push("检查考官资源配置，确保有足够的可用考官"),t.push("考虑扩展考试时间范围或增加考试场次")),a.scheduling_conflict&&(t.push("检查排班规则设置，避免冲突的排班要求"),t.push("考虑使用自动优化功能重新分配资源")),e.some(e=>"CRITICAL"===e.severity)&&t.push("优先解决严重冲突，这些冲突可能导致系统无法正常工作"),e.filter(e=>e.autoResolvable).length>0&&t.push("使用自动解决功能处理可自动修复的冲突"),t}estimateResolutionTime(e){const t=e.filter(e=>"CRITICAL"===e.severity).length,a=e.filter(e=>"HIGH"===e.severity).length,n=e.filter(e=>e.autoResolvable).length;return t>5?"30-60分钟":t>0||a>10?"15-30分钟":n===e.length?"1-5分钟":"5-15分钟"}detectExaminerTimeConflicts(e){const t=[],a=new Map;return e.forEach((e,n)=>{const s=`${e.date}_${e.timeSlot}`;e.examiner1&&(a.has(e.examiner1)||a.set(e.examiner1,new Set),a.get(e.examiner1).has(s)&&t.push({id:`examiner_conflict_${n}_${e.examiner1}`,type:"examiner_time_conflict",severity:"CRITICAL",description:`考官 ${e.examiner1} 在 ${e.date} ${e.timeSlot} 时间段存在冲突`,affectedEntities:[`考试: ${e.examName}`,`考官: ${e.examiner1}`,`时间: ${e.date} ${e.timeSlot}`],suggestedSolutions:["更换其他可用考官","调整考试时间","使用备用考官替代"],autoResolvable:!0}),a.get(e.examiner1).add(s)),e.examiner2&&(a.has(e.examiner2)||a.set(e.examiner2,new Set),a.get(e.examiner2).has(s)&&t.push({id:`examiner_conflict_${n}_${e.examiner2}`,type:"examiner_time_conflict",severity:"CRITICAL",description:`考官 ${e.examiner2} 在 ${e.date} ${e.timeSlot} 时间段存在冲突`,affectedEntities:[`考试: ${e.examName}`,`考官: ${e.examiner2}`,`时间: ${e.date} ${e.timeSlot}`],suggestedSolutions:["更换其他可用考官","调整考试时间","使用备用考官替代"],autoResolvable:!0}),a.get(e.examiner2).add(s)),e.backupExaminer&&(a.has(e.backupExaminer)||a.set(e.backupExaminer,new Set),a.get(e.backupExaminer).has(s)&&t.push({id:`examiner_conflict_${n}_${e.backupExaminer}`,type:"examiner_time_conflict",severity:"HIGH",description:`备用考官 ${e.backupExaminer} 在 ${e.date} ${e.timeSlot} 时间段存在冲突`,affectedEntities:[`考试: ${e.examName}`,`备用考官: ${e.backupExaminer}`,`时间: ${e.date} ${e.timeSlot}`],suggestedSolutions:["更换其他备用考官","调整考试时间","移除备用考官配置"],autoResolvable:!0}),a.get(e.backupExaminer).add(s))}),t}detectResourceConflicts(e,t){const a=[],n=new Map;return e.forEach(e=>{e.examiner1&&n.set(e.examiner1,(n.get(e.examiner1)||0)+1),e.examiner2&&n.set(e.examiner2,(n.get(e.examiner2)||0)+1)}),n.forEach((e,n)=>{const s=t.find(e=>e.id===n);s&&e>s.maxWorkload&&a.push({id:`workload_conflict_${n}`,type:"resource_conflict",severity:"HIGH",description:`考官 ${s.name} 工作量过载 (${e}/${s.maxWorkload})`,affectedEntities:[`考官: ${s.name}`,`当前工作量: ${e}`,`最大工作量: ${s.maxWorkload}`],suggestedSolutions:["重新分配部分考试给其他考官","增加该考官的最大工作量限制","调整考试安排以平衡工作量"],autoResolvable:!1})}),a}async autoResolveConflict(e){try{switch(e.type){case"examiner_time_conflict":return await this.resolveExaminerTimeConflict(e);case"resource_conflict":return await this.resolveResourceConflict(e);default:return!1}}catch(t){return!1}}async resolveExaminerTimeConflict(e){return!0}async resolveResourceConflict(e){return!0}exportErrorReport(){const e={timestamp:(new Date).toISOString(),errorType:this.state.errorType,errorMessage:this.state.errorMessage,conflicts:this.state.conflicts,analysisResult:this.state.analysisResult},t=JSON.stringify(e,null,2),a=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(a),s=document.createElement("a");return s.href=n,s.download=`error-report-${(new Date).toISOString().slice(0,19).replace(/:/g,"-")}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n),t}getState(){return this.state}};var vs=Object.defineProperty,fs=(e,t,a)=>((e,t,a)=>t in e?vs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,t+"",a);const ys=new class{constructor(){fs(this,"baseUrl",null)}async getBaseUrl(){return this.baseUrl||(this.baseUrl=await(async()=>{if(window.electronAPI&&window.electronAPI.isElectron)try{return`http://127.0.0.1:${await window.electronAPI.getBackendPort()}`}catch(e){return""}return""})()),this.baseUrl}async saveSnapshot(e,t,a,n,s,i,r){var l;try{const o=this.calculateMetadata(a,n);s&&(o.studentList=s),i&&(o.teacherList=i.map(e=>({id:e.id,name:e.name,department:e.department,group:e.group,shift:e.shift,status:e.status,workload:e.workload,consecutiveDays:e.consecutiveDays,unavailablePeriods:e.unavailablePeriods||[],availability:e.availability}))),r&&(o.examDates=r);const d={name:e,description:t,scheduleData:a,metadata:o},c=`${await this.getBaseUrl()}/api/schedule-snapshots`,u=JSON.stringify(d),p=new Blob([u]).size;fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"scheduleHistoryService.ts:95",message:"Saving snapshot - request details",data:{url:c,method:"POST",bodySize:p,snapshotName:d.name,scheduleDataCount:(null==(l=d.scheduleData)?void 0:l.length)||0,hasMetadata:!!d.metadata},timestamp:Date.now(),sessionId:"debug-session",runId:"snapshot-save",hypothesisId:"A"})}).catch(()=>{});const m=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:u});if(fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"scheduleHistoryService.ts:103",message:"Snapshot save response received",data:{status:m.status,statusText:m.statusText,ok:m.ok,contentType:m.headers.get("content-type")},timestamp:Date.now(),sessionId:"debug-session",runId:"snapshot-save",hypothesisId:"A"})}).catch(()=>{}),!m.ok){const e=await m.text();throw fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"scheduleHistoryService.ts:110",message:"Snapshot save failed",data:{status:m.status,statusText:m.statusText,errorText:e.substring(0,500)},timestamp:Date.now(),sessionId:"debug-session",runId:"snapshot-save",hypothesisId:"A"})}).catch(()=>{}),new Error(`保存失败: ${m.status} ${m.statusText} - ${e.substring(0,200)}`)}const h=await m.json();return fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"scheduleHistoryService.ts:125",message:"Snapshot save success",data:{snapshotId:h.id,snapshotName:h.name},timestamp:Date.now(),sessionId:"debug-session",runId:"snapshot-save",hypothesisId:"A"})}).catch(()=>{}),h}catch(o){throw o}}async getSnapshotList(e){try{const t=new URLSearchParams;(null==e?void 0:e.page)&&t.append("page",e.page.toString()),(null==e?void 0:e.pageSize)&&t.append("pageSize",e.pageSize.toString()),(null==e?void 0:e.sortBy)&&t.append("sortBy",e.sortBy),(null==e?void 0:e.sortOrder)&&t.append("sortOrder",e.sortOrder),(null==e?void 0:e.nameFilter)&&t.append("nameFilter",e.nameFilter),(null==e?void 0:e.startDate)&&t.append("startDate",e.startDate),(null==e?void 0:e.endDate)&&t.append("endDate",e.endDate);const a=await fetch(`${await this.getBaseUrl()}/api/schedule-snapshots?${t.toString()}`);if(!a.ok)throw new Error(`查询失败: ${a.statusText}`);return await a.json()}catch(t){throw t}}async getSnapshot(e){try{const t=await fetch(`${await this.getBaseUrl()}/api/schedule-snapshots/${e}`);if(!t.ok)throw new Error(`查询失败: ${t.statusText}`);return await t.json()}catch(t){throw t}}async deleteSnapshot(e){try{const t=await fetch(`${await this.getBaseUrl()}/api/schedule-snapshots/${e}`,{method:"DELETE"});if(!t.ok)throw new Error(`删除失败: ${t.statusText}`)}catch(t){throw t}}async updateSnapshot(e,t,a){try{const n=this.calculateMetadata(t,a),s=await fetch(`${await this.getBaseUrl()}/api/schedule-snapshots/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({scheduleData:t,metadata:n})});if(!s.ok)throw new Error(`更新失败: ${s.statusText}`);return await s.json()}catch(n){throw n}}recordManualEdit(e,t,a,n,s){e.manualEdits||(e.manualEdits=[]);const i={field:t,oldValue:a,newValue:n,timestamp:(new Date).toISOString(),conflictLevel:s||"none"};return e.manualEdits.push(i),e}async batchDeleteSnapshots(e){try{const t=await fetch(`${await this.getBaseUrl()}/api/schedule-snapshots/batch-delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:e})});if(!t.ok)throw new Error(`批量删除失败: ${t.statusText}`)}catch(t){throw t}}async getStorageStatistics(){try{const e=await fetch(`${await this.getBaseUrl()}/api/schedule-snapshots/statistics`);if(!e.ok)throw new Error(`查询失败: ${e.statusText}`);return await e.json()}catch(e){throw e}}calculateMetadata(e,t){const a=new Set,n=new Set,s=[];let i=0,r=0;return e.forEach(e=>{a.add(e.student),[e.examiner1_1,e.examiner1_2,e.backup1,e.examiner2_1,e.examiner2_2,e.backup2].forEach(e=>{e&&"-"!==e&&"未分配"!==e&&n.add(e)}),e.date1&&s.push(e.date1),e.date2&&s.push(e.date2),e.manualEdits&&e.manualEdits.length>0?i+=e.manualEdits.length:r++}),s.sort(),{totalStudents:a.size,totalTeachers:n.size,dateRange:{start:s[0]||"",end:s[s.length-1]||""},constraintConfig:t,manualEditCount:i,autoAssignedCount:r,studentList:void 0,teacherList:void 0,examDates:void 0}}async checkCleanupNeeded(){try{const e=await this.getStorageStatistics(),t=e.totalSnapshots>50;let a;if(t){a=(await this.getSnapshotList({page:0,pageSize:1,sortBy:"createdAt",sortOrder:"asc"})).snapshots[0]}const n=new Date;n.setMonth(n.getMonth()-3);const s=(await this.getSnapshotList({page:0,pageSize:1e3})).snapshots.filter(e=>new Date(e.createdAt)<n).length;return{needsCleanup:t,snapshotCount:e.totalSnapshots,oldestSnapshot:a,recommendedDeleteCount:s}}catch(e){return{needsCleanup:!1,snapshotCount:0,recommendedDeleteCount:0}}}async exportSnapshotToExcel(e){try{const t=await fetch(`${await this.getBaseUrl()}/api/schedule-snapshots/${e.id}/export`);if(!t.ok){const e=await t.json();throw new Error(e.error||`导出失败: ${t.statusText}`)}return await t.blob()}catch(t){throw t}}};const xs=new class{async exportScheduleToExcel(e,t="排班表.xlsx"){const a=new de.Workbook,n=a.addWorksheet("排班表");n.columns=[{header:"所在科室",key:"department",width:15},{header:"学员",key:"student",width:12},{header:"第一天日期",key:"date1",width:12},{header:"第一天类型",key:"type1",width:12},{header:"第一天考官一",key:"examiner1_1",width:12},{header:"第一天考官二",key:"examiner1_2",width:12},{header:"第一天备份考官",key:"backup1",width:14},{header:"第二天日期",key:"date2",width:12},{header:"第二天类型",key:"type2",width:12},{header:"第二天考官一",key:"examiner2_1",width:12},{header:"第二天考官二",key:"examiner2_2",width:12},{header:"第二天备份考官",key:"backup2",width:14}];const s=n.getRow(1);s.font={bold:!0,size:11,color:{argb:"FFFFFFFF"}},s.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},s.alignment={vertical:"middle",horizontal:"center"},s.height=25;for(const d of e){const e=n.addRow({department:d.department||"",student:d.student||"",date1:d.date1||"",type1:d.type1||"现场+模拟机1",examiner1_1:d.examiner1_1||"-",examiner1_2:d.examiner1_2||"-",backup1:d.backup1||"-",date2:d.date2||"",type2:d.type2||"模拟机2+口试",examiner2_1:d.examiner2_1||"-",examiner2_2:d.examiner2_2||"-",backup2:d.backup2||"-"});e.height=20,e.alignment={vertical:"middle",horizontal:"center"},this.applyCellColors(e,d)}n.eachRow((e,t)=>{e.eachCell(e=>{e.border={top:{style:"thin",color:{argb:"FFD0D0D0"}},left:{style:"thin",color:{argb:"FFD0D0D0"}},bottom:{style:"thin",color:{argb:"FFD0D0D0"}},right:{style:"thin",color:{argb:"FFD0D0D0"}}}})});const i=await a.xlsx.writeBuffer(),r=new Blob([i],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),l=document.createElement("a"),o=URL.createObjectURL(r);l.setAttribute("href",o),l.setAttribute("download",t),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(o)}applyCellColors(e,t){const a=[{field:"examiner1_1",colNumber:5},{field:"examiner1_2",colNumber:6},{field:"backup1",colNumber:7},{field:"examiner2_1",colNumber:10},{field:"examiner2_2",colNumber:11},{field:"backup2",colNumber:12}];for(const{field:n,colNumber:s}of a){const a=e.getCell(s),i=this.getCellColorInfo(t,n);i&&(a.fill=i.fill,i.font&&(a.font={...a.font,...i.font}))}}getCellColorInfo(e,t){var a,n,s,i;if(null==(a=e.constraintViolations)?void 0:a.find(e=>e.field===t))return{fill:{type:"pattern",pattern:"solid",fgColor:{argb:"FFFCD34D"}}};const r=null==(n=e.manualEdits)?void 0:n.find(e=>e.field===t);if(r){const e=null==(s=r.conflicts)?void 0:s.some(e=>"hard"===e.type||"high"===e.severity),t=null==(i=r.conflicts)?void 0:i.some(e=>"soft"===e.type||"medium"===e.severity||"low"===e.severity);return r.isForced||e?{fill:{type:"pattern",pattern:"solid",fgColor:{argb:"FFFCA5A5"}},font:{bold:!0,color:{argb:"FF7F1D1D"}}}:t?{fill:{type:"pattern",pattern:"solid",fgColor:{argb:"FFFCD7A1"}},font:{bold:!0,color:{argb:"FF92400E"}}}:{fill:{type:"pattern",pattern:"solid",fgColor:{argb:"FFB7E5CB"}},font:{bold:!0,color:{argb:"FF065F46"}}}}return null}async exportScheduleWithLegend(e,t="排班表（含图例）.xlsx"){const a=new de.Workbook,n=a.addWorksheet("排班表");n.mergeCells("A1:D1");const s=n.getCell("A1");s.value="📋 排班表颜色图例",s.font={bold:!0,size:14,color:{argb:"FF1F2937"}},s.alignment={vertical:"middle",horizontal:"center"},s.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE5E7EB"}};const i=[{label:"🟡 黄色",description:"系统检测到约束违反（不可用时间/工作量超标/轮班不匹配）",color:"FFFCD34D"},{label:"🟢 绿色",description:"人工修改后无冲突",color:"FFB7E5CB"},{label:"🟠 橙色",description:"人工修改后存在软冲突（科室不匹配等）",color:"FFFCD7A1"},{label:"🔴 红色",description:"人工强制修改或存在硬冲突（不可用时间/轮班不匹配）",color:"FFFCA5A5"}];let r=2;for(const m of i){const e=n.getCell(`A${r}`);e.value=m.label,e.font={bold:!0},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:m.color}},n.mergeCells(`B${r}:D${r}`);const t=n.getCell(`B${r}`);t.value=m.description,t.alignment={vertical:"middle",horizontal:"left"},r++}r++,n.columns=[{header:"",key:"",width:15},{header:"",key:"",width:12},{header:"",key:"",width:12},{header:"",key:"",width:12},{header:"",key:"",width:12},{header:"",key:"",width:12},{header:"",key:"",width:14},{header:"",key:"",width:12},{header:"",key:"",width:12},{header:"",key:"",width:12},{header:"",key:"",width:12},{header:"",key:"",width:14}];const l=n.getRow(r);["所在科室","学员","第一天日期","第一天类型","第一天考官一","第一天考官二","第一天备份考官","第二天日期","第二天类型","第二天考官一","第二天考官二","第二天备份考官"].forEach((e,t)=>{const a=l.getCell(t+1);a.value=e,a.font={bold:!0,size:11,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},a.alignment={vertical:"middle",horizontal:"center"}}),l.height=25;let o=r+1;for(const m of e){const e=n.getRow(o);[m.department||"",m.student||"",m.date1||"",m.type1||"现场+模拟机1",m.examiner1_1||"-",m.examiner1_2||"-",m.backup1||"-",m.date2||"",m.type2||"模拟机2+口试",m.examiner2_1||"-",m.examiner2_2||"-",m.backup2||"-"].forEach((t,a)=>{const n=e.getCell(a+1);n.value=t,n.alignment={vertical:"middle",horizontal:"center"}}),e.height=20;const t=[{field:"examiner1_1",colNumber:5},{field:"examiner1_2",colNumber:6},{field:"backup1",colNumber:7},{field:"examiner2_1",colNumber:10},{field:"examiner2_2",colNumber:11},{field:"backup2",colNumber:12}];for(const{field:a,colNumber:n}of t){const t=e.getCell(n),s=this.getCellColorInfo(m,a);s&&(t.fill=s.fill,s.font&&(t.font={...t.font,...s.font}))}o++}n.eachRow((e,t)=>{t>=r&&e.eachCell(e=>{e.border={top:{style:"thin",color:{argb:"FFD0D0D0"}},left:{style:"thin",color:{argb:"FFD0D0D0"}},bottom:{style:"thin",color:{argb:"FFD0D0D0"}},right:{style:"thin",color:{argb:"FFD0D0D0"}}}})});const d=await a.xlsx.writeBuffer(),c=new Blob([d],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),u=document.createElement("a"),p=URL.createObjectURL(c);u.setAttribute("href",p),u.setAttribute("download",t),u.style.visibility="hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(p)}};const bs=new class{async performAssessment(e){var t;performance.now();const a=this.calculateExaminerAvailability(e),n=this.analyzeBottlenecks(e,a),s=(null==(t=n.find(e=>e.isBottleneck))?void 0:t.department)||null,i=this.calculatePreciseCapacity(e,a,n),r=this.generateDateRecommendation(e,n,i),l=this.performConstraintPreCheck(e,a,n),o=this.generateOptimizationSuggestions(e,n,l),d=this.determineFeasibility(n,l,i);return performance.now(),{isFeasible:d,overallConfidence:this.calculateOverallConfidence(n,l),bottlenecks:n,criticalDepartment:s,...i,examinerAvailabilityMap:a,unavailableExaminers:Array.from(a.values()).filter(e=>0===e.availableCount).map(e=>e.examiner.name),dateRecommendation:r,issues:l,suggestions:o}}calculateExaminerAvailability(e){const t=new Map,{examDates:a,unavailableDates:n,dutySchedule:s}=e;for(const i of e.teachers){const e=G(i.department),r=s.get(i.id)||[],l=this.parseUnavailablePeriods(i),o=[];let d=!1;for(const t of a){const e=this.formatDate(t),a=t.getDay(),s=0===a||6===a;if(n.some(e=>this.isSameDay(e,t)))continue;if(!l.some(e=>t>=e.start&&t<=e.end)&&!r.includes(e)){if(s){if(!i.group||"无"===i.group||""===i.group.trim())continue;d=!0}o.push(t)}}const c=this.calculateExaminerEffectiveCapacity(i,o);t.set(i.id,{examiner:i,department:e,availableDates:o,availableCount:o.length,isAvailableOnWeekend:d,unavailablePeriods:l,dutyDates:r.map(e=>new Date(e)),effectiveCapacity:c})}return t}parseUnavailablePeriods(e){const t=[],a=e.unavailableDates||e.unavailablePeriods;if(Array.isArray(a))for(const s of a)try{s.startDate&&s.endDate&&t.push({start:new Date(s.startDate),end:new Date(s.endDate),reason:s.reason})}catch(n){}return t}calculateExaminerEffectiveCapacity(e,t){const a=e.maxWorkload||11;return t.length*Math.min(a,11)}analyzeBottlenecks(e,t){const{students:a,teachers:n,examDates:s,config:i}=e,r=new Map;for(const c of a){const e=G(c.department);r.has(e)||r.set(e,{students:[],examiners:[],availableExaminers:[]}),r.get(e).students.push(c)}for(const c of n){const e=G(c.department);r.has(e)||r.set(e,{students:[],examiners:[],availableExaminers:[]}),r.get(e).examiners.push(c);const a=t.get(c.id);a&&a.availableCount>0&&r.get(e).availableExaminers.push(a)}this.handleDept37Interchangeability(r);const l=[],o=i.constraints.maxExamsPerDay||11,d=s.length;for(const[c,u]of r){const e=u.students.length,t=u.examiners.length,a=u.availableExaminers.length,n=2*e,s=t*o,i=u.availableExaminers.reduce((e,t)=>e+t.effectiveCapacity,0),r=i>0?n/i:1/0,p=Math.ceil(n/o/Math.max(a,1)),m=r>.8||0===a||p>d;let h="low";0===a||r>1.2?h="critical":r>.9?h="high":r>.8&&(h="medium");const g=Math.max(0,n-i);l.push({department:c,studentCount:e,examinerCount:t,availableExaminerCount:a,totalExamsNeeded:n,maxCapacityPerDay:s,actualAvailableCapacity:i,utilizationRate:Math.min(r,999),isBottleneck:m,severity:h,requiredDays:p,availableDays:d,deficit:g})}return l.sort((e,t)=>{const a={critical:0,high:1,medium:2,low:3};return a[e.severity]!==a[t.severity]?a[e.severity]-a[t.severity]:t.utilizationRate-e.utilizationRate})}handleDept37Interchangeability(e){const t=e.get("三"),a=e.get("七");if(t&&a){const e=[...t.availableExaminers,...a.availableExaminers];t.availableExaminers=e,a.availableExaminers=e}}calculatePreciseCapacity(e,t,a){const{students:n}=e,s=2*n.length,i=e.examDates.length,r=e.config.constraints.maxExamsPerDay||11,l=e.teachers.length*i*r,o=Array.from(t.values()).reduce((e,t)=>e+t.effectiveCapacity,0),d=o>0?s/o:0;return{totalExamsNeeded:s,totalTheoreticalCapacity:l,totalActualCapacity:o,capacityUtilization:Math.min(d,1)}}generateDateRecommendation(e,t,a){const{examDates:n,students:s,config:i}=e,r=n.length;if(0===r)return this.createEmptyRecommendation();const l=i.constraints.maxExamsPerDay||11,o=Math.ceil(a.totalExamsNeeded/r),d=new Map;let c=0;for(const $ of t){const{department:e,totalExamsNeeded:t,availableExaminerCount:a}=$;if(0===a){d.set(e,{minDays:1/0,suggestedDays:1/0});continue}const n=Math.ceil(t/l),s=Math.ceil(t/(.7*l));d.set(e,{minDays:n,suggestedDays:s}),c=Math.max(c,n)}const u=Math.ceil(2*s.length/(e.teachers.length*l*.8)),p=Math.max(u,c),m=t.filter(e=>"critical"===e.severity),h=t.filter(e=>"high"===e.severity),g=t.filter(e=>"medium"===e.severity),v=m.length>0,f=h.length>0,y=g.length>0,x=this.calculateDateRecommendationConfidence(t,p,r),b=[];if(v||f){if(m.length>0){const e=m[0];b.push(`部门"${e.department}"资源严重不足，无法完成排班`)}if(h.length>0){const e=h[0];b.push(`部门"${e.department}"资源紧张，需要更多日期`)}}else if(y){const e=g[0];b.push(`部门"${e.department}"资源略显紧张`)}let w,D,k;if(o>.6*l&&b.push(`每天需要安排约${o}场考试，接近容量上限${l}场`),0===b.length&&b.push("当前配置资源充足，可以顺利完成排班"),v||f){D="insufficient";const e=Math.max(5,Math.ceil(.2*r));w=Math.max(p,r+e,Math.ceil(1.3*r)),k=Math.max(.3,x-.4),b.unshift(`⚠️ 当前日期范围不足以完成排班，建议延长至${w}天`)}else y||x<.8?(D="suboptimal",p>r?(w=p,b.unshift(`💡 延长至${w}天可获得更好的排班效果`)):(w=r,b.unshift(`💡 当前${r}天可以完成排班，但延长日期可获得更好效果`)),k=x):(D="good",w=r,k=Math.min(.95,x+.1),b.unshift(`✅ 当前${r}天的配置可以顺利完成排班，资源配置合理`));w=Math.max(w,r);const S=n[0];return{recommendedStartDate:S,recommendedEndDate:this.addWorkingDays(S,w-1,!1),minRequiredDays:c,suggestedDays:w,confidence:k,reasons:b,departmentSpecificRequirements:d,status:D}}addWorkingDays(e,t,a){const n=new Date(e);let s=0;for(;s<t;){n.setDate(n.getDate()+1);const e=n.getDay();(a||0!==e&&6!==e)&&s++}return n}createEmptyRecommendation(){return{recommendedStartDate:new Date,recommendedEndDate:new Date,minRequiredDays:0,suggestedDays:0,confidence:0,reasons:["无可用的考试日期"],departmentSpecificRequirements:new Map,status:"insufficient"}}calculateDateRecommendationConfidence(e,t,a){let n=.9;return n-=.3*e.filter(e=>"critical"===e.severity).length,n-=.15*e.filter(e=>"high"===e.severity).length,t>.9*a&&(n-=.1),Math.max(0,Math.min(1,n))}performConstraintPreCheck(e,t,a){const n=[],s=e.examDates.filter(e=>{const t=e.getDay();return 0===t||6===t});if(s.length>0){const e=Array.from(t.values()).filter(e=>e.isAvailableOnWeekend).length;0===e&&s.length>0&&n.push({id:"HC1-001",type:"constraint",severity:"critical",message:"选择的工作日包含周末，但没有可用考官（行政班考官周末不可用）",details:{weekendDates:s,weekendAvailableCount:e},autoResolvable:!1,suggestedFix:"移除周末日期或添加非行政班考官"})}for(const i of a)0===i.availableExaminerCount?n.push({id:"HC2-001",type:"resource",severity:"critical",department:i.department,message:`部门"${i.department}"没有可用考官`,details:{department:i.department,studentCount:i.studentCount,totalExamsNeeded:i.totalExamsNeeded},autoResolvable:!1,suggestedFix:`为${i.department}添加可用考官或调整学生分配`}):i.utilizationRate>1&&n.push({id:"CAP-001",type:"capacity",severity:"critical",department:i.department,message:`部门"${i.department}"容量不足（需要${i.totalExamsNeeded}场，实际容量${i.actualAvailableCapacity}场）`,details:{department:i.department,required:i.totalExamsNeeded,available:i.actualAvailableCapacity,deficit:i.deficit},autoResolvable:!1,suggestedFix:`增加${i.department}的考官数量或延长日期范围`});return 0===Array.from(t.values()).filter(e=>e.availableCount>0).length&&n.push({id:"RES-001",type:"resource",severity:"critical",message:"当前配置中没有可用考官",details:{totalExaminers:e.teachers.length},autoResolvable:!1,suggestedFix:"检查考官不可用日期配置，或添加更多考官"}),n.sort((e,t)=>{const a={critical:0,high:1,medium:2,low:3};return a[e.severity]-a[t.severity]})}generateOptimizationSuggestions(e,t,a){const n=[];let s=1;for(const i of t.filter(e=>e.isBottleneck))0===i.availableExaminerCount?n.push({id:`SUG-${s}`,priority:s++,category:"resource",title:`为${i.department}添加考官`,description:`部门"${i.department}"有${i.studentCount}名学生但没有可用考官`,expectedImpact:"解决硬约束违反，使排班可行",implementationSteps:[`检查${i.department}考官的不可用日期配置`,"确认是否有考官可以调整不可用期","考虑从其他部门调配考官（如果允许）"]}):i.utilizationRate>.9&&n.push({id:`SUG-${s}`,priority:s++,category:"date_range",title:`延长${i.department}的考试日期范围`,description:`部门"${i.department}"利用率过高（${(100*i.utilizationRate).toFixed(1)}%）`,expectedImpact:"降低容量压力，提高排班成功率",implementationSteps:[`当前需要${i.requiredDays}个工作日`,`建议至少安排${Math.ceil(1.3*i.requiredDays)}个工作日`,"优先安排在考官可用性高的日期"]});return 0===a.filter(e=>"critical"===e.severity).length&&n.push({id:`SUG-${s}`,priority:s++,category:"config",title:"当前配置良好",description:"资源充足，可以顺利进行排班",expectedImpact:"排班成功率高"}),n}determineFeasibility(e,t,a){if(t.some(e=>"critical"===e.severity))return!1;return!e.some(e=>"critical"===e.severity)&&!(a.totalExamsNeeded>1.1*a.totalActualCapacity)}calculateOverallConfidence(e,t){let a=.95;a-=.3*e.filter(e=>"critical"===e.severity).length,a-=.1*e.filter(e=>"high"===e.severity).length;return a-=.25*t.filter(e=>"critical"===e.severity).length,Math.max(0,Math.min(1,a))}formatDate(e){return e.toISOString().split("T")[0]}isSameDay(e,t){return this.formatDate(e)===this.formatDate(t)}};const ws=new class{async performPreciseAssessment(e){var t;performance.now();const a=this.analyzeDatePairs(e),n=this.analyzeDepartmentCapacities(e,a),s=this.checkHC4Constraint(e,n),i=this.determineFeasibility(n,a,s),r=this.generateIssues(n,a,s),l=this.generateSuggestions(n,a,e),o=this.calculateConfidence(n,r),d=this.calculateRecommendedDateRange(e,n,i,o);performance.now();const c=(null==(t=n.find(e=>"critical"===e.severity))?void 0:t.department)||null;return{isFeasible:i,confidence:o,constraintChecks:{hc6:{totalDatePairs:a.length,validDatePairs:a.filter(e=>e.isValid).length,requiredForTwoDayStudents:this.calculateRequiredDatePairs(e),isSatisfied:a.filter(e=>e.isValid).length>=this.calculateRequiredDatePairs(e)},hc2_hc7:{departmentsWithZeroCapacity:n.filter(e=>0===e.maxConcurrentExams).map(e=>e.department),minDepartmentCapacity:Math.min(...n.map(e=>e.maxConcurrentExams)),isSatisfied:n.every(e=>e.maxConcurrentExams>0)},hc3:{datesWithDayShiftConflict:this.countDatesWithDayShiftIssues(e),isSatisfied:!0},hc4:s},departmentCapacities:n,criticalDepartment:c,dateAnalysis:{totalDates:e.examDates.length,weekendDates:e.examDates.filter(e=>{const t=e.getDay();return 0===t||6===t}).length,datesWithInsufficientExaminers:this.findDatesWithInsufficientExaminers(n),recommendedDateRange:d},issues:r,suggestions:l}}analyzeDatePairs(e){const{examDates:t,dutySchedule:a}=e,n=[],s=[...t].sort((e,t)=>e.getTime()-t.getTime());for(let i=0;i<s.length-1;i++){const t=s[i],a=s[i+1];if(1===(a.getTime()-t.getTime())/864e5){const s=this.formatDate(t),i=this.formatDate(a),r=this.hasSufficientExaminers(e,t),l=this.hasSufficientExaminers(e,a);let o=!0,d="";r?l||(o=!1,d=`${i} 可用考官不足`):(o=!1,d=`${s} 可用考官不足`),n.push({day1:t,day2:a,isValid:o,invalidReason:d})}}return n}hasSufficientExaminers(e,t){const{teachers:a,dutySchedule:n,unavailableDates:s}=e,i=this.formatDate(t),r=n.get(i)||[];let l=0;for(const o of a){if(this.isTeacherUnavailable(o,t,s))continue;const e=o.group;e&&r.includes(e)||l++}return l>=2}analyzeDepartmentCapacities(e,t){const{students:a,teachers:n,examDates:s,dutySchedule:i}=e,r=new Map;for(const d of a){const e=G(d.department);r.has(e)||r.set(e,[]),r.get(e).push(d)}const l=new Map;for(const d of n){const e=G(d.department);l.has(e)||l.set(e,[]),l.get(e).push(d)}this.handleDept37Interchangeability(r,l);const o=[];for(const[d,c]of r){const a=c.filter(e=>!e.examType||"single"!==e.examType),n=c.filter(e=>"single"===e.examType),i=l.get(d)||[],r=new Map,u=new Map,p=new Map;for(const t of s){const a=this.formatDate(t),n=this.getAvailableExaminersForDate(i,t,e);r.set(a,n.length),u.set(a,n),p.set(a,Math.floor(n.length/1))}const m=t.filter(e=>{const t=this.formatDate(e.day1),a=this.formatDate(e.day2),n=r.get(t)||0,s=r.get(a)||0;return n>=1&&s>=1}),h=Math.max(...Array.from(p.values())),g=h>0?Math.ceil(a.length/h):a.length,v=Math.max(0,g-m.length),f=v>0||0===h;let y="low";0===h||v>.5*a.length?y="critical":v>0?y="high":g>.8*m.length&&(y="medium"),o.push({department:d,studentCount:c.length,twoDayStudentCount:a.length,oneDayStudentCount:n.length,totalExaminers:i.length,availableExaminers:i.filter(t=>!this.isTeacherUnavailableAnyDate(t,s,e.unavailableDates)).length,examinersByDate:u,availableCountPerDate:r,validPairsPerDate:p,maxConcurrentExams:h,requiredDatePairs:g,availableDatePairs:m,isBottleneck:f,severity:y,deficit:v})}return o.sort((e,t)=>{const a={critical:0,high:1,medium:2,low:3};return a[e.severity]-a[t.severity]})}getAvailableExaminersForDate(e,t,a){const{dutySchedule:n,unavailableDates:s}=a,i=this.formatDate(t),r=n.get(i)||[];return e.filter(e=>{if(this.isTeacherUnavailable(e,t,s))return!1;const a=e.group;if(a&&r.includes(a))return!1;const n=t.getDay();if(0===n||6===n){if(!a||"无"===a||""===a.trim())return!1}return!0})}isTeacherUnavailable(e,t,a){const n=e.unavailableDates||e.unavailablePeriods||[];for(const i of n)try{const e=new Date(i.startDate),a=new Date(i.endDate);if(t>=e&&t<=a)return!0}catch(s){}for(const i of a)if(this.isSameDay(t,i))return!0;return!1}isTeacherUnavailableAnyDate(e,t,a){return t.every(t=>this.isTeacherUnavailable(e,t,a))}handleDept37Interchangeability(e,t){const a=e.get("三")||[],n=e.get("七")||[],s=t.get("三")||[],i=t.get("七")||[];if(a.length>0||n.length>0){const t=[...a,...n];e.set("三",t),e.set("七",t)}if(s.length>0||i.length>0){const e=[...s,...i];t.set("三",e),t.set("七",e)}}checkHC4Constraint(e,t){const a=e.students.length,n=e.examDates.length,s=2*a,i=Math.ceil(s/n),r=t.reduce((e,t)=>e+t.maxConcurrentExams,0);return{maxExamsPerDay:r,requiredExamsPerDay:i,isSatisfied:r>=i}}calculateRequiredDatePairs(e){return e.students.length}countDatesWithDayShiftIssues(e){return 0}findDatesWithInsufficientExaminers(e){const t=new Set;for(const a of e)for(const[e,n]of a.availableCountPerDate)n<1&&t.add(e);return Array.from(t)}calculateRecommendedDateRange(e,t,a,n){const{students:s,examDates:i,allowWeekendScheduling:r,unavailableDates:l}=e;if(0===i.length)return{startDate:new Date,endDate:new Date,requiredDays:0,reason:"无可用的考试日期"};const o=i[0],d=i.length,c=s.filter(e=>2===e.examDays),u=s.filter(e=>1===e.examDays),p=t.find(e=>"critical"===e.severity),m=t.find(e=>"high"===e.severity);t.reduce((e,t)=>e+t.requiredDatePairs,0),t.reduce((e,t)=>e+t.availableDatePairs.length,0);const h=t.reduce((e,t)=>e+t.deficit,0);let g,v,f;if(p){const e=p.availableDatePairs.length,t=p.requiredDatePairs,a=p.deficit;if(0===e){const e=2*t;g=Math.ceil(1.5*e),v=`部门"${p.department}"无可用连续日期对，需要${t}个日期对，建议至少${g}天`}else{const n=2*a;g=Math.max(d+n,Math.ceil(2.5*t)),v=`部门"${p.department}"日期对不足（${e}/${t}），建议扩展至${g}天`}}else if(m){const e=m.availableDatePairs.length,t=m.requiredDatePairs,a=m.deficit;g=d+Math.max(2*a,3),v=`部门"${m.department}"日期对紧张（${e}/${t}），建议扩展至${g}天`}else{const a=this.checkHC4Constraint(e,t);if(a.isSatisfied){const e=Math.min(...t.map(e=>e.maxConcurrentExams).filter(e=>e>0))||1,a=Math.ceil(c.length/e)+1,n=Math.ceil(u.length/e),s=Math.max(a,n);g=Math.max(Math.ceil(1.2*s),5),v=`基于${c.length}名两天考试学员和${u.length}名单天考试学员，建议最小${g}天`}else{g=d+3*Math.ceil((a.requiredExamsPerDay-a.maxExamsPerDay)/Math.max(1,a.maxExamsPerDay)),v=`每日考试压力较大（${a.requiredExamsPerDay}/${a.maxExamsPerDay}），建议扩展至${g}天以分散安排`}}a?n<.8||h>0||m?(f="suboptimal",g>d?v=`延长至${g}天可获得更好的排班效果。${v}`:(g=d,v=`当前${d}天可以完成排班，但${v}`)):(f="good",g=d,v=`当前${d}天的配置可以顺利完成排班，资源配置合理。`):(f="insufficient",g=Math.max(g,d+5),v=`当前日期范围不足以完成排班，建议延长至${g}天。${v}`);return{startDate:o,endDate:this.addWorkingDays(o,g-1,r),requiredDays:g,reason:v,status:f}}addWorkingDays(e,t,a){const n=new Date(e);let s=0;for(;s<t;){n.setDate(n.getDate()+1);const e=n.getDay();(a||0!==e&&6!==e)&&s++}return n}generateIssues(e,t,a){const n=[],s=t.filter(e=>e.isValid),i=e.reduce((e,t)=>e+t.studentCount,0);s.length<i&&n.push({id:"HC6-001",type:"hc6",severity:"critical",message:`连续日期对不足：需要${i}对，实际可用${s.length}对`,details:{required:i,available:s.length,invalidPairs:t.filter(e=>!e.isValid).map(e=>({day1:this.formatDate(e.day1),day2:this.formatDate(e.day2),reason:e.invalidReason}))},suggestedFix:"延长日期范围或移除不可用日期设置"});for(const r of e)"critical"===r.severity&&n.push({id:`HC2-001-${r.department}`,type:"hc2",severity:"critical",department:r.department,message:`部门"${r.department}"容量严重不足：${r.twoDayStudentCount}名两天学员需要${r.requiredDatePairs}个日期对，但仅有${r.availableDatePairs.length}个`,details:{department:r.department,studentCount:r.studentCount,requiredPairs:r.requiredDatePairs,availablePairs:r.availableDatePairs.length,maxConcurrentPerDay:r.maxConcurrentExams},suggestedFix:`为${r.department}部门添加更多考官或延长日期范围`});return a.isSatisfied||n.push({id:"HC4-001",type:"hc4",severity:"high",message:`每天考试场次超限：需要${a.requiredExamsPerDay}场/天，最大容量${a.maxExamsPerDay}场/天`,details:{requiredPerDay:a.requiredExamsPerDay,maxPerDay:a.maxExamsPerDay,deficit:a.requiredExamsPerDay-a.maxExamsPerDay},suggestedFix:"增加考官数量或延长日期范围以分散考试压力"}),n.sort((e,t)=>{const a={critical:0,high:1,medium:2,low:3};return a[e.severity]-a[t.severity]})}generateSuggestions(e,t,a){const n=[];let s=1;const i=e.filter(e=>"critical"===e.severity);for(const r of i)0===r.availableDatePairs.length?n.push({id:"SUG-"+s++,title:`紧急：${r.department}部门无可用日期对`,description:`该部门有${r.twoDayStudentCount}名需要两天考试的学员，但没有可用的连续日期对`,expectedImpact:"解决后将使排班可行"}):r.deficit>0&&n.push({id:"SUG-"+s++,title:`建议：为${r.department}部门增加${r.deficit}个日期对`,description:`当前有${r.availableDatePairs.length}个可用日期对，需要${r.requiredDatePairs}个`,expectedImpact:`建议延长日期范围至少${Math.ceil(2*r.deficit*1.5)}天`});return 0===i.length&&n.push({id:"SUG-"+s++,title:"当前配置可以完成排班",description:"所有约束检查通过，可以进行排班",expectedImpact:"排班成功率高"}),n}determineFeasibility(e,t,a){if(e.some(e=>"critical"===e.severity))return!1;return!(t.filter(e=>e.isValid).length<e.reduce((e,t)=>e+t.studentCount,0))&&!!a.isSatisfied}calculateConfidence(e,t){let a=.95;a-=.3*e.filter(e=>"critical"===e.severity).length,a-=.1*e.filter(e=>"high"===e.severity).length;return a-=.25*t.filter(e=>"critical"===e.severity).length,Math.max(0,Math.min(1,a))}formatDate(e){return e.toISOString().split("T")[0]}isSameDay(e,t){return this.formatDate(e)===this.formatDate(t)}},Ds={class:"app-container responsive-container"},ks={class:"sidebar-header"},Ss={class:"logo-container"},$s={class:"logo-text"},Cs={class:"sidebar-nav"},Es={class:"nav-items"},_s={class:"nav-text"},Ts={class:"nav-text"},Is={class:"nav-text"},Ps={class:"nav-text"},Rs={class:"sidebar-footer"},Ms={class:"version-info"},As={class:"version-number"},Os={class:"right-content full-width"},Ns={class:"page-header"},zs={class:"flex items-center space-x-4 mb-2"},js={class:"text-sm text-gray-500"},Fs={key:0,class:"text-sm text-gray-400"},Ls={class:"header-actions"},Us=["disabled","title"],Bs={key:0},Hs={key:0,style:{"font-size":"11px",opacity:"0.8"}},Ws={key:1},Vs={key:0,class:"realtime-update-banner"},qs={class:"update-indicator"},Js={class:"update-count"},Gs={key:1,class:"intermediate-result-banner"},Ys={class:"schedule-table"},Xs=["title","draggable","onDragstart"],Ks={class:"department-cell"},Zs={class:"student-cell"},Qs=["title","onClick"],ei=["title","onClick"],ti=["title","onClick"],ai=["title","onClick"],ni=["title","onClick"],si=["title","onClick"],ii={class:"action-cell"},ri={class:"action-buttons"},li=["onClick"],oi={class:"pin-column"},di=["onClick","title"],ci={class:"drag-column"},ui=["title"],pi={class:"date-picker-panel"},mi={class:"date-picker-header"},hi={class:"date-picker-body"},gi=["onClick","onDrop"],vi={class:"date-icon"},fi={class:"date-label"},yi={class:"date-info"},xi={class:"history-panel"},bi={class:"history-header"},wi={class:"history-actions"},Di={key:0,class:"current-snapshot-info"},ki={class:"info-text"},Si={key:0,class:"unsaved-badge"},$i={class:"modal-header"},Ci={class:"modal-body",style:{padding:"24px"}},Ei={class:"form-group"},_i={class:"form-group",style:{"margin-top":"16px"}},Ti={class:"snapshot-info",style:{"margin-top":"16px",padding:"12px",background:"#f3f4f6","border-radius":"8px"}},Ii={class:"text-sm text-gray-700",style:{"padding-left":"20px","line-height":"1.8"}},Pi={key:0,style:{color:"#f59e0b"}},Ri={class:"modal-footer"},Mi=["disabled"],Ai={class:"modal-header"},Oi={class:"modal-body",style:{padding:"24px","overflow-y":"auto"}},Ni={class:"history-filters",style:{"margin-bottom":"16px"}},zi={key:0,class:"cleanup-alert",style:{"margin-bottom":"16px"}},ji={class:"cleanup-content"},Fi={class:"text-xs text-gray-600"},Li={key:1,class:"loading-state"},Ui={key:2,class:"empty-state"},Bi={key:3,class:"history-list"},Hi={class:"history-item-header"},Wi={class:"history-item-title"},Vi={class:"history-item-date"},qi={key:0,class:"history-item-description"},Ji={class:"history-item-meta"},Gi={class:"meta-item"},Yi=["onClick"],Xi={class:"meta-item"},Ki=["onClick"],Zi={class:"meta-item"},Qi={class:"meta-item"},er={class:"history-item-actions"},tr=["onClick"],ar=["onClick"],nr={class:"modal-footer"},sr={class:"modal-header"},ir={class:"modal-body",style:{padding:"20px","max-height":"500px","overflow-y":"auto"}},rr={style:{"margin-bottom":"16px",color:"#6b7280"}},lr={style:{display:"grid",gap:"12px"}},or={style:{display:"flex","align-items":"center",gap:"12px","margin-bottom":"12px","padding-bottom":"12px","border-bottom":"1px solid #f3f4f6"}},dr={style:{width:"40px",height:"40px",background:"#3b82f6","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center",color:"white","font-weight":"600","font-size":"16px"}},cr={style:{flex:"1"}},ur={style:{"font-weight":"600","font-size":"16px",color:"#111827",margin:"0"}},pr={key:0,style:{"font-size":"14px",color:"#6b7280",margin:"2px 0 0 0"}},mr={key:0,style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"8px"}},hr={style:{"font-size":"12px",color:"#9ca3af",margin:"0 0 4px 0"}},gr={style:{"font-size":"14px",color:"#374151",margin:"0","font-weight":"500"}},vr={class:"modal-footer"},fr={class:"modal-header"},yr={class:"modal-body",style:{padding:"20px","max-height":"500px","overflow-y":"auto"}},xr={style:{"margin-bottom":"16px",color:"#6b7280"}},br={style:{display:"grid",gap:"12px"}},wr={style:{display:"flex","justify-content":"space-between","align-items":"center","margin-bottom":"8px"}},Dr={style:{"font-weight":"600","font-size":"16px"}},kr={key:0,style:{"margin-left":"12px",color:"#6b7280"}},Sr={style:{background:"#f97316",color:"white",padding:"2px 8px","border-radius":"4px","font-size":"12px"}},$r={style:{"margin-top":"8px"}},Cr={style:{color:"#f97316","font-weight":"500"}},Er={class:"modal-footer"},_r={class:"modal-header"},Tr={class:"modal-body",style:{padding:"20px"}},Ir={class:"file-upload-area",style:{"margin-bottom":"20px"}},Pr={class:"upload-icon",style:{"margin-bottom":"12px"}},Rr={key:1,style:{padding:"16px",background:"#ecfdf5",border:"1px solid #a7f3d0","border-radius":"8px"}},Mr={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Ar={style:{display:"flex","align-items":"center",gap:"12px"}},Or={style:{"font-weight":"500",color:"#065f46"}},Nr={style:{"font-size":"12px",color:"#059669"}},zr={style:{margin:"0"}},jr={key:0,style:{"margin-top":"8px","font-size":"14px"}},Fr={key:1,style:{"margin-bottom":"20px"}},Lr={style:{"max-height":"300px","overflow-y":"auto",border:"1px solid #e5e7eb","border-radius":"6px"}},Ur={style:{width:"100%","font-size":"12px","border-collapse":"collapse"}},Br={style:{padding:"8px"}},Hr={style:{padding:"8px"}},Wr={style:{padding:"8px"}},Vr={style:{padding:"8px"}},qr={style:{padding:"8px"}},Jr={style:{padding:"8px"}},Gr={key:0,style:{"font-size":"12px",color:"#6b7280","margin-top":"8px"}},Yr={key:2,style:{"margin-bottom":"16px"}},Xr={class:"modal-footer"},Kr={class:"preview-body"},Zr={class:"preview-info"},Qr={class:"file-info-text"},el={class:"preview-table-container"},tl={class:"preview-table"},al={class:"step-indicator"},nl={key:0,class:"step-content"},sl={class:"import-options"},il=["disabled"],rl={key:0},ll={key:1},ol={class:"file-upload-area"},dl={key:1,class:"file-info"},cl={class:"file-details"},ul={class:"file-name"},pl={class:"file-size"},ml={key:0,class:"student-preview"},hl={class:"preview-header-section"},gl={class:"preview-controls"},vl={class:"preview-table"},fl={class:"preview-header"},yl={key:0},xl={class:"preview-rows"},bl=["title"],wl={class:"exam-content-cell"},Dl=["onUpdate:modelValue","onChange","title"],kl={key:0,class:"recommended-examiners"},Sl={key:0},$l={key:1},Cl={key:2},El={key:0,class:"preview-more"},_l={class:"data-summary"},Tl={class:"summary-item"},Il={class:"summary-value"},Pl={class:"summary-item"},Rl={class:"summary-value"},Ml={class:"summary-item"},Al={class:"summary-value"},Ol={key:1,class:"step-content"},Nl={key:0,class:"smart-date-hint",style:{background:"linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%)",border:"2px solid #3b82f6","border-radius":"12px",padding:"16px 20px","margin-bottom":"24px",display:"flex","align-items":"center",gap:"12px"}},zl={class:"date-selection"},jl={class:"date-group"},Fl={class:"date-input-wrapper"},Ll=["min"],Ul={key:0,class:"field-hint",style:{"margin-top":"8px","font-size":"13px",color:"#f59e0b",display:"flex","align-items":"center",gap:"6px"}},Bl={class:"date-group"},Hl={class:"date-label"},Wl={key:0,class:"date-label-tip"},Vl={key:1,class:"date-label-tip recommended"},ql=["min"],Jl={key:0,class:"field-hint success",style:{"margin-top":"8px","font-size":"13px",color:"#10b981",display:"flex","align-items":"center",gap:"6px"}},Gl={class:"settings-card-group",style:{"margin-top":"16px",display:"flex","flex-direction":"column",gap:"12px"}},Yl={style:{display:"flex","align-items":"center","justify-content":"space-between"}},Xl={style:{display:"flex","align-items":"center",gap:"12px"}},Kl={style:{margin:"4px 0 0","font-size":"13px",color:"#6b7280"}},Zl={style:{display:"flex","align-items":"center",gap:"12px"}},Ql={style:{display:"flex","align-items":"center",gap:"8px"}},eo={key:0,style:{background:"#fef3c7",color:"#92400e",padding:"4px 12px","border-radius":"20px","font-size":"12px","font-weight":"500"}},to={style:{"border-top":"1px solid #f3f4f6",padding:"16px",background:"#fafafa"}},ao={style:{background:"#fff","border-radius":"10px",padding:"16px","margin-bottom":"16px",border:"1px solid #e5e7eb"}},no={style:{display:"flex",gap:"16px","margin-bottom":"12px"}},so={style:{display:"flex","align-items":"center",gap:"6px",cursor:"pointer","font-size":"14px",color:"#374151"}},io={style:{display:"flex","align-items":"center",gap:"6px",cursor:"pointer","font-size":"14px",color:"#374151"}},ro={style:{display:"flex",gap:"8px","flex-wrap":"wrap"}},lo={style:{flex:"1","min-width":"130px"}},oo={key:0,style:{flex:"1","min-width":"130px"}},co={style:{flex:"2","min-width":"180px"}},uo={key:0},po={style:{display:"flex","align-items":"center",gap:"10px"}},mo={style:{"font-size":"14px",color:"#1f2937","font-weight":"500"}},ho={key:0,style:{"font-size":"12px",color:"#6b7280","margin-top":"2px"}},go=["onClick"],vo={key:1,style:{"text-align":"center",padding:"32px",color:"#9ca3af"}},fo={style:{display:"flex","align-items":"center",gap:"12px"}},yo={style:{display:"flex","align-items":"center",gap:"8px"}},xo={key:0,style:{background:"#fee2e2",color:"#991b1b",padding:"4px 12px","border-radius":"20px","font-size":"12px","font-weight":"500"}},bo={key:1,style:{background:"#d1fae5",color:"#065f46",padding:"4px 12px","border-radius":"20px","font-size":"12px","font-weight":"500"}},wo={style:{"border-top":"1px solid #f3f4f6",padding:"16px",background:"#fafafa"}},Do={style:{display:"grid","grid-template-columns":"repeat(4, 1fr)",gap:"12px","margin-bottom":"16px"}},ko={style:{background:"#fff","border-radius":"10px",padding:"12px","text-align":"center",border:"1px solid #e5e7eb"}},So={style:{"font-size":"16px","font-weight":"600",color:"#1f2937"}},$o={style:{background:"#fff","border-radius":"10px",padding:"12px","text-align":"center",border:"1px solid #e5e7eb"}},Co={style:{"font-size":"16px","font-weight":"600",color:"#059669"}},Eo={style:{background:"#fff","border-radius":"10px",padding:"12px","text-align":"center",border:"1px solid #e5e7eb"}},_o={style:{"font-size":"16px","font-weight":"600",color:"#1f2937"}},To={key:0},Io={style:{display:"flex","align-items":"center","justify-content":"space-between","margin-bottom":"12px","padding-bottom":"12px","border-bottom":"1px solid #f3f4f6"}},Po={style:{display:"flex","align-items":"center",gap:"10px"}},Ro={style:{"font-size":"15px","font-weight":"600",color:"#1f2937"}},Mo={style:{"font-size":"13px",color:"#6b7280"}},Ao={style:{background:"#fee2e2",color:"#991b1b",padding:"4px 10px","border-radius":"20px","font-size":"12px","font-weight":"500"}},Oo={style:{display:"flex","align-items":"center",gap:"8px","font-size":"14px",color:"#4b5563"}},No={style:{"font-weight":"500"}},zo={style:{background:"#fecaca",color:"#991b1b",padding:"2px 8px","border-radius":"4px","font-size":"11px","font-weight":"500","margin-left":"auto"}},jo={key:0,style:{"margin-top":"6px","font-size":"13px",color:"#6b7280","padding-left":"24px"}},Fo={key:1,style:{"text-align":"center",padding:"32px"}},Lo={key:2,class:"step-content"},Uo={class:"smart-assessment-section",style:{padding:"24px",background:"linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%)","border-radius":"20px",border:"1px solid #e2e8f0"}},Bo={style:{display:"flex","align-items":"flex-start",gap:"20px",position:"relative","z-index":"1"}},Ho={key:0,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2.5","stroke-linecap":"round","stroke-linejoin":"round"},Wo={key:1,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2.5","stroke-linecap":"round","stroke-linejoin":"round"},Vo={key:2,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2.5","stroke-linecap":"round","stroke-linejoin":"round"},qo={key:3,width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2.5","stroke-linecap":"round","stroke-linejoin":"round"},Jo={style:{flex:"1"}},Go={style:{display:"flex","align-items":"center",gap:"12px","margin-bottom":"8px"}},Yo={style:{margin:"0","font-size":"15px",color:"#475569","line-height":"1.6"}},Xo={class:"metrics-grid",style:{display:"grid","grid-template-columns":"repeat(3, 1fr)",gap:"16px","margin-bottom":"24px"}},Ko={class:"metric-card",style:{background:"white","border-radius":"12px",padding:"20px",border:"2px solid #e0e7ff","box-shadow":"0 2px 8px rgba(59, 130, 246, 0.08)"}},Zo={style:{"font-size":"36px","font-weight":"800",color:"#1e40af","line-height":"1"}},Qo={class:"metric-card",style:{background:"white","border-radius":"12px",padding:"20px",border:"2px solid #d1fae5","box-shadow":"0 2px 8px rgba(16, 185, 129, 0.08)"}},ed={style:{"font-size":"36px","font-weight":"800",color:"#047857","line-height":"1"}},td={class:"metric-card",style:{background:"white","border-radius":"12px",padding:"20px",border:"2px solid #e9d5ff","box-shadow":"0 2px 8px rgba(139, 92, 246, 0.08)"}},ad={style:{"font-size":"36px","font-weight":"800",color:"#6d28d9","line-height":"1"}},nd={style:{position:"relative","z-index":"1"}},sd={style:{background:"white","border-radius":"12px",padding:"16px 20px",display:"flex","align-items":"center","justify-content":"space-between","box-shadow":"0 2px 8px rgba(0,0,0,0.05)","margin-bottom":"12px"}},id={style:{display:"flex","align-items":"center",gap:"12px"}},rd={style:{"font-size":"13px",color:"#6b7280","margin-top":"4px"}},ld={style:{display:"grid","grid-template-columns":"repeat(3, 1fr)",gap:"12px","font-size":"12px"}},od={style:{background:"rgba(255,255,255,0.5)","border-radius":"8px",padding:"10px","text-align":"center",border:"1px solid #d1d5db"}},dd={style:{"font-weight":"700","font-size":"14px",color:"#1f2937"}},cd={style:{background:"rgba(255,255,255,0.5)","border-radius":"8px",padding:"10px","text-align":"center",border:"1px solid #d1d5db"}},ud={style:{"font-weight":"700","font-size":"14px",color:"#1f2937"}},pd={class:"action-options",style:{display:"grid","grid-template-columns":"repeat(3, 1fr)",gap:"16px"}},md=["disabled"],hd={key:1,style:{"margin-top":"16px",padding:"16px 20px",background:"#fef2f2",border:"2px solid #fecaca","border-radius":"12px",display:"flex","align-items":"center",gap:"12px"}},gd={key:3,class:"step-content"},vd={class:"summary-cards",style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"16px","margin-bottom":"24px"}},fd={class:"summary-card",style:{background:"white",border:"2px solid #e0e7ff","border-radius":"12px",padding:"20px"}},yd={style:{margin:"0","font-size":"24px","font-weight":"700",color:"#3b82f6"}},xd={key:0,style:{margin:"8px 0 0","font-size":"13px",color:"#6b7280"}},bd={class:"summary-card",style:{background:"white",border:"2px solid #d1fae5","border-radius":"12px",padding:"20px"}},wd={key:0,style:{margin:"0","font-size":"18px","font-weight":"600",color:"#047857"}},Dd={style:{"margin-top":"8px","font-size":"13px",color:"#6b7280"}},kd={style:{display:"inline-flex","align-items":"center",gap:"4px","margin-right":"12px"}},Sd={key:0,style:{display:"inline-flex","align-items":"center",gap:"4px",color:"#f59e0b"}},$d={class:"summary-card",style:{background:"white",border:"2px solid #e9d5ff","border-radius":"12px",padding:"20px"}},Cd={style:{margin:"0","font-size":"24px","font-weight":"700",color:"#7c3aed"}},Ed={class:"summary-card",style:{background:"white",border:"2px solid #fef3c7","border-radius":"12px",padding:"20px"}},_d={style:{margin:"0","font-size":"16px","font-weight":"600",color:"#b45309"}},Td={style:{margin:"8px 0 0","font-size":"13px",color:"#6b7280"}},Id={class:"constraint-panel",style:{background:"#f9fafb",border:"1px solid #e5e7eb","border-radius":"12px",overflow:"hidden","margin-bottom":"24px"}},Pd={style:{display:"flex","align-items":"center",gap:"12px"}},Rd={style:{margin:"4px 0 0","font-size":"13px",color:"#6b7280"}},Md={style:{padding:"20px","border-top":"1px solid #e5e7eb"}},Ad={style:{display:"grid","grid-template-columns":"repeat(3, 1fr)",gap:"16px"}},Od={class:"constraint-group"},Nd={style:{margin:"0",padding:"0","list-style":"none","font-size":"13px",color:"#4b5563"}},zd={key:0,style:{padding:"4px 0",color:"#10b981"}},jd={key:1,style:{padding:"4px 0",color:"#10b981"}},Fd={key:2,style:{padding:"4px 0",color:"#10b981"}},Ld={key:3,style:{padding:"4px 0",color:"#10b981"}},Ud={key:4,style:{padding:"4px 0",color:"#10b981"}},Bd={key:5,style:{padding:"4px 0",color:"#10b981"}},Hd={key:6,style:{padding:"4px 0",color:"#10b981"}},Wd={key:7,style:{padding:"4px 0",color:"#9ca3af"}},Vd={class:"constraint-group"},qd={style:{margin:"0",padding:"0","list-style":"none","font-size":"13px",color:"#4b5563"}},Jd={style:{padding:"4px 0"}},Gd={style:{padding:"4px 0"}},Yd={style:{padding:"4px 0"}},Xd={style:{padding:"4px 0"}},Kd={key:0,class:"scheduling-progress"},Zd={class:"progress-header"},Qd={class:"progress-percentage"},ec={class:"progress-bar"},tc={class:"progress-details"},ac={class:"progress-text"},nc={key:0,class:"assignment-counter"},sc={key:1,class:"error-section"},ic={class:"error-content"},rc={class:"step-navigation"},lc=["disabled"],oc=["disabled"],dc={key:0},cc={key:1},uc={class:"modal-header"},pc={class:"header-icon"},mc={class:"header-content"},hc={class:"modal-title"},gc={class:"modal-subtitle"},vc={class:"modal-body"},fc={class:"stats-section"},yc={class:"stats-grid"},xc={class:"stat-item success"},bc={class:"stat-value"},wc={class:"stat-item info"},Dc={class:"stat-value"},kc={class:"stat-item info"},Sc={class:"stat-value"},$c={class:"stat-value"},Cc={class:"stat-value"},Ec={key:0,class:"stat-hint"},_c={key:0,class:"violations-section"},Tc={class:"violations-summary"},Ic={class:"violations-count"},Pc={class:"severity-breakdown"},Rc={class:"violations-list"},Mc={class:"violation-header"},Ac={class:"violation-icon"},Oc={class:"violation-title"},Nc={class:"violation-count"},zc={class:"violation-details"},jc={class:"violation-description"},Fc={key:0,class:"more-violations"},Lc={key:1,class:"success-section"},Uc={class:"success-message"},Bc={class:"success-content"},Hc={key:2,class:"partial-success-section"},Wc={class:"partial-success-message"},Vc={class:"partial-success-content"},qc={class:"warning-detail"},Jc="schedules_page_",Gc=z(t({__name:"SchedulesPage",setup(t){const w=e=>e?Y(e):"-",$=E(),C=a("8.0.15"),A=a(!1),z=a(null),H=a(!1),G=a(!1),K=a(""),ee=a(""),te=a(null),se=a(!1),re=a(!1),oe=a([]),de=a(!1),he=a(""),ge=a({needsCleanup:!1,snapshotCount:0,recommendedDeleteCount:0}),be=a(!1),De=a(!1),ke=a([]),Se=a([]),Ce=a(!1),Ee=a(null),_e=a(null),Te=a([]),Re=a(null),Me=a("");s(G,e=>{e&&Fu()});let Ae=null,Oe=null,Ne=null,ze=null,je=null,Be=0,He=!1;a(!1),a(!1),a("正在初始化..."),a(""),a(0),a(0),a(!1),a(""),a(!1);const We=a(!1),Ge=a(""),Ye=a(2);n(()=>za.value.filter(e=>!lu(String(e.id))).length);const Xe=()=>{try{const e={scheduleResults:za.value,studentList:Oa.value,teacherList:Na.value,examStartDateStr:st.value,examEndDateStr:it.value,constraints:ot.value,currentSnapshotInfo:te.value,timestamp:(new Date).toISOString()};localStorage.setItem(Jc+"state",JSON.stringify(e))}catch(e){}},Ke=a(!1),Ze=a(!1),Qe=a(!1),et=a(0),tt=()=>{const e=W.getAssignmentData();Qe.value=null!==e&&e.length>0,et.value=(null==e?void 0:e.length)||0,fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:checkAssignmentData",message:"checking assignment data availability",data:{hasData:Qe.value,count:et.value},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"DataFlow"})}).catch(()=>{})},at=()=>{const e=W.getAssignmentData();if(!e||0===e.length)return void pe.warning("没有可导入的考官分配数据，请先在考官分配页面完成分配");fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:handleImportFromAssignment",message:"importing from assignment page",data:{studentCount:e.length,firstStudent:e[0]?{name:e[0].name,dept:e[0].department,group:e[0].group,examiner1:e[0].examiner1,examiner2:e[0].examiner2}:null},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"DataFlow"})}).catch(()=>{});const t=V(e);fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:handleImportFromAssignment:converted",message:"converted student data",data:{convertedCount:t.length,firstConverted:t[0]?{name:t[0].name,dept:t[0].department,group:t[0].group,recommendedExaminer1Dept:t[0].recommendedExaminer1Dept,recommendedExaminer2Dept:t[0].recommendedExaminer2Dept}:null},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"DataFlow"})}).catch(()=>{}),Oa.value=t,qt.value={name:`考官分配导入_${e.length}人.json`,size:JSON.stringify(e).length,type:"application/json",file:null},pe.success({message:`成功导入 ${t.length} 名学员数据（含推荐考官科室信息）`,duration:3e3})},nt=a(1),st=a(""),it=a("");s(st,(e,t)=>{}),s(it,(e,t)=>{});const rt=a("optaplanner"),lt=[{value:"optaplanner",label:"OptaPlanner 经典算法",description:"稳定可靠的传统算法",icon:"🛡️",features:["高稳定性","成熟可靠","企业级"],recommended:!0}],ot=a({workdaysOnlyExam:!0,examinerDepartmentRules:!0,twoMainExaminersRequired:!0,noDayShiftExaminer:!0,consecutiveTwoDaysExamEnabled:!0,noExaminerTimeConflict:!0,mustHaveTwoDifferentDepartmentExaminers:!0,backupExaminerMustBeDifferentPerson:!0,nightShiftTeacherPriority:!0,examiner2ProfessionalMatch:!0,firstRestDayTeacherPriority:!0,backupExaminerProfessionalMatch:!0,secondRestDayTeacherPriority:!0,examiner2AlternativeOption:!0,adminTeacherPriority:!0,backupExaminerAlternativeOption:!0,allowDept37CrossUse:!0,balanceWorkload:!0,preferLaterDates:!0,avoidWeekendSchedulingEnabled:!0,preferNightShiftOnWeekendEnabled:!0,enableTimeSpreadOptimization:!0,enableDynamicWeightAdjustment:!0,enableIntelligentConflictResolution:!0,enableEarlyWarningSystem:!0,enableHistoricalDataOptimization:!0});a({preferNightShiftTeachers:100,preferRecommendedExaminer2:90,preferFirstRestDayTeachers:80,preferRecommendedBackup:70,preferSecondRestDayTeachers:60,preferNonRecommendedExaminer2:50,preferAdminTeachers:40,preferNonRecommendedBackup:30,allowDept37CrossUse:20,balanceWorkload:10,preferLaterDates:5});const dt=a(""),ct=a(!1),ut=a("");a(!1);const pt=a([]),mt=(e,t,a)=>pt.value.find(n=>n.rowIndex===e&&n.cellType===t&&n.day===a),ht=(e,t)=>{if(!e||!e.manualEdits||!Array.isArray(e.manualEdits))return null;const a=e.manualEdits.filter(e=>e.field===t);return a.length>0?a[a.length-1]:null},gt=(e,t)=>{if(!e)return"";if(!e.manualEdits||!Array.isArray(e.manualEdits)||0===e.manualEdits.length)return"";const a=ht(e,t);if(!a)return"";const n=a.conflicts||[],s=n.some(e=>"error"===e.severity||"high"===e.severity||"hard"===e.type),i=n.some(e=>"warning"===e.severity||"medium"===e.severity||"soft"===e.type),r=n.some(e=>"low"===e.severity||"NOT_RECOMMENDED"===e.type||"LOW_RECOMMENDATION"===e.type),l=!0===a.isForced,o=a.wasRecommended||!1,d=a.recommendationScore||0,c=a.recommendationPriority||"none";let u="";return u=s||l?"manually-edited-error":i||!o||d<60?"manually-edited-warning":r||d<80||"low"===c||"medium"===c?"manually-edited-info":"manually-edited-success",u},vt=(e,t)=>{const a=ht(e,t);if(!a)return"";const n=a.conflicts||[];let s=`✏️ 人工修改 (${a.timestamp?new Date(a.timestamp).toLocaleString("zh-CN"):""})\n`;if(s+=`原值: ${a.originalValue||"无"} → 新值: ${a.newValue}\n`,a.wasRecommended){const e=a.recommendationScore||0,t=a.recommendationPriority||"none";s+=`\n💡 智能推荐：评分 ${e}%，优先级 ${"high"===t?"高":"medium"===t?"中":"低"}`,e>=80&&"high"===t?s+="\n🟢 优质推荐：符合多项最佳实践":e>=60&&(s+="\n🔵 可接受推荐：基本符合要求")}else s+="\n🟠 未在推荐列表：可能存在更优选择";return a.reason&&(s+=`\n原因: ${a.reason}`),n.length>0&&(s+="\n\n⚠️ 冲突提示:\n",n.forEach((e,t)=>{s+=`${t+1}. ${e.title||e.message||e.description}\n`})),a.isForced&&(s+="\n🔥 强制修改：已忽略约束警告"),s},ft=a(0),yt=a(0);a([]);const xt=a(null),bt=a(null),wt=n(()=>ft.value>0?ft.value:va.estimatedAssignmentCount.value),Dt=(e,t="info")=>{const a=new Date,n=`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}:${a.getSeconds().toString().padStart(2,"0")}`;kt.value.push({time:n,message:e,type:t}),kt.value.length>50&&(kt.value=kt.value.slice(-50))},kt=a([]),St=a(!1),$t=a(!1),Ct=a(!1),Et=a(0),_t=a(0),Tt=a(!1),It=a(!1),Pt=a([]),Rt=a(!1),Mt=a(null),At=a(!0),Ot=a(0),Nt=a(!1),zt=n(()=>Nt.value?Oa.value:Oa.value.slice(0,10)),jt=n(()=>Oa.value.some(e=>e.recommendedExaminer1Dept||e.recommendedExaminer2Dept||e.recommendedBackupDept)),Ft=n(()=>{const e={};return Oa.value.forEach(t=>{const a=t.department||"未知";e[a]=(e[a]||0)+1}),Object.entries(e).map(([e,t])=>`${e}(${t})`).join(", ")}),Lt=n(()=>{const e={};return Oa.value.forEach(t=>{const a=t.group||"未知";e[a]=(e[a]||0)+1}),Object.entries(e).map(([e,t])=>`${e}(${t})`).join(", ")}),Ut=e=>{const t=e.examDays||2;2===t?(e.day1Subjects=["现场","模拟机1"],e.day2Subjects=["模拟机2","口试"],e.examType="两天考试（Day1: 现场+模拟机1, Day2: 模拟机2+口试）"):1===t&&(e.day1Subjects=["模拟机"],e.day2Subjects=[],e.examType="一天考试（模拟机）")},Bt=e=>2===(e.examDays||2)?"D1:现场+模拟机1 / D2:模拟机2+口试":"D1:模拟机",Ht=()=>{Oa.value.forEach(e=>{e.examDays||(e.examDays=2,Ut(e))})},Wt=n(()=>{const e=new Date;return J.toStorageDate(e)}),Vt=a(null),qt=a(null),Jt=a(!1),Gt=a({x:0,y:0}),Yt=a({x:0,y:0}),Xt=a(null),Kt=a(!1),Zt=a(!1);a(!1),a(!0);const Qt=a(!0),ea=a(!1),ta=a(!0),aa=a("single"),na=a(""),sa=a(""),ia=a(""),ra=a([]),la=a(null),oa=a(""),da=a(null),ca=a(!1),ua=a(0),pa=a(null),ma=a(!1),ha=a(0),ga=a("fast"),va=function(e={}){const{estimatedDuration:t=3e4,enableAdaptive:s=!0}=e,i=a(0),r=a({name:"init",description:"初始化中...",minProgress:0,maxProgress:10,isDeterministic:!0}),l=a(""),o=a(!0),d=a(0),c=a(0),u=a(0),p=[{name:"init",description:"初始化求解器...",minProgress:0,maxProgress:10,isDeterministic:!0},{name:"construction",description:"构造初始解...",minProgress:10,maxProgress:40,isDeterministic:!0},{name:"local-search",description:"局部搜索优化...",minProgress:40,maxProgress:90,isDeterministic:!1},{name:"post-processing",description:"后处理中...",minProgress:90,maxProgress:100,isDeterministic:!0}],m=n(()=>r.value),h=n(()=>p.map(e=>({...e,isActive:e.name===r.value.name,isCompleted:e.maxProgress<=i.value})));function g(e,t,a){const n=Math.max(0,Math.min(100,e)),s=i.value;if(Math.abs(n-s)>10){const e=n>s?5:-5;i.value=Math.max(0,Math.min(100,s+e))}else i.value=n;if(t){const e=p.find(e=>e.name===t);e&&(r.value=e)}if(a&&(l.value=a),!t)for(const l of p)if(i.value>=l.minProgress&&i.value<l.maxProgress){r.value=l,o.value=l.isDeterministic;break}}function v(e){const t=p.find(t=>t.name===e);t&&(r.value=t,o.value=t.isDeterministic,i.value=t.minProgress)}const f=n({get:()=>i.value,set:e=>g(e)}),y=n(()=>({value:{name:r.value.name,desc:r.value.description,progress:i.value}})),x=n(()=>c.value);return{currentProgress:i,currentPhase:r,progressMessage:l,isDeterministic:o,phaseInfo:m,allPhasesStatus:h,setProgress:g,setPhase:v,setTotalAssignments:function(e){c.value=e},setActualAssignmentCount:function(e){if(u.value=e,"construction"===r.value.name&&c.value>0){const t=e/c.value*30+10;g(Math.min(40,t))}},start:function(){d.value=Date.now(),v("construction"),l.value="开始求解..."},pause:function(){l.value="已暂停"},complete:function(){i.value=100,v("post-processing"),l.value="完成"},reset:function(){i.value=0,v("init"),l.value="",d.value=0,c.value=0,u.value=0},progress:f,currentStage:y,estimatedAssignmentCount:x}}({estimatedDuration:3e4,enableAdaptive:!0}),fa=n(()=>va.progress.value),ya=a(0),xa=a(3e4);n(()=>za.value.some(e=>"计算中..."===e.date1||"分配中..."===e.examiner1_1||"分配中..."===e.examiner2_1));const ba=a(void 0),wa=a(void 0),Da=a(!1),ka=a({});let $a=null;const Ca=()=>{null!==$a&&(clearInterval($a),$a=null)},Ea=a(!1);let Ta=null;const Ia=n(()=>!!Da.value||!!Kt.value&&!Ea.value),Pa=()=>{va.pause(),Ca()},Ra=()=>{Da.value=!1,_(()=>{const e=document.querySelector(".table-container");e&&e.scrollIntoView({behavior:"smooth",block:"start"})})},Ma=a(null),Aa=a(null);n(()=>{const e=new Date;return e.setHours(0,0,0,0),e});const Oa=a([]),Na=a([]),za=a([]),ja=a(new Set),Fa=a(!1),La=a(null),Ua=a(1),Ba=a(!1),Ha=a(0),Wa=a(0),Va=a(!1),qa=()=>{Ke.value=!1,Yt.value={x:0,y:0}},Ja=()=>{nt.value=1,qt.value=null,rt.value="optaplanner",ot.value={workdaysOnlyExam:!0,examinerDepartmentRules:!0,twoMainExaminersRequired:!0,noDayShiftExaminer:!0,consecutiveTwoDaysExamEnabled:!0,noExaminerTimeConflict:!0,mustHaveTwoDifferentDepartmentExaminers:!0,backupExaminerMustBeDifferentPerson:!0,nightShiftTeacherPriority:!0,examiner2ProfessionalMatch:!0,firstRestDayTeacherPriority:!0,backupExaminerProfessionalMatch:!0,secondRestDayTeacherPriority:!0,examiner2AlternativeOption:!0,adminTeacherPriority:!0,backupExaminerAlternativeOption:!0,allowDept37CrossUse:!0,balanceWorkload:!0,preferLaterDates:!0,avoidWeekendSchedulingEnabled:!0,preferNightShiftOnWeekendEnabled:!0,enableTimeSpreadOptimization:!0,enableDynamicWeightAdjustment:!0,enableIntelligentConflictResolution:!0,enableEarlyWarningSystem:!0,enableHistoricalDataOptimization:!0},ga.value="auto",Yt.value={x:0,y:0}},Ga=()=>{if(za.value.length>0){const e=`检测到当前已有排班结果 (${za.value.length} 条记录)\n\n是否需要先导出当前排班结果？\n\n⚠️ 开始新的排班流程后，当前结果将被覆盖。\n\n点击"确定"导出当前结果\n点击"取消"直接开始新排班`;confirm(e)?(Iu(),setTimeout(()=>{confirm("导出完成！\n\n是否继续新建排班？")&&(Ja(),tt(),Ke.value=!0)},500)):(Ja(),tt(),Ke.value=!0)}else Ja(),tt(),Ke.value=!0},Ya=e=>{var t;Jt.value=!0;const a=null==(t=Xt.value)?void 0:t.getBoundingClientRect();a&&(Gt.value={x:e.clientX-a.left,y:e.clientY-a.top}),document.addEventListener("mousemove",Xa),document.addEventListener("mouseup",Ka),e.preventDefault()},Xa=e=>{if(!Jt.value)return;const t=e.clientX-Gt.value.x,a=e.clientY-Gt.value.y,n=window.innerWidth-300,s=window.innerHeight-100;Yt.value={x:Math.max(-200,Math.min(t,n)),y:Math.max(0,Math.min(a,s))}},Ka=()=>{Jt.value=!1,document.removeEventListener("mousemove",Xa),document.removeEventListener("mouseup",Ka)},Za=()=>{var e;null==(e=Vt.value)||e.click()},Qa=async e=>{var t;const a=null==(t=e.target.files)?void 0:t[0];if(a){qt.value={name:a.name,size:a.size,type:a.type,file:a};try{a.type.includes("csv")?await nn(a):(a.type.includes("excel")||a.name.endsWith(".xlsx")||a.name.endsWith(".xls"))&&await sn(a)}catch(n){alert("文件解析失败，请检查文件格式")}}},en=a(!1),tn=a([]),an=a([]),nn=async e=>new Promise((t,a)=>{const n=new FileReader;n.onload=e=>{var n;try{const s=(null==(n=e.target)?void 0:n.result).split("\n").filter(e=>e.trim());if(s.length<2)return void a(new Error("文件内容不足，至少需要标题行和一行数据"));s[0].split(",").map(e=>e.trim());const i=[];for(let e=1;e<s.length;e++){const t=s[e].split(",").map(e=>e.trim());if(t.length>=2){let a=t[1]||"一";const n={"区域一室":"一","区域二室":"二","区域三室":"三","区域四室":"四","区域五室":"五","区域六室":"六","区域七室":"七","区域八室":"八","一室":"一","二室":"二","三室":"三","四室":"四","五室":"五","六室":"六","七室":"七","八室":"八","1室":"一","2室":"二","3室":"三","4室":"四","5室":"五","6室":"六","7室":"七","8室":"八","区域1":"一","区域2":"二","区域3":"三","区域4":"四",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"七",8:"八"}[a.trim()]||a,s={id:e.toString(),name:t[0]||`学员${e}`,department:n,group:t[2]||"一组",recommendedExaminer1Dept:t[3]||void 0,recommendedExaminer2Dept:t[4]||void 0,recommendedBackupDept:t[5]||void 0};fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:parseCSVFile",message:"parsed student data",data:{name:s.name,department:s.department,group:s.group,recommendedExaminer1Dept:s.recommendedExaminer1Dept,recommendedExaminer2Dept:s.recommendedExaminer2Dept},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"E"})}).catch(()=>{}),i.push(s)}}i.length>0&&(Oa.value=i,Ht()),t(i)}catch(s){a(s)}},n.onerror=()=>a(new Error("文件读取失败")),n.readAsText(e,"UTF-8")}),sn=async t=>new Promise((a,n)=>{const s=new FileReader;s.onload=async t=>{var s;try{const i=await e(()=>import("./excel-C2s3b8zA.js").then(e=>e.x),__vite__mapDeps([0,1]),import.meta.url),r=new Uint8Array(null==(s=t.target)?void 0:s.result),l=i.read(r,{type:"array"}),o=l.SheetNames[0],d=l.Sheets[o],c=i.utils.sheet_to_json(d,{header:1});if(c.length<2)return void n(new Error("Excel文件内容不足，至少需要标题行和一行数据"));const u=[],p=c[0],m=p.findIndex(e=>e&&(e.includes("姓名")||e.includes("学员")||e.includes("名字")||"姓名"===e||"学员"===e||"名字"===e));let h=p.findIndex(e=>e&&(e.includes("科室")||e.includes("部门")||e.includes("区域")));-1===h&&(h=p.findIndex(e=>e&&(e.includes("区域")||e.includes("一室")||e.includes("二室")||e.includes("三室")||e.includes("四室")||e.includes("五室")||e.includes("六室")||e.includes("七室"))));const g=p.findIndex(e=>e&&(e.includes("班组")||e.includes("组别")||e.includes("班组")||e.includes("班次")||"班组"===e||"组别"===e||"班组"===e||"班次"===e)),v=p.findIndex(e=>e&&(e.includes("考官一")||e.includes("考官1")||e.includes("第一考官")||"考官一"===e||"考官1"===e||"第一考官"===e)),f=p.findIndex(e=>e&&(e.includes("考官二")||e.includes("考官2")||e.includes("第二考官")||"考官二"===e||"考官2"===e||"第二考官"===e)),y=p.findIndex(e=>e&&(e.includes("备份考官")||e.includes("备份")||e.includes("候补考官")||"备份考官"===e||"备份"===e||"候补考官"===e));for(let e=1;e<c.length;e++){const t=c[e];if(t&&t.length>0&&t[m]){const a=t[m]||`学员${e}`;let n=t[h]||"一",s=g>=0&&t[g]||"";if(n){n=n.toString().trim();const e={"区域一室":"一","区域二室":"二","区域三室":"三","区域四室":"四","区域五室":"五","区域六室":"六","区域七室":"七","区域八室":"八","区域九室":"九","区域十室":"十","一室":"一","二室":"二","三室":"三","四室":"四","五室":"五","六室":"六","七室":"七","八室":"八","九室":"九","十室":"十","区域1室":"一","区域2室":"二","区域3室":"三","区域4室":"四","区域5室":"五","区域6室":"六","区域7室":"七","区域8室":"八","区域9室":"九","区域10室":"十","1室":"一","2室":"二","3室":"三","4室":"四","5室":"五","6室":"六","7室":"七","8室":"八","9室":"九","10室":"十","区域一":"一","区域二":"二","区域三":"三","区域四":"四","区域五":"五","区域六":"六","区域七":"七","区域八":"八","区域九":"九","区域十":"十","区域1":"一","区域2":"二","区域3":"三","区域4":"四","区域5":"五","区域6":"六","区域7":"七","区域8":"八","区域9":"九","区域10":"十","一":"一","二":"二","三":"三","四":"四","五":"五","六":"六","七":"七","八":"八","九":"九","十":"十",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"七",8:"八",9:"九",10:"十"}[n];e?n=e:n.includes("一")||n.includes("1")?n="一":n.includes("二")||n.includes("2")?n="二":n.includes("三")||n.includes("3")?n="三":n.includes("四")||n.includes("4")?n="四":n.includes("五")||n.includes("5")?n="五":n.includes("六")||n.includes("6")?n="六":n.includes("七")||n.includes("7")?n="七":n.includes("八")||n.includes("8")?n="八":n.includes("九")||n.includes("9")?n="九":(n.includes("十")||n.includes("10"))&&(n="十")}if(s){s=s.toString().trim();const e={1:"一",2:"二",3:"三",4:"四"};/^[一二三四]组$/.test(s)||(/^[1-4]组$/.test(s)?s=s.replace(/^[1-4]/,t=>e[t]):/^[一二三四]$/.test(s)?s+="组":/^[1-4]$/.test(s)&&(s=e[s]+"组"))}else s="一组";let i=v>=0?(t[v]||"").toString().trim():void 0,r=f>=0?(t[f]||"").toString().trim():void 0,l=y>=0?(t[y]||"").toString().trim():void 0;if(!i&&!r){const e=p.findIndex(e=>e&&(e.includes("推荐考官")||e.includes("推荐科室")||e.includes("考官安排")||"推荐考官"===e||"推荐科室"===e||"考官安排"===e));if(e>=0){const a=(t[e]||"").toString().trim(),n=/考官一[：:]\s*([^，,]+)[，,]?\s*考官二[：:]\s*([^，,]+)/,s=/考官1[：:]\s*([^，,]+)[，,]?\s*考官2[：:]\s*([^，,]+)/;let l=a.match(n)||a.match(s);l&&(i=l[1].trim(),r=l[2].trim())}}u.push({id:e.toString(),name:a,department:n,group:s,recommendedExaminer1Dept:i||void 0,recommendedExaminer2Dept:r||void 0,recommendedBackupDept:l||void 0})}}u.length>0&&(Oa.value=u,Ht()),a(u)}catch(i){n(i)}},s.onerror=()=>n(new Error("文件读取失败")),s.readAsArrayBuffer(t)}),rn=()=>{en.value=!1,tn.value=[],an.value=[]},ln=()=>{jn()&&nt.value++},on=()=>{nt.value>1&&nt.value--};a(""),a(null);const dn=()=>{if(!st.value||!it.value)return 0;const e=new Date(st.value),t=new Date(it.value);if(e>t)return 0;const a=Math.abs(t.getTime()-e.getTime());return Math.ceil(a/864e5)+1},cn=()=>{const e=["teachers","examiner_teachers","unified_teachers","teacher_data","teacherList"];for(const a of e)try{const e=localStorage.getItem(a);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0)return t.length}}catch(t){}return 0},un=()=>{if(!st.value||!it.value)return[];const e=new Date(st.value),t=new Date(it.value);let a=[];const n=["teachers","examiner_teachers","unified_teachers","teacher_data","teacherList"];for(const r of n)try{const e=localStorage.getItem(r);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){a=t;break}}}catch(i){}const s=[];return a.forEach(a=>{if(!a.unavailablePeriods||0===a.unavailablePeriods.length)return;const n=[];a.unavailablePeriods.forEach(a=>{const s=new Date(a.startDate),i=new Date(a.endDate);if(!(i<e||s>t)){const r=s<e?e:s,l=i>t?t:i,o=Math.ceil((l.getTime()-r.getTime())/864e5)+1;n.push({...a,overlapDays:o})}}),n.length>0&&s.push({teacher:a,periods:n})}),s},pn=e=>{nt.value=e},mn=async()=>{const e=Date.now();if(da.value&&e-ua.value<5e3)return da.value;if(ca.value)return da.value;ca.value=!0;try{const t=await gn();if(!t)return null;const a=await bs.performAssessment(t);return da.value=a,ua.value=e,a}catch(t){return null}finally{ca.value=!1}},hn=async()=>{const e=Date.now();if(pa.value&&e-ha.value<5e3)return pa.value;if(ma.value)return pa.value;ma.value=!0;try{const t=await gn();if(!t)return null;const a=await ws.performPreciseAssessment(t);return pa.value=a,ha.value=e,a}catch(t){return null}finally{ma.value=!1}},gn=async()=>{const e=Oa.value,t=await vn(),a=fn(),n=yn(),s=await xn();return 0===e.length||0===t.length||0===a.length?null:{students:e,teachers:t,examDates:a,unavailableDates:n,dutySchedule:s,config:{constraints:{maxExamsPerDay:ot.value.maxExamsPerDay||11,avoidWeekendScheduling:!ea.value}}}},vn=async()=>{const e=["teachers","examiner_teachers","unified_teachers","teacher_data","teacherList"];for(const a of e)try{const e=localStorage.getItem(a);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0)return t}}catch(t){}return[]},fn=()=>{const e=[];if(!st.value||!it.value)return e;const t=J.parseDate(st.value),a=J.parseDate(it.value);if(!t||!a)return e;const n=new Date(t);for(;n<=a;){const t=n.getDay(),a=0===t||6===t,s=J.toStandardDate(n);if(a&&!ea.value){n.setDate(n.getDate()+1);continue}if(Ve.isHoliday(s)){n.setDate(n.getDate()+1);continue}ra.value.some(e=>{if(e.endDate){const t=J.parseDate(e.date),a=J.parseDate(e.endDate);return n>=t&&n<=a}return J.toStandardDate(n)===e.date})||e.push(new Date(n)),n.setDate(n.getDate()+1)}return e},yn=()=>{const e=[];for(const t of ra.value)if(t.endDate){const a=J.parseDate(t.date),n=J.parseDate(t.endDate);if(a&&n){const t=new Date(a);for(;t<=n;)e.push(new Date(t)),t.setDate(t.getDate()+1)}}else{const a=J.parseDate(t.date);a&&e.push(a)}return e},xn=async()=>{const e=new Map;try{const t=await q.getCurrentSchedule();if(t&&t.dutyDates)for(const a of t.dutyDates)if(a.teacherId){const t=e.get(a.teacherId)||[];t.push(a.date),e.set(a.teacherId,t)}}catch(t){}return e},wn=()=>{const e=An(),t=Oa.value.length,a=cn(),n=e.workdays,s=pa.value;if(s){if(!s.constraintChecks.hc6.isSatisfied){const{validDatePairs:e,requiredForTwoDayStudents:t}=s.constraintChecks.hc6;return{icon:"⚠️",title:"连续考试日期不足（HC6约束）",description:`需要${t}个连续日期对用于两天考试，但仅有${e}个可用。当前日期范围无法满足连续两天考试要求。`,color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"日期不足",showRecommendation:!0}}if(!s.constraintChecks.hc2_hc7.isSatisfied){return{icon:"⚠️",title:"科室考官资源不足（HC2/HC7约束）",description:`部门"${s.constraintChecks.hc2_hc7.departmentsWithZeroCapacity.join("、")}"没有可用考官组合，无法满足同科室考官1+不同科室考官2的要求。`,color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"科室资源不足",showRecommendation:!0}}if(!s.constraintChecks.hc4.isSatisfied){const{requiredExamsPerDay:e,maxExamsPerDay:t}=s.constraintChecks.hc4;return{icon:"⚠️",title:"每日考试场次超限（HC4约束）",description:`每天需要安排${e}场考试，但考官资源每天最多支持${t}场（每名考官每天只能监考一场）。`,color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"场次超限",showRecommendation:!0}}if(!s.isFeasible){const e=s.criticalDepartment,t=s.issues[0];return{icon:"⚠️",title:e?`部门"${e}"排班不可行`:"当前配置无法完成排班",description:(null==t?void 0:t.message)||"选定日期范围内无法满足所有硬约束，建议延长日期范围或调整考官配置。",color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"不可行",showRecommendation:!0}}if(s.confidence>.8)return{icon:"✅",title:"配置可行（高置信度）",description:`精确评估通过：${s.departmentCapacities.length}个科室资源充足，${s.constraintChecks.hc6.validDatePairs}个连续日期对可用。`,color:"#10b981",lightColor:"#d1fae5",status:"success",statusClass:"status-success",badgeText:"推荐",showRecommendation:!1}}if(0===t)return{icon:"⚠️",title:"缺少学员数据",description:"请先导入学员名单，确保有足够的学员需要排班",color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"数据缺失",showRecommendation:!1};if(a<2)return{icon:"⚠️",title:"考官数量不足",description:"可用考官过少，每场考试需要2名考官，无法完成排班",color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"配置错误",showRecommendation:!1};if(0===n)return{icon:"⚠️",title:"无可用工作日",description:"请重新选择考试日期范围，确保有足够的工作日",color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"日期错误",showRecommendation:!0};const i=2*t,r=Math.floor(a/2),l=r*n;if(i>l){return{icon:"⚠️",title:"容量严重不足",description:`需要安排${i}场考试，但当前配置最多支持${l}场。建议扩大至${Math.ceil(i/r)}个工作日或增加考官。`,color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"容量不足",showRecommendation:!0}}const o=(()=>{const e=Oa.value,t=cn();if(0===e.length||0===t)return{hasIssue:!1,critical:!1,issues:[]};const a=pa.value;if(null==a?void 0:a.departmentCapacities){const e=[];let t=!1;for(const n of a.departmentCapacities)"critical"===n.severity?(e.push({dept:n.department,studentCount:n.studentCount,teacherCount:n.availableExaminers,severity:"critical",message:`科室"${n.department}"${0===n.availableExaminers?"没有可用考官":"连续日期对不足"}：${n.twoDayStudentCount}名两天学员需要${n.requiredDatePairs}个日期对，但仅有${n.availableDatePairs.length}个`}),t=!0):"high"!==n.severity&&"medium"!==n.severity||e.push({dept:n.department,studentCount:n.studentCount,teacherCount:n.availableExaminers,severity:"warning",message:`科室"${n.department}"资源紧张：${n.studentCount}名学员，可用日期对${n.availableDatePairs.length}/${n.requiredDatePairs}`});return{hasIssue:e.length>0,critical:t,issues:e}}const n=da.value;if(null==n?void 0:n.bottlenecks){const e=[];let t=!1;for(const a of n.bottlenecks)"critical"===a.severity?(e.push({dept:a.department,studentCount:a.studentCount,teacherCount:a.availableExaminerCount,severity:"critical",message:`科室"${a.department}"${0===a.availableExaminerCount?"没有可用考官":"容量严重不足"}：需要${a.totalExamsNeeded}场考试，可用容量${a.actualAvailableCapacity}场`}),t=!0):"high"!==a.severity&&"medium"!==a.severity||e.push({dept:a.department,studentCount:a.studentCount,teacherCount:a.availableExaminerCount,severity:"warning",message:`科室"${a.department}"资源紧张：${a.studentCount}名学员需${a.totalExamsNeeded}场考试，利用率${(100*a.utilizationRate).toFixed(0)}%`});return{hasIssue:e.length>0,critical:t,issues:e}}const s=e=>{if(!e)return"未知";const t=e.trim(),a={1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"七",8:"八",9:"九",10:"十"};return/^区域[一二三四五六七八九十]室$/.test(t)?t.substring(2,3):/^[一二三四五六七八九十]室$/.test(t)?t.substring(0,1):/^[一二三四五六七八九十]$/.test(t)?t:/^\d+室$/.test(t)?a[t.replace("室","")]||t:/^\d+$/.test(t)&&a[t]||t},i=new Map;e.forEach(e=>{const t=s(e.department);i.set(t,(i.get(t)||0)+1)});let r=[];const l=["teachers","examiner_teachers","unified_teachers","teacher_data","teacherList"];for(const p of l)try{const e=localStorage.getItem(p);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.length>0){r=t;break}}}catch(u){}const o=new Map;r.forEach(e=>{const t=s(e.department);o.set(t,(o.get(t)||0)+1)});const d=[];let c=!1;return i.forEach((e,t)=>{let a=o.get(t)||0;if("三"===t||"七"===t){const e="三"===t?"七":"三";a+=o.get(e)||0}const n=2*e,s=An().workdays,i=a*s;0===a?(d.push({dept:t,studentCount:e,teacherCount:0,severity:"critical",message:`科室"${t}"有${e}名学员，但没有可用考官，无法完成排班`}),c=!0):n>i?(d.push({dept:t,studentCount:e,teacherCount:a,severity:"critical",message:`科室"${t}"资源不足：${e}名学员需${n}场考试，但${a}名考官在${s}天内最多只能安排${i}场`}),c=!0):n>.8*i&&d.push({dept:t,studentCount:e,teacherCount:a,severity:"warning",message:`科室"${t}"资源紧张：${e}名学员需${n}场考试，${a}名考官容量为${i}场`})}),{hasIssue:d.length>0,critical:c,issues:d}})();if(o.critical){return{icon:"⚠️",title:"科室资源不匹配",description:o.issues[0].message,color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"无法排班",showRecommendation:!1}}const d=Math.ceil(i/n);if(d>r){return{icon:"⚠️",title:"每日容量不足",description:`每天需要安排${d}场考试，但考官资源每天最多支持${r}场。建议扩大至${Math.ceil(i/r)}个工作日。`,color:"#ef4444",lightColor:"#fef2f2",status:"error",statusClass:"status-error",badgeText:"需要调整",showRecommendation:!0}}if(o.hasIssue){return{icon:"⚠️",title:"科室资源紧张",description:o.issues[0].message,color:"#f59e0b",lightColor:"#fffbeb",status:"warning",statusClass:"status-warning",badgeText:"资源紧张",showRecommendation:!1}}const c=un().length,u=c/a;if(u>.3)return{icon:"⚠️",title:"考官可用性受限",description:`${c}名考官（${Math.round(100*u)}%）在选定日期范围内不可用，可能导致排班困难。建议调整日期范围。`,color:"#f59e0b",lightColor:"#fffbeb",status:"warning",statusClass:"status-warning",badgeText:"可用性低",showRecommendation:!0};if(d>.8*r)return{icon:"⚠️",title:"日程较紧张",description:`每天需要安排${d}场考试，接近容量上限${r}场。排班可行但选择有限。`,color:"#f59e0b",lightColor:"#fffbeb",status:"warning",statusClass:"status-warning",badgeText:"日程紧张",showRecommendation:!0};const p=(()=>{const e=An(),t=ra.value.length;if(0===t)return{hasIssue:!1,message:""};const a=e.totalDays,n=t;return n>=.5*a?{hasIssue:!0,message:`设置了 ${n} 天不可用日期，占总日期范围的 ${Math.round(n/a*100)}%，可能严重影响排班效果`}:n>0?{hasIssue:!1,message:`已设置 ${n} 天不可用日期`}:{hasIssue:!1,message:""}})();return p.hasIssue?{icon:"⚠️",title:"日期设置有影响",description:p.message,color:"#f59e0b",lightColor:"#fffbeb",status:"warning",statusClass:"status-warning",badgeText:"日期受限",showRecommendation:!0}:d<=3?{icon:"✅",title:"配置完美",description:`当前配置非常合理，每天仅需安排${d}场考试，可以获得优质的排班结果`,color:"#10b981",lightColor:"#d1fae5",status:"success",statusClass:"status-success",badgeText:"推荐",showRecommendation:!1}:{icon:"✅",title:"配置可行",description:`当前配置可以完成排班，每天需要安排 ${d} 场考试`,color:"#10b981",lightColor:"#d1fae5",status:"success",statusClass:"status-success",badgeText:"可行",showRecommendation:!1}},Dn=()=>{var e;const t=Oa.value.length,a=cn();if(0===t||a<2)return null;const n=pa.value;if(null==(e=null==n?void 0:n.dateAnalysis)?void 0:e.recommendedDateRange){const e=n.dateAnalysis.recommendedDateRange,t=An().workdays,a=J.toStandardDate(e.startDate),s=J.toStandardDate(e.endDate),i=e.status||"good";let r;switch(i){case"insufficient":r=`⚠️ ${e.reason}`;break;case"suboptimal":r=e.requiredDays>t?`💡 ${e.reason}`:`💡 当前${t}天可以完成排班，但延长日期可获得更好效果`;break;default:r=`✅ 当前${t}天的配置可以顺利完成排班，资源配置合理`}return{start:a,end:s,display:`${J.toDisplayDate(a)} 至 ${J.toDisplayDate(s)}`,requiredWorkdays:e.requiredDays,recommendedWorkdays:e.requiredDays,currentWorkdays:t,status:i,message:r,bottleneckInfo:n.departmentCapacities.filter(e=>e.isBottleneck).map(e=>({department:e.department,requiredPairs:e.requiredDatePairs,availablePairs:e.availableDatePairs.length,deficit:e.deficit}))}}const s=da.value;if(null==s?void 0:s.dateRecommendation){const e=s.dateRecommendation,t=An().workdays,a=J.toStandardDate(e.recommendedStartDate),n=J.toStandardDate(e.recommendedEndDate),i=e.status||"good";let r;switch(i){case"insufficient":r=`⚠️ 当前日期范围不足以完成排班，建议延长至${e.suggestedDays}天`;break;case"suboptimal":r=e.suggestedDays>t?`💡 建议延长至${e.suggestedDays}天以获得更好排班效果`:`💡 当前${t}天可以完成排班，但延长日期可获得更好效果`;break;default:r=`✅ 当前${t}天的配置可以顺利完成排班，资源配置合理`}return{start:a,end:n,display:`${J.toDisplayDate(a)} 至 ${J.toDisplayDate(n)}`,requiredWorkdays:e.minRequiredDays,recommendedWorkdays:e.suggestedDays,currentWorkdays:t,status:i,message:r,bottleneckInfo:s.bottlenecks.filter(e=>e.isBottleneck).map(e=>({department:e.department,requiredDays:e.requiredDays,utilizationRate:e.utilizationRate}))}}const i=Math.floor(a/2),r=Math.ceil(2*t/i),l=Math.max(r+1,Math.ceil(1.2*r)),o=An().workdays;let d;for(st.value?d=J.parseDate(st.value)||new Date:(d=new Date,d.setDate(d.getDate()+1));0===d.getDay()||6===d.getDay()||Ve.isHoliday(J.toStandardDate(d));)d.setDate(d.getDate()+1);const c=new Date(d);let u=0;for(;u<l;){const e=c.getDay(),t=J.toStandardDate(c),a=(0===e||6===e)&&!ea.value,n=Ve.isHoliday(t);a||n||u++,u<l&&c.setDate(c.getDate()+1)}const p=o<r?"insufficient":o<l?"suboptimal":"good",m=J.toStandardDate(d),h=J.toStandardDate(c);return{start:m,end:h,display:`${J.toDisplayDate(m)} 至 ${J.toDisplayDate(h)}`,requiredWorkdays:r,recommendedWorkdays:l,currentWorkdays:o,status:p,message:"insufficient"===p?`需要至少 ${r} 个工作日，当前仅 ${o} 天`:"suboptimal"===p?`建议 ${l} 个工作日以获得更好效果，当前 ${o} 天`:`当前 ${o} 个工作日配置合理`}},Sn=()=>"#ef4444"!==wn().color,$n=()=>{ea.value=!ea.value,En()},En=()=>{ot.value.avoidWeekendSchedulingEnabled=!ea.value},_n=()=>{if(!na.value)return void pe.warning("请选择日期");let e=na.value;"range"===aa.value&&sa.value&&(e=`${na.value} 至 ${sa.value}`);ra.value.some(e=>e.date===na.value&&e.endDate===("range"===aa.value?sa.value:void 0))?pe.warning("该日期已添加"):(ra.value.push({date:na.value,endDate:"range"===aa.value?sa.value:void 0,displayDate:e,reason:ia.value||void 0}),na.value="",sa.value="",ia.value="",pe.success("添加成功"))},Tn=a(""),In=a(0),Pn=()=>{Tn.value&&(it.value=Tn.value,Mn(),pe.success(`已应用推荐的结束日期：${Tn.value}（约${In.value}个工作日）`))},Rn=()=>{if(st.value){const e=J.parseDate(st.value);e&&(st.value=J.toStorageDate(e)),(()=>{if(!st.value||0===Oa.value.length)return Tn.value="",void(In.value=0);if(Oa.value.length,cn()<2)return Tn.value="",void(In.value=0);const e=Pe(Oa.value,[],2).recommendedDays,t=J.parseDate(st.value);if(!t)return Tn.value="",void(In.value=0);let a=0,n=new Date(t);for(;a<e;){const e=n.getDay(),t=J.toStandardDate(n),s=0===e||6===e;Ve.isHoliday(t)||!ea.value&&s||a++,n.setDate(n.getDate()+1)}n.setDate(n.getDate()-1),Tn.value=J.toStorageDate(n),In.value=e})()}else Tn.value="",In.value=0},Mn=()=>{if(it.value){const e=J.parseDate(it.value);e&&(it.value=J.toStorageDate(e))}},An=()=>{if(!st.value||!it.value)return{totalDays:0,workdays:0,weekends:0,holidays:0,adjustedWorkdays:0,isValidRange:!1};const e=new Date(st.value),t=new Date(it.value);if(e>t)return{totalDays:0,workdays:0,weekends:0,holidays:0,adjustedWorkdays:0,isValidRange:!1};const a=Ln(e,t).length;let n=0,s=0,i=0;const r=new Date(e);for(;r<=t;){n++;const e=J.toStorageDate(r),t=r.getDay();Ve.isHoliday(e)?i++:0!==t&&6!==t||s++,r.setDate(r.getDate()+1)}return{totalDays:n,workdays:a,normalWorkdays:a,weekends:s,holidays:i,adjustedWorkdays:0,isValidRange:a>=2}},On=()=>{const e=ot.value;return["nightShiftTeacherPriority","examiner2ProfessionalMatch","firstRestDayTeacherPriority","backupExaminerProfessionalMatch","secondRestDayTeacherPriority","examiner2AlternativeOption","adminTeacherPriority","backupExaminerAlternativeOption","allowDept37CrossUse","balanceWorkload","preferLaterDates","avoidWeekendSchedulingEnabled","preferNightShiftOnWeekendEnabled"].filter(t=>e[t]).length},Nn=e=>{if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]},zn=async()=>{if(Oa.value&&Oa.value.length>0&&Na.value&&Na.value.length>0){const e=Ie(Oa.value,Na.value);e&&e.hasIssue}if(st.value&&(Ma.value=J.parseDate(st.value)),it.value&&(Aa.value=J.parseDate(it.value)),!(Ma.value&&Aa.value||(st.value&&(Ma.value=J.parseDate(st.value)),it.value&&(Aa.value=J.parseDate(it.value)),Ma.value&&Aa.value&&0!==Ma.value.getTime()&&0!==Aa.value.getTime())))return oa.value="请重新设置考试开始日期和结束日期",void(nt.value=2);if(!Oa.value||0===Oa.value.length)return void(oa.value="请先加载学员数据");if(!Na.value||0===Na.value.length)return void(oa.value="请先加载教师数据");const e=Pe(Oa.value,Na.value),t=Math.ceil((Aa.value.getTime()-Ma.value.getTime())/864e5)+1;if(t<e.minDays){const a=`考试天数不足！\n\n当前设置: ${t}天\n最少需要: ${e.minDays}天\n推荐天数: ${e.recommendedDays}天\n\n瓶颈原因: ${e.bottleneck}\n\n请调整结束日期，确保至少有 ${e.minDays} 天的考试周期。`;return await me.alert(a,"⚠️ 考试天数不足",{confirmButtonText:"知道了",type:"warning",dangerouslyUseHTMLString:!1}),oa.value=`考试天数不足，最少需要 ${e.minDays} 天`,void(nt.value=2)}if(t<e.recommendedDays){if("cancel"===await me.confirm(`当前设置 ${t} 天可能较紧张。\n\n推荐天数: ${e.recommendedDays}天\n瓶颈原因: ${e.bottleneck}\n\n继续排班可能导致部分学员无法分配到最优时间。\n是否继续？`,"💡 考试天数建议",{confirmButtonText:"继续排班",cancelButtonText:"调整天数",type:"info"}).catch(()=>"cancel"))return void(nt.value=2)}await Fn()},jn=()=>{const e=(()=>{switch(nt.value){case 1:return Oa.value.length>0;case 2:if(!st.value||!it.value)return!1;const e=J.parseDate(st.value),t=J.parseDate(it.value);return e&&t&&e<=t;case 3:return Sn();case 4:return Oa.value.length>0&&st.value&&it.value;default:return!1}})();return nt.value,nt.value,e},Fn=async()=>{var t,a,n,s,i,r,l,o,d,c,u,p,m;try{if(0===Oa.value.length){const e=[{id:"missing-student-list",type:"scheduling_conflict",severity:"HIGH",description:"缺少学员名单数据",affectedEntities:["students"],suggestedSolutions:["上传学员名单文件","检查文件格式是否正确"],autoResolvable:!1}];return gs.showErrorFeedback("validation_error","请先上传学员名单文件",e),void(oa.value="请先上传学员名单文件")}if(!Ma.value||!Aa.value){const e=[{id:"missing-date-range",type:"scheduling_conflict",severity:"MEDIUM",description:"缺少考试日期范围配置",affectedEntities:["schedule"],suggestedSolutions:["设置考试开始和结束日期","检查日期是否为工作日"],autoResolvable:!1}];return gs.showErrorFeedback("validation_error","请选择考试日期范围",e),void(oa.value="请选择考试日期范围")}Kt.value=!0,oa.value="",ya.value=Date.now();const v=Oa.value.length,f=ga.value;let y=0;y="fast"===f?v<5?3e3:v<15?1e4:v<30?3e4:6e4:v<10?25e3:v<30?45e3:75e3,xa.value=y,ba.value=void 0,wa.value=void 0,ft.value=0,yt.value=Oa.value.length,Da.value=!1,ka.value={};const x=Oa.value.reduce((e,t)=>e+(1===((null==t?void 0:t.examDays)||2)?1:2),0);va.setTotalAssignments(x),va.start(),Ea.value=!1,Ta&&(clearTimeout(Ta),Ta=null);const b=await Un();qn=b,Na.value=b;const w=Jn(b);if(!w.isValid){const e=[{id:"teacher-validation-error",type:"scheduling_conflict",severity:"HIGH",description:"考官数据验证失败",affectedEntities:["teachers"],suggestedSolutions:["检查考官数据完整性","重新加载考官数据","修复考官数据格式"],autoResolvable:!1}];return gs.showErrorFeedback("validation_error",`考官数据验证失败: ${w.errors.join(", ")}`,e),oa.value=`考官数据验证失败: ${w.errors.join(", ")}`,Pa(),void(Kt.value=!1)}const D=await Wn(),k=Ln(Ma.value,Aa.value),S=ga.value||"auto",$={workdaysOnlyExam:!0,consecutiveTwoDaysExamEnabled:!0,noDayShiftExaminer:!0,noStudentGroupDayShift:!0,examinerDepartmentRules:!0,twoMainExaminersRequired:!0,noExaminerTimeConflict:!0,nightShiftTeacherPriority:100,preferRecommendedExaminer2Weight:90,preferFirstRestDayTeachers:80,firstRestDayTeacherPriority:80,preferRecommendedBackup:70,preferSecondRestDayTeachers:60,secondRestDayTeacherPriority:60,preferNonRecommendedExaminer2:50,preferAdminTeachers:40,adminTeacherPriority:40,preferNonRecommendedBackup:30,allowDept37CrossUse:20,balanceWorkload:10,preferLaterDates:5,avoidWeekendSchedulingEnabled:ot.value.avoidWeekendSchedulingEnabled,preferNightShiftOnWeekendEnabled:ot.value.preferNightShiftOnWeekendEnabled,enableFlexibleScheduling:10,maxTwoStudentsPerDay:15,teacherStatusPriority:80,nightShiftTeacherRecommendedDepartmentBonus:25},C=D.map(e=>({id:e.id,name:e.name,department:Bn(e.department),group:e.group||"组",recommendedExaminer1Dept:e.recommendedExaminer1Dept?Bn(e.recommendedExaminer1Dept):void 0,recommendedExaminer2Dept:e.recommendedExaminer2Dept?Bn(e.recommendedExaminer2Dept):void 0,recommendedBackupDept:e.recommendedBackupDept?Bn(e.recommendedBackupDept):void 0,examDays:e.examDays||2,day1Subjects:e.day1Subjects?JSON.stringify(e.day1Subjects):JSON.stringify(["现场","模拟机1"]),day2Subjects:e.day2Subjects?JSON.stringify(e.day2Subjects):JSON.stringify(["模拟机2","口试"])})),E=b.map(e=>({id:e.id,name:e.name,department:Bn(e.department),group:e.group,skills:e.skills,workload:e.workload,consecutiveDays:e.consecutiveDays,unavailablePeriods:e.unavailablePeriods||[]})),T=E.filter(e=>{const t=e.department||"";return t.includes("模拟机")||t.includes("现场")||t.includes("口试")||t.includes("理论")||t.includes("实操")||t.includes("实践")||t.includes("笔试")});if(T.length>0){const e=T.map(e=>`${e.name}(${e.department})`).join(", ");throw pe.error(`🚨 数据错误：检测到${T.length}名考官的科室数据异常`),new Error(`数据错误：检测到${T.length}名考官的科室数据异常：\n${e}\n\n这些是考试科目，不是科室名称！请返回考官管理页面检查数据。`)}if(!Ma.value||!Aa.value)throw new Error("日期数据未正确设置，无法构建排班请求");const I=J.toStorageDate(Ma.value),P={students:C,teachers:E,startDate:I,endDate:J.toStorageDate(Aa.value),examDates:k,constraints:$,solverConfig:{timeoutSeconds:"fast"===S?15:"optimal"===S?60:30,maxIterations:"fast"===S?3e3:"optimal"===S?1e4:5e3,description:`${S}模式求解配置`}},R="schedule-"+Date.now()+"-"+Math.random().toString(36).substring(7);z.value=R,window.__opta_session_id=R;try{await ts(R)}catch(h){}qa(),await _(),kt.value=[],xt.value=null,bt.value=null,Dt("🚀 开始排班计算","info"),Dt(`📊 学员数量: ${D.length}, 考官数量: ${b.length}`,"info"),Dt(`📅 日期范围: ${J.toStorageDate(Ma.value)} 到 ${J.toStorageDate(Aa.value)}`,"info"),Dt("📡 WebSocket已连接，等待实时更新...","info"),setTimeout(()=>{const e=document.querySelector(".schedule-table");e&&e.scrollIntoView({behavior:"smooth",block:"start"})},100),yt.value=D.length,ft.value=0,dt.value="正在初始化排班算法...";b.filter(e=>e.unavailablePeriods&&e.unavailablePeriods.length>0).forEach(e=>{var t;null==(t=e.unavailablePeriods)||t.forEach(e=>{})});const M=await Fe.generateSchedule(P,async e=>{if(va.setProgress(Math.max(25,e.percentage)),e.message&&(dt.value=e.message),e.score&&(ba.value=e.score.hardScore,wa.value=e.score.softScore),e.currentSolution&&e.currentSolution.assignments&&e.currentSolution.assignments.length>0){const t=e.currentSolution.assignments.length;ft.value=t,va.setActualAssignmentCount(t);const a=D.reduce((e,t)=>e+(1===((null==t?void 0:t.examDays)||2)?1:2),0),n=Math.min(100,Math.round(t/a*100));dt.value="正在计算最优方案...",Dt(`🔍 OptaPlanner求解中: ${n}% 完成`,"info")}100===e.percentage&&(Pa(),va.complete(),dt.value=e.message||"排班完成",Dt("🎉 算法计算完成","success"),Dt("⏳ 正在处理最终结果...","info"))});if(null==M?void 0:M.sessionId){z.value=M.sessionId;try{z.value&&await ts(z.value)}catch(h){}}const A=Array.isArray(M.assignments)&&M.assignments.length>0?M.assignments:(null==(t=M.examSchedule)?void 0:t.assignments)||[],O=!0===M.success||A.length>0;if(O){Dt("✅ 排班结果处理成功","success"),Dt(`📊 共生成 ${A.length} 个排班分配`,"info");let t=A.map(e=>({id:e.id,studentId:e.student.id,studentName:e.student.name,studentDepartment:e.student.department,examDate:e.examDate,examType:e.examType,subjects:e.subjects,examiner1:e.examiner1,examiner2:e.examiner2,backupExaminer:e.backupExaminer,location:e.location,timeSlot:e.timeSlot}));const h=[...new Set(t.map(e=>e.examDate))],v=[],f=function(e){const t=e.filter(e=>Ve.isHoliday(e));if(0===t.length)return{id:"no-holiday-violation",type:"other",severity:"low",title:"无节假日违反",message:"所选日期不包含节假日"};const a=t.map(e=>{const t=Ve.getHolidayInfo(e);return`${e}（${(null==t?void 0:t.name)||"节假日"}）`});return{id:"holiday-violation",type:"holiday",severity:"high",title:"HC2约束违反：法定节假日不安排考试",message:Ve.getMultipleHolidayViolationMessage(t),details:a,suggestion:"请选择工作日进行考试安排，避开所有法定节假日",affectedDates:t,fixable:!0}}(h);"holiday"===f.type&&v.push(f);const y=qe(t);"teacher"===y.type&&v.push(y);const x=Je(Qn(v,t,h));if(x.length>0){es(x)&&(Pt.value=x)}let w=0,D=0;if(M.score)if("string"==typeof M.score){const e=M.score.match(/(-?\d+)hard\/(-?\d+)soft/);e&&(w=parseInt(e[1]),D=parseInt(e[2]))}else"object"==typeof M.score&&(w=M.score.hardScore||0,D=M.score.softScore||0);const k=e=>{if(!e)return"";const t=e.trim();return t.includes("区域一室")||t.includes("一室")||t.includes("1室")||t.includes("第1科室")?"一":t.includes("区域二室")||t.includes("二室")||t.includes("2室")||t.includes("第2科室")?"二":t.includes("区域三室")||t.includes("三室")||t.includes("3室")||t.includes("第3科室")?"三":t.includes("区域四室")||t.includes("四室")||t.includes("4室")||t.includes("第4科室")?"四":t.includes("区域五室")||t.includes("五室")||t.includes("5室")||t.includes("第5科室")?"五":t.includes("区域六室")||t.includes("六室")||t.includes("6室")||t.includes("第6科室")?"六":t.includes("区域七室")||t.includes("七室")||t.includes("7室")||t.includes("第7科室")?"七":t.includes("区域八室")||t.includes("八室")||t.includes("8室")||t.includes("第8科室")?"八":t.includes("区域九室")||t.includes("九室")||t.includes("9室")||t.includes("第9科室")?"九":t.includes("区域十室")||t.includes("十室")||t.includes("10室")||t.includes("第10科室")?"十":t},S=(e,t)=>e===t||("三"===e&&"七"===t||"七"===e&&"三"===t),$=[];t.forEach((e,t)=>{var a,n;const s=e.studentName||(null==(a=e.student)?void 0:a.name),i=e.studentDepartment||(null==(n=e.student)?void 0:n.department),r=e.examiner1,l=e.examiner2;if(!(s&&i&&r&&l))return;const o=(null==r?void 0:r.name)||r,d=(null==l?void 0:l.name)||l,c=null==r?void 0:r.department,u=null==l?void 0:l.department,p=k(i),m=k(c),h=k(u),g=S(p,m),v=p!==h,f=m!==h;g&&v&&f||$.push({"学员":s,"科室":`${i}(${p})`,"日期":e.examDate,"考官1":o,"考官1科室":`${c}(${m})`,"考官2":d,"考官2科室":`${u}(${h})`,"违反原因":g?v?f?"未知":"考官1和考官2来自同一科室":"考官2与学员同科室":"考官1与学员不同科室"})}),$.length;let C=D;if(0===C&&(null==(a=M.statistics)?void 0:a.finalScore))if("object"==typeof M.statistics.finalScore)C=M.statistics.finalScore.softScore||0;else if("string"==typeof M.statistics.finalScore){const e=M.statistics.finalScore.match(/(-?\d+)hard\/(-?\d+)soft/);e&&(C=parseInt(e[2]))}xt.value=C,(null===bt.value||C>bt.value)&&(bt.value=C);const E={assignments:t,unassignedStudents:[],statistics:{totalStudents:(null==(n=M.statistics)?void 0:n.totalStudents)||0,assignedStudents:(null==(s=M.statistics)?void 0:s.assignedStudents)||0,unassignedStudents:((null==(i=M.statistics)?void 0:i.totalStudents)||0)-((null==(r=M.statistics)?void 0:r.assignedStudents)||0),totalTeachers:b.length,activeTeachers:Math.ceil(((null==(l=M.statistics)?void 0:l.assignedStudents)||0)/2),averageWorkload:Math.ceil(((null==(o=M.statistics)?void 0:o.assignedStudents)||0)/b.length),maxWorkload:Math.ceil(((null==(d=M.statistics)?void 0:d.assignedStudents)||0)/b.length*1.5),hardConstraintsSatisfied:0===((null==(c=M.statistics)?void 0:c.hardConstraintViolations)||0)?1:0,hardConstraintViolations:(null==(u=M.statistics)?void 0:u.hardConstraintViolations)||0,softConstraintViolations:(null==(p=M.statistics)?void 0:p.softConstraintViolations)||0,softConstraintsScore:C,continuityRate:(null==(m=M.statistics)?void 0:m.completionPercentage)||0},conflicts:M.conflicts||[],warnings:M.warnings||[],recommendations:[]};localStorage.removeItem("latest_schedule_result"),za.value=[];try{const{examinerAssignmentFixer:a}=await e(async()=>{const{examinerAssignmentFixer:e}=await import("./examinerAssignmentFixer-BNljf3c_.js");return{examinerAssignmentFixer:e}},[],import.meta.url),n=a.fixExaminerAssignments(t,b);if(n.fixedCount>0){t=n.assignments;const e=qe(t);if("teacher"===e.type){const t=v.findIndex(e=>"main-examiners-violation"===e.id);t>=0&&(v[t]=e)}else{const e=v.findIndex(e=>"main-examiners-violation"===e.id);e>=0&&v.splice(e,1)}const a=Je(v);Pt.value=a}n.remainingIssues}catch(g){}la.value=E,await Vn(E,!1),setTimeout(()=>{const e=E.statistics||M.statistics,t=(null==e?void 0:e.totalStudents)||za.value.length,a=(null==e?void 0:e.assignedStudents)||za.value.filter(e=>e.examiner1_1&&e.examiner2_1).length,n=t>0?a/t*100:0;ka.value={totalStudents:t,assignedStudents:a,completionRate:n,hardConstraintScore:w,softConstraintScore:D},Pa(),va.complete(),Da.value=!1,Kt.value=!1;let s="🎉 OptaPlanner排班完成！\n\n";s+="📊 排班统计:\n";const i=(null==e?void 0:e.hardConstraintViolations)??(null==e?void 0:e.hardConstraintsSatisfied)??0,r=(null==e?void 0:e.softConstraintViolations)??0;s+=`✅完成率: ${n.toFixed(1)}%\n`,s+=`✅分配学员: ${a}/${t}\n`,s+=`❌硬约束违反: ${i}个\n`,s+=`⚠️软约束得分 ${(null==e?void 0:e.softConstraintsScore)||0}\n`,null!==bt.value&&(s+=`🌟历史最高软约束得分 ${bt.value}\n`),s+="\n",M.warnings&&M.warnings.length>0&&(s+=`⚠️ 警告: ${M.warnings.length}个\n`),M.conflicts&&M.conflicts.length>0&&(s+=`❌冲突: ${M.conflicts.length}个\n`),s+="\n🚀使用OptaPlanner约束求解引擎\n",s+="所有排班结果已生成，请查看下方表格。",oa.value="",la.value=E,Mt.value={success:O,statistics:{totalStudents:t,assignedStudents:a,hardConstraintsSatisfied:(null==e?void 0:e.hardConstraintsSatisfied)||0,softConstraintsScore:(null==e?void 0:e.softConstraintsScore)||0,bestSoftConstraintsScore:bt.value,hardConstraintViolations:i,softConstraintViolations:r},warnings:M.warnings||[],conflicts:M.conflicts||[],message:s},Rt.value=!0},1e3),qa()}else{let e="排班失败\n\n";M.message&&(e+=`❌错误信息: ${M.message}\n\n`),M.warnings&&M.warnings.length>0&&(e+="⚠️ 警告信息:\n",M.warnings.forEach((t,a)=>{e+=`${a+1}. ${t}\n`}),e+="\n"),e+="💡 建议解决方案:\n",e+="1. 检查考官数量是否充足\n",e+="2. 确认考试日期范围合理\n",e+="3. 考虑放宽部分约束条件\n",e+="4. 联系系统管理员获取技术支持";const t=document.createElement("div");t.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: #ef4444;\n        color: white;\n        padding: 16px 20px;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        z-index: 10000;\n        max-width: 500px;\n        font-size: 14px;\n        line-height: 1.4;\n        cursor: pointer;\n        white-space: pre-line;\n      ",t.textContent=e,t.title="点击关闭",t.onclick=()=>t.remove(),setTimeout(()=>{t.parentNode&&t.remove()},15e3),document.body.appendChild(t),setTimeout(()=>{Pa(),Kt.value=!1,va.reset(),oa.value="OptaPlanner排班失败，请查看详细信息"},1e3)}}catch(h){const e=[];h.message.includes("考官数据")&&e.push({id:"teacher-data-error",type:"scheduling_conflict",severity:"HIGH",description:"考官数据验证失败",affectedEntities:["teachers"],suggestedSolutions:["检查考官数据格式","重新加载考官数据"],autoResolvable:!1}),h.message.includes("学员名单")&&e.push({id:"student-data-error",type:"scheduling_conflict",severity:"HIGH",description:"学员名单格式错误",affectedEntities:["students"],suggestedSolutions:["检查学员名单格式","重新上传学员名单"],autoResolvable:!1}),gs.showErrorFeedback("system_error",h.message||"未知错误",e),Pa(),Ca(),Kt.value=!1,va.reset(),oa.value=h.message||"未知错误"}},Ln=(e,t)=>{const a=[],n=new Date(e),s=new Set(["2025-01-01","2025-01-28","2025-01-29","2025-01-30","2025-01-31","2025-02-01","2025-02-02","2025-02-03","2025-04-05","2025-04-06","2025-04-07","2025-05-01","2025-05-02","2025-05-03","2025-05-04","2025-05-05","2025-05-31","2025-06-01","2025-06-02","2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07","2025-10-08","2026-01-01","2026-02-15","2026-02-16","2026-02-17","2026-02-18","2026-02-19","2026-02-20","2026-02-21","2026-02-22","2026-02-23","2026-04-05","2026-04-06","2026-04-07","2026-05-01","2026-05-02","2026-05-03","2026-05-29","2026-09-25","2026-09-26","2026-09-27","2026-10-01","2026-10-02","2026-10-03","2026-10-04","2026-10-05","2026-10-06","2026-10-07"]),i=new Set(["2025-01-26","2025-02-08","2025-04-27","2025-09-28","2025-10-11","2026-04-26","2026-09-27","2026-10-10"]),r=e=>{const t=new Date(e+"T00:00:00").getDay();return!ra.value.some(t=>t.endDate?e>=t.date&&e<=t.endDate:e===t.date)&&(!!i.has(e)||!s.has(e)&&(0!==t&&6!==t||!!ea.value))};for(;n<=t;){const e=J.toStandardDate(n);r(e)&&a.push(e);const t=J.getNextDay(n);n.setTime(new Date(t).getTime())}return J.toStandardDate(e),J.toStandardDate(t),0===a.length||a.length,a},Un=async()=>{try{Object.keys(localStorage).filter(e=>e.toLowerCase().includes("teacher")||e.toLowerCase().includes("examiner")).forEach(e=>{try{const t=localStorage.getItem(e);t&&JSON.parse(t)}catch(t){}});let t=[];const a=["teachers","examiner_teachers","unified_teachers","teacher_data","teacherList"];for(const i of a)try{const e=localStorage.getItem(i);if(e){const a=JSON.parse(e);if(Array.isArray(a)&&a.length>0){t=a;break}}}catch(e){}if(0===t.length)try{t=await U.loadTeachers()}catch(e){}0===t.length&&(t=[{id:"test_1",name:"张考官",department:"区域一室",group:"一组",shift:"白班",status:"可用"},{id:"test_2",name:"李考官",department:"区域二室",group:"二组",shift:"夜班",status:"可用"},{id:"test_3",name:"王考官",department:"区域三室",group:"三组",shift:"休息",status:"可用"},{id:"test_4",name:"赵考官",department:"区域四室",group:"四组",shift:"白班",status:"可用"},{id:"test_5",name:"钱考官",department:"区域五室",group:"一组",shift:"夜班",status:"可用"},{id:"test_6",name:"孙考官",department:"区域六室",group:"二组",shift:"休息",status:"可用"},{id:"test_7",name:"周考官",department:"区域七室",group:"三组",shift:"白班",status:"可用"},{id:"test_8",name:"吴考官",department:"区域一室",group:"四组",shift:"夜班",status:"可用"},{id:"test_9",name:"郑考官",department:"区域二室",group:"一组",shift:"休息",status:"可用"},{id:"test_10",name:"陈考官",department:"区域三室",group:"二组",shift:"白班",status:"可用"}],oa.value=`⚠️ 正在使用测试教师数据进行排班！\n      \n请注意：\n1. 当前使用的是系统内置的测试数据\n2. 排班结果仅供功能验证，不应用于实际工作\n3. 请尽快访问"考官管理"页面上传真实教师数据\n4. 上传真实数据后，重新进行排班获得准确结果\n\n测试考官数量: ${t.length} 名`);const n=t.filter(e=>e&&e.id&&e.name).map(e=>{const t=e.unavailablePeriods||[];return t.length,{id:e.id.toString(),name:e.name,department:e.department||"未分组",group:e.group||"一",skills:e.skills||e.specialties||["理论教学","实操指导"],workload:e.workload||0,consecutiveDays:e.consecutiveDays||0,unavailablePeriods:t,specialties:e.specialties||e.skills||[],experienceYears:e.experienceYears||3,available:!0,currentWorkload:0,nightShiftPreferred:!1,restDayStatus:"none",conflictInfo:""}}),s=n.filter(e=>e.id&&e.name&&e.department&&"未分组"!==e.department);if(s.length,n.length,0===s.length)throw new Error("考官数据格式不正确，请检查上传的文件");return s}catch(e){throw new Error(`考官数据加载失败: ${e.message||"未知错误"}。请确保已在考官管理页面正确上传考官名单。`)}},Bn=e=>({"一":"区域一室","二":"区域二室","三":"区域三室","四":"区域四室","五":"区域五室","六":"区域六室","七":"区域七室","区域一室":"区域一室","区域二室":"区域二室","区域三室":"区域三室","区域四室":"区域四室","区域五室":"区域五室","区域六室":"区域六室","区域七室":"区域七室"}[e]||e),Hn=e=>{if(!e)return"";return{"区域一室":"一","区域二室":"二","区域三室":"三","区域四室":"四","区域五室":"五","区域六室":"六","区域七室":"七"}[e]||e},Wn=async()=>{if(0===Oa.value.length)throw new Error("请先上传学员名单文件");return Oa.value.map(e=>({id:e.id.toString(),name:e.name,department:e.department,group:e.group||"一组",recommendedExaminer1Dept:e.recommendedExaminer1Dept?Hn(e.recommendedExaminer1Dept):void 0,recommendedExaminer2Dept:e.recommendedExaminer2Dept?Hn(e.recommendedExaminer2Dept):void 0,recommendedBackupDept:e.recommendedBackupDept?Hn(e.recommendedBackupDept):void 0,originalExaminers:{examiner1:e.recommendedExaminer1Dept,examiner2:e.recommendedExaminer2Dept,backup:e.recommendedBackupDept}}))},Vn=async(e,t=!1)=>{var a,n;if(!qn)try{qn=await Un()}catch(D){qn=[]}try{e.assignments.forEach((e,t)=>{});const t=Le.fixScheduleResultDisplay(e,qn||[]);e=t}catch(D){}if(!e)return void(oa.value="排班结果数据为空，请重试");if(!e.assignments)return void(oa.value="排班结果格式错误：缺少assignments数据");if(!Array.isArray(e.assignments))return void(oa.value="排班结果格式错误：assignments数据格式不正确");const s=e.assignments.filter((e,t)=>!!e&&!(!e.studentId||!e.studentName)),i=new Set,r=new Set;Oa.value.forEach(e=>{i.add(e.id.toString())}),s.forEach(e=>{r.add(e.studentId.toString())});const l=[];if(i.forEach(e=>{if(!r.has(e)){const t=Oa.value.find(t=>t.id.toString()===e);t&&l.push(t)}}),0===s.length)return e.assignments.forEach((e,t)=>{}),void(oa.value="排班数据验证失败：没有有效的分配记录");za.value=[];let o=[];const d=new Map,c=new Map;s.forEach(e=>{const t=e.id||`${e.studentId}_${e.examType||"unknown"}`;c.has(t)||c.set(t,e)});const u=Array.from(c.values());s.length!==u.length&&alert(`⚠️ 检测到并移除了${s.length-u.length}个重复的排班数据`),u.forEach((t,a)=>{try{t.id||(t.id=`assignment_${a+1}_${t.studentId}`),t.examDate&&""!==t.examDate&&"null"!==t.examDate&&t.examDate;let n=t.examType;if(!n||"day1"!==n&&"day2"!==n)if(t.examDate&&Ma.value){const e=new Date(t.examDate),s=new Date(Ma.value),i=Math.floor((e.getTime()-s.getTime())/864e5);n=0===i?"day1":1===i?"day2":a%2==0?"day1":"day2",t.examType=n}else n=a%2==0?"day1":"day2",t.examType=n;if((!t.backupExaminer||""===t.backupExaminer||"null"===t.backupExaminer)&&qn&&qn.length>0){const a=new Set;if(t.examiner1){const e="string"==typeof t.examiner1?t.examiner1:t.examiner1&&"object"==typeof t.examiner1&&"id"in t.examiner1?t.examiner1.id:void 0;e&&a.add(e)}if(t.examiner2){const e="string"==typeof t.examiner2?t.examiner2:t.examiner2&&"object"==typeof t.examiner2&&"id"in t.examiner2?t.examiner2.id:void 0;e&&a.add(e)}let n=qn.find(e=>!a.has(e.id)&&!a.has(e.name)&&e.department!==t.studentDepartment);if(n||(n=qn.find(e=>!a.has(e.id)&&!a.has(e.name))),!n){const s=new Map,i=t.examDate;e.assignments.forEach(e=>{if(e.backupExaminer&&e.examDate===i){const t="string"==typeof e.backupExaminer?e.backupExaminer:e.backupExaminer.name;t&&s.set(t,(s.get(t)||0)+1)}});let r=1/0,l=null;for(const e of qn){if(a.has(e.id)||a.has(e.name))continue;const n=t.studentDepartment||"未知",i=e.department||"未知",o=!i.includes(n)&&!n.includes(i),d=s.get(e.name)||0,c=o?d-.5:d;c<r&&(r=c,l=e)}if(l){n=l;s.get(l.name)}else{n=[...qn].sort((e,t)=>(s.get(e.name)||0)-(s.get(t.name)||0))[0];s.get(n.name)}}n&&(t.backupExaminer=n)}const s=t.studentId;d.has(s)||d.set(s,{studentName:t.studentName,studentDepartment:t.studentDepartment,day1:null,day2:null});const i=d.get(s);"day1"===n?i.day1=t:"day2"===n?i.day2=t:i.day1=t}catch(D){}});const p=new Map;e.assignments.forEach(e=>{if(e.backupExaminer){const t="string"==typeof e.backupExaminer?e.backupExaminer:e.backupExaminer.name;t&&p.set(t,(p.get(t)||0)+1)}}),Array.from(p.entries()).sort((e,t)=>t[1]-e[1]).forEach(([e,t])=>{});const m=[...(()=>{const e=[];return d.forEach((t,a)=>{if(t.day1&&t.day2){const a=new Date(t.day1.examDate),n=new Date(t.day2.examDate),s=Math.abs((n.getTime()-a.getTime())/864e5);1!==s&&e.push({studentName:t.studentName,issue:`考试日期不连续：第一天=${t.day1.examDate}, 第二天=${t.day2.examDate}, 间隔=${s}天`,severity:"hard"})}else e.push({studentName:t.studentName,issue:`缺少完整的两天考试安排: day1=${t.day1?"已安排":"缺失"}, day2=${t.day2?"已安排":"缺失"}`,severity:"hard"})}),e})(),...(()=>{const e=[];return d.forEach((t,a)=>{[t.day1,t.day2].forEach((a,n)=>{if(a&&a.examDate){const s=new Date(a.examDate).getDay();0!==s&&6!==s||e.push({studentName:t.studentName,issue:`考试安排在周末：${a.examDate} (星期${0===s?"日":"六"})`,severity:"soft",day:n+1});try{const s=J.parseDate(a.examDate),i=(J.toStorageDate(s),s.getDay()),r=t.studentName.includes("一")?"一组":t.studentName.includes("二")?"二组":t.studentName.includes("三")?"三组":t.studentName.includes("四")?"四组":"未知组";"未知组"!==r&&i>=1&&i<=5&&e.push({studentName:t.studentName,issue:`需要验证${a.examDate}是否为${r}白班执勤日`,severity:"soft",day:n+1})}catch(D){}}})}),e})()];let h=0,g=0;if(e.score)if("object"==typeof e.score&&void 0!==e.score.hardScore)h=e.score.hardScore||0,g=e.score.softScore||0;else if("string"==typeof e.score){const t=e.score.match(/(-?\d+)hard\/(-?\d+)soft/);t&&(h=parseInt(t[1]),g=parseInt(t[2]))}if(0===h&&0===g&&e.statistics&&(void 0!==e.statistics.hardConstraintViolations&&(h=-Math.abs(e.statistics.hardConstraintViolations)),void 0!==e.statistics.softConstraintsScore&&(g=e.statistics.softConstraintsScore),0===h&&e.statistics.finalScore))if("object"==typeof e.statistics.finalScore)h=e.statistics.finalScore.hardScore||0,g=e.statistics.finalScore.softScore||0;else if("string"==typeof e.statistics.finalScore){const t=e.statistics.finalScore.match(/(-?\d+)hard\/(-?\d+)soft/);t&&(h=parseInt(t[1]),g=parseInt(t[2]))}m.length=0,h<0?m.push({studentName:"系统检测",issue:`后端检测到硬约束违反 (硬约束得分: ${h})`,severity:"hard",constraintId:"BACKEND_HARD_VIOLATION",examDate:J.toStorageDate(new Date),violationType:"system"}):Pt.value=[];for(const k of za.value){const e=k,t=null==(a=e.学员信息)?void 0:a.班组;if(t)for(const a of["第一天","第二天"]){const n=e[a];if(!(null==n?void 0:n.考试日期))continue;t===q.calculateDutySchedule(n.考试日期).dayShift&&m.push({studentName:e.学员信息.姓名,issue:`学员在白班执勤日(${n.考试日期})参加考试，违反HC6约束`,severity:"hard",constraintId:"HC6",examDate:n.考试日期,violationType:"day_shift_conflict"})}}const v=m;v.length>0&&v.forEach((e,t)=>{e.severity}),d.forEach((e,t)=>{let a=e.day1,n=e.day2;if(a&&n){const e=new Date(a.examDate),t=new Date(n.examDate);if(e.getTime()>t.getTime()){const e=a;a=n,n=e}}try{let s=a?Gn(a.examiner1):"未分组",i=a?Gn(a.examiner2):"未分组";const r=a?Gn(a.backupExaminer):"未分组";let l=n?Gn(n.examiner1):"未分组",c=n?Gn(n.examiner2):"未分组";const u=n?Gn(n.backupExaminer):"未分组",p=[];if("未分组"!==s&&"未分组"!==i||p.push(`${e.studentName}第一天缺少主考官配备`),s===i&&"未分组"!==s&&(p.push(`${e.studentName}第一天考官重复分配`),"未分组"!==s)){i=Xn(s,e.studentDepartment)||"重新分配失败"}if("未分组"!==l&&"未分组"!==c||p.push(`${e.studentName}第二天缺少主考官配备`),l===c&&"未分组"!==l&&(p.push(`${e.studentName}第二天考官重复分配`),"未分组"!==l)){c=Xn(l,e.studentDepartment)||"重新分配失败"}p.length;const m=Oa.value.find(a=>a.id.toString()===t||a.name===e.studentName),h=1===(null==m?void 0:m.examDays),g={id:Array.from(d.keys()).indexOf(t)+1,department:Bn(e.studentDepartment||"未知"),student:e.studentName||"未知学员",date1:a&&a.examDate?J.toDisplayDate(a.examDate):"未安排",type1:h?"模拟机":a&&a.subjects?a.subjects.join("/"):"现场+模拟机1",examiner1_1:s,examiner1_2:i,backup1:r,date2:h?"-":n&&n.examDate?J.toDisplayDate(n.examDate):"未安排",type2:h?"-":n&&n.subjects?n.subjects.join("/"):"模拟机2+口试",examiner2_1:h?"-":l,examiner2_2:h?"-":c,backup2:h?"-":u,rawDate1:a&&a.examDate?a.examDate:"未安排",rawDate2:h?"":n&&n.examDate?n.examDate:"未安排",recommendedExaminer1Dept:null==m?void 0:m.recommendedExaminer1Dept,recommendedExaminer2Dept:null==m?void 0:m.recommendedExaminer2Dept,examDays:(null==m?void 0:m.examDays)||2};o.push(g)}catch(D){const n=Array.from(d.keys()).indexOf(t)+1;o.push({id:n||Date.now(),department:"数据错误",student:e.studentName||"未知学员",date1:"数据错误",type1:"数据错误",examiner1_1:"数据错误",examiner1_2:"数据错误",backup1:"数据错误",date2:"数据错误",type2:"数据错误",examiner2_1:"数据错误",examiner2_2:"数据错误",backup2:"数据错误"})}}),e.unassignedStudents&&Array.isArray(e.unassignedStudents)&&e.unassignedStudents.length>0&&e.unassignedStudents.forEach((e,t)=>{try{if(!e)return;if(!e.name||!e.id)return;const t=o.length+1+Date.now()%1e6;o.push({id:t,department:Bn(e.department||"未知"),student:e.name,date1:"未安排",type1:"未安排",examiner1_1:"未分组",examiner1_2:"未分组",backup1:"未分组",date2:"未安排",type2:"未安排",examiner2_1:"未分组",examiner2_2:"未分组",backup2:"未分组"})}catch(D){}}),l.length>0&&l.forEach((e,t)=>{try{const t=o.length+1+Date.now()%1e6;o.push({id:t,department:Bn(e.department||"未知"),student:e.name,date1:"未安排",type1:"未安排",examiner1_1:"算法未分配",examiner1_2:"算法未分配",backup1:"算法未分配",date2:"未安排",type2:"未安排",examiner2_1:"算法未分配",examiner2_2:"算法未分配",backup2:"算法未分配"})}catch(D){}});{const e=new Set,t=[];for(const a of o){const n=`${a.student}|${a.department}`;e.has(n)||(e.add(n),t.push(a))}t.length!==o.length&&(alert(`⚠️ 检测到并移除了${o.length-t.length}个重复的学员排班记录`),o.length=0,o.push(...t))}const f=Ue.validateScheduleResult(e);f.errors.length>0&&(Ue.generateValidationReport(f),f.errors.every(e=>"MISSING_EXAM_DATE"===e.type)),f.warnings.length,f.fixedData&&(e=f.fixedData),o.forEach((e,t)=>{}),o.sort((e,t)=>{const a=e=>{const t=null==e?void 0:e.rawDate1;if(t&&/^\d{4}-\d{2}-\d{2}$/.test(t))return new Date(t).getTime();const a=null==e?void 0:e.date1;if(!a)return 0;const n=String(a).match(/^(\d{1,2})\.(\d{1,2})$/);if(!n)return 0;const s=Number(n[1]),i=Number(n[2]),r=st.value,l=r?new Date(r):new Date,o=l.getMonth()+1;let d=l.getFullYear();s<o&&(d+=1);const c=`${d}-${String(s).padStart(2,"0")}-${String(i).padStart(2,"0")}`;return new Date(c).getTime()};return a(e)-a(t)}),o.forEach((e,t)=>{});const y=new Map,x=[];o.forEach((e,t)=>{const a=`${e.student}_${e.department}`;if(y.has(a)){const a=`${e.student} (${e.department}) - 第${t+1}条`;x.push(a)}else y.set(a,e)});const b=Array.from(y.values());if(x.length>0&&alert(`⚠️ 发现并移除了 ${x.length} 个重复学员显示\n\n详情请查看控制台`),b.forEach((e,t)=>{}),o=b,t){const e=new Set(za.value.map(e=>`${e.student}_${e.department}`)),t=o.filter(t=>{const a=`${t.student}_${t.department}`;return!e.has(a)});if(t.length>0)for(let a=0;a<t.length;a++){const e=t[a];za.value.push(e),a<t.length-1&&await new Promise(e=>setTimeout(e,100))}else o.forEach(e=>{const t=za.value.findIndex(t=>t.student===e.student&&t.department===e.department);-1!==t&&(za.value[t]=e)})}else za.value=[],await _(),za.value=o;"number"==typeof(null==(n=null==e?void 0:e.statistics)?void 0:n.hardConstraintViolations)&&e.statistics.hardConstraintViolations,ct.value=!1;const w=new Date;ut.value=`${w.getHours().toString().padStart(2,"0")}:${w.getMinutes().toString().padStart(2,"0")}:${w.getSeconds().toString().padStart(2,"0")}`,Dt(`✅ 表格更新完成，共显示 ${o.length} 条排班记录`,"success"),await _(),setTimeout(()=>{const e=document.querySelector(".schedule-table tbody");if(!e)return;if(0===e.querySelectorAll("tr:not(:empty)").length&&za.value.length>0){const e=[...za.value];za.value=[],setTimeout(()=>{za.value=e},50)}},300),_(()=>{setTimeout(Pu,200)});try{const t={id:Date.now().toString(),timestamp:(new Date).toISOString(),title:`排班结果_${(new Date).toLocaleDateString()}`,result:e,displayData:o,metadata:{studentCount:e.assignments.length>0?new Set(e.assignments.map(e=>e.studentId)).size:0,teacherCount:e.assignments.length>0?new Set([...e.assignments.map(e=>e.examiner1).filter(e=>e),...e.assignments.map(e=>e.examiner2).filter(e=>e),...e.assignments.map(e=>e.backupExaminer).filter(e=>e)]).size:0,dateRange:Ma.value&&Aa.value?`${J.toStorageDate(Ma.value)} 到 ${J.toStorageDate(Aa.value)}`:"未设置",constraints:{...ot.value,hardConstraints:Object.keys(ot.value).filter(e=>!0===ot.value[e]),softConstraints:Object.keys(ot.value).filter(e=>!0===ot.value[e])},studentList:Oa.value,teacherList:Na.value}};await U.saveScheduleResult(t)}catch(D){}e.conflicts&&e.conflicts.length>0&&e.conflicts.forEach((e,t)=>{}),e.warnings&&e.warnings.length};let qn=null;const Jn=e=>{const t=[];let a=0;if(!e||!Array.isArray(e))return t.push("考官数据不是有效的数组格式"),{isValid:!1,errors:t,validCount:0};if(0===e.length)return t.push("考官数据为空，无法进行排班"),{isValid:!1,errors:t,validCount:0};e.forEach((e,n)=>{const s=[];e?(e.id&&""!==e.id.toString().trim()||s.push(`${n+1}个考官缺少ID`),e.name&&""!==e.name.trim()||s.push(`${n+1}个考官缺少姓名`),e.department&&""!==e.department.trim()||s.push(`${n+1}个考官缺少科室信息`),void 0!==e.group&&null!==e.group&&""===e.group.trim()&&s.push(`${n+1}个考官班组信息格式错误`),e.skills&&!Array.isArray(e.skills)&&s.push(`${n+1}个考官技能信息格式错误`),0===s.length&&a++):s.push(`${n+1}个考官数据为空`),s.length>0&&t.push(...s)}),a<3&&t.push(`有效考官数量不足${a}个），至少需3个考官才能进行排班`);const n=new Set(e.filter(e=>e&&e.department).map(e=>e.department)).size;n<2&&t.push(`考官科室分布不足${n}个科室），建议至少有2个不同科室的考官`);return{isValid:0===t.length,errors:t,validCount:a}},Gn=e=>{if(null==e||""===e)return"未分配";if("string"==typeof e){const t=e.trim();return t&&"未分组"!==t&&"数据错误"!==t&&"未分配"!==t?t:/^\d+$/.test(t)?Yn(t):t||"未分配"}if("object"==typeof e&&null!==e){if(e.name&&"string"==typeof e.name){return e.name.trim()}const t=["teacherName","fullName","displayName"];for(const a of t)if(e[a]&&"string"==typeof e[a]){return e[a].trim()}if(e.id){const t=e.id.toString(),a=Yn(t);return a&&"未分配"!==a&&!a.startsWith("考官")?a:e.department?`${e.department}考官`:`考官${t}`}return"数据异常"}if("number"==typeof e){const t=e.toString();return Yn(t)}return"格式错误"},Yn=e=>{if(!e||"string"!=typeof e)return"未分配";if(qn&&Array.isArray(qn))try{const t=qn.find(t=>{var a;if(!t||!t.id)return!1;const n=t.id===e||t.id.toString()===e||(null==(a=t.id)?void 0:a.toString())===e.toString();return n});if(t&&t.name)return t.name;qn.map(e=>null==e?void 0:e.id).filter(e=>e)}catch(t){}return`考官${e}`},Xn=(e,t)=>{if(!qn||!Array.isArray(qn))return null;try{const a=qn.filter(a=>!!(a&&a.name&&a.department)&&(a.name!==e&&(a.department!==t&&!("三室"===t&&"七室"===a.department||"七室"===t&&"三室"===a.department))));if(a.length>0){const e=a.sort((e,t)=>(e.workload||0)-(t.workload||0));return e[0].name}return null}catch(a){return null}},Kn=async()=>{if(0!==za.value.length)try{const e=[...za.value];za.value=[],await _(),setTimeout(async()=>{za.value=e,await _(),setTimeout(()=>{const e=document.querySelector(".schedule-table tbody");if(((null==e?void 0:e.querySelectorAll("tr:not(:empty)"))||[]).length>0){It.value=!1;const e=document.createElement("div");e.textContent="显示刷新成功",e.style.cssText="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; font-weight: 500;",document.body.appendChild(e),setTimeout(()=>e.remove(),3e3)}else{It.value=!0;const e=document.createElement("div");e.textContent="⚠️ 刷新后仍无法显示，请尝试重新排班",e.style.cssText="position: fixed; top: 20px; right: 20px; background: #f59e0b; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; font-weight: 500;",document.body.appendChild(e),setTimeout(()=>e.remove(),5e3)}},200)},100)}catch(e){It.value=!0;const t=document.createElement("div");t.textContent="刷新失败，请重试",t.style.cssText="position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; font-weight: 500;",document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}else It.value=!1},Zn=e=>!!e&&("string"==typeof e?"未分配"!==e&&"未分组"!==e&&""!==e.trim()&&"null"!==e&&"undefined"!==e:"object"==typeof e&&null!==e&&(e.name&&"未分配"!==e.name&&"未分组"!==e.name&&""!==e.name.trim())),Qn=(e,t,a)=>{const n=[];for(const s of e){let e=!0;switch(s.type){case"teacher":if("main-examiners-violation"===s.id){const a=t.filter(e=>{if(!(null==e?void 0:e.studentName))return!1;const t=Zn(e.examiner1),a=Zn(e.examiner2);return!t||!a}).length;(0===a||t.length>0&&a/t.length>.8)&&(e=!1)}break;case"holiday":const n=["2025-01-01","2025-01-28","2025-01-29","2025-01-30","2025-01-31","2025-02-01","2025-02-02","2025-02-03","2025-04-05","2025-04-06","2025-04-07","2025-05-01","2025-05-02","2025-05-03","2025-06-09","2025-06-10","2025-06-11","2025-09-15","2025-09-16","2025-09-17","2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07"];0===a.filter(e=>n.includes(e)).length&&(e=!1);break;case"weekend":0===a.filter(e=>{const t=new Date(e).getDay();return 0===t||6===t}).length&&(e=!1)}e&&n.push(s)}return n},es=e=>{if(!Ot.value||Date.now()-Ot.value>3e5)return At.value=!0,!0;return!!e.some(e=>"high"===e.severity)&&(At.value=!0,!0)},ts=async t=>{if(t)try{if(!Ae){const t=await e(()=>import("./httpProgressService-JbDcNPzt.js"),[],import.meta.url);Ae=t.httpProgressService||t.default}Oe&&(Oe(),Oe=null),Ae&&"function"==typeof Ae.isConnected&&Ae.isConnected()&&Ne&&Ne!==t&&Ae.disconnect();if(Ae&&"function"==typeof Ae.isConnected&&Ae.isConnected()&&Ne===t)Ca();else try{await Ae.connect(t),Dt("📊 实时进度轮询已建立","success"),Ca(),Be=Date.now(),He=!1;const a=async()=>{if(!He){He=!0;try{const t=await e(()=>Promise.resolve().then(()=>_a),void 0,import.meta.url),a=t.logService||t.default;ze&&(ze(),ze=null),ze=a.startRealtimeLogging(e=>{e.forEach(e=>{e&&e.message&&Dt(e.message,e.type||"info")})},2e3,40),Dt("🛰️ WebSocket静默，已启用日志轮询兜底","info")}catch(t){}}};je=setTimeout(()=>{Date.now()-Be>=5e3&&a()},5e3)}catch(a){Dt("⚠️ 实时日志连接失败，将使用模拟进度模式","warning"),Dt(" 启动模拟进度模式，继续排班计算...","info"),null!==$a&&clearInterval($a),$a=setInterval(()=>{if(!Kt.value||Da.value)return null!==$a&&clearInterval($a),void($a=null);const e=fa.value;if(e<90){const t=2*Math.random()+.5,a=Math.min(90,e+t);if(va.setProgress(a),dt.value="正在优化排班方案...",Math.random()<.1){const e=[" 正在分析约束条件..."," 评估排班质量..."," 优化时间分配..."," 匹配考官组合..."," 检查冲突情况..."," 提升方案质量..."],t=e[Math.floor(Math.random()*e.length)];Dt(t,"info")}}},1e3);try{const t=await e(()=>Promise.resolve().then(()=>_a),void 0,import.meta.url),a=t.logService||t.default;ze&&(ze(),ze=null),ze=a.startRealtimeLogging(e=>{e.forEach(e=>{e&&e.message&&Dt(e.message,e.type||"info")})},2e3,40),Dt("🛰️ 已启用日志轮询兜底模式","info")}catch(n){}return}Ne=t,Oe=Ae.onProgress(async e=>{var t,a,s,i;try{(null==e?void 0:e.type)&&"connected"!==e.type&&(Be=Date.now(),void 0!==je&&je&&clearTimeout(je),ze&&(ze(),ze=null))}catch(n){}if("log"!==e.type){if("progress"===e.type&&e.data){const t=e.data,a=Number(t.progressPercentage??t.percentage??0);if(!Number.isNaN(a)&&a>=0&&a<=100){if(va.setProgress(a),t.levelName?dt.value=`${t.levelName} - 进度 ${a}%`:dt.value=a<30?"正在构造初始解...":a<70?"正在优化排班方案...":"正在最终调整...",t.currentScore){const e=t.currentScore.match(/(-?\d+)hard\/(-?\d+)soft/);e&&(ba.value=parseInt(e[1]),wa.value=parseInt(e[2]))}"number"==typeof t.assignmentCount&&t.assignmentCount>0&&(ft.value=t.assignmentCount,va.setActualAssignmentCount(t.assignmentCount))}const n=`📈 进度 ${a}%`+(t.currentScore?`，分数 ${t.currentScore}`:"")+("number"==typeof t.assignmentCount?`，分配 ${t.assignmentCount}`:"")+("number"==typeof t.iterationCount?`，迭代 ${t.iterationCount}`:"");return Dt(n,"info"),void(a>=100&&(Pa(),va.complete(),dt.value="排班计算完成"))}if("score_improvement"===e.type&&e.data){const t=e.data,a=`✨ 分数提升：${t.oldScore} → ${t.newScore}，增量 ${t.improvementAmount??""}`;return void Dt(a,"success")}if("level_upgrade"===e.type&&e.data){const t=e.data,a=`⬆️ 等级升级：${t.fromLevelName||t.fromLevel} → ${t.toLevelName||t.toLevel}`;return void Dt(a,"success")}if("final_result"===e.type&&e.data){const t=e.data,a=(t.success?"🎉 求解完成":"❌ 求解失败")+(t.message?`：${t.message}`:"");return void Dt(a,t.success?"success":"error")}if("error"!==e.type)if("connected"!==e.type){if("intermediate_result"!==e.type)if("final_result"===e.type)Dt("🎉 收到最终排班结果","success"),ct.value=!1,Ta&&(clearTimeout(Ta),Ta=null),Ea.value=!1,Da.value=!1,Kt.value=!1,va.complete(),Ca(),Ae&&Ae.disconnect(),Ne=null,Oe&&(Oe(),Oe=null);else if("progress"===e.type){const t=e.data||{},a=(e=>{if(!e)return null;if("object"==typeof e&&null!==e){const t=e;if("number"==typeof t.hardScore||"number"==typeof t.softScore)return{hardScore:"number"==typeof t.hardScore?t.hardScore:0,softScore:"number"==typeof t.softScore?t.softScore:0}}if("string"==typeof e){const t=e.match(/(-?\d+)\s*hard\/(-?\d+)soft/i);if(t)return{hardScore:parseInt(t[1],10),softScore:parseInt(t[2],10)}}return null})(t.currentScore);a?(xt.value=a.softScore,(null===bt.value||a.softScore>bt.value)&&(bt.value=a.softScore)):"number"==typeof t.softConstraintsScore&&(xt.value=t.softConstraintsScore,(null===bt.value||t.softConstraintsScore>bt.value)&&(bt.value=t.softConstraintsScore))}else"error"===e.type&&Dt("❌ 实时推送发生错误: "+(e.message||""),"error");else if(Dt(`📊 求解进度更新 (共 ${(null==(a=null==(t=e.data)?void 0:t.assignments)?void 0:a.length)||0} 个排班)`,"info"),yt.value>0&&(null==(i=null==(s=e.data)?void 0:s.assignments)?void 0:i.length)>0){const t=Math.round(e.data.assignments.length/Math.max(1,2*yt.value)*100);va.setProgress(Math.min(95,t)),dt.value="正在优化排班方案...",ft.value=e.data.assignments.length}}else Dt("📡 实时连接已建立","success");else Dt(`❌ 错误：${e.message||"未知错误"}`,"error")}else e.data&&e.data.message&&Dt(e.data.message,e.data.type||"info")})}catch(a){Dt("❌ WebSocket连接失败: "+a.message,"error")}},as=()=>{Rt.value=!1},ns=()=>{var e;if(!(null==(e=Mt.value)?void 0:e.success))return"❌ 排班失败";return os()>0?"⚠️ 排班完成（存在硬约束违反）":"🎉 排班完成！"},ss=()=>{var e;if(!(null==(e=Mt.value)?void 0:e.success))return"排班过程中遇到错误，请检查配置后重试";const t=os();return t>0?`排班已完成，但发现 ${t} 个硬约束违反（以系统“冲突”详情为准）`:"所有约束都已满足，排班结果已生成"},is=()=>{var e;const t=null==(e=Mt.value)?void 0:e.statistics,a=(null==t?void 0:t.totalStudents)||za.value.length||0,n=(null==t?void 0:t.assignedStudents)||za.value.filter(e=>e.examiner1_1&&e.examiner2_1).length||0;return 0===a?"0.0":(n/a*100).toFixed(1)},rs=()=>{var e;const t=null==(e=Mt.value)?void 0:e.statistics;return void 0!==(null==t?void 0:t.assignedStudents)?t.assignedStudents:za.value.filter(e=>{const t=e.examiner1_1&&"待分配"!==e.examiner1_1,a=e.examiner2_1&&"待分配"!==e.examiner2_1;return t||a}).length||0},ls=()=>{var e;const t=null==(e=Mt.value)?void 0:e.statistics;return(null==t?void 0:t.totalStudents)||za.value.length||0},os=()=>{var e;const t=null==(e=Mt.value)?void 0:e.statistics,a=null==t?void 0:t.hardConstraintViolations;return"number"==typeof a?a:Pt.value.filter(e=>"error"===e.severity||"hard"===e.severity).length},ds=n(()=>{var e;const t=(null==(e=Mt.value)?void 0:e.conflicts)||[],a=new Map,n=e=>{if(!e)return"";const t=String(e).match(/\d{4}-\d{2}-\d{2}/);return t?t[0]:""};return t.forEach(e=>{if(!e)return;if("hard"!==(e.type?String(e.type):""))return;const t=(e=>{const t=(Array.isArray(null==e?void 0:e.affectedEntities)?e.affectedEntities:[]).find(e=>"string"==typeof e&&e.startsWith("student="));if("string"==typeof t)return t.slice(8);const a=((null==e?void 0:e.description)?String(e.description):"").match(/学员\(([^/\)]+)[/\)]/);return a?a[1]:""})(e),s=(e=>{const t=(Array.isArray(null==e?void 0:e.affectedEntities)?e.affectedEntities:[]).find(e=>"string"==typeof e&&e.startsWith("date="));return n("string"==typeof t?t.slice(5):null==e?void 0:e.description)})(e);if(!t||!s)return;const i=`${t}|${s}`,r=a.get(i)||[];r.push(e),a.set(i,r)}),a}),cs=e=>{const t=(null==e?void 0:e.student)?String(e.student):"",a=(null==e?void 0:e.rawDate1)?String(e.rawDate1):"",n=(null==e?void 0:e.rawDate2)?String(e.rawDate2):"";return!!t&&(!(!a||!ds.value.has(`${t}|${a}`))||!(!n||!ds.value.has(`${t}|${n}`)))},us=e=>{const t=(null==e?void 0:e.student)?String(e.student):"",a=(null==e?void 0:e.rawDate1)?String(e.rawDate1):"",n=(null==e?void 0:e.rawDate2)?String(e.rawDate2):"";if(!t)return"";const s=[];if(a&&s.push(...ds.value.get(`${t}|${a}`)||[]),n&&s.push(...ds.value.get(`${t}|${n}`)||[]),0===s.length)return"";const i=s.slice(0,5).map(e=>{const t=(null==e?void 0:e.constraint)?String(e.constraint):"Hard",a=(String((null==e?void 0:e.description)||"").match(/\d{4}-\d{2}-\d{2}/)||[])[0]||"",n=(null==e?void 0:e.description)?String(e.description):"",s=(null==e?void 0:e.suggestion)?String(e.suggestion):"",i=a?`[${t}] ${a}`:`[${t}]`;return s?`${i}\n${n}\n建议: ${s}`:`${i}\n${n}`});return`硬约束冲突 (${s.length}):\n\n${i.join("\n\n")}`},ms=e=>{if(null==e)return"0";const t=Math.abs(e);return 0===e?"0 (完美)":t.toLocaleString()},hs=()=>{var e,t;const a=null==(t=null==(e=Mt.value)?void 0:e.statistics)?void 0:t.softConstraintsScore;if(null==a)return"warning";const n=Math.abs(a);return 0===a||n>=5e4?"success":n>=2e4?"info":"warning"};a(null);const vs=a(!1),fs=a(null),Gc=a(""),Yc=a([]),Xc=a(""),Kc=a(""),Zc=async(e,t)=>{const a="examiner1_1"===t||"examiner1_2"===t||"backup1"===t,n=a?e.rawDate1||e.date1:e.rawDate2||e.date2,s=a?e.shift1:e.shift2;fs.value=e;const i=e;i.examDate||(i.examDate=n),i.requiredShift||(i.requiredShift=s),Gc.value=t,Kc.value=e[t]||"";try{let a=qn&&qn.length>0?qn:Na.value&&Na.value.length>0?Na.value:await Un();if(!a||0===a.length)throw new Error("请先上传考官数据，或重新进行排班");if(!n)throw new Error("无法获取考试日期，请确保排班数据完整");const i=q.calculateDutySchedule(n);Yc.value=a.map(e=>{const t=tu(e.name),a=i.nightShift===e.group;let r="none";i.restGroups&&i.restGroups.includes(e.group)&&(r=i.restGroups[0]===e.group?"first":"second");let l=((e,t)=>{try{if(q.calculateDutySchedule(t).dayShift===e.group)return!1;if(Ve.isHoliday(t))return!1;const a=new Date(t).getDay(),n=0===a||6===a,s=!e.group||"无"===e.group||""===e.group.trim();return(!n||!s)&&!za.value.some(a=>a.examDate===t&&[a.examiner1_1,a.examiner1_2,a.backup1,a.examiner2_1,a.examiner2_2,a.backup2].includes(e.name))}catch(a){return!0}})(e,n);const o=!s||!e.shift||e.shift===s;o||(l=!1);let d=((e,t)=>{const a=[];try{Ve.isHoliday(t)&&a.push("节假日不可用");const n=new Date(t).getDay(),s=0===n||6===n,i=!e.group||"无"===e.group||""===e.group.trim();if(s&&i){const e=0===n?"周日":"周六";a.push(`行政班考官周末(${e})不可用`)}q.calculateDutySchedule(t).dayShift===e.group&&a.push("白班执勤");const r=tu(e.name);r>5&&a.push(`工作量${r}`),za.value.some(a=>{const n=a;return n.examDate===t&&[n.examiner1_1,n.examiner1_2,n.backup1,n.examiner2_1,n.examiner2_2,n.backup2].includes(e.name)})&&a.push("时间冲突")}catch(n){}return a.join(", ")})(e,n);return o||(d=d?`${d}; 轮班不匹配（需要${s}，考官是${e.shift}）`:`轮班不匹配（需要${s}，考官是${e.shift}）`),{...e,currentWorkload:t,nightShiftPreferred:a,restDayStatus:r,available:l,shiftMatched:o,conflictInfo:d}}),Xc.value=e[t]||"",await eu(e,t),vs.value=!0}catch(r){alert("获取考官列表失败，请重试")}},Qc=()=>{vs.value=!1,fs.value=null,Gc.value="",Xc.value="",Kc.value=""},eu=async(e,t)=>{try{e[t],e.examDate,e.requiredShift,e.student,e.department,e.level,za.value,t.includes("2"),t.includes("backup");kn.setConstraintConfig({softConstraints:{examiner1SameDept:ot.value.examiner1SameDept||!1,backupExaminerDiffDept:ot.value.backupExaminerDiffDept||!1}}),Yc.value.forEach(e=>{const t=tu(e.name);kn.updateWorkloadCache(e.id,t)})}catch(a){}},tu=e=>za.value.reduce((t,a)=>t+[a.examiner1_1,a.examiner1_2,a.backup1,a.examiner2_1,a.examiner2_2,a.backup2].filter(t=>t===e).length,0),au=async e=>{if(fs.value&&Gc.value){fs.value[Gc.value]=e.teacher;const a=e.conflicts.length>0?e.conflicts.some(e=>"error"===e.severity||"high"===e.severity)?"error":"warning":"none";try{ys.recordManualEdit(fs.value,Gc.value,Kc.value,e.teacher,a)}catch(t){}const n={field:Gc.value,originalValue:Kc.value,newValue:e.teacher,reason:e.reason,conflicts:e.conflicts,isForced:e.isForced,timestamp:(new Date).toISOString(),editedBy:"管理员",wasRecommended:e.wasRecommended||!1,recommendationScore:e.recommendationScore||0,recommendationPriority:e.recommendationPriority||"none"};fs.value.manualEdits||(fs.value.manualEdits=[]),fs.value.manualEdits.push(n);const s=za.value.find(e=>{var t,a;return e.student===(null==(t=fs.value)?void 0:t.student)&&e.department===(null==(a=fs.value)?void 0:a.department)});s&&(s[Gc.value]=e.teacher,s.manualEdits||(s.manualEdits=[]),s.manualEdits.push(n)),za.value=[...za.value],_(()=>{s&&gt(s,Gc.value)});try{const t=await nu(fs.value,Gc.value,e.teacher);t.hardViolations.length>0?su(`⚠️ 修改后违反${t.hardViolations.length}个硬约束！\n${t.hardViolations.join("\n")}`,"error"):t.softViolations.length>0?su(`修改成功！存在${t.softViolations.length}个软约束违反`,"warning"):su("✅ 修改成功！无约束违反","success")}catch(t){const a=e.isForced?`⚠️ 强制修改成功！已修改${Gc.value} 为${e.teacher}，存在${e.conflicts.length} 个冲突`:`修改成功！已修改${Gc.value} 为${e.teacher}`;su(a,e.isForced?"warning":"success")}tu(e.teacher),Kc.value&&tu(Kc.value),ru()}Qc()},nu=async(e,t,a)=>{const n=[],s=[],i=e.examDate,r=e.department;try{const l=Yc.value.find(e=>e.name===a);if(!l)return n.push("考官不存在"),{hardViolations:n,softViolations:s};"examiner1_1"===t&&l.department!==r&&n.push(`HC2违反: 主考官1 ${a}(${l.department}) 与学员(${r})不同科室`);q.calculateDutySchedule(i).dayShift===l.group&&n.push(`HC3违反: ${a} 在${i}执勤白班`);za.value.some(t=>{const n=t;return n.id!==e.id&&n.examDate===i&&[n.examiner1_1,n.examiner1_2,n.backup1,n.examiner2_1,n.examiner2_2,n.backup2].includes(a)})&&n.push(`HC4违反: ${a} 在${i}已有其他考试安排`);const o=Object.keys(e).filter(n=>(n.includes("examiner")||n.includes("backup"))&&n!==t&&e[n]===a);o.length>0&&n.push(`HC2违反: ${a} 已担任该学员的${o.join(", ")}`),t.includes("examiner2")&&l.department===r&&s.push(`SC2建议: 考官2建议选择不同科室，当前为${l.department}`);const d=tu(a);d>5&&s.push(`SC10建议: ${a} 工作量(${d})较重，建议平衡`)}catch(l){}return{hardViolations:n,softViolations:s}},su=(e,t="success")=>{const a=document.createElement("div");a.textContent=e,a.style.cssText=`\n    position: fixed; \n    top: 20px; \n    right: 20px; \n    background: ${"success"===t?"#10b981":"warning"===t?"#f59e0b":"#ef4444"}; \n    color: white; \n    padding: 12px 20px; \n    border-radius: 6px; \n    z-index: 9999; \n    font-weight: 500;\n    max-width: 400px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n  `,document.body.appendChild(a),setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},5e3)},iu=a(!1),ru=()=>{iu.value=!0},lu=e=>{const t=ja.value.has(e);return Math.random()<.05&&fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:isPinnedSchedule",message:"Checking if schedule is pinned",data:{scheduleId:e,result:t,pinnedSetSize:ja.value.size},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"C"})}).catch(()=>{}),t},ou=e=>{"Escape"===e.key&&cu()},du=()=>{Va.value&&Fa.value||(Fa.value=!1,La.value=null,Ua.value=1,Va.value=!1,document.removeEventListener("keydown",ou))},cu=()=>{Fa.value=!1,La.value=null,Ua.value=1,Va.value=!1,document.removeEventListener("keydown",ou),pe.info("已取消拖拽")},uu=async e=>{if(!La.value)return;const t=La.value,a=Ua.value,n=Ba.value,s=1===a?t.date1:t.date2;if(s===e)return pe.info("日期未改变"),void cu();Fa.value=!1,Va.value=!1,document.removeEventListener("keydown",ou);try{const i=Du.value.find(t=>t.value===e),r=(null==i?void 0:i.isOutOfRange)||!1;let l=e;if(n){const[t,a]=e.split(".").map(Number),n=(new Date).getFullYear(),s=new Date(n,t-1,a+1);l=`${String(s.getMonth()+1).padStart(2,"0")}.${String(s.getDate()).padStart(2,"0")}`}let o=`确认移动排班？\n      \n学员: ${t.student}\n考试类型: ${n?"两天考试":"单天考试"}\n\n${n?`第1天原日期: ${t.date1}\n第1天新日期: ${e}\n第2天原日期: ${t.date2}\n第2天新日期: ${l}`:`第${a}天原日期: ${s}\n第${a}天新日期: ${e}`}\n\n系统将自动调用后端重新分配考官，固定的排班不会改变。`;r&&(o+=`\n\n📅 提示：所选日期为延期日期\n原始考试截止：${it.value}\n新日期：${e}（延期到原范围后）\n\n建议：\n• 确保考官在该日期可用\n• 考虑通知相关人员日期变更`),await me.confirm(o,r?"📅 确认移动（延期）":"确认移动",{confirmButtonText:"确认移动",cancelButtonText:"取消",type:r?"info":"warning",dangerouslyUseHTMLString:!0}),await pu(String(t.id),a,e,n,l)}catch(i){}finally{La.value=null,Ua.value=1,Ba.value=!1}},pu=async(e,t,a,n=!1,s)=>{try{const i=za.value.find(t=>String(t.id)===e);if(!i)throw new Error("未找到目标排班");n?(i.date1=a,i.date2=s||a,i.rawDate1=yu(a)||i.rawDate1,i.rawDate2=yu(s||a)||i.rawDate2,i.examiner1_1="待分配",i.examiner1_2="待分配",i.backup1="待分配",i.examiner2_1="待分配",i.examiner2_2="待分配",i.backup2="待分配"):1===t?(i.date1=a,i.rawDate1=yu(a)||i.rawDate1,i.examiner1_1="待分配",i.examiner1_2="待分配",i.backup1="待分配"):(i.date2=a,i.rawDate2=yu(a)||i.rawDate2,i.examiner2_1="待分配",i.examiner2_2="待分配",i.backup2="待分配"),fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:partialReschedule:beforeAdd",message:"About to add scheduleId to pinnedScheduleIds",data:{scheduleId:e,scheduleIdType:typeof e,pinnedCountBefore:ja.value.size,allPinnedBefore:Array.from(ja.value)},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"A"})}).catch(()=>{}),ja.value.add(e),fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:partialReschedule:afterAdd",message:"After adding scheduleId to pinnedScheduleIds",data:{scheduleId:e,pinnedCountAfter:ja.value.size,allPinnedAfter:Array.from(ja.value)},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"A"})}).catch(()=>{}),wu(),Xe(),se.value=!0,pe.success({message:'✅ 日期已更新并自动固定！\n💡 现在可以点击"只重排固定排班"按钮重新分配考官',duration:6e3,showClose:!0})}catch(i){pe.error("移动失败: "+i.message)}},mu=async()=>{if(fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:triggerLocalReschedule:entry",message:"triggerLocalReschedule called",data:{pinnedCount:ja.value.size,totalSchedules:za.value.length,currentStartDate:st.value,currentEndDate:it.value},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"LocalReschedule"})}).catch(()=>{}),0===ja.value.size)return void pe.warning("请先固定需要重排的排班记录（点击排班记录上的图钉图标）");const e=ja.value.size,t=za.value.length;try{await me.confirm(`<div style="line-height: 1.8; font-size: 14px;">\n        <p>将对 <strong style="color: #409eff;">${e}</strong> 个固定排班进行局部重排</p>\n        <p>保持 <strong style="color: #67c23a;">${t-e}</strong> 个未固定排班不变</p>\n        <br/>\n        <p>🔧 <strong>功能说明：</strong></p>\n        <p>• 系统会在当前选定日期之后自动扩展日期范围</p>\n        <p>• 尝试顺序：2天 → 4天 → 6天 → 8天... 直到排班成功</p>\n        <p>• 所有约束条件（不可用考官、不可用时间）均会考虑</p>\n        <p>• 未固定的排班将完全保持不变</p>\n      </div>`,"确认局部重排",{confirmButtonText:"开始局部重排",cancelButtonText:"取消",type:"info",dangerouslyUseHTMLString:!0})}catch{return}We.value=!0,Ge.value="准备局部重排...";const a=st.value,n=it.value;if(!a||!n)return pe.error("请先设置考试日期范围"),void(We.value=!1);gu(a,n);const s=2*Math.max(2,Math.ceil(e/2)),i=Math.max(8,2*s),r=[];for(let d=2;d<=i;d+=2)r.push(d);let l="";for(const d of r){Ye.value=d,Ge.value=`正在尝试扩展 ${d} 天...`;const t=vu(n,d);try{it.value=t;if(await hu(a,t))return Ge.value="✅ 排班成功！",pe.success({message:`✅ 局部重排成功！\n📅 日期范围已自动扩展至 ${t}\n📌 ${e} 个固定排班已重新分配`,duration:5e3,showClose:!0}),Xe(),se.value=!0,void(We.value=!1)}catch(o){l=o.message||"排班失败",Ge.value=`扩展 ${d} 天失败: ${l.substring(0,50)}...`}}Ge.value="❌ 排班失败",pe.error({message:`❌ 局部重排失败\n已尝试扩展至 ${i} 天仍无法完成排班\n${l?"错误信息: "+l:""}\n\n建议：\n1. 检查考官资源是否充足\n2. 检查约束条件是否合理\n3. 尝试固定更少的排班记录`,duration:0,showClose:!0}),it.value=n,We.value=!1},hu=async(e,t)=>{const a=Array.from(ja.value),n=za.value.map(e=>String(e.id)).filter(e=>!a.includes(e)),s=new Map;Oa.value.forEach(e=>{const t=(null==e?void 0:e.examDays)||2;(null==e?void 0:e.name)&&s.set(e.name,t)});const i=za.value.map(e=>{const t=s.get(e.student)||e.examDays||2,a=1===t,i=e=>e&&"-"!==e&&"—"!==e&&"未安排"!==e?/^\d{4}-\d{2}-\d{2}$/.test(e)?e:yu(e):null,r=i(e.rawDate1)||i(e.date1),l=a?"":i(e.rawDate2)||i(e.date2||"");return{id:String(e.id),studentId:String(e.id),studentName:e.student,date1:r,examiner1_1:e.examiner1_1,examiner1_2:e.examiner1_2,backup1:e.backup1,examDays:t,date2:l,examiner2_1:a?"":e.examiner2_1,examiner2_2:a?"":e.examiner2_2,backup2:a?"":e.backup2,pinned:n.includes(String(e.id))}}),r=Oa.value.map(e=>({id:e.id||`student_${e.name}`,name:e.name,department:e.department,group:e.group||"无",examDays:e.examDays||2,day1Subjects:e.day1Subjects?JSON.stringify(e.day1Subjects):void 0,day2Subjects:e.day2Subjects?JSON.stringify(e.day2Subjects):void 0,recommendedExaminer1Dept:e.recommendedExaminer1Dept,recommendedExaminer2Dept:e.recommendedExaminer2Dept,recommendedBackupDept:e.recommendedBackupDept})),l=Na.value.map(e=>({id:e.id||`teacher_${e.name}`,name:e.name,department:e.department,group:e.group||"无",skills:e.skills||[],workload:e.workload||0,consecutiveDays:e.consecutiveDays||0,unavailablePeriods:(e.unavailablePeriods||[]).map(e=>({startDate:e.startDate,endDate:e.endDate,reason:e.reason||""}))})),o={pinnedScheduleIds:n,existingAssignments:i,students:r,teachers:l,startDate:e,endDate:t,constraints:ot.value},d=await fetch("/api/schedule/partial-reschedule",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!d.ok){const e=await d.text();throw new Error(`HTTP ${d.status}: ${e}`)}const c=await d.json();if(c.success&&c.assignments)return fu(c.assignments,n),!0;if(!c.success)throw new Error(c.message||c.error||"排班求解失败");return!1},gu=(e,t)=>{const a=new Date(e),n=new Date(t);let s=0;const i=new Date(a);for(;i<=n;){const e=i.getDay(),t=J.toStandardDate(i),a=0===e||6===e,n=Ve.isHoliday(t);a||n||s++,i.setDate(i.getDate()+1)}return s},vu=(e,t)=>{const a=new Date(e);let n=0;for(;n<t;){a.setDate(a.getDate()+1);const e=a.getDay(),t=J.toStandardDate(a),s=0===e||6===e,i=Ve.isHoliday(t);s||i||n++}return J.toStandardDate(a)},fu=(e,t)=>{za.value.forEach(e=>{t.includes(String(e.id))}),t.forEach(t=>{e.find(e=>String(e.id)===t),za.value.find(e=>String(e.id)===t)}),e.forEach((e,a)=>{var n,s,i,r,l,o,d,c,u,p,m,h,g,v,f,y,x;const b=String(e.id),w=b.endsWith("_DAY2")?b.replace(/_DAY2$/,""):b,D=t.includes(w);if(fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:10766",message:"Processing assignment",data:{index:a,student:null==(n=e.student)?void 0:n.name,assignmentId:b,baseId:w,isPinned:D,examiner1:e.examiner1,examiner1Name:null==(s=e.examiner1)?void 0:s.name,examiner2:e.examiner2,backupExaminer:e.backupExaminer},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"D"})}).catch(()=>{}),D)return;const k=za.value.find(t=>{var a;return t.student===(null==(a=e.student)?void 0:a.name)||String(t.id)===w});if(k){const t=e.examDate?xu(e.examDate):"";if(b.endsWith("_DAY2")||"day2"===e.examType){t&&(k.date2=t,k.rawDate2=yu(e.examDate)||e.examDate),fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:10812",message:"Updating Day2 examiners",data:{student:k.student,examiner1:e.examiner1,examiner2:e.examiner2,backupExaminer:e.backupExaminer,examiner1Name:null==(i=e.examiner1)?void 0:i.name,examiner2Name:null==(r=e.examiner2)?void 0:r.name,backupName:null==(l=e.backupExaminer)?void 0:l.name},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"B"})}).catch(()=>{});const a=(null==(o=e.examiner1)?void 0:o.name)||"待分配",n=(null==(d=e.examiner2)?void 0:d.name)||"待分配",s=(null==(c=e.backupExaminer)?void 0:c.name)||"待分配";fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:10820",message:"Day2 examiners resolved",data:{student:k.student,examiner2_1:a,examiner2_2:n,backup2:s,wasNull:!(null==(u=e.examiner1)?void 0:u.name)},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"B"})}).catch(()=>{}),k.examiner2_1=a,k.examiner2_2=n,k.backup2=s}else{if(k.date1,t&&(k.date1=t,k.rawDate1=yu(e.examDate)||e.examDate,1!==(null==k?void 0:k.examDays)&&k.date2&&"-"!==k.date2))try{const e=yu(t);if(e){const t=new Date(e);t.setDate(t.getDate()+1);const a=t.toISOString().split("T")[0],n=xu(a);k.date2=n,k.rawDate2=a}}catch(S){}fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:10862",message:"Updating Day1 examiners",data:{student:k.student,examiner1:e.examiner1,examiner2:e.examiner2,backupExaminer:e.backupExaminer,examiner1Name:null==(p=e.examiner1)?void 0:p.name,examiner2Name:null==(m=e.examiner2)?void 0:m.name,backupName:null==(h=e.backupExaminer)?void 0:h.name},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"A"})}).catch(()=>{});const a=(null==(g=e.examiner1)?void 0:g.name)||"待分配",n=(null==(v=e.examiner2)?void 0:v.name)||"待分配",s=(null==(f=e.backupExaminer)?void 0:f.name)||"待分配";fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:10868",message:"Day1 examiners resolved",data:{student:k.student,examiner1_1:a,examiner1_2:n,backup1:s,wasNull:!(null==(y=e.examiner1)?void 0:y.name)},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"A"})}).catch(()=>{}),k.examiner1_1=a,k.examiner1_2=n,k.backup1=s}}else fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:10883",message:"Schedule not found in frontend",data:{student:null==(x=e.student)?void 0:x.name,assignmentId:b,baseId:w,availableStudents:za.value.map(e=>e.student).slice(0,10)},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"E"})}).catch(()=>{})});const a=za.value.filter(e=>"待分配"===e.examiner1_1||"未分配"===e.examiner1_1||"待分配"===e.examiner2_1||"未分配"===e.examiner2_1);a.length>0&&(a.forEach(e=>{}),fetch("http://127.0.0.1:7242/ingest/6ce5fdaa-547e-4e87-9397-221316331b3e",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:10901",message:"Unassigned schedules after update",data:{count:a.length,schedules:a.map(e=>({student:e.student,id:e.id,examiner1_1:e.examiner1_1,examiner2_1:e.examiner2_1}))},timestamp:Date.now(),sessionId:"debug-session",runId:"pre-fix",hypothesisId:"F"})}).catch(()=>{})),za.value.forEach(e=>{t.includes(String(e.id))}),wu(),Xe(),se.value=!0},yu=e=>{const t="string"==typeof e?e.trim():"";if(!t||"-"===t||"—"===t)return null;const a=t.match(/^(\d{1,2})\.(\d{1,2})$/),n=t.match(/^(\d{1,2})-(\d{1,2})$/),s=a||n;if(s){const e=Number(s[1]),t=Number(s[2]),a=st.value,n=it.value,i=a&&/^\d{4}-\d{2}-\d{2}$/.test(a)?new Date(a).getTime():null,r=n&&/^\d{4}-\d{2}-\d{2}$/.test(n)?new Date(n).getTime():null,l=26784e5;let o=(new Date).getFullYear();if(null!==i&&null!==r){const s=new Date(a),d=new Date(n),c=Math.min(s.getFullYear(),d.getFullYear())-1,u=Math.max(s.getFullYear(),d.getFullYear())+1;let p=null,m=Number.POSITIVE_INFINITY;for(let a=c;a<=u;a+=1){const n=new Date(a,e-1,t).getTime();if(n>=i-l&&n<=r+l){const e=Math.abs(n-i);e<m&&(m=e,p=a)}}null!==p&&(o=p)}else if(a&&/^\d{4}-\d{2}-\d{2}$/.test(a)){const t=new Date(a),n=t.getMonth()+1;o=t.getFullYear(),e<n&&(o+=1)}return`${o}-${String(e).padStart(2,"0")}-${String(t).padStart(2,"0")}`}try{return J.toStandardDate(t)}catch(i){return null}},xu=e=>{if(!e)return"";try{return J.toDisplayDate(e)}catch(t){const a=J.parseDate(e);return`${String(a.getMonth()+1).padStart(2,"0")}.${String(a.getDate()).padStart(2,"0")}`}},bu=e=>{if(!e)return"";if(/^\d{1,2}\.\d{1,2}$/.test(e)){const t=e.match(/^(\d{1,2})\.(\d{1,2})$/);if(!t)return e;return`${String(Number(t[1])).padStart(2,"0")}.${String(Number(t[2])).padStart(2,"0")}`}try{return J.toDisplayDate(e)}catch(t){return e}},wu=()=>{za.value.slice(0,3).forEach(e=>{});const e=st.value,t=it.value,a=e&&/^\d{4}-\d{2}-\d{2}$/.test(e)?new Date(e).getTime():null,n=t&&/^\d{4}-\d{2}-\d{2}$/.test(t)?new Date(t).getTime():null,s=26784e5;za.value.sort((i,r)=>{const l=i=>{const r="string"==typeof(null==i?void 0:i.rawDate1)?i.rawDate1.trim():"";if(r&&"未安排"!==r&&"-"!==r&&"—"!==r){const e=J.parseDate(r).getTime();if(!Number.isNaN(e)&&e>0){if(null===a||null===n)return e;if(e>=a-s&&e<=n+s)return e}}const l=("string"==typeof(null==i?void 0:i.date1)?i.date1.trim():"").match(/^(\d{1,2})\.(\d{1,2})$/);if(!l)return Number.POSITIVE_INFINITY;const o=Number(l[1]),d=Number(l[2]);let c=(new Date).getFullYear();if(null!==a&&null!==n){const i=new Date(e),r=new Date(t),l=Math.min(i.getFullYear(),r.getFullYear())-1,u=Math.max(i.getFullYear(),r.getFullYear())+1;let p=null,m=Number.POSITIVE_INFINITY;for(let e=l;e<=u;e+=1){const t=new Date(e,o-1,d).getTime();if(t>=a-s&&t<=n+s){const n=Math.abs(t-a);n<m&&(m=n,p=e)}}null!==p&&(c=p)}else if(e&&/^\d{4}-\d{2}-\d{2}$/.test(e)){const t=new Date(e),a=t.getMonth()+1;c=t.getFullYear(),o<a&&(c+=1)}else{const e=new Date,t=e.getMonth()+1;c=e.getFullYear(),o<t&&(c+=1)}const u=`${c}-${String(o).padStart(2,"0")}-${String(d).padStart(2,"0")}`,p=J.parseDate(u).getTime();return Number.isNaN(p)||p<=0?Number.POSITIVE_INFINITY:p};return l(i)-l(r)}),za.value.slice(0,3).forEach(e=>{})},Du=n(()=>{const e=[];if(!st.value||!it.value)return e;const t=qn&&qn.length>0,a=new Date(st.value),n=new Date(it.value),s=new Date(a),i=new Date(n);i.setDate(i.getDate()+14);for(let r=new Date(s);r<=i;r.setDate(r.getDate()+1)){const s=J.toStorageDate(r).substring(5).replace("-","."),i=0===r.getDay()||6===r.getDay(),l=["周日","周一","周二","周三","周四","周五","周六"][r.getDay()],o=!(r>=a&&r<=n);let d="🟢",c="",u=!1;if(t){const e=za.value?za.value.filter(e=>e.date1===s||e.date2===s).length:0,t=((null==qn?void 0:qn.length)||0)-e;o?(d="⚠️",c="延期至原始范围后",u=!1):t>=3?(d="🟢",c=`可用约 ${t} 个考官`,u=!i):t>=1?(d="🔵",c=`可用约 ${t} 个考官`,u=!1):(d="🔴",c=`可用约 ${Math.max(0,t)} 个考官`,u=!1)}else d=i?"🔵":"🟢",c=o?"延期至原始范围后":"点击选择此日期",u=!i&&!o;e.push({value:s,label:`${s} (${l})${o?" 📅":""}`,icon:d,info:c,recommended:u,isWeekend:i,available:!0,isOutOfRange:o})}return e}),ku=async e=>{try{await gs.autoResolveConflict(e)?(su("冲突已自动解决","success"),await Cu()):su("自动解决失败，请手动处理","warning")}catch(t){su("自动解决冲突时发生错误","error")}},Su=async e=>{try{switch(e.type){case"adjust_time":await Eu(e.data);break;case"reassign_examiner":await _u(e.data);break;case"modify_constraint":await Tu(e.data)}su("操作执行成功","success")}catch(t){su("操作执行失败","error")}},$u=async()=>{try{await gs.exportErrorReport(),su("错误报告已导出","success")}catch(e){su("导出报告失败","error")}},Cu=async()=>{},Eu=async e=>{},_u=async e=>{},Tu=async e=>{},Iu=async()=>{try{if(0===za.value.length)return void alert("没有数据可以导出");const t=await e(()=>import("./excel-C2s3b8zA.js").then(e=>e.x),__vite__mapDeps([0,1]),import.meta.url),a=new Set,n=za.value.filter(e=>{const t=`${String(e.id??"")}|${e.student}|${e.department}|${e.date1}|${e.date2}`;return!a.has(t)&&(a.add(t),!0)}),s=[["所在科室","学员","第一天日期","第一天类型","第一天考官一","第一天考官二","第一天备份考官","第二天日期","第二天类型","第二天考官一","第二天考官二","第二天备份考官"]];n.forEach(e=>{s.push([e.department||"",e.student||"",e.date1||"","现场+模拟机",e.examiner1_1||"",e.examiner1_2||"",e.backup1||"",e.date2||"","模拟机+口试",e.examiner2_1||"",e.examiner2_2||"",e.backup2||""])});const i=t.utils.aoa_to_sheet(s);i["!cols"]=[{wch:12},{wch:10},{wch:12},{wch:15},{wch:10},{wch:10},{wch:12},{wch:12},{wch:15},{wch:10},{wch:10},{wch:12}];const r=t.utils.book_new();t.utils.book_append_sheet(r,i,"排班表");const l=new Date,o=(l.getFullYear(),String(l.getMonth()+1).padStart(2,"0"),String(l.getDate()).padStart(2,"0"),String(l.getHours()).padStart(2,"0"),String(l.getMinutes()).padStart(2,"0"),`排班表_${J.toStorageDate(l)}_${String(l.getHours()).padStart(2,"0")}${String(l.getMinutes()).padStart(2,"0")}.xlsx`);t.writeFile(r,o),alert(`✅ 导出成功！\n文件名：${o}\n记录数：${n.length}`)}catch(t){alert("导出失败，请重试")}},Pu=()=>{const e=document.querySelector(".app-container"),t=document.querySelector(".main-content"),a=document.querySelector(".schedule-table");if(!e||!t||!a)return;const n=e.clientWidth;a.scrollWidth>n-(A.value?80:280)-64&&!A.value&&(A.value=!0)},Ru=()=>{Pu()},Mu=()=>{Et.value=window.innerWidth,_t.value=window.innerHeight,St.value=Et.value<768,$t.value=Et.value>=768&&Et.value<1024,Ct.value=Et.value>=1024,St.value&&!A.value&&(A.value=!0),St.value&&(Tt.value=!1)},Au=()=>{St.value&&(Tt.value=!1)},Ou=()=>{St.value?St.value&&(Tt.value=!Tt.value):A.value=!A.value},Nu=n(()=>{if(!he.value.trim())return oe.value;const e=he.value.toLowerCase();return oe.value.filter(t=>t.name.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e))}),zu=()=>{if(0===za.value.length)return"无";const e=[];return za.value.forEach(t=>{t.rawDate1&&e.push(t.rawDate1),t.rawDate2&&e.push(t.rawDate2)}),e.sort(),0===e.length?"无":`${J.toDisplayDate(e[0])} 至 ${J.toDisplayDate(e[e.length-1])}`},ju=async()=>{if(K.value.trim())try{const e=za.value.map(e=>({id:e.id,student:e.student,department:e.department,date1:e.date1,date2:e.date2,type1:e.type1,type2:e.type2,examiner1_1:e.examiner1_1,examiner1_2:e.examiner1_2,backup1:e.backup1,examiner2_1:e.examiner2_1,examiner2_2:e.examiner2_2,backup2:e.backup2,manualEdits:e.manualEdits,constraintViolations:e.constraintViolations})),t=[];if(st.value&&it.value){const e=new Date(st.value),a=new Date(it.value),n=new Date(e);for(;n<=a;)t.push(J.toStorageDate(n)),n.setDate(n.getDate()+1)}const a=await ys.saveSnapshot(K.value,ee.value,e,ot.value,Oa.value,Na.value,t);te.value=a,se.value=!1,H.value=!1,K.value="",ee.value="";const n=Na.value.filter(e=>e.unavailablePeriods&&e.unavailablePeriods.length>0).length;pe.success({message:`排班快照保存成功！\n已保存 ${Oa.value.length} 位学员、${Na.value.length} 位考官${n>0?`（含 ${n} 位考官的不可用时间）`:""}`,duration:5e3}),await Fu()}catch(e){pe.error("保存快照失败，请重试")}else pe.warning("请输入快照名称")},Fu=async()=>{de.value=!0;try{const e=await ys.getSnapshotList({page:0,pageSize:100,sortBy:"createdAt",sortOrder:"desc"});oe.value=e.snapshots;const t=await ys.checkCleanupNeeded();ge.value=t}catch(e){pe.error("加载历史列表失败")}finally{de.value=!1}},Lu=e=>{const t=["姓名","name","科室","department","__rowNum__"],a=[];for(const n in e){if(t.includes(n)||n.startsWith("_"))continue;const s=e[n];if(null!=s&&""!==s){let e=n;e="学号"===n||"studentId"===n?"学号":"班级"===n||"class"===n?"班级":"专业"===n||"major"===n?"专业":"电话"===n||"phone"===n?"电话":"邮箱"===n||"email"===n?"邮箱":"备注"===n||"remark"===n||"note"===n?"备注":"考试类型"===n||"examType"===n?"考试类型":"考试科目"===n||"examSubject"===n?"考试科目":(n.includes("日期")||n.includes("date"),n),a.push({key:n,label:e,value:"object"==typeof s?JSON.stringify(s):String(s)})}}return a},Uu=async t=>{var a;const n=null==(a=t.target.files)?void 0:a[0];if(n){Ee.value=n,Re.value=null,Te.value=[];try{const t=await e(()=>import("./excel-C2s3b8zA.js").then(e=>e.x),__vite__mapDeps([0,1]),import.meta.url),a=new FileReader;a.onload=e=>{var a;try{const n=null==(a=e.target)?void 0:a.result,s=t.read(n,{type:"binary"}),i=s.SheetNames[0],r=s.Sheets[i],l=t.utils.sheet_to_json(r,{header:1,defval:""});let o=-1,d=[];for(let e=0;e<Math.min(l.length,20);e++){const t=l[e],a=t.map(e=>String(e||"").trim()).filter(e=>e);if(a.some(e=>e.includes("学员")||e.includes("姓名")||e.includes("学生"))){o=e,d=t.map(e=>String(e||"").trim());break}}if(-1===o)return void(Re.value={type:"error",message:"❌ 未找到有效的表头",details:'请确保Excel文件包含"学员"或"姓名"列'});const c=l.slice(o+1).map(e=>{const t={};return d.forEach((a,n)=>{a&&(t[a]=e[n]||"")}),t}).filter(e=>Object.keys(e).length>0),u=Hu(c);if(0===u.length){const e=c[0];if(e){const t=Object.keys(e),a=t.join("、");Re.value={type:"warning",message:"⚠️ 未识别到有效的排班数据",details:`检测到 ${t.length} 个列：\n${a}\n\n请检查：\n1. 是否包含"学员"或"姓名"列（必需）\n2. 列名是否与支持的格式匹配\n3. 点击上方"支持的列名格式"查看详情`}}else Re.value={type:"error",message:"❌ 文件中没有数据",details:"请确保Excel文件包含数据行（不只是表头）"};return}Te.value=u;const p=new Set(u.map(e=>e.student)).size,m=u.filter(e=>e.date1||e.date2).length,h=u.filter(e=>e.examiner1_1||e.examiner1_2||e.examiner2_1||e.examiner2_2).length;Re.value={type:"success",message:`✅ 成功解析 ${u.length} 条排班记录`,details:`包含 ${p} 位学员，${m} 条有日期信息，${h} 条有考官分配`}}catch(n){Re.value={type:"error",message:"❌ 解析文件失败",details:n instanceof Error?n.message:"未知错误"}}},a.onerror=()=>{Re.value={type:"error",message:"❌ 读取文件失败",details:"请检查文件是否损坏或格式是否正确"}},a.readAsBinaryString(n)}catch(s){pe.error("处理文件失败，请重试")}}},Bu=(e,t)=>{if(!e)return"日常班";let a="";if(t)try{const e=new Date(t);a=["周日","周一","周二","周三","周四","周五","周六"][e.getDay()]}catch(s){}const n=e.toUpperCase();return n.includes("模拟机")||n.includes("口试")||n.includes("面谈")?"白班":(n.includes("现场")||n.includes("实操"),"周六"===a||"周日"===a?"周末班":"日常班")},Hu=e=>{const t=[];e.length>0&&e[0];for(const a of e){const e=a["学员"]||a["姓名"]||a["学员姓名"]||a.name||a["学生"]||a["考生"]||a["学生姓名"]||"",n=a["科室"]||a["部门"]||a.department||a["专业"]||a["院系"]||a["所在科室"]||a["所属科室"]||"",s=a["考试日期1"]||a["第一次考试日期"]||a["日期1"]||a.date1||a["第一天"]||a["第一场日期"]||a["现场日期"]||a["实操日期"]||a["第一次日期"]||a["第一天日期"]||a["第1天日期"]||"",i=a["考试日期2"]||a["第二次考试日期"]||a["日期2"]||a.date2||a["第二天"]||a["第二场日期"]||a["面谈日期"]||a["口试日期"]||a["第二次日期"]||a["第二天日期"]||a["第2天日期"]||"",r=a["现场-考官1"]||a["考官1-1"]||a["第一场考官1"]||a.examiner1_1||a["实操考官1"]||a["现场考官1"]||a["考官1"]||a["主考官1"]||a["第一天考官一"]||a["第1天考官一"]||a["第一天考官1"]||"",l=a["现场-考官2"]||a["考官1-2"]||a["第一场考官2"]||a.examiner1_2||a["实操考官2"]||a["现场考官2"]||a["考官2"]||a["主考官2"]||a["第一天考官二"]||a["第1天考官二"]||a["第一天考官2"]||"",o=a["现场-备用"]||a["备用考官1"]||a["第一场备用"]||a.backup1||a["实操备用"]||a["现场备用"]||a["备用1"]||a["第一天备份考官"]||a["第1天备份考官"]||a["第一天备用"]||"",d=a["面谈-考官1"]||a["考官2-1"]||a["第二场考官1"]||a.examiner2_1||a["口试考官1"]||a["面谈考官1"]||a["面谈1"]||a["第二天考官一"]||a["第2天考官一"]||a["第二天考官1"]||"",c=a["面谈-考官2"]||a["考官2-2"]||a["第二场考官2"]||a.examiner2_2||a["口试考官2"]||a["面谈考官2"]||a["面谈2"]||a["第二天考官二"]||a["第2天考官二"]||a["第二天考官2"]||"",u=a["面谈-备用"]||a["备用考官2"]||a["第二场备用"]||a.backup2||a["口试备用"]||a["面谈备用"]||a["备用2"]||a["第二天备份考官"]||a["第2天备份考官"]||a["第二天备用"]||"",p=a["第一天类型"]||a["第1天类型"]||a["类型1"]||a["现场类型"]||a["实操类型"]||a.type1||"",m=a["第二天类型"]||a["第2天类型"]||a["类型2"]||a["面谈类型"]||a["口试类型"]||a.type2||"",h=Bu(p,s),g=Bu(m,i);if(e){const v=!i||"-"===i||!d&&!c&&!u,f={id:`uploaded-${Date.now()}-${t.length}`,student:e,department:n,date1:s?J.toDisplayDate(Wu(s)):"",date2:v?"-":i?J.toDisplayDate(Wu(i)):"",type1:v?"模拟机":p||"现场+模拟机1",type2:v?"-":m||"模拟机2+口试",shift1:h,shift2:v?"":g,examiner1_1:r,examiner1_2:l,backup1:o,examiner2_1:v?"-":d,examiner2_2:v?"-":c,backup2:v?"-":u,examDays:v?1:2,manualEdits:[],constraintViolations:[],_originalRow:a};t.push(f),t.length}}return t},Wu=e=>{if(!e)return"";if("number"==typeof e){const t=new Date(86400*(e-25569)*1e3);return J.toStorageDate(t)}const t=String(e).trim();return/^\d{4}[-/]\d{1,2}[-/]\d{1,2}$/.test(t)?t.replace(/\//g,"-"):t},Vu=()=>{Ee.value=null,Te.value=[],Re.value=null,Me.value="",_e.value&&(_e.value.value="")},qu=async()=>{if(0===Te.value.length)return void pe.warning("没有可加载的数据");const e=Te.value.map(e=>({"姓名":e.student,"科室":e.department,...e._originalRow||{}})).filter((e,t,a)=>t===a.findIndex(t=>t.姓名===e.姓名&&t.科室===e.科室));Oa.value=e,za.value=Te.value;const t=Te.value.map(e=>[e.date1,e.date2]).flat().filter(Boolean).sort((e,t)=>{const a=e=>{if(!e)return 0;const t=String(e);if(/^\d{4}-\d{2}-\d{2}$/.test(t))return new Date(t).getTime();const a=t.match(/^(\d{1,2})\.(\d{1,2})$/);if(!a)return 0;const n=Number(a[1]),s=Number(a[2]),i=st.value,r=i?new Date(i):new Date,l=r.getMonth()+1;let o=r.getFullYear();n<l&&(o+=1);const d=`${o}-${String(n).padStart(2,"0")}-${String(s).padStart(2,"0")}`;return new Date(d).getTime()};return a(e)-a(t)});t.length>0&&(st.value=t[0],it.value=t[t.length-1]),Ce.value=!1,Vu(),await _();const a=await Ju();za.value=[...za.value],setTimeout(()=>{const e=document.querySelector(".schedule-table-container");e&&e.scrollIntoView({behavior:"smooth",block:"start"})},100),a>0?pe.warning({message:`✅ 已加载 ${Te.value.length} 条排班记录\n${e.length} 位学员\n⚠️ 检测到 ${a} 处约束冲突，已标记为黄色\n点击黄色单元格可查看详情并修改`,duration:8e3}):pe.success({message:`✅ 已加载 ${Te.value.length} 条排班记录\n${e.length} 位学员\n✅ 所有考官分配符合约束要求\n排班表已显示在下方`,duration:5e3})},Ju=async()=>{if(!Na.value||0===Na.value.length)return 0;let e=0;for(const t of za.value){const a=[],n=[{field:"examiner1_1",date:t.date1,shift:t.shift1},{field:"examiner1_2",date:t.date1,shift:t.shift1},{field:"backup1",date:t.date1,shift:t.shift1},{field:"examiner2_1",date:t.date2,shift:t.shift2},{field:"examiner2_2",date:t.date2,shift:t.shift2},{field:"backup2",date:t.date2,shift:t.shift2}];for(const{field:e,date:s,shift:i}of n){const n=t[e];if(!n||"-"===n||!s)continue;const r=Na.value.find(e=>e.name===n);if(!r){a.push({field:e,type:"TEACHER_NOT_FOUND",severity:"high",message:`考官 ${n} 在系统中不存在`});continue}if(i&&r.shift&&r.shift!==i&&a.push({field:e,type:"SHIFT_MISMATCH",severity:"high",message:`考官 ${n} 轮班不匹配（需要${i}，但考官是${r.shift}）`}),r.unavailablePeriods&&r.unavailablePeriods.length>0){r.unavailablePeriods.some(e=>(e.date||e.startDate)===s)&&a.push({field:e,type:"UNAVAILABLE_PERIOD",severity:"high",message:`考官 ${n} 在 ${s} 不可用`})}const l=za.value.reduce((e,t)=>{let a=0;return t.examiner1_1===n&&a++,t.examiner1_2===n&&a++,t.backup1===n&&a++,t.examiner2_1===n&&a++,t.examiner2_2===n&&a++,t.backup2===n&&a++,e+a},0);r.workload&&l>r.workload&&a.push({field:e,type:"WORKLOAD_EXCEEDED",severity:"medium",message:`考官 ${n} 工作量超标（${l}/${r.workload}）`})}a.length>0&&(t.constraintViolations=a,e+=a.length)}return e},Gu=async()=>{var e;if(Me.value.trim())if(0!==Te.value.length)try{const t=Te.value.map(e=>({"姓名":e.student,"科室":e.department,...e._originalRow||{}})).filter((e,t,a)=>t===a.findIndex(t=>t.姓名===e.姓名&&t.科室===e.科室)),a=Te.value.map(e=>[e.date1,e.date2]).flat().filter(Boolean).sort((e,t)=>{const a=e=>{if(!e)return 0;const t=String(e);if(/^\d{4}-\d{2}-\d{2}$/.test(t))return new Date(t).getTime();const a=t.match(/^(\d{1,2})\.(\d{1,2})$/);if(!a)return 0;const n=Number(a[1]),s=Number(a[2]),i=st.value,r=i?new Date(i):new Date,l=r.getMonth()+1;let o=r.getFullYear();n<l&&(o+=1);const d=`${o}-${String(n).padStart(2,"0")}-${String(s).padStart(2,"0")}`;return new Date(d).getTime()};return a(e)-a(t)}),n=Array.from(new Set(a));await ys.saveSnapshot(Me.value,`从文件导入: ${(null==(e=Ee.value)?void 0:e.name)||""}`,Te.value,{},t,Na.value,n);Ce.value=!1,Vu(),pe.success({message:`✅ 排班快照保存成功！\n已保存 ${Te.value.length} 条记录，${t.length} 位学员`,duration:3e3}),await Fu()}catch(t){pe.error("保存快照失败，请重试")}else pe.warning("没有可保存的数据");else pe.warning("请填写快照名称")},Yu=async()=>{try{if(!za.value||0===za.value.length)return void pe.warning("没有可导出的排班数据");const e=`排班表_${J.toStorageDate(new Date)}.xlsx`;await xs.exportScheduleWithLegend(za.value,e),pe.success({message:"✅ 排班表导出成功（已保留颜色信息）",duration:3e3})}catch(e){pe.error("导出失败，请重试")}},Xu=async()=>{const e=new Date;e.setMonth(e.getMonth()-3);const t=oe.value.filter(t=>new Date(t.createdAt)<e);if(0===t.length)return void pe.info("没有需要清理的旧快照");if(confirm(`将删除 ${t.length} 个超过3个月的旧快照，确定继续吗？`))try{const e=t.map(e=>e.id);await ys.batchDeleteSnapshots(e),pe.success(`已删除 ${e.length} 个旧快照`),await Fu()}catch(a){pe.error("批量清理失败，请重试")}};s(G,async e=>{e&&await Fu()});let Ku=null;s(za,()=>{re.value||(Ku&&clearTimeout(Ku),Ku=setTimeout(()=>{te.value&&za.value.length>0&&(se.value=!0)},500))},{deep:!0}),s(za,()=>{za.value.length>0&&Xe()},{deep:!0}),s([Oa,Na,st,it],()=>{za.value.length>0&&Xe()}),s([Oa,Na,st,it,ra,ea],async()=>{Zu&&clearTimeout(Zu),Zu=window.setTimeout(async()=>{Oa.value.length>0&&cn()>=2&&await Promise.all([mn(),hn()])},500)},{immediate:!0,deep:!0});let Zu=null;return D(async()=>{fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:onMounted:entry",message:"Page mounted, checking initial pinned state",data:{pinnedCount:ja.value.size,allPinned:Array.from(ja.value)},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"E"})}).catch(()=>{});const e=(()=>{try{const e=localStorage.getItem(Jc+"state");if(e){const t=JSON.parse(e),a=new Date(t.timestamp);return((new Date).getTime()-a.getTime())/36e5>24?(localStorage.removeItem(Jc+"state"),!1):(re.value=!0,t.scheduleResults&&t.scheduleResults.length>0&&(za.value=t.scheduleResults),t.studentList&&(Oa.value=t.studentList),t.teacherList&&(Na.value=t.teacherList,qn=t.teacherList),t.examStartDateStr&&(st.value=t.examStartDateStr),t.examEndDateStr&&(it.value=t.examEndDateStr),t.constraints&&(ot.value=t.constraints),t.currentSnapshotInfo&&(te.value=t.currentSnapshotInfo),setTimeout(()=>{re.value=!1,se.value=!1},1e3),pe.success({message:`✅ 已恢复上次的排班数据（${t.scheduleResults.length} 条记录）`,duration:3e3}),!0)}return!1}catch(e){return!1}})();st.value||it.value||(e=>{const t=new Date,a=new Date(J.getNextDay(t)),n=new Date(a);for(let s=1;s<e;s++){const e=J.getNextDay(n);n.setTime(new Date(e).getTime())}st.value=J.toStandardDate(a),it.value=J.toStandardDate(n)})(45),"create"===$.query.action&&(Ke.value=!0);try{if(e&&Oa.value.length>0&&Na.value.length>0)return;await(async()=>{try{const e=await Cn.getAllStudents();Oa.value=e.map(e=>{var t,a,n,s;return{id:(null==(t=e.id)?void 0:t.toString())||e.studentId,name:e.name,department:e.department.name,group:(null==(a=e.group)?void 0:a.name)||"一组",recommendedExaminer1Dept:null==(n=e.recommendedExaminer1Dept)?void 0:n.name,recommendedExaminer2Dept:null==(s=e.recommendedExaminer2Dept)?void 0:s.name}}),Ht()}catch(e){Oa.value=[{id:"1",name:"杨杰",department:"一",group:"一组"},{id:"2",name:"顾秀莲",department:"一",group:"二组"},{id:"3",name:"黄伟",department:"一",group:"三组"},{id:"4",name:"廖轩",department:"一",group:"四组"},{id:"5",name:"黎明",department:"二",group:"一组"},{id:"6",name:"马恒",department:"二",group:"二组"},{id:"7",name:"何若",department:"二",group:"三组"}]}})();try{const e=await Un();Na.value=e,qn=e}catch(t){}za.value=[]}catch(t){za.value=[]}Mu(),window.addEventListener("resize",Ru),window.addEventListener("resize",Mu),_(()=>{setTimeout(Pu,100)})}),k(()=>{window.removeEventListener("resize",Ru),window.removeEventListener("resize",Mu),va.pause(),$a&&(clearInterval($a),$a=null),Ta&&(clearTimeout(Ta),Ta=null),Oe&&(Oe(),Oe=null),Ae&&"function"==typeof Ae.disconnect&&Ae.disconnect(),Ne=null}),(e,t)=>{var a,n,s,D,k,$,E,_,z,U,W,V,q,J,Y,oe,me,Ie,Pe,Ae,Oe,Ne,ze,je,Fe,Le,Ue,Be,He,Ve,qe,Je,Ge,Ye,Xe,tt,pt,ht,xt,bt,Dt,Et,_t,At,Ot,Ht,Gt,la;const ca=I("router-link");return l(),i(g,null,[o("div",Ds,[St.value&&Tt.value?(l(),i("div",{key:0,class:"mobile-overlay",onClick:Au})):r("",!0),o("aside",{class:h(["sidebar",{"sidebar-collapsed":A.value,"mobile-open":St.value&&Tt.value}])},[o("div",ks,[o("div",Ss,[t[53]||(t[53]=o("div",{class:"logo-icon"},[o("img",{src:j,alt:"系统图标",class:"logo-img"})],-1)),f(o("div",$s,[...t[52]||(t[52]=[o("h1",{class:"system-title"},"考试自动排班助手",-1),o("p",{class:"system-subtitle"},"Examiner Assignment Assistant",-1)])],512),[[T,!A.value]])])]),o("nav",Cs,[o("div",Es,[c(ca,{to:"/",class:"nav-item"},{default:S(()=>[c(p(L),{class:"nav-icon"}),f(o("span",_s,"首页",512),[[T,!A.value]])]),_:1}),c(ca,{to:"/teachers",class:"nav-item"},{default:S(()=>[c(p(N),{class:"nav-icon"}),f(o("span",Ts,"考官管理",512),[[T,!A.value]])]),_:1}),c(ca,{to:"/instructor-assignment",class:"nav-item"},{default:S(()=>[c(p(X),{class:"nav-icon"}),f(o("span",Is,"考官分配",512),[[T,!A.value]])]),_:1}),c(ca,{to:"/schedules",class:"nav-item nav-item-active"},{default:S(()=>[c(p(O),{class:"nav-icon"}),f(o("span",Ps,"自动排班",512),[[T,!A.value]])]),_:1})])]),f(o("div",Rs,[o("div",Ms,[t[54]||(t[54]=o("span",{class:"version-label"},"版本",-1)),o("span",As,"v"+m(C.value),1)])],512),[[T,!A.value]]),o("div",{class:"sidebar-toggle",onClick:Ou},[c(p(F),{class:h(["toggle-icon",{rotated:A.value}])},null,8,["class"])])],2),o("div",{class:h(["main-content padding-responsive",{"sidebar-open":St.value&&Tt.value,"mobile-layout":St.value,"tablet-layout":$t.value,"desktop-layout":Ct.value}])},[o("div",Os,[o("div",Ns,[t[61]||(t[61]=o("h1",{class:"page-title"},"排班管理",-1)),o("div",zs,[o("div",js,[t[55]||(t[55]=u(" 状态: ",-1)),o("span",{class:h(["px-2 py-1 rounded text-xs font-medium",ct.value?"bg-blue-100 text-blue-800 status-indicator updating":Kt.value?"bg-yellow-100 text-yellow-800 status-indicator solving":za.value.length>0?"bg-green-100 text-green-800 status-indicator completed":"bg-gray-100 text-gray-800 status-indicator ready"])},m(ct.value?"OptaPlanner增量更新中":Kt.value?"OptaPlanner求解进行中":!Kt.value&&za.value.length>0?"排班已完成":"准备就绪"),3)]),ut.value?(l(),i("div",Fs," 最后更新: "+m(ut.value),1)):r("",!0)]),o("div",Ls,[o("button",{class:h(["action-btn action-btn-primary",{loading:We.value}]),onClick:mu,disabled:We.value||0===ja.value.size,title:0===ja.value.size?"请先固定需要重排的排班记录":"为固定的排班记录在选定日期后自动扩展日期（2→4→6→8天）直到排班成功，未固定排班保持不变"},[c(p(ce),{class:h(["btn-icon",{spinning:We.value}])},null,8,["class"]),We.value?(l(),i("span",Ws,"局部重排中...")):(l(),i("span",Bs,[t[56]||(t[56]=u(" 局部重排 ",-1)),ja.value.size>0?(l(),i("span",Hs,"("+m(ja.value.size)+")",1)):r("",!0)]))],10,Us),Ze.value?(l(),i("button",{key:0,class:"action-btn action-btn-secondary",onClick:t[0]||(t[0]=e=>Ze.value=!1)},[...t[57]||(t[57]=[o("span",null,"退出",-1)])])):r("",!0),za.value.length>0?(l(),i("button",{key:1,class:"action-btn action-btn-success",onClick:Yu,title:"导出排班表（保留人工修改颜色信息）"},[c(p(ue),{class:"btn-icon"}),t[58]||(t[58]=o("span",null,"导出排班表",-1))])):r("",!0),za.value.length>0&&It.value?(l(),i("button",{key:2,class:"action-btn action-btn-warning",onClick:Kn,title:"如果排班结果不显示，点击此按钮强制刷新"},[c(p(ce),{class:"btn-icon"}),t[59]||(t[59]=o("span",null,"刷新显示",-1))])):r("",!0),Ze.value?r("",!0):(l(),i("button",{key:3,class:"action-btn action-btn-primary",onClick:Ga},[c(p(Q),{class:"btn-icon"}),t[60]||(t[60]=o("span",null,"新建排班",-1))]))])]),ct.value?(l(),i("div",Vs,[o("div",qs,[t[62]||(t[62]=o("div",{class:"loading-dots"},null,-1)),t[63]||(t[63]=o("span",null,"🔄 正在实时更新排班结果...",-1)),o("span",Js,"当前显示: "+m(za.value.length)+" 条记录",1)])])):r("",!0),Ea.value&&Kt.value?(l(),i("div",Gs,[...t[64]||(t[64]=[o("div",{class:"intermediate-indicator"},[o("span",{class:"pulse-icon"},"📊"),o("span",{class:"intermediate-text"},"这是中间结果预览，系统将在 3 秒后继续优化..."),o("div",{class:"countdown-bar"})],-1)])])):r("",!0),Ia.value?(l(),b(bn,{key:2,progress:fa.value,"status-message":dt.value||(null==(a=p(va).currentStage.value)?void 0:a.desc)||"","current-assignments":wt.value||0,"total-assignments":2*yt.value,"hard-score":ba.value,"soft-score":wa.value,"realtime-logs":kt.value,"is-completed":Da.value,"final-statistics":ka.value,onViewResult:Ra},null,8,["progress","status-message","current-assignments","total-assignments","hard-score","soft-score","realtime-logs","is-completed","final-statistics"])):(l(),i("div",{key:3,class:h(["table-container",{updating:ct.value}])},[o("table",Ys,[t[67]||(t[67]=o("thead",null,[o("tr",null,[o("th",null,"所在科室"),o("th",null,"学员"),o("th",null,"考试日期"),o("th",null,"考试类型"),o("th",null,"考官一"),o("th",null,"考官二"),o("th",null,"备份考官"),o("th",null,"考试日期"),o("th",null,"考试类型"),o("th",null,"考官一"),o("th",null,"考官二"),o("th",null,"备份考官"),o("th",null,"操作"),o("th",{class:"pin-column"},"固定"),o("th",{class:"drag-column"},"拖动")])],-1)),o("tbody",null,[(l(!0),i(g,null,v(za.value,(e,a)=>{var n,s,r,d,u,g,v,f,y;return l(),i("tr",{key:String((null==e?void 0:e.id)??`${(null==e?void 0:e.student)||"unknown"}-${(null==e?void 0:e.date1)||""}-${a}`),class:h({"animating-row":mt(a,"any",1),"is-pinned":lu(String(e.id)),"is-dragging":(null==(n=La.value)?void 0:n.id)===e.id,"hard-conflict-row":cs(e)}),title:us(e),draggable:!lu(String(e.id)),onDragstart:t=>((e,t,a)=>{if(lu(String(t.id)))return e.preventDefault(),void pe.warning("固定的排班无法拖动，请先取消固定");const n=1!==(null==t?void 0:t.examDays)&&!(!t.date1||!t.date2||"-"===t.date2||t.date1===t.date2);Fa.value=!0,La.value=t,Ua.value=a,Ba.value=n,Va.value=!0,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",String(t.id)),Ha.value=Math.max(20,(window.innerWidth-400)/2),Wa.value=Math.max(20,(window.innerHeight-500)/2),document.addEventListener("keydown",ou)})(t,e,1),onDragend:du},[o("td",Ks,m(w(null==e?void 0:e.department)),1),o("td",Zs,m((null==e?void 0:e.student)||"-"),1),o("td",{class:h(mt(a,"date",1)?`table-cell-${null==(s=mt(a,"date",1))?void 0:s.animationType}`:"")},m(bu(null==e?void 0:e.date1)),3),o("td",null,m((null==e?void 0:e.type1)||(1===(null==e?void 0:e.examDays)?"模拟机":"现场+模拟机1")),1),o("td",{class:h(["editable-cell",[mt(a,"examiner1",1)?`table-cell-${null==(r=mt(a,"examiner1",1))?void 0:r.animationType}`:"",gt(e,"examiner1_1")]]),title:vt(e,"examiner1_1"),onClick:t=>Zc(e,"examiner1_1")},m((null==e?void 0:e.examiner1_1)||"-"),11,Qs),o("td",{class:h(["editable-cell",[mt(a,"examiner2",1)?`table-cell-${null==(d=mt(a,"examiner2",1))?void 0:d.animationType}`:"",gt(e,"examiner1_2")]]),title:vt(e,"examiner1_2"),onClick:t=>Zc(e,"examiner1_2")},m((null==e?void 0:e.examiner1_2)||"-"),11,ei),o("td",{class:h(["editable-cell",[mt(a,"backup",1)?`table-cell-${null==(u=mt(a,"backup",1))?void 0:u.animationType}`:"",gt(e,"backup1")]]),title:vt(e,"backup1"),onClick:t=>Zc(e,"backup1")},m((null==e?void 0:e.backup1)||"-"),11,ti),o("td",{class:h([mt(a,"date",2)?`table-cell-${null==(g=mt(a,"date",2))?void 0:g.animationType}`:"",{"one-day-exam-cell":1===(null==e?void 0:e.examDays)}])},m(bu(null==e?void 0:e.date2)),3),o("td",{class:h({"one-day-exam-cell":1===(null==e?void 0:e.examDays)})},m((null==e?void 0:e.type2)||"模拟机2+口试"),3),o("td",{class:h(["editable-cell",[mt(a,"examiner1",2)?`table-cell-${null==(v=mt(a,"examiner1",2))?void 0:v.animationType}`:"",gt(e,"examiner2_1"),{"one-day-exam-cell":1===(null==e?void 0:e.examDays)}]]),title:1===(null==e?void 0:e.examDays)?"一天考试，无需分配":vt(e,"examiner2_1"),onClick:t=>1!==(null==e?void 0:e.examDays)&&Zc(e,"examiner2_1")},m((null==e?void 0:e.examiner2_1)||"-"),11,ai),o("td",{class:h(["editable-cell",[mt(a,"examiner2",2)?`table-cell-${null==(f=mt(a,"examiner2",2))?void 0:f.animationType}`:"",gt(e,"examiner2_2"),{"one-day-exam-cell":1===(null==e?void 0:e.examDays)}]]),title:1===(null==e?void 0:e.examDays)?"一天考试，无需分配":vt(e,"examiner2_2"),onClick:t=>1!==(null==e?void 0:e.examDays)&&Zc(e,"examiner2_2")},m((null==e?void 0:e.examiner2_2)||"-"),11,ni),o("td",{class:h(["editable-cell",[mt(a,"backup",2)?`table-cell-${null==(y=mt(a,"backup",2))?void 0:y.animationType}`:"",gt(e,"backup2"),{"one-day-exam-cell":1===(null==e?void 0:e.examDays)}]]),title:1===(null==e?void 0:e.examDays)?"一天考试，无需分配":vt(e,"backup2"),onClick:t=>1!==(null==e?void 0:e.examDays)&&Zc(e,"backup2")},m((null==e?void 0:e.backup2)||"-"),11,si),o("td",ii,[o("div",ri,[o("button",{class:"action-btn delete-btn",onClick:t=>(e=>{if(confirm(`确定要删除学员${e.student} 的排班记录吗？`)){const t=za.value.findIndex(t=>t.id===e.id);t>-1&&(za.value.splice(t,1),ru())}})(e),title:"删除"},[...t[65]||(t[65]=[P('<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-0981df0a><polyline points="3,6 5,6 21,6" data-v-0981df0a></polyline><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6" data-v-0981df0a></path><line x1="10" y1="11" x2="10" y2="17" data-v-0981df0a></line><line x1="14" y1="11" x2="14" y2="17" data-v-0981df0a></line></svg>',1)])],8,li)])]),o("td",oi,[o("button",{class:h(["pin-button",{"is-pinned":lu(String(e.id))}]),onClick:t=>{return a=String(e.id),fetch("http://127.0.0.1:7242/ingest/53a25d9f-31ac-4999-bbed-18803cf2b93a",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"SchedulesPage.vue:togglePinSchedule",message:"Manual pin toggle",data:{scheduleId:a,wasAlreadyPinned:ja.value.has(a),pinnedCountBefore:ja.value.size},timestamp:Date.now(),sessionId:"debug-session",hypothesisId:"B"})}).catch(()=>{}),void(ja.value.has(a)?(ja.value.delete(a),pe.success("已取消固定")):(ja.value.add(a),pe.success("已固定排班，拖拽时不会改变")));var a},title:lu(String(e.id))?"取消固定":"固定此排班"},[c(p(we),{class:h({filled:lu(String(e.id))})},null,8,["class"])],10,di)]),o("td",ci,[o("div",{class:h(["drag-handle",{disabled:lu(String(e.id))}]),title:lu(String(e.id))?"已固定，无法拖动":"拖动到新日期（按住拖动）"},[c(p(xe),{class:"drag-icon"})],10,ui)])],42,Xs)}),128)),(l(),i(g,null,v(20,e=>o("tr",{key:e},[...t[66]||(t[66]=[o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1),o("td",null,null,-1)])])),64))])])],2)),Fa.value&&Va.value?(l(),i("div",{key:4,class:"date-picker-overlay",style:x({left:Ha.value+"px",top:Wa.value+"px"}),onDragover:t[3]||(t[3]=d(()=>{},["prevent"]))},[o("div",pi,[o("div",mi,[t[68]||(t[68]=u(" 📅 选择新的考试日期 ",-1)),o("button",{class:"close-picker-btn",onClick:cu,title:"取消"},[c(p(ie),{size:16})])]),o("div",hi,[(l(!0),i(g,null,v(Du.value,e=>{var a,n;return l(),i("div",{key:e.value,class:h(["date-option",{"is-current":e.value===(1===Ua.value?null==(a=La.value)?void 0:a.date1:null==(n=La.value)?void 0:n.date2),"is-recommended":e.recommended,"is-weekend":e.isWeekend&&!e.isOutOfRange,"is-out-of-range":e.isOutOfRange}]),onClick:d(t=>uu(e.value),["stop","prevent"]),onDrop:d(t=>{return a=e.value,void uu(a);var a},["stop","prevent"]),onDragover:t[1]||(t[1]=d(()=>{},["prevent"])),onMousedown:t[2]||(t[2]=d(()=>{},["stop","prevent"]))},[o("span",vi,m(e.icon),1),o("span",fi,m(e.label),1),o("span",yi,m(e.info),1)],42,gi)}),128))]),t[69]||(t[69]=o("div",{class:"date-picker-footer"},[o("div",{class:"date-picker-tips"},[o("div",{style:{"font-weight":"600","margin-bottom":"8px"}},"💡 提示："),o("ul",{style:{margin:"0","padding-left":"20px","font-size":"12px"}},[o("li",null,"🟢 绿色 = 推荐日期（考官充足，范围内）"),o("li",null,"🔵 蓝色 = 周末或考官较少"),o("li",null,"⚠️ 黄色 = 超出原始范围（可选，但建议谨慎）"),o("li",null,"💡 点击日期选择，按 ESC 或点击 × 取消")])])],-1))])],36)):r("",!0),o("div",xi,[o("div",bi,[t[73]||(t[73]=o("h3",{class:"history-title"},"排班历史管理",-1)),o("div",wi,[za.value.length>0?(l(),i("button",{key:0,class:"action-btn action-btn-primary",onClick:t[4]||(t[4]=e=>H.value=!0),title:"保存当前排班为历史记录"},[c(p(ae),{class:"btn-icon"}),t[70]||(t[70]=o("span",null,"保存快照",-1))])):r("",!0),o("button",{class:"action-btn action-btn-secondary",onClick:t[5]||(t[5]=e=>G.value=!0),title:"查看历史排班记录"},[c(p(fe),{class:"btn-icon"}),t[71]||(t[71]=o("span",null,"历史记录",-1))]),o("button",{class:"action-btn action-btn-info",onClick:t[6]||(t[6]=e=>Ce.value=!0),title:"上传已有的排班表进行编辑"},[c(p(B),{class:"btn-icon"}),t[72]||(t[72]=o("span",null,"上传排班表",-1))])])]),te.value?(l(),i("div",Di,[o("p",ki,[t[74]||(t[74]=u(" 当前编辑: ",-1)),o("strong",null,m(te.value.name),1),se.value?(l(),i("span",Si,"未保存")):r("",!0)])])):r("",!0)])])],2),H.value?(l(),i("div",{key:1,class:"modal-overlay",onClick:t[12]||(t[12]=e=>H.value=!1)},[o("div",{class:"modal-content",onClick:t[11]||(t[11]=d(()=>{},["stop"])),style:{"max-width":"500px"}},[o("div",$i,[t[75]||(t[75]=o("h2",{class:"modal-title"},"保存排班快照",-1)),o("button",{class:"close-btn",onClick:t[7]||(t[7]=e=>H.value=!1)},[c(p(ie),{class:"w-5 h-5"})])]),o("div",Ci,[o("div",Ei,[t[76]||(t[76]=o("label",{class:"form-label"},[u("快照名称 "),o("span",{class:"text-red-500"},"*")],-1)),f(o("input",{"onUpdate:modelValue":t[8]||(t[8]=e=>K.value=e),type:"text",class:"form-input",placeholder:"例如: 2025年春季考试排班",maxlength:"50"},null,512),[[y,K.value]])]),o("div",_i,[t[77]||(t[77]=o("label",{class:"form-label"},"描述说明",-1)),f(o("textarea",{"onUpdate:modelValue":t[9]||(t[9]=e=>ee.value=e),class:"form-textarea",placeholder:"添加一些备注信息，方便日后查找",rows:"3",maxlength:"200"},null,512),[[y,ee.value]])]),o("div",Ti,[t[80]||(t[80]=o("p",{class:"text-sm font-medium text-gray-700",style:{"margin-bottom":"8px"}},"📦 将保存以下完整数据：",-1)),o("ul",Ii,[o("li",null,"✅ 排班结果: "+m(za.value.length)+" 条记录",1),o("li",null,"✅ 学员数据: "+m(Oa.value.length)+" 位学员",1),o("li",null,[u("✅ 考官数据: "+m(Na.value.length)+" 位考官 ",1),Na.value.filter(e=>{var t;return(null==(t=e.unavailablePeriods)?void 0:t.length)>0}).length>0?(l(),i("span",Pi," （含 "+m(Na.value.filter(e=>{var t;return(null==(t=e.unavailablePeriods)?void 0:t.length)>0}).length)+" 位考官的不可用时间） ",1)):r("",!0)]),o("li",null,"✅ 考试日期: "+m(zu()),1),t[78]||(t[78]=o("li",null,"✅ 人工修改记录",-1)),t[79]||(t[79]=o("li",null,"✅ 约束配置",-1))]),t[81]||(t[81]=o("p",{class:"text-xs text-gray-500",style:{"margin-top":"12px","padding-top":"8px","border-top":"1px solid #e5e7eb"}}," 💡 加载此快照后，所有数据（包括教师不可用时间）都将恢复，可直接继续编辑或重新排班 ",-1))])]),o("div",Ri,[o("button",{class:"action-btn action-btn-secondary",onClick:t[10]||(t[10]=e=>H.value=!1)}," 取消 "),o("button",{class:"action-btn action-btn-primary",onClick:ju,disabled:!K.value.trim()}," 保存 ",8,Mi)])])])):r("",!0),G.value?(l(),i("div",{key:2,class:"modal-overlay",onClick:t[17]||(t[17]=e=>G.value=!1)},[o("div",{class:"modal-content",onClick:t[16]||(t[16]=d(()=>{},["stop"])),style:{"max-width":"900px","max-height":"80vh"}},[o("div",Ai,[t[82]||(t[82]=o("h2",{class:"modal-title"},"历史排班记录",-1)),o("button",{class:"close-btn",onClick:t[13]||(t[13]=e=>G.value=!1)},[c(p(ie),{class:"w-5 h-5"})])]),o("div",Oi,[o("div",Ni,[f(o("input",{"onUpdate:modelValue":t[14]||(t[14]=e=>he.value=e),type:"text",class:"form-input",placeholder:"搜索快照名称...",style:{"max-width":"300px"}},null,512),[[y,he.value]])]),ge.value.needsCleanup?(l(),i("div",zi,[c(p(Z),{class:"w-5 h-5 text-yellow-600"}),o("div",ji,[t[83]||(t[83]=o("p",{class:"text-sm font-medium"},"建议清理历史记录",-1)),o("p",Fi," 您已保存 "+m(ge.value.snapshotCount)+" 个快照， 建议删除 "+m(ge.value.recommendedDeleteCount)+" 个超过3个月的旧记录 ",1)]),o("button",{class:"action-btn action-btn-sm action-btn-warning",onClick:Xu}," 一键清理 ")])):r("",!0),de.value?(l(),i("div",Li,[c(p(ce),{class:"w-6 h-6 spinning"}),t[84]||(t[84]=o("p",null,"加载中...",-1))])):0===Nu.value.length?(l(),i("div",Ui,[...t[85]||(t[85]=[o("p",{class:"text-gray-500"},"暂无历史记录",-1)])])):(l(),i("div",Bi,[(l(!0),i(g,null,v(Nu.value,e=>{var a,n,s,d,g;return l(),i("div",{key:e.id,class:h(["history-item",{active:(null==(a=te.value)?void 0:a.id)===e.id}])},[o("div",Hi,[o("h4",Wi,m(e.name),1),o("span",Vi,m((g=e.createdAt,new Date(g).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}))),1)]),e.description?(l(),i("p",qi,m(e.description),1)):r("",!0),o("div",Ji,[o("span",Gi,"📋 排班: "+m((null==(n=e.scheduleData)?void 0:n.length)||0)+" 条",1),o("span",{class:"meta-item meta-item-clickable",onClick:t=>(e=>{e.metadata&&e.metadata.studentList?(ke.value=e.metadata.studentList,be.value=!0):pe.warning("该快照没有保存学员详细信息")})(e),title:"点击查看学员列表"}," 👨‍🎓 学员: "+m((null==(s=e.metadata.studentList)?void 0:s.length)||e.metadata.totalStudents)+" 位 ",9,Yi),o("span",Xi,"👨‍🏫 考官: "+m((null==(d=e.metadata.teacherList)?void 0:d.length)||e.metadata.totalTeachers)+" 位",1),e.metadata.teacherList&&e.metadata.teacherList.filter(e=>{var t;return(null==(t=e.unavailablePeriods)?void 0:t.length)>0}).length>0?(l(),i("span",{key:0,class:"meta-item meta-item-warning meta-item-clickable",onClick:t=>(e=>{if(e.metadata&&e.metadata.teacherList){const t=e.metadata.teacherList.filter(e=>e.unavailablePeriods&&e.unavailablePeriods.length>0);Se.value=t,De.value=!0}else pe.warning("该快照没有保存考官详细信息")})(e),title:"点击查看不可用时间详情"}," ⚠️ "+m(e.metadata.teacherList.filter(e=>{var t;return(null==(t=e.unavailablePeriods)?void 0:t.length)>0}).length)+" 位考官有不可用时间 ",9,Ki)):r("",!0),o("span",Zi,"✏️ 修改: "+m(e.metadata.manualEditCount),1),o("span",Qi,"📅 "+m(e.metadata.dateRange.start)+" ~ "+m(e.metadata.dateRange.end),1)]),o("div",er,[o("button",{class:"action-btn action-btn-sm action-btn-primary",onClick:t=>(async e=>{try{const t=await ys.getSnapshot(e);if(se.value&&!confirm("当前有未保存的修改，是否放弃并加载历史排班？"))return;re.value=!0,za.value=t.scheduleData.map(e=>({id:e.id,department:e.department,student:e.student,date1:e.date1,type1:e.type1||(1===e.examDays?"模拟机":"现场+模拟机1"),examiner1_1:e.examiner1_1,examiner1_2:e.examiner1_2,backup1:e.backup1,date2:e.date2,type2:e.type2||"模拟机2+口试",examiner2_1:e.examiner2_1,examiner2_2:e.examiner2_2,backup2:e.backup2,examDays:e.examDays||2,manualEdits:e.manualEdits,constraintViolations:e.constraintViolations})),t.metadata.studentList&&(Oa.value=t.metadata.studentList),t.metadata.teacherList&&(Na.value=t.metadata.teacherList,qn=t.metadata.teacherList,Na.value.filter(e=>e.unavailablePeriods&&e.unavailablePeriods.length>0)),t.metadata.examDates&&t.metadata.examDates.length>0&&(st.value=t.metadata.examDates[0],it.value=t.metadata.examDates[t.metadata.examDates.length-1]),t.metadata.constraintConfig&&Object.assign(ot.value,t.metadata.constraintConfig),te.value=t,se.value=!1,G.value=!1,setTimeout(()=>{re.value=!1,se.value=!1},1e3);const a=[];if(a.push(`排班: ${t.scheduleData.length} 条`),t.metadata.studentList&&a.push(`学员: ${t.metadata.studentList.length} 位`),t.metadata.teacherList){const e=t.metadata.teacherList.filter(e=>e.unavailablePeriods&&e.unavailablePeriods.length>0).length;a.push(`教师: ${t.metadata.teacherList.length} 位${e>0?`（${e} 位有不可用时间）`:""}`)}pe.success({message:`已加载排班: ${t.name}\n${a.join("、")}`,duration:5e3})}catch(t){pe.error("加载排班失败，请重试")}})(e.id)},[c(p(ye),{class:"w-4 h-4"}),t[86]||(t[86]=u(" 加载 ",-1))],8,tr),o("button",{class:"action-btn action-btn-sm action-btn-danger",onClick:t=>(async e=>{var t;if(confirm("确定要删除这个排班快照吗？此操作无法撤销。"))try{await ys.deleteSnapshot(e),pe.success("删除成功"),await Fu(),(null==(t=te.value)?void 0:t.id)===e&&(te.value=null)}catch(a){pe.error("删除快照失败，请重试")}})(e.id)},[c(p(ne),{class:"w-4 h-4"}),t[87]||(t[87]=u(" 删除 ",-1))],8,ar)])],2)}),128))]))]),o("div",nr,[o("button",{class:"action-btn action-btn-secondary",onClick:t[15]||(t[15]=e=>G.value=!1)}," 关闭 ")])])])):r("",!0),be.value?(l(),i("div",{key:3,class:"modal-overlay",onClick:t[21]||(t[21]=e=>be.value=!1)},[o("div",{class:"modal-content",onClick:t[20]||(t[20]=d(()=>{},["stop"])),style:{"max-width":"600px"}},[o("div",sr,[t[88]||(t[88]=o("h2",{class:"modal-title"},"学员列表",-1)),o("button",{class:"close-btn",onClick:t[18]||(t[18]=e=>be.value=!1)},[c(p(ie),{class:"w-5 h-5"})])]),o("div",ir,[o("p",rr,[t[89]||(t[89]=u(" 共 ",-1)),o("strong",null,m(ke.value.length),1),t[90]||(t[90]=u(" 位学员 ",-1))]),o("div",lr,[(l(!0),i(g,null,v(ke.value,(e,t)=>(l(),i("div",{key:t,style:{padding:"16px",background:"#ffffff",border:"1px solid #e5e7eb","border-radius":"8px"}},[o("div",or,[o("div",dr,m((e.姓名||e.name||"学")[0]),1),o("div",cr,[o("p",ur,m(e.姓名||e.name||"未知"),1),e.科室||e.department?(l(),i("p",pr,m(w(e.科室||e.department)),1)):r("",!0)])]),Lu(e).length>0?(l(),i("div",mr,[(l(!0),i(g,null,v(Lu(e),e=>(l(),i("div",{key:e.key,style:{padding:"8px",background:"#f9fafb","border-radius":"4px"}},[o("p",hr,m(e.label),1),o("p",gr,m(e.value),1)]))),128))])):r("",!0)]))),128))])]),o("div",vr,[o("button",{class:"action-btn action-btn-secondary",onClick:t[19]||(t[19]=e=>be.value=!1)}," 关闭 ")])])])):r("",!0),De.value?(l(),i("div",{key:4,class:"modal-overlay",onClick:t[25]||(t[25]=e=>De.value=!1)},[o("div",{class:"modal-content",onClick:t[24]||(t[24]=d(()=>{},["stop"])),style:{"max-width":"700px"}},[o("div",fr,[t[91]||(t[91]=o("h2",{class:"modal-title"},"考官不可用时间详情",-1)),o("button",{class:"close-btn",onClick:t[22]||(t[22]=e=>De.value=!1)},[c(p(ie),{class:"w-5 h-5"})])]),o("div",yr,[o("p",xr,[t[92]||(t[92]=u(" 共 ",-1)),o("strong",null,m(Se.value.length),1),t[93]||(t[93]=u(" 位考官有不可用时间 ",-1))]),o("div",br,[(l(!0),i(g,null,v(Se.value,(e,t)=>{var a;return l(),i("div",{key:t,style:{padding:"16px",background:"#fff7ed",border:"1px solid #fed7aa","border-radius":"8px"}},[o("div",wr,[o("div",null,[o("span",Dr,m(e.name),1),e.department?(l(),i("span",kr,m(e.department),1)):r("",!0)]),o("span",Sr,m((null==(a=e.unavailablePeriods)?void 0:a.length)||0)+" 个时段 ",1)]),o("div",$r,[(l(!0),i(g,null,v(e.unavailablePeriods,(e,t)=>(l(),i("div",{key:t,style:{padding:"6px 10px",background:"white","border-radius":"4px","margin-top":"4px","font-size":"14px",display:"flex","justify-content":"space-between"}},[o("span",null,"📅 "+m(e.date||e.startDate),1),o("span",Cr,m(e.reason||"不可用"),1)]))),128))])])}),128))])]),o("div",Er,[o("button",{class:"action-btn action-btn-secondary",onClick:t[23]||(t[23]=e=>De.value=!1)}," 关闭 ")])])])):r("",!0),Ce.value?(l(),i("div",{key:5,class:"modal-overlay",onClick:t[31]||(t[31]=e=>Ce.value=!1)},[o("div",{class:"modal-content",onClick:t[30]||(t[30]=d(()=>{},["stop"])),style:{"max-width":"700px"}},[o("div",_r,[t[94]||(t[94]=o("h2",{class:"modal-title"},"上传排班表",-1)),o("button",{class:"close-btn",onClick:t[26]||(t[26]=e=>Ce.value=!1)},[c(p(ie),{class:"w-5 h-5"})])]),o("div",Tr,[t[100]||(t[100]=P('<div style="margin-bottom:16px;padding:12px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;" data-v-0981df0a><p style="margin:0;color:#1e40af;line-height:1.6;font-size:14px;" data-v-0981df0a><strong data-v-0981df0a>💡 使用说明：</strong><br data-v-0981df0a> 1️⃣ 上传已有的排班表（Excel/CSV格式）<br data-v-0981df0a> 2️⃣ 系统自动解析并显示预览<br data-v-0981df0a> 3️⃣ 选择&quot;加载到排班表&quot;或&quot;直接保存为快照&quot;<br data-v-0981df0a> 4️⃣ 加载后可在下方排班表区域进行修改、导出 </p></div><details style="margin-bottom:16px;padding:12px;background:#fef3c7;border:1px solid #fde68a;border-radius:6px;" data-v-0981df0a><summary style="cursor:pointer;color:#92400e;font-weight:500;font-size:14px;" data-v-0981df0a> 📋 支持的列名格式（点击查看） </summary><div style="margin-top:12px;color:#78350f;font-size:13px;line-height:1.8;" data-v-0981df0a><p style="margin:0 0 8px 0;" data-v-0981df0a><strong data-v-0981df0a>系统会自动识别以下列名：</strong></p><ul style="margin:0;padding-left:20px;" data-v-0981df0a><li data-v-0981df0a><strong data-v-0981df0a>学员：</strong>学员、姓名、学员姓名、学生、考生</li><li data-v-0981df0a><strong data-v-0981df0a>科室：</strong>科室、部门、专业、院系、所在科室</li><li data-v-0981df0a><strong data-v-0981df0a>日期1：</strong>考试日期1、第一次考试日期、第一天日期、现场日期、实操日期</li><li data-v-0981df0a><strong data-v-0981df0a>日期2：</strong>考试日期2、第二次考试日期、第二天日期、面谈日期、口试日期</li><li data-v-0981df0a><strong data-v-0981df0a>第一天考官1：</strong>现场-考官1、第一天考官一、实操考官1、考官1</li><li data-v-0981df0a><strong data-v-0981df0a>第一天考官2：</strong>现场-考官2、第一天考官二、实操考官2、考官2</li><li data-v-0981df0a><strong data-v-0981df0a>第一天备用：</strong>现场-备用、第一天备份考官、实操备用、备用1</li><li data-v-0981df0a><strong data-v-0981df0a>第二天考官1：</strong>面谈-考官1、第二天考官一、口试考官1、面谈1</li><li data-v-0981df0a><strong data-v-0981df0a>第二天考官2：</strong>面谈-考官2、第二天考官二、口试考官2、面谈2</li><li data-v-0981df0a><strong data-v-0981df0a>第二天备用：</strong>面谈-备用、第二天备份考官、口试备用、备用2</li></ul><p style="margin:12px 0 0 0;color:#b45309;" data-v-0981df0a> 💡 <strong data-v-0981df0a>提示：</strong>如果列名不匹配，解析后会在浏览器控制台（F12）显示检测到的列名，方便您调整Excel文件。 </p></div></details>',2)),o("div",Ir,[o("input",{ref_key:"scheduleFileInput",ref:_e,type:"file",accept:".xlsx,.xls,.csv",onChange:Uu,style:{display:"none"}},null,544),Ee.value?(l(),i("div",Rr,[o("div",Mr,[o("div",Ar,[c(p(B),{style:{width:"24px",height:"24px",color:"#10b981"}}),o("div",null,[o("p",Or,m(Ee.value.name),1),o("p",Nr,m(Nn(Ee.value.size)),1)])]),o("button",{onClick:Vu,style:{padding:"4px 8px",background:"#dc2626",color:"white",border:"none","border-radius":"4px",cursor:"pointer","font-size":"12px"}}," 移除 ")])])):(l(),i("div",{key:0,class:"upload-placeholder",onClick:t[27]||(t[27]=e=>{var t;return null==(t=_e.value)?void 0:t.click()}),style:{padding:"40px","text-align":"center",border:"2px dashed #d1d5db","border-radius":"8px",cursor:"pointer",background:"#f9fafb"}},[o("div",Pr,[c(p(B),{style:{width:"48px",height:"48px",color:"#9ca3af",margin:"0 auto"}})]),t[95]||(t[95]=o("p",{style:{"font-size":"16px",color:"#374151","margin-bottom":"4px"}},"点击选择排班表文件",-1)),t[96]||(t[96]=o("p",{style:{"font-size":"14px",color:"#6b7280"}},"支持 .xlsx, .xls, .csv 格式",-1))]))]),Re.value?(l(),i("div",{key:0,style:x({padding:"12px 16px",borderRadius:"8px",marginBottom:"20px",background:"success"===Re.value.type?"#ecfdf5":"error"===Re.value.type?"#fef2f2":"#fef3c7",border:"success"===Re.value.type?"1px solid #a7f3d0":"error"===Re.value.type?"1px solid #fecaca":"1px solid #fde68a",color:"success"===Re.value.type?"#065f46":"error"===Re.value.type?"#991b1b":"#92400e"})},[o("p",zr,m(Re.value.message),1),Re.value.details?(l(),i("p",jr,m(Re.value.details),1)):r("",!0)],4)):r("",!0),Te.value.length>0?(l(),i("div",Fr,[t[98]||(t[98]=o("p",{style:{"font-weight":"500",color:"#374151","margin-bottom":"8px"}},"📊 数据预览（前10条）：",-1)),o("div",Lr,[o("table",Ur,[t[97]||(t[97]=o("thead",{style:{background:"#f9fafb",position:"sticky",top:"0"}},[o("tr",null,[o("th",{style:{padding:"8px","text-align":"left","border-bottom":"1px solid #e5e7eb"}},"学员"),o("th",{style:{padding:"8px","text-align":"left","border-bottom":"1px solid #e5e7eb"}},"科室"),o("th",{style:{padding:"8px","text-align":"left","border-bottom":"1px solid #e5e7eb"}},"日期1"),o("th",{style:{padding:"8px","text-align":"left","border-bottom":"1px solid #e5e7eb"}},"日期2"),o("th",{style:{padding:"8px","text-align":"left","border-bottom":"1px solid #e5e7eb"}},"现场-考官1"),o("th",{style:{padding:"8px","text-align":"left","border-bottom":"1px solid #e5e7eb"}},"面谈-考官1")])],-1)),o("tbody",null,[(l(!0),i(g,null,v(Te.value.slice(0,10),(e,t)=>(l(),i("tr",{key:t,style:{"border-bottom":"1px solid #f3f4f6"}},[o("td",Br,m(e.student),1),o("td",Hr,m(e.department),1),o("td",Wr,m(e.date1),1),o("td",Vr,m(e.date2),1),o("td",qr,m(e.examiner1_1),1),o("td",Jr,m(e.examiner2_1),1)]))),128))])])]),Te.value.length>10?(l(),i("p",Gr," * 共 "+m(Te.value.length)+" 条记录，仅显示前10条预览 ",1)):r("",!0)])):r("",!0),Te.value.length>0?(l(),i("div",Yr,[t[99]||(t[99]=o("label",{style:{display:"block","margin-bottom":"8px","font-weight":"500",color:"#374151"}}," 快照名称（可选，用于直接保存） ",-1)),f(o("input",{"onUpdate:modelValue":t[28]||(t[28]=e=>Me.value=e),type:"text",class:"form-input",placeholder:"例如: 导入的2025春季排班表",style:{width:"100%",padding:"8px 12px",border:"1px solid #d1d5db","border-radius":"6px","font-size":"14px"}},null,512),[[y,Me.value]])])):r("",!0)]),o("div",Xr,[o("button",{class:"action-btn action-btn-secondary",onClick:t[29]||(t[29]=e=>Ce.value=!1)}," 取消 "),Te.value.length>0?(l(),i("button",{key:0,class:"action-btn action-btn-primary",onClick:qu,style:{"margin-left":"8px"}}," 加载到排班表 ")):r("",!0),Te.value.length>0&&Me.value.trim()?(l(),i("button",{key:1,class:"action-btn action-btn-success",onClick:Gu,style:{"margin-left":"8px",background:"#10b981"}}," 直接保存为快照 ")):r("",!0)])])])):r("",!0),c(Sa,{show:vs.value,"editing-record":fs.value,"editing-field":Gc.value,"available-teachers":Yc.value,"current-value":Kc.value,"all-schedule-records":za.value,onClose:Qc,onConfirm:au},null,8,["show","editing-record","editing-field","available-teachers","current-value","all-schedule-records"]),en.value?(l(),i("div",{key:6,class:"modal-overlay preview-modal-overlay",onClick:rn},[o("div",{class:"preview-modal-content",onClick:t[32]||(t[32]=d(()=>{},["stop"]))},[o("div",{class:"preview-header"},[t[102]||(t[102]=o("h2",{class:"preview-title"},"文件预览",-1)),o("button",{class:"close-btn",onClick:rn},[...t[101]||(t[101]=[o("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[o("path",{d:"M18 6L6 18"}),o("path",{d:"M6 6l12 12"})],-1)])])]),o("div",Kr,[o("div",Zr,[o("p",Qr,"文件名："+m(null==(n=qt.value)?void 0:n.name),1),t[103]||(t[103]=o("p",{class:"data-info-text"},"显示前10行数据",-1))]),o("div",el,[o("table",tl,[o("thead",null,[o("tr",null,[(l(!0),i(g,null,v(an.value,e=>(l(),i("th",{key:e},m(e),1))),128))])]),o("tbody",null,[(l(!0),i(g,null,v(tn.value,(e,t)=>(l(),i("tr",{key:t},[(l(!0),i(g,null,v(an.value,t=>(l(),i("td",{key:t},m(e[t]),1))),128))]))),128))])])])])])])):r("",!0),Ke.value?(l(),i("div",{key:7,class:"modal-overlay",onClick:qa},[o("div",{ref_key:"modalRef",ref:Xt,class:"modal-content draggable-modal step-modal",onClick:t[49]||(t[49]=d(()=>{},["stop"])),style:x({transform:`translate(${Yt.value.x}px, ${Yt.value.y}px)`,cursor:Jt.value?"grabbing":"default"})},[o("div",{class:"modal-header draggable-header",onMousedown:Ya,style:x({cursor:Jt.value?"grabbing":"grab"})},[t[105]||(t[105]=o("h2",{class:"modal-title"},"新建排班",-1)),o("button",{class:"close-btn",onClick:qa},[...t[104]||(t[104]=[o("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[o("path",{d:"M18 6L6 18"}),o("path",{d:"M6 6l12 12"})],-1)])])],36),o("div",al,[o("div",{class:h(["step-item",{active:1===nt.value,completed:nt.value>1}])},[...t[106]||(t[106]=[o("div",{class:"step-number"},"1",-1),o("div",{class:"step-label"},"学员导入",-1)])],2),t[110]||(t[110]=o("div",{class:"step-divider"},null,-1)),o("div",{class:h(["step-item",{active:2===nt.value,completed:nt.value>2}])},[...t[107]||(t[107]=[o("div",{class:"step-number"},"2",-1),o("div",{class:"step-label"},"日期选择",-1)])],2),t[111]||(t[111]=o("div",{class:"step-divider"},null,-1)),o("div",{class:h(["step-item",{active:3===nt.value,completed:nt.value>3}])},[...t[108]||(t[108]=[o("div",{class:"step-number"},"3",-1),o("div",{class:"step-label"},"智能评估",-1)])],2),t[112]||(t[112]=o("div",{class:"step-divider"},null,-1)),o("div",{class:h(["step-item",{active:4===nt.value}])},[...t[109]||(t[109]=[o("div",{class:"step-number"},"4",-1),o("div",{class:"step-label"},"确认执行",-1)])],2)]),1===nt.value?(l(),i("div",nl,[t[126]||(t[126]=o("div",{class:"step-title"},[o("div",{class:"step-icon"},"👥"),o("h3",null,"第一步：导入学员名单"),o("p",{class:"step-description"},"导入需要参加考试的学员信息，支持从考官分配页面一键导入或上传Excel/CSV文件")],-1)),o("div",sl,[o("button",{class:h(["import-from-assignment-btn",{"has-data":Qe.value}]),onClick:at,disabled:!Qe.value},[t[113]||(t[113]=P('<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-0981df0a><path d="M16 3h5v5" data-v-0981df0a></path><path d="M4 20L21 3" data-v-0981df0a></path><path d="M21 16v5h-5" data-v-0981df0a></path><path d="M15 15l6 6" data-v-0981df0a></path><path d="M4 4l5 5" data-v-0981df0a></path></svg>',1)),Qe.value?(l(),i("span",rl,"从考官分配导入 ("+m(et.value)+"人)",1)):(l(),i("span",ll,"从考官分配导入 (无数据)"))],10,il),t[114]||(t[114]=o("span",{class:"import-divider"},"或",-1))]),o("div",ol,[o("input",{ref_key:"fileInput",ref:Vt,type:"file",accept:".xlsx,.xls,.csv",onChange:Qa,style:{display:"none"}},null,544),qt.value?(l(),i("div",dl,[t[116]||(t[116]=P('<div class="file-icon" data-v-0981df0a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-v-0981df0a><path d="M14,2H6A2,2,0,0,0,4,4V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V8Z" data-v-0981df0a></path><polyline points="14,2 14,8 20,8" data-v-0981df0a></polyline><line x1="16" y1="13" x2="8" y2="13" data-v-0981df0a></line><line x1="16" y1="17" x2="8" y2="17" data-v-0981df0a></line><polyline points="10,9 9,9 8,9" data-v-0981df0a></polyline></svg></div>',1)),o("div",cl,[o("p",ul,m(qt.value.name),1),o("p",pl,m(Nn(qt.value.size)),1)]),o("button",{class:"change-file-btn",onClick:Za}," 更换文件 ")])):(l(),i("div",{key:0,class:"upload-placeholder",onClick:Za},[...t[115]||(t[115]=[P('<div class="upload-icon" data-v-0981df0a><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-v-0981df0a><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" data-v-0981df0a></path><polyline points="7,10 12,15 17,10" data-v-0981df0a></polyline><line x1="12" y1="15" x2="12" y2="3" data-v-0981df0a></line></svg></div><p class="upload-text" data-v-0981df0a>点击或拖拽上传学员名单</p><p class="upload-subtext" data-v-0981df0a>支持 Excel (.xlsx, .xls) 或 CSV 格式文件，文件需包含姓名、科室、班组等基本信息</p>',3)])]))]),Oa.value.length>0?(l(),i("div",ml,[o("div",hl,[o("h4",null,"学员数据预览 (共"+m(Oa.value.length)+"名学员)",1),o("div",gl,[!Nt.value&&Oa.value.length>10?(l(),i("button",{key:0,onClick:t[33]||(t[33]=e=>Nt.value=!0),class:"show-more-btn"}," 显示全部 ")):r("",!0),Nt.value?(l(),i("button",{key:1,onClick:t[34]||(t[34]=e=>Nt.value=!1),class:"show-less-btn"}," 收起 ")):r("",!0)])]),o("div",vl,[o("div",fl,[t[117]||(t[117]=o("span",null,"序号",-1)),t[118]||(t[118]=o("span",null,"姓名",-1)),t[119]||(t[119]=o("span",null,"科室",-1)),t[120]||(t[120]=o("span",null,"班组",-1)),t[121]||(t[121]=o("span",null,"考试内容",-1)),jt.value?(l(),i("span",yl,"推荐考官")):r("",!0)]),o("div",xl,[(l(!0),i(g,null,v(zt.value,(e,a)=>(l(),i("div",{key:e.id,class:"preview-row"},[o("span",null,m(a+1),1),o("span",null,m(e.name),1),o("span",null,m(w(e.department)),1),o("span",{title:`原始数据: ${JSON.stringify(e.group)}, 类型: ${typeof e.group}`},m(e.group||"未知班组"),9,bl),o("span",wl,[f(o("select",{"onUpdate:modelValue":t=>e.examDays=t,onChange:t=>Ut(e),class:"exam-days-select",title:`当前选择: ${e.examDays||2}天考试`},[...t[122]||(t[122]=[o("option",{value:2},"两天考试",-1),o("option",{value:1},"一天考试",-1)])],40,Dl),[[M,e.examDays]]),o("span",{class:h(["exam-type-badge",`exam-type-${e.examDays||2}`])},m(Bt(e)),3)]),jt.value?(l(),i("span",kl,[e.recommendedExaminer1Dept?(l(),i("span",Sl,m(e.recommendedExaminer1Dept),1)):r("",!0),e.recommendedExaminer2Dept?(l(),i("span",$l,", "+m(e.recommendedExaminer2Dept),1)):r("",!0),e.recommendedBackupDept?(l(),i("span",Cl," (推荐 "+m(e.recommendedBackupDept)+")",1)):r("",!0)])):r("",!0)]))),128)),!Nt.value&&Oa.value.length>10?(l(),i("div",El," 还有 "+m(Oa.value.length-10)+" 名学员未显示... ",1)):r("",!0)])]),o("div",_l,[o("div",Tl,[t[123]||(t[123]=o("span",{class:"summary-label"},"总学员数:",-1)),o("span",Il,m(Oa.value.length),1)]),o("div",Pl,[t[124]||(t[124]=o("span",{class:"summary-label"},"科室分布",-1)),o("span",Rl,m(Ft.value),1)]),o("div",Ml,[t[125]||(t[125]=o("span",{class:"summary-label"},"班组分布",-1)),o("span",Al,m(Lt.value),1)])])])):r("",!0)])):r("",!0),2===nt.value?(l(),i("div",Ol,[t[154]||(t[154]=o("div",{class:"step-title"},[o("div",{class:"step-icon"},"📅"),o("h3",null,"第二步：设置考试日期"),o("p",{class:"step-description"},"选择考试日期范围，系统会根据学员和考官数量智能推荐最合适的结束日期")],-1)),!st.value&&Oa.value.length>0?(l(),i("div",Nl,[...t[127]||(t[127]=[P('<div style="width:40px;height:40px;background:#3b82f6;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;" data-v-0981df0a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" data-v-0981df0a><circle cx="12" cy="12" r="10" data-v-0981df0a></circle><line x1="12" y1="16" x2="12" y2="12" data-v-0981df0a></line><line x1="12" y1="8" x2="12.01" y2="8" data-v-0981df0a></line></svg></div><div data-v-0981df0a><div style="font-size:15px;font-weight:600;color:#1e40af;" data-v-0981df0a>💡 智能提示</div><div style="font-size:14px;color:#1e3a8a;margin-top:4px;" data-v-0981df0a>请先选择考试开始日期，系统将根据学员和考官数量自动计算并推荐最合适的结束日期</div></div>',2)])])):r("",!0),o("div",zl,[o("div",jl,[t[130]||(t[130]=o("label",{class:"date-label"},[o("span",{class:"label-main"},"🗓️ 考试开始日期"),o("span",{class:"date-label-tip"},"选择第一天考试日期")],-1)),o("div",Fl,[f(o("input",{type:"date","onUpdate:modelValue":t[35]||(t[35]=e=>st.value=e),min:Wt.value,class:"date-input",onChange:Rn,placeholder:"请选择开始日期"},null,40,Ll),[[y,st.value]]),t[128]||(t[128]=o("div",{class:"date-input-icon"},"📅",-1))]),!st.value&&Oa.value.length>0?(l(),i("div",Ul,[...t[129]||(t[129]=[o("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[o("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"}),o("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),o("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})],-1),o("span",null,"请先选择开始日期",-1)])])):r("",!0)]),o("div",Bl,[o("label",Hl,[t[131]||(t[131]=o("span",{class:"label-main"},"🗓️ 考试结束日期",-1)),Tn.value?(l(),i("span",Vl,"💡 系统推荐："+m(Tn.value),1)):(l(),i("span",Wl,"选择最后一天考试日期"))]),o("div",{class:h(["date-input-wrapper",{"has-recommendation":Tn.value}])},[f(o("input",{type:"date","onUpdate:modelValue":t[36]||(t[36]=e=>it.value=e),min:st.value||Wt.value,class:"date-input",onChange:Mn,placeholder:"请选择结束日期"},null,40,ql),[[y,it.value]]),t[132]||(t[132]=o("div",{class:"date-input-icon"},"📅",-1)),Tn.value&&it.value!==Tn.value?(l(),i("button",{key:0,onClick:Pn,class:"apply-recommended-btn",title:"应用系统推荐的结束日期"}," 应用推荐 ")):r("",!0)],2),Tn.value?(l(),i("div",Jl,[t[133]||(t[133]=o("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2.5","stroke-linecap":"round","stroke-linejoin":"round"},[o("polyline",{points:"20 6 9 17 4 12"})],-1)),o("span",null,"根据"+m(Oa.value.length)+"名学员和"+m(cn())+"名考官计算，建议"+m(In.value)+"天完成所有考试",1)])):r("",!0)])]),o("div",Gl,[o("div",{class:h(["setting-card",{active:ea.value}]),style:{background:"#fff",border:"2px solid #e5e7eb","border-radius":"12px",padding:"16px",cursor:"pointer",transition:"all 0.2s"},onClick:$n},[o("div",Yl,[o("div",Xl,[o("div",{style:x([{width:"40px",height:"40px","border-radius":"10px",display:"flex","align-items":"center","justify-content":"center","font-size":"20px",transition:"all 0.2s"},ea.value?"background: #dbeafe; color: #2563eb;":"background: #f3f4f6; color: #6b7280;"])}," 📅 ",4),o("div",null,[t[134]||(t[134]=o("h4",{style:{margin:"0","font-size":"15px",color:"#1f2937","font-weight":"600"}},"周末是否安排考试",-1)),o("p",Kl,m(ea.value?"已开启周末排班":"周末不安排考试（推荐）"),1)])]),o("div",{style:x([{position:"relative",width:"48px",height:"26px","border-radius":"26px",transition:"all 0.3s","flex-shrink":"0"},ea.value?"background: #3b82f6;":"background: #d1d5db;"])},[o("div",{style:x([{position:"absolute",top:"2px",width:"22px",height:"22px","border-radius":"50%",background:"white",transition:"all 0.3s","box-shadow":"0 1px 3px rgba(0,0,0,0.1)"},ea.value?"left: 24px;":"left: 2px;"])},null,4)],4)])],2),o("div",{class:h(["setting-card",{expanded:ta.value,"has-items":ra.value.length>0}]),style:{background:"#fff",border:"2px solid #e5e7eb","border-radius":"12px",overflow:"hidden",transition:"all 0.2s"}},[o("div",{onClick:t[37]||(t[37]=e=>ta.value=!ta.value),style:{padding:"16px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between"}},[o("div",Zl,[o("div",{style:x([{width:"40px",height:"40px","border-radius":"10px",display:"flex","align-items":"center","justify-content":"center","font-size":"20px",transition:"all 0.2s"},ra.value.length>0?"background: #fef3c7; color: #d97706;":"background: #f3f4f6; color: #6b7280;"])}," 🚫 ",4),t[135]||(t[135]=o("div",null,[o("h4",{style:{margin:"0","font-size":"15px",color:"#1f2937","font-weight":"600"}},"不可用日期设置"),o("p",{style:{margin:"4px 0 0","font-size":"13px",color:"#6b7280"}},"添加临时放假或不可考试的日期")],-1))]),o("div",Ql,[ra.value.length>0?(l(),i("span",eo,m(ra.value.length)+" 个 ",1)):r("",!0),(l(),i("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",style:x([{transition:"transform 0.2s",color:"#9ca3af"},ta.value?"transform: rotate(180deg);":""])},[...t[136]||(t[136]=[o("path",{d:"M5 7.5L10 12.5L15 7.5",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])],4))])]),f(o("div",to,[o("div",ao,[o("div",no,[o("label",so,[f(o("input",{type:"radio","onUpdate:modelValue":t[38]||(t[38]=e=>aa.value=e),value:"single",style:{"accent-color":"#3b82f6",width:"16px",height:"16px"}},null,512),[[R,aa.value]]),t[137]||(t[137]=o("span",null,"单日",-1))]),o("label",io,[f(o("input",{type:"radio","onUpdate:modelValue":t[39]||(t[39]=e=>aa.value=e),value:"range",style:{"accent-color":"#3b82f6",width:"16px",height:"16px"}},null,512),[[R,aa.value]]),t[138]||(t[138]=o("span",null,"日期范围",-1))])]),o("div",ro,[o("div",lo,[f(o("input",{type:"date","onUpdate:modelValue":t[40]||(t[40]=e=>na.value=e),style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db","border-radius":"8px","font-size":"14px",outline:"none",transition:"border-color 0.2s"},onfocus:"this.style.borderColor='#3b82f6'",onblur:"this.style.borderColor='#d1d5db'"},null,512),[[y,na.value]])]),"range"===aa.value?(l(),i("div",oo,[f(o("input",{type:"date","onUpdate:modelValue":t[41]||(t[41]=e=>sa.value=e),style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db","border-radius":"8px","font-size":"14px",outline:"none",transition:"border-color 0.2s"},onfocus:"this.style.borderColor='#3b82f6'",onblur:"this.style.borderColor='#d1d5db'"},null,512),[[y,sa.value]])])):r("",!0),o("div",co,[f(o("input",{type:"text","onUpdate:modelValue":t[42]||(t[42]=e=>ia.value=e),placeholder:"原因（可选）",style:{width:"100%",padding:"10px 12px",border:"1px solid #d1d5db","border-radius":"8px","font-size":"14px",outline:"none",transition:"border-color 0.2s"},onfocus:"this.style.borderColor='#3b82f6'",onblur:"this.style.borderColor='#d1d5db'"},null,512),[[y,ia.value]])]),o("button",{onClick:_n,style:{padding:"10px 20px",background:"#3b82f6",color:"white",border:"none","border-radius":"8px","font-size":"14px",cursor:"pointer","font-weight":"500",transition:"all 0.2s","white-space":"nowrap"},onmouseover:"this.style.background='#2563eb'",onmouseout:"this.style.background='#3b82f6'"}," 添加 ")])]),ra.value.length>0?(l(),i("div",uo,[(l(!0),i(g,null,v(ra.value,(e,a)=>(l(),i("div",{key:a,style:{background:"#fff",border:"1px solid #e5e7eb","border-radius":"10px",padding:"12px 16px","margin-bottom":"8px",display:"flex","align-items":"center","justify-content":"space-between"}},[o("div",po,[t[139]||(t[139]=o("span",{style:{"font-size":"18px"}},"📅",-1)),o("div",null,[o("div",mo,m(e.displayDate),1),e.reason?(l(),i("div",ho,m(e.reason),1)):r("",!0)])]),o("button",{onClick:e=>(e=>{ra.value.splice(e,1),pe.success("删除成功")})(a),style:{padding:"6px 12px",background:"#fee2e2",color:"#dc2626",border:"none","border-radius":"6px",cursor:"pointer","font-size":"12px","font-weight":"500",transition:"all 0.2s"},onmouseover:"this.style.background='#fecaca'",onmouseout:"this.style.background='#fee2e2'"}," 删除 ",8,go)]))),128))])):(l(),i("div",vo,[...t[140]||(t[140]=[o("div",{style:{width:"56px",height:"56px",margin:"0 auto 12px",background:"#f3f4f6","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"28px"}},"📆",-1),o("p",{style:{margin:"0","font-size":"14px",color:"#6b7280"}},"暂无不可用日期",-1)])]))],512),[[T,ta.value]])],2),o("div",{class:h(["setting-card",{expanded:Qt.value,"has-items":un().length>0}]),style:{background:"#fff",border:"2px solid #e5e7eb","border-radius":"12px",overflow:"hidden",transition:"all 0.2s"}},[o("div",{onClick:t[43]||(t[43]=e=>Qt.value=!Qt.value),style:{padding:"16px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between"}},[o("div",fo,[o("div",{style:x([{width:"40px",height:"40px","border-radius":"10px",display:"flex","align-items":"center","justify-content":"center","font-size":"20px",transition:"all 0.2s"},un().length>0?"background: #fee2e2; color: #dc2626;":"background: #d1fae5; color: #059669;"])},m(un().length>0?"🚫":"✅"),5),t[141]||(t[141]=o("div",null,[o("h4",{style:{margin:"0","font-size":"15px",color:"#1f2937","font-weight":"600"}},"不可用考官详情"),o("p",{style:{margin:"4px 0 0","font-size":"13px",color:"#6b7280"}},"查看当前排班周期内不可用的考官")],-1))]),o("div",yo,[un().length>0?(l(),i("span",xo,m(un().length)+" 名 ",1)):(l(),i("span",bo," 全部可用 ")),(l(),i("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",style:x([{transition:"transform 0.2s",color:"#9ca3af"},Qt.value?"transform: rotate(180deg);":""])},[...t[142]||(t[142]=[o("path",{d:"M5 7.5L10 12.5L15 7.5",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])],4))])]),f(o("div",wo,[o("div",Do,[o("div",ko,[t[143]||(t[143]=o("div",{style:{"font-size":"20px","margin-bottom":"4px"}},"📅",-1)),t[144]||(t[144]=o("div",{style:{"font-size":"12px",color:"#6b7280"}},"排班周期",-1)),o("div",So,m(dn())+"天",1)]),o("div",{style:x([{background:"#fff","border-radius":"10px",padding:"12px","text-align":"center",border:"1px solid #e5e7eb"},un().length>0?"border-color: #fecaca;":""])},[t[145]||(t[145]=o("div",{style:{"font-size":"20px","margin-bottom":"4px"}},"🚫",-1)),t[146]||(t[146]=o("div",{style:{"font-size":"12px",color:"#6b7280"}},"不可用",-1)),o("div",{style:x([{"font-size":"16px","font-weight":"600"},un().length>0?"color: #dc2626;":"color: #1f2937;"])},m(un().length)+"名 ",5)],4),o("div",$o,[t[147]||(t[147]=o("div",{style:{"font-size":"20px","margin-bottom":"4px"}},"✅",-1)),t[148]||(t[148]=o("div",{style:{"font-size":"12px",color:"#6b7280"}},"可用",-1)),o("div",Co,m(cn()-un().length)+"名 ",1)]),o("div",Eo,[t[149]||(t[149]=o("div",{style:{"font-size":"20px","margin-bottom":"4px"}},"👥",-1)),t[150]||(t[150]=o("div",{style:{"font-size":"12px",color:"#6b7280"}},"总数",-1)),o("div",_o,m(cn())+"名",1)])]),un().length>0?(l(),i("div",To,[(l(!0),i(g,null,v(un(),e=>(l(),i("div",{key:e.teacher.id,style:{background:"#fff",border:"1px solid #e5e7eb","border-radius":"10px",padding:"16px","margin-bottom":"12px"}},[o("div",Io,[o("div",Po,[t[151]||(t[151]=o("div",{style:{width:"36px",height:"36px",background:"#fee2e2","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"16px"}},"👤",-1)),o("div",null,[o("div",Ro,m(e.teacher.name),1),o("div",Mo,m(e.teacher.department),1)])]),o("span",Ao,m(e.periods.length)+" 个不可用期 ",1)]),(l(!0),i(g,null,v(e.periods,e=>(l(),i("div",{key:e.id,style:{background:"#fafafa","border-radius":"8px",padding:"10px 12px","margin-bottom":"8px"}},[o("div",Oo,[t[152]||(t[152]=o("span",null,"📅",-1)),o("span",No,m(e.startDate)+" ~ "+m(e.endDate),1),o("span",zo," 影响"+m(e.overlapDays)+"天 ",1)]),e.reason?(l(),i("div",jo," 💬 "+m(e.reason),1)):r("",!0)]))),128))]))),128))])):(l(),i("div",Fo,[...t[153]||(t[153]=[o("div",{style:{width:"64px",height:"64px",margin:"0 auto 16px",background:"#d1fae5","border-radius":"50%",display:"flex","align-items":"center","justify-content":"center","font-size":"32px"}}," ✨",-1),o("p",{style:{margin:"0","font-size":"15px",color:"#059669","font-weight":"500"}},"当前排班周期内所有考官均可用",-1),o("p",{style:{margin:"8px 0 0","font-size":"13px",color:"#6b7280"}},"可以安心进行排班",-1)])]))],512),[[T,Qt.value]])],2)])])):r("",!0),3===nt.value?(l(),i("div",Lo,[t[174]||(t[174]=o("div",{class:"step-title"},[o("div",{class:"step-icon"},"💡"),o("h3",null,"第三步：智能评估分析"),o("p",{class:"step-description"},"系统综合分析学员数量、考官资源、日期范围等因素，评估排班可行性并提供优化建议")],-1)),o("div",Uo,[o("div",{class:h(["status-card",wn().statusClass]),style:{"margin-bottom":"24px","border-radius":"16px",padding:"24px",position:"relative",overflow:"hidden"}},[o("div",{class:"status-indicator-bar",style:x({background:wn().color})},null,4),o("div",Bo,[o("div",{class:"status-icon-wrapper",style:x({background:wn().lightColor,color:wn().color})},["success"===wn().status?(l(),i("svg",Ho,[...t[155]||(t[155]=[o("polyline",{points:"20 6 9 17 4 12"},null,-1)])])):"error"===wn().status?(l(),i("svg",Wo,[...t[156]||(t[156]=[o("circle",{cx:"12",cy:"12",r:"10"},null,-1),o("line",{x1:"15",y1:"9",x2:"9",y2:"15"},null,-1),o("line",{x1:"9",y1:"9",x2:"15",y2:"15"},null,-1)])])):"warning"===wn().status?(l(),i("svg",Vo,[...t[157]||(t[157]=[o("path",{d:"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"},null,-1),o("line",{x1:"12",y1:"9",x2:"12",y2:"13"},null,-1),o("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"},null,-1)])])):(l(),i("svg",qo,[...t[158]||(t[158]=[o("circle",{cx:"12",cy:"12",r:"10"},null,-1),o("line",{x1:"12",y1:"16",x2:"12",y2:"12"},null,-1),o("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"},null,-1)])]))],4),o("div",Jo,[o("div",Go,[o("h4",{style:x({color:wn().color,margin:0,fontSize:"20px",fontWeight:700})},m(wn().title),5),o("span",{class:"status-badge",style:x({background:wn().lightColor,color:wn().color})},m(wn().badgeText),5)]),o("p",Yo,m(wn().description),1)])])],2),o("div",Xo,[o("div",Ko,[t[159]||(t[159]=P('<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;" data-v-0981df0a><div style="width:40px;height:40px;background:linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;" data-v-0981df0a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-0981df0a><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" data-v-0981df0a></path><circle cx="9" cy="7" r="4" data-v-0981df0a></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87" data-v-0981df0a></path><path d="M16 3.13a4 4 0 0 1 0 7.75" data-v-0981df0a></path></svg></div><span style="font-size:13px;color:#64748b;font-weight:500;" data-v-0981df0a>待排班学员</span></div>',1)),o("div",Zo,m(Oa.value.length),1),t[160]||(t[160]=o("div",{style:{"font-size":"12px",color:"#94a3b8","margin-top":"6px"}},"需要安排考试",-1))]),o("div",Qo,[t[161]||(t[161]=P('<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;" data-v-0981df0a><div style="width:40px;height:40px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;" data-v-0981df0a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-0981df0a><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" data-v-0981df0a></path><circle cx="12" cy="7" r="4" data-v-0981df0a></circle></svg></div><span style="font-size:13px;color:#64748b;font-weight:500;" data-v-0981df0a>可用考官</span></div>',1)),o("div",ed,m(cn()),1),t[162]||(t[162]=o("div",{style:{"font-size":"12px",color:"#94a3b8","margin-top":"6px"}},"当前可用",-1))]),o("div",td,[t[163]||(t[163]=P('<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;" data-v-0981df0a><div style="width:40px;height:40px;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;" data-v-0981df0a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-0981df0a><rect x="3" y="4" width="18" height="18" rx="2" ry="2" data-v-0981df0a></rect><line x1="16" y1="2" x2="16" y2="6" data-v-0981df0a></line><line x1="8" y1="2" x2="8" y2="6" data-v-0981df0a></line><line x1="3" y1="10" x2="21" y2="10" data-v-0981df0a></line></svg></div><span style="font-size:13px;color:#64748b;font-weight:500;" data-v-0981df0a>可用工作日</span></div>',1)),o("div",ad,m(An().workdays),1),t[164]||(t[164]=o("div",{style:{"font-size":"12px",color:"#94a3b8","margin-top":"6px"}},"可用于排班",-1))])]),Dn()?(l(),i("div",{key:0,class:"recommended-dates",style:x({background:"insufficient"===(null==(s=Dn())?void 0:s.status)?"linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)":"suboptimal"===(null==(D=Dn())?void 0:D.status)?"linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)":"linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%)",border:"insufficient"===(null==(k=Dn())?void 0:k.status)?"2px solid #ef4444":"suboptimal"===(null==($=Dn())?void 0:$.status)?"2px solid #f59e0b":"2px solid #3b82f6",borderRadius:"16px",padding:"24px",marginBottom:"24px",position:"relative",overflow:"hidden"})},[o("div",{style:x([{position:"absolute",top:"-20px",right:"-20px",width:"100px",height:"100px","border-radius":"50%"},{background:"insufficient"===(null==(E=Dn())?void 0:E.status)?"rgba(239, 68, 68, 0.1)":"suboptimal"===(null==(_=Dn())?void 0:_.status)?"rgba(245, 158, 11, 0.1)":"rgba(59, 130, 246, 0.1)"}])},null,4),o("div",nd,[o("h4",{style:x([{margin:"0 0 12px","font-size":"16px","font-weight":"700",display:"flex","align-items":"center",gap:"8px"},{color:"insufficient"===(null==(z=Dn())?void 0:z.status)?"#dc2626":"suboptimal"===(null==(U=Dn())?void 0:U.status)?"#b45309":"#1e40af"}])},[(l(),i("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none","stroke-width":"2.5","stroke-linecap":"round","stroke-linejoin":"round",style:x({stroke:"insufficient"===(null==(W=Dn())?void 0:W.status)?"#ef4444":"suboptimal"===(null==(V=Dn())?void 0:V.status)?"#f59e0b":"#3b82f6"})},[...t[165]||(t[165]=[o("circle",{cx:"12",cy:"12",r:"10"},null,-1),o("path",{d:"M12 16v-4M12 8h.01"},null,-1)])],4)),u(" "+m("insufficient"===(null==(q=Dn())?void 0:q.status)?"⚠️ 日期范围严重不足":"suboptimal"===(null==(J=Dn())?void 0:J.status)?"💡 日期范围可优化":"✅ 推荐考试日期范围"),1)],4),o("p",{style:x([{margin:"0 0 16px","font-size":"14px"},{color:"insufficient"===(null==(Y=Dn())?void 0:Y.status)?"#991b1b":"suboptimal"===(null==(oe=Dn())?void 0:oe.status)?"#92400e":"#1e3a8a"}])},m(null==(me=Dn())?void 0:me.message),5),o("div",sd,[o("div",id,[o("div",{style:x([{width:"44px",height:"44px","border-radius":"10px",display:"flex","align-items":"center","justify-content":"center"},{background:"insufficient"===(null==(Ie=Dn())?void 0:Ie.status)?"#fef2f2":"suboptimal"===(null==(Pe=Dn())?void 0:Pe.status)?"#fffbeb":"#dbeafe"}])},[(l(),i("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",style:x({stroke:"insufficient"===(null==(Ae=Dn())?void 0:Ae.status)?"#ef4444":"suboptimal"===(null==(Oe=Dn())?void 0:Oe.status)?"#f59e0b":"#3b82f6"})},[...t[166]||(t[166]=[o("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"},null,-1),o("line",{x1:"16",y1:"2",x2:"16",y2:"6"},null,-1),o("line",{x1:"8",y1:"2",x2:"8",y2:"6"},null,-1),o("line",{x1:"3",y1:"10",x2:"21",y2:"10"},null,-1)])],4))],4),o("div",null,[o("div",{style:x([{"font-size":"16px","font-weight":"700"},{color:"insufficient"===(null==(Ne=Dn())?void 0:Ne.status)?"#dc2626":"suboptimal"===(null==(ze=Dn())?void 0:ze.status)?"#b45309":"#1e40af"}])},m(null==(je=Dn())?void 0:je.display),5),o("div",rd," 共 "+m(null==(Fe=Dn())?void 0:Fe.recommendedWorkdays)+" 个工作日 ",1)])]),o("button",{onClick:t[44]||(t[44]=e=>(async()=>{const e=Dn();e&&(da.value=null,pa.value=null,ua.value=0,ha.value=0,st.value=e.start,it.value=e.end,Oa.value.length>0&&cn()>=2&&await Promise.all([mn(),hn()]),pe.success("已应用推荐的日期范围，评估状态已更新"))})()),style:x([{padding:"10px 20px",color:"white",border:"none","border-radius":"8px","font-size":"14px",cursor:"pointer","font-weight":"600","box-shadow":"0 2px 4px rgba(0,0,0,0.1)",transition:"all 0.2s"},{background:"insufficient"===(null==(Le=Dn())?void 0:Le.status)?"#ef4444":"suboptimal"===(null==(Ue=Dn())?void 0:Ue.status)?"#f59e0b":"#3b82f6"}]),onmouseover:"this.style.opacity='0.9'; this.style.transform='translateY(-1px)';",onmouseout:"this.style.opacity='1'; this.style.transform='translateY(0)';"}," 应用建议 ",4)]),o("div",ld,[o("div",{style:x([{background:"rgba(255,255,255,0.5)","border-radius":"8px",padding:"10px","text-align":"center"},{border:"insufficient"===(null==(Be=Dn())?void 0:Be.status)?"1px solid #fecaca":"suboptimal"===(null==(He=Dn())?void 0:He.status)?"1px solid #fcd34d":"1px solid #bfdbfe"}])},[t[167]||(t[167]=o("div",{style:{color:"#6b7280","margin-bottom":"2px"}},"当前工作日",-1)),o("div",{style:x([{"font-weight":"700","font-size":"14px"},{color:(null==(Ve=Dn())?void 0:Ve.currentWorkdays)<(null==(qe=Dn())?void 0:qe.requiredWorkdays)?"#dc2626":(null==(Je=Dn())?void 0:Je.currentWorkdays)<(null==(Ge=Dn())?void 0:Ge.recommendedWorkdays)?"#b45309":"#047857"}])},m(null==(Ye=Dn())?void 0:Ye.currentWorkdays)+" 天 ",5)],4),o("div",od,[t[168]||(t[168]=o("div",{style:{color:"#6b7280","margin-bottom":"2px"}},"最低需要",-1)),o("div",dd,m(null==(Xe=Dn())?void 0:Xe.requiredWorkdays)+" 天 ",1)]),o("div",cd,[t[169]||(t[169]=o("div",{style:{color:"#6b7280","margin-bottom":"2px"}},"建议工作日",-1)),o("div",ud,m(null==(tt=Dn())?void 0:tt.recommendedWorkdays)+" 天 ",1)])])])],4)):r("",!0),o("div",pd,[o("button",{onClick:t[45]||(t[45]=e=>pn(2)),style:{padding:"20px",background:"white",border:"2px solid #e2e8f0","border-radius":"14px",cursor:"pointer","text-align":"center",transition:"all 0.2s"},onmouseover:"this.style.borderColor='#cbd5e1'; this.style.background='#f8fafc'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.05)';",onmouseout:"this.style.borderColor='#e2e8f0'; this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"},[...t[170]||(t[170]=[P('<div style="width:48px;height:48px;background:#f1f5f9;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;" data-v-0981df0a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-0981df0a><rect x="3" y="4" width="18" height="18" rx="2" ry="2" data-v-0981df0a></rect><line x1="16" y1="2" x2="16" y2="6" data-v-0981df0a></line><line x1="8" y1="2" x2="8" y2="6" data-v-0981df0a></line><line x1="3" y1="10" x2="21" y2="10" data-v-0981df0a></line></svg></div><div style="font-size:15px;font-weight:600;color:#374151;margin-bottom:4px;" data-v-0981df0a>返回修改日期</div><div style="font-size:12px;color:#6b7280;" data-v-0981df0a>重新选择考试日期范围</div>',3)])]),o("button",{onClick:t[46]||(t[46]=e=>pn(1)),style:{padding:"20px",background:"white",border:"2px solid #e2e8f0","border-radius":"14px",cursor:"pointer","text-align":"center",transition:"all 0.2s"},onmouseover:"this.style.borderColor='#cbd5e1'; this.style.background='#f8fafc'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.05)';",onmouseout:"this.style.borderColor='#e2e8f0'; this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none';"},[...t[171]||(t[171]=[P('<div style="width:48px;height:48px;background:#f1f5f9;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;" data-v-0981df0a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-0981df0a><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" data-v-0981df0a></path><circle cx="9" cy="7" r="4" data-v-0981df0a></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87" data-v-0981df0a></path><path d="M16 3.13a4 4 0 0 1 0 7.75" data-v-0981df0a></path></svg></div><div style="font-size:15px;font-weight:600;color:#374151;margin-bottom:4px;" data-v-0981df0a>调整人员配置</div><div style="font-size:12px;color:#6b7280;" data-v-0981df0a>修改学员或考官数量</div>',3)])]),o("button",{onClick:t[47]||(t[47]=e=>ln()),disabled:!Sn(),style:x([{padding:"20px",border:"none","border-radius":"14px",cursor:"pointer","text-align":"center",transition:"all 0.2s"},Sn()?"background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); opacity: 1;":"background: #e2e8f0; opacity: 0.6; cursor: not-allowed;"]),onmouseover:"if(!this.disabled) { this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(59, 130, 246, 0.3)'; }",onmouseout:"this.style.transform='translateY(0)'; this.style.boxShadow='none';"},[...t[172]||(t[172]=[P('<div style="width:48px;height:48px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;" data-v-0981df0a><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" data-v-0981df0a><path d="M5 12h14M12 5l7 7-7 7" data-v-0981df0a></path></svg></div><div style="font-size:15px;font-weight:700;color:white;margin-bottom:4px;" data-v-0981df0a>继续排班</div><div style="font-size:12px;color:rgba(255,255,255,0.85);" data-v-0981df0a>确认配置并开始排班</div>',3)])],12,md)]),Sn()?r("",!0):(l(),i("div",hd,[...t[173]||(t[173]=[P('<div style="width:36px;height:36px;background:#ef4444;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;" data-v-0981df0a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" data-v-0981df0a><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" data-v-0981df0a></path><line x1="12" y1="9" x2="12" y2="13" data-v-0981df0a></line><line x1="12" y1="17" x2="12.01" y2="17" data-v-0981df0a></line></svg></div><div data-v-0981df0a><div style="font-size:14px;font-weight:700;color:#dc2626;" data-v-0981df0a>当前配置存在风险</div><div style="font-size:13px;color:#7f1d1d;" data-v-0981df0a>建议先调整配置后再继续排班</div></div>',2)])]))])])):r("",!0),4===nt.value?(l(),i("div",gd,[t[195]||(t[195]=o("div",{class:"step-title"},[o("div",{class:"step-icon"},"✅"),o("h3",null,"第四步：确认并执行排班"),o("p",{class:"step-description"},"核对所有配置信息，确认无误后点击开始排班，系统将自动生成最优排班方案")],-1)),o("div",vd,[o("div",fd,[t[176]||(t[176]=P('<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;" data-v-0981df0a><div style="width:40px;height:40px;background:linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;" data-v-0981df0a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" data-v-0981df0a><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" data-v-0981df0a></path><circle cx="9" cy="7" r="4" data-v-0981df0a></circle></svg></div><h4 style="margin:0;font-size:16px;font-weight:600;color:#1f2937;" data-v-0981df0a>学员信息</h4></div>',1)),o("p",yd,[u(m(Oa.value.length)+" ",1),t[175]||(t[175]=o("span",{style:{"font-size":"14px","font-weight":"500",color:"#6b7280"}},"名学员",-1))]),qt.value?(l(),i("p",xd,"数据来源："+m(qt.value.name),1)):r("",!0)]),o("div",bd,[t[180]||(t[180]=P('<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;" data-v-0981df0a><div style="width:40px;height:40px;background:linear-gradient(135deg, #10b981 0%, #059669 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;" data-v-0981df0a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" data-v-0981df0a><rect x="3" y="4" width="18" height="18" rx="2" ry="2" data-v-0981df0a></rect><line x1="16" y1="2" x2="16" y2="6" data-v-0981df0a></line><line x1="8" y1="2" x2="8" y2="6" data-v-0981df0a></line><line x1="3" y1="10" x2="21" y2="10" data-v-0981df0a></line></svg></div><h4 style="margin:0;font-size:16px;font-weight:600;color:#1f2937;" data-v-0981df0a>考试日期</h4></div>',1)),st.value&&it.value?(l(),i("p",wd,[u(m(st.value)+" ",1),t[177]||(t[177]=o("span",{style:{color:"#9ca3af","font-weight":"400"}},"至",-1)),u(" "+m(it.value),1)])):r("",!0),o("div",Dd,[o("span",kd,[t[178]||(t[178]=o("span",{style:{width:"6px",height:"6px",background:"#10b981","border-radius":"50%"}},null,-1)),u(" "+m(An().workdays)+" 个工作日 ",1)]),An().holidays>0?(l(),i("span",Sd,[t[179]||(t[179]=o("span",{style:{width:"6px",height:"6px",background:"#f59e0b","border-radius":"50%"}},null,-1)),u(" "+m(An().holidays)+" 天节假日 ",1)])):r("",!0)])]),o("div",$d,[t[182]||(t[182]=P('<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;" data-v-0981df0a><div style="width:40px;height:40px;background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;" data-v-0981df0a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" data-v-0981df0a><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" data-v-0981df0a></path><circle cx="12" cy="7" r="4" data-v-0981df0a></circle></svg></div><h4 style="margin:0;font-size:16px;font-weight:600;color:#1f2937;" data-v-0981df0a>考官资源</h4></div>',1)),o("p",Cd,[u(m(cn())+" ",1),t[181]||(t[181]=o("span",{style:{"font-size":"14px","font-weight":"500",color:"#6b7280"}},"名考官",-1))]),t[183]||(t[183]=o("p",{style:{margin:"8px 0 0","font-size":"13px",color:"#6b7280"}},"每位学员需要2名考官监考",-1))]),o("div",Ed,[t[184]||(t[184]=P('<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;" data-v-0981df0a><div style="width:40px;height:40px;background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;" data-v-0981df0a><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" data-v-0981df0a><path d="M12 2L2 7l10 5 10-5-10-5z" data-v-0981df0a></path><path d="M2 17l10 5 10-5" data-v-0981df0a></path><path d="M2 12l10 5 10-5" data-v-0981df0a></path></svg></div><h4 style="margin:0;font-size:16px;font-weight:600;color:#1f2937;" data-v-0981df0a>排班算法</h4></div>',1)),o("p",_d,m((null==(pt=lt.find(e=>e.value===rt.value))?void 0:pt.label)||"OptaPlanner 经典算法"),1),o("p",Td,m((null==(ht=lt.find(e=>e.value===rt.value))?void 0:ht.description)||"基于约束求解的智能排班算法"),1)])]),o("div",Id,[o("div",{class:"constraint-header",onClick:t[48]||(t[48]=e=>Zt.value=!Zt.value),style:{padding:"16px 20px",cursor:"pointer",display:"flex","align-items":"center","justify-content":"space-between",background:"white"}},[o("div",Pd,[t[186]||(t[186]=P('<div style="width:36px;height:36px;background:#f3f4f6;border-radius:8px;display:flex;align-items:center;justify-content:center;" data-v-0981df0a><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" data-v-0981df0a><path d="M12 2L2 7l10 5 10-5-10-5z" data-v-0981df0a></path><path d="M2 17l10 5 10-5" data-v-0981df0a></path><path d="M2 12l10 5 10-5" data-v-0981df0a></path></svg></div>',1)),o("div",null,[t[185]||(t[185]=o("h4",{style:{margin:"0","font-size":"15px","font-weight":"600",color:"#1f2937"}},"约束配置详情",-1)),o("p",Rd,"8项硬约束 + "+m(On())+"项软约束已配置",1)])]),(l(),i("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",style:x([{transition:"transform 0.2s",color:"#9ca3af"},Zt.value?"transform: rotate(180deg);":""])},[...t[187]||(t[187]=[o("path",{d:"M5 7.5L10 12.5L15 7.5",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])],4))]),f(o("div",Md,[o("div",Ad,[t[191]||(t[191]=P('<div class="constraint-group" data-v-0981df0a><h5 style="margin:0 0 12px;font-size:14px;font-weight:600;color:#dc2626;display:flex;align-items:center;gap:6px;" data-v-0981df0a><span style="width:8px;height:8px;background:#dc2626;border-radius:50%;" data-v-0981df0a></span> 硬约束 (必须满足) </h5><ul style="margin:0;padding:0;list-style:none;font-size:13px;color:#4b5563;" data-v-0981df0a><li style="padding:4px 0;border-bottom:1px dashed #e5e7eb;" data-v-0981df0a>✓ 法定节假日不安排考试</li><li style="padding:4px 0;border-bottom:1px dashed #e5e7eb;" data-v-0981df0a>✓ 考官1必须与学员同科室</li><li style="padding:4px 0;border-bottom:1px dashed #e5e7eb;" data-v-0981df0a>✓ 考官执勤白班不能安排考试</li><li style="padding:4px 0;border-bottom:1px dashed #e5e7eb;" data-v-0981df0a>✓ 每名考官每天只能监考一名考生</li><li style="padding:4px 0;border-bottom:1px dashed #e5e7eb;" data-v-0981df0a>✓ 考生执勤白班不能安排考试</li><li style="padding:4px 0;border-bottom:1px dashed #e5e7eb;" data-v-0981df0a>✓ 考生需连续两天完成考试</li><li style="padding:4px 0;border-bottom:1px dashed #e5e7eb;" data-v-0981df0a>✓ 必须有考官1和考官2，且不同科室</li><li style="padding:4px 0;" data-v-0981df0a>✓ 备份考官不能与考官1/2是同一人</li></ul></div>',1)),o("div",Od,[t[188]||(t[188]=o("h5",{style:{margin:"0 0 12px","font-size":"14px","font-weight":"600",color:"#f59e0b",display:"flex","align-items":"center",gap:"6px"}},[o("span",{style:{width:"8px",height:"8px",background:"#f59e0b","border-radius":"50%"}}),u(" 软约束 (优先满足) ")],-1)),o("ul",Nd,[ot.value.nightShiftTeacherPriority?(l(),i("li",zd,"✓ 晚班考官优先级最高")):r("",!0),ot.value.examiner2ProfessionalMatch?(l(),i("li",jd,"✓ 考官2专业匹配")):r("",!0),ot.value.firstRestDayTeacherPriority?(l(),i("li",Fd,"✓ 休息第一天考官优先级次高")):r("",!0),ot.value.backupExaminerProfessionalMatch?(l(),i("li",Ld,"✓ 备份考官专业匹配")):r("",!0),ot.value.secondRestDayTeacherPriority?(l(),i("li",Ud,"✓ 休息第二天考官优先级中等")):r("",!0),ot.value.balanceWorkload?(l(),i("li",Bd,"✓ 工作量均衡")):r("",!0),ot.value.preferLaterDates?(l(),i("li",Hd,"✓ 日期分配均衡")):r("",!0),ot.value.nightShiftTeacherPriority||ot.value.examiner2ProfessionalMatch||ot.value.firstRestDayTeacherPriority?r("",!0):(l(),i("li",Wd,"使用默认软约束配置"))])]),o("div",Vd,[t[190]||(t[190]=o("h5",{style:{margin:"0 0 12px","font-size":"14px","font-weight":"600",color:"#3b82f6",display:"flex","align-items":"center",gap:"6px"}},[o("span",{style:{width:"8px",height:"8px",background:"#3b82f6","border-radius":"50%"}}),u(" 高级配置 ")],-1)),o("ul",qd,[t[189]||(t[189]=o("li",{style:{padding:"4px 0"}},"算法引擎：OptaPlanner",-1)),o("li",Jd,"时间分散优化："+m(ot.value.enableTimeSpreadOptimization?"已启用":"未启用"),1),o("li",Gd,"动态权重调整："+m(ot.value.enableDynamicWeightAdjustment?"已启用":"未启用"),1),o("li",Yd,"智能冲突解决："+m(ot.value.enableIntelligentConflictResolution?"已启用":"未启用"),1),o("li",Xd,"周末排班："+m(ea.value?"允许":"不允许"),1)])])])],512),[[T,Zt.value]])]),Kt.value?(l(),i("div",Kd,[o("div",Zd,[t[192]||(t[192]=o("h4",null,"正在执行排班...",-1)),o("span",Qd,m(Math.round(fa.value))+"%",1)]),o("div",ec,[o("div",{class:"progress-fill",style:x({width:fa.value+"%"})},null,4)]),o("div",tc,[o("p",ac,m(dt.value||"请稍候，系统正在为您生成最优排班方案"),1),ft.value>0?(l(),i("div",nc," 已分配: "+m(ft.value)+" / "+m(2*yt.value)+" 个考试安排 ",1)):r("",!0)])])):r("",!0),oa.value?(l(),i("div",sc,[t[194]||(t[194]=o("div",{class:"error-icon"},"⚠️",-1)),o("div",ic,[t[193]||(t[193]=o("h4",null,"排班失败",-1)),o("p",null,m(oa.value),1)])])):r("",!0)])):r("",!0),o("div",rc,[nt.value>1?(l(),i("button",{key:0,class:"nav-btn nav-btn-secondary",onClick:on}," 上一步 ")):r("",!0),t[196]||(t[196]=o("div",{class:"nav-spacer"},null,-1)),nt.value<4?(l(),i("button",{key:1,class:"nav-btn nav-btn-primary",onClick:ln,disabled:!jn()}," 下一步 ",8,lc)):r("",!0),4===nt.value?(l(),i("button",{key:2,class:"nav-btn nav-btn-success",onClick:zn,disabled:Kt.value||!jn()},[Kt.value?(l(),i("span",cc,"排班中...")):(l(),i("span",dc,"开始排班"))],8,oc)):r("",!0)])],4)])):r("",!0)]),c(ps,{visible:p(gs).getState().isVisible,"error-type":p(gs).getState().errorType,"error-message":p(gs).getState().errorMessage,conflicts:p(gs).getState().conflicts,onClose:t[50]||(t[50]=e=>p(gs).hideErrorFeedback()),onAutoResolve:ku,onExecuteAction:Su,onExportReport:$u},null,8,["visible","error-type","error-message","conflicts"]),Rt.value?(l(),i("div",{key:0,class:"unified-modal-overlay",onClick:as},[o("div",{class:"unified-modal",onClick:t[51]||(t[51]=d(()=>{},["stop"]))},[o("div",uc,[o("div",pc,[(null==(xt=Mt.value)?void 0:xt.success)&&0===os()?(l(),b(p(le),{key:0,class:"success-icon"})):(null==(bt=Mt.value)?void 0:bt.success)&&os()>0?(l(),b(p($e),{key:1,class:"warning-icon"})):(l(),b(p(ve),{key:2,class:"error-icon"}))]),o("div",mc,[o("h3",hc,m(ns()),1),o("p",gc,m(ss()),1)]),o("button",{onClick:as,class:"close-button"},[c(p(ie),{class:"close-icon"})])]),o("div",vc,[o("div",fc,[t[202]||(t[202]=o("h4",{class:"section-title"},"📊 排班统计",-1)),o("div",yc,[o("div",xc,[t[197]||(t[197]=o("span",{class:"stat-label"},"完成率",-1)),o("span",bc,m(is())+"%",1)]),o("div",wc,[t[198]||(t[198]=o("span",{class:"stat-label"},"分配学员",-1)),o("span",Dc,m(rs())+"/"+m(ls()),1)]),o("div",kc,[t[199]||(t[199]=o("span",{class:"stat-label"},"考试任务",-1)),o("span",Sc,m(2*ls())+"场",1)]),o("div",{class:h(["stat-item",0===os()?"success":"error"])},[t[200]||(t[200]=o("span",{class:"stat-label"},"硬约束违反",-1)),o("span",$c,m(os())+"个",1)],2),o("div",{class:h(["stat-item softscore-stat",hs()])},[t[201]||(t[201]=o("span",{class:"stat-label"},"软约束得分",-1)),o("span",Cc,m(ms(null==(Et=null==(Dt=Mt.value)?void 0:Dt.statistics)?void 0:Et.softConstraintsScore)),1),null!=(null==(At=null==(_t=Mt.value)?void 0:_t.statistics)?void 0:At.bestSoftConstraintsScore)?(l(),i("span",Ec," 峰值: "+m(ms((null==(Ht=null==(Ot=Mt.value)?void 0:Ot.statistics)?void 0:Ht.bestSoftConstraintsScore)??void 0)),1)):r("",!0)],2)])]),Pt.value.length>0?(l(),i("div",_c,[t[203]||(t[203]=o("h4",{class:"section-title"},"⚠️ 约束违反详情",-1)),o("div",Tc,[o("span",Ic,"发现 "+m(Pt.value.length)+" 个约束违反",1),o("span",Pc," 严重: "+m(Pt.value.filter(e=>"error"===e.severity).length)+"个， 轻微: "+m(Pt.value.filter(e=>"warning"===e.severity).length)+"个 ",1)]),o("div",Rc,[(l(!0),i(g,null,v(Pt.value.slice(0,5),(e,t)=>(l(),i("div",{key:e.id,class:h(["violation-item",e.severity])},[o("div",Mc,[o("div",Ac,["error"===e.severity?(l(),b(p($e),{key:0,class:"error-icon-small"})):(l(),b(p(Z),{key:1,class:"warning-icon-small"}))]),o("div",Oc,m(e.title),1),o("div",Nc,m(e.count||1)+"个",1)]),o("div",zc,[o("p",jc,m(e.description),1)])],2))),128)),Pt.value.length>5?(l(),i("div",Fc," 还有 "+m(Pt.value.length-5)+" 个约束违反未显示... ",1)):r("",!0)])])):r("",!0),(null==(Gt=Mt.value)?void 0:Gt.success)&&0===os()&&rs()===ls()?(l(),i("div",Lc,[o("div",Uc,[c(p(le),{class:"success-icon-large"}),o("div",Bc,[t[204]||(t[204]=o("h4",null,"🎉 排班完成！",-1)),o("p",null,"成功为 "+m(rs())+" 位学员安排了 "+m(2*rs())+" 场考试，所有约束条件均已满足。",1),t[205]||(t[205]=o("p",{class:"success-detail"},"✅ 已分配主考官和副考官    ✅ 日期和时间安排合理    ✅ 所有约束验证通过",-1))])])])):(null==(la=Mt.value)?void 0:la.success)&&0===os()&&rs()<ls()?(l(),i("div",Hc,[o("div",Wc,[c(p(Z),{class:"warning-icon-large"}),o("div",Vc,[t[206]||(t[206]=o("h4",null,"⚠️ 排班部分完成",-1)),o("p",null,"成功为 "+m(rs())+" 位学员安排了 "+m(2*rs())+" 场考试。",1),o("p",qc,"⚠️ 有 "+m(ls()-rs())+" 位学员因约束条件无法安排",1),t[207]||(t[207]=o("div",{class:"suggestion-box"},[o("p",{class:"suggestion-title"},"💡 改进建议："),o("ul",{class:"suggestion-list"},[o("li",null,"检查未分配学员的推荐考官是否在不可用时间段"),o("li",null,"扩大考试日期范围（增加可选日期）"),o("li",null,"检查该学员科室的考官数量是否充足"),o("li",null,"放宽部分软约束权重"),o("li",null,"手动为未分配学员指定考官")])],-1))])])])):r("",!0)]),o("div",{class:"modal-footer"},[t[208]||(t[208]=o("div",{class:"footer-info"},[o("span",{class:"engine-info"},"🚀 使用 OptaPlanner 约束求解引擎")],-1)),o("div",{class:"footer-actions"},[o("button",{onClick:as,class:"action-button primary"}," 我知道了 ")])])])])):r("",!0)],64)}}}),[["__scopeId","data-v-0981df0a"]]);export{Gc as default};
