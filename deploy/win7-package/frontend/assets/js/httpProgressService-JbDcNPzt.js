var t=Object.defineProperty,e=(e,n,s)=>((e,n,s)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[n]=s)(e,"symbol"!=typeof n?n+"":n,s);const n=new class{constructor(){e(this,"callbacks",[]),e(this,"pollingInterval",null),e(this,"sessionId",null),e(this,"backendPort",8081),e(this,"isPolling",!1),this.initializeBackendPort()}async initializeBackendPort(){try{const e=window.electronAPI;if(!e||!e.isElectron)return;if(e.getBackendStatus)try{const t=await e.getBackendStatus();if(t&&t.isRunning&&t.port)return void(this.backendPort=t.port)}catch(t){}if(e.onBackendReady)await new Promise(t=>{var n;null==(n=e.getBackendStatus)||n.call(e).then(n=>{if(n&&n.isRunning&&n.port)return this.backendPort=n.port,void t();e.onBackendReady(()=>{var n;null==(n=e.getBackendPort)||n.call(e).then(e=>{"number"==typeof e&&e>0&&(this.backendPort=e),t()}).catch(()=>t())})}).catch(()=>{e.onBackendReady(()=>{var n;null==(n=e.getBackendPort)||n.call(e).then(e=>{"number"==typeof e&&e>0&&(this.backendPort=e),t()}).catch(()=>t())})})});else if(e.getBackendPort){const t=await e.getBackendPort();"number"==typeof t&&t>0&&(this.backendPort=t)}}catch(e){this.backendPort=8081}}async connect(t){this.sessionId=t;const e=window.electronAPI;if(e&&e.isElectron)try{if(e.getBackendStatus){const t=await e.getBackendStatus();t&&t.isRunning&&t.port&&"number"==typeof t.port&&(this.backendPort=t.port)}}catch(n){}this.notifyCallbacks({type:"connected",message:"HTTP轮询已建立",data:null,timestamp:Date.now()}),this.startPolling()}startPolling(){this.isPolling||(this.isPolling=!0,this.poll(),this.pollingInterval=setInterval(()=>{this.poll()},800))}async poll(){if(this.sessionId)try{const t=window.electronAPI;let e;e=t&&t.isElectron?`http://127.0.0.1:${this.backendPort}/api/schedule/progress/${this.sessionId}`:`/api/schedule/progress/${this.sessionId}`;const n=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok){if(404===n.status)return;throw new Error(`HTTP ${n.status}`)}const s=await n.json();if("not_found"===s.type)return;const a={type:"progress",message:s.levelName||"求解中",data:{currentLevel:s.level||0,levelName:s.levelName||"求解中",elapsedTime:0,estimatedRemaining:0,progressPercentage:s.progressPercentage||0,currentScore:s.currentScore||"",iterationCount:s.iterationCount||0,assignmentCount:s.assignmentCount||0},timestamp:s.timestamp||Date.now()};0,this.notifyCallbacks(a),s.progressPercentage>=100&&this.stopPolling()}catch(t){}}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null),this.isPolling=!1}disconnect(){this.stopPolling(),this.sessionId=null}onProgress(t){return this.callbacks.push(t),()=>{this.callbacks=this.callbacks.filter(e=>e!==t)}}notifyCallbacks(t){this.callbacks.forEach(e=>{try{e(t)}catch(n){}})}sendComplete(t){this.notifyCallbacks({type:"complete",message:"求解完成",data:t,timestamp:Date.now()}),this.stopPolling()}sendError(t){this.notifyCallbacks({type:"error",message:t,data:null,timestamp:Date.now()}),this.stopPolling()}};export{n as httpProgressService};
