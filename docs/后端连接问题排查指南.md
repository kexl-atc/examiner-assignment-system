# 后端连接问题排查指南

**版本**: v6.1.3  
**日期**: 2025-01-02

---

## 🚨 常见错误

### ERR_CONNECTION_REFUSED

**错误信息**：
```
POST http://127.0.0.1:8082/api/instructor-assignment/run net::ERR_CONNECTION_REFUSED
```

**含义**：无法连接到后端服务，后端服务可能未启动。

---

## 🔍 诊断工具

### 自动诊断

系统已集成后端诊断工具，连接失败时会自动诊断。

### 手动诊断

在浏览器控制台运行：

```javascript
// 诊断后端连接
window.__backendDiagnostics.diagnose().then(result => {
  console.log('诊断结果:', result)
  console.log('状态:', result.status)
  console.log('消息:', result.message)
  console.log('解决步骤:')
  result.steps.forEach((step, i) => {
    console.log(`  ${i + 1}. ${step}`)
  })
})

// 检查特定端口
window.__backendDiagnostics.check(8082).then(status => {
  console.log('后端状态:', status)
  if (!status.isRunning) {
    console.log('建议:', status.suggestions)
  }
})

// 扫描常用端口
window.__backendDiagnostics.scan().then(results => {
  const running = results.find(r => r.isRunning)
  if (running) {
    console.log('找到运行中的后端服务:', running)
  } else {
    console.log('未找到运行中的后端服务')
  }
})
```

---

## 🔧 排查步骤

### 1. 检查后端服务是否运行

#### 开发环境

```bash
# 检查后端进程
ps aux | grep java  # Linux/Mac
tasklist | findstr java  # Windows

# 检查端口占用
netstat -ano | findstr 8082  # Windows
lsof -i :8082  # Linux/Mac
```

#### 生产环境

- 检查服务是否已部署
- 检查服务是否已启动
- 查看服务日志

### 2. 检查端口配置

系统默认使用以下端口：
- **开发环境**: 8081
- **生产环境**: 8082

可以通过环境变量配置：
```bash
# .env 文件
VITE_BACKEND_PORT=8082
```

### 3. 检查防火墙

确保防火墙没有阻止端口：
- Windows: 检查Windows防火墙设置
- Linux: 检查iptables/firewalld
- Mac: 检查系统防火墙

### 4. 检查后端服务日志

查看后端服务日志，确认：
- 服务是否成功启动
- 是否监听在正确的端口
- 是否有错误信息

### 5. 测试后端健康检查接口

在浏览器中访问：
```
http://127.0.0.1:8082/api/health
```

如果返回200 OK，说明后端服务正常运行。

---

## 🛠️ 解决方案

### 方案1: 启动后端服务

#### Quarkus应用

```bash
# 进入后端目录
cd optaplanner-service

# 启动开发服务器
./mvnw quarkus:dev

# 或启动生产服务器
./mvnw quarkus:build
java -jar target/quarkus-app/quarkus-run.jar
```

#### 检查启动日志

后端启动成功应该看到：
```
Listening on: http://0.0.0.0:8082
```

### 方案2: 检查端口冲突

如果端口被占用：

1. **查找占用端口的进程**：
   ```bash
   # Windows
   netstat -ano | findstr 8082
   
   # Linux/Mac
   lsof -i :8082
   ```

2. **终止占用进程**或**更改端口**

### 方案3: 检查Electron环境

如果是Electron应用：

1. 确认后端进程已启动
2. 检查Electron主进程日志
3. 确认后端端口配置正确

### 方案4: 使用代理

如果是Web环境，检查Vite代理配置：

```javascript
// vite.config.mjs
export default {
  server: {
    proxy: {
      '/api': {
        target: 'http://127.0.0.1:8082',
        changeOrigin: true,
      },
    },
  },
}
```

---

## 📊 诊断报告示例

运行诊断后，您会看到类似以下报告：

```
诊断结果: {
  status: 'error',
  message: '后端服务未运行（已检查端口: 8082, 8081, 8080, 3000, 5173）',
  details: {
    isRunning: false,
    port: 8082,
    url: 'http://127.0.0.1:8082/api',
    error: '连接被拒绝，后端服务可能未启动',
    suggestions: [
      '检查后端服务是否在端口 8082 上运行',
      '确认后端服务已启动（检查控制台或日志）',
      '尝试访问 http://127.0.0.1:8082/api/health 验证服务状态',
      '检查防火墙是否阻止了连接',
      '如果是Electron环境，确认后端进程已启动'
    ]
  },
  steps: [
    '启动后端服务',
    '确认后端服务监听在端口 8082',
    '检查后端服务日志，确认启动状态',
    '如果是开发环境，运行后端启动命令',
    '如果是生产环境，检查服务是否已部署'
  ]
}
```

---

## ✅ 验证后端连接

### 快速测试

```javascript
// 在控制台运行
fetch('http://127.0.0.1:8082/api/health')
  .then(r => r.json())
  .then(data => console.log('✅ 后端服务正常:', data))
  .catch(err => console.error('❌ 后端服务异常:', err))
```

### 检查API服务配置

```javascript
// 查看API服务配置
import('@/services/api-service').then(m => {
  console.log('API Base URL:', m.apiService.baseURL)
})
```

---

## 🔄 自动重试机制

系统已实现：
- ✅ 连接失败时自动诊断
- ✅ 提供友好的错误消息
- ✅ 给出解决建议

**注意**：系统不会自动重试，需要手动启动后端服务。

---

## 📝 常见问题

### Q: 为什么连接被拒绝？

A: 最常见的原因是后端服务未启动。请按照上述步骤检查。

### Q: 端口8082被占用怎么办？

A: 
1. 查找占用进程并终止
2. 或更改后端服务端口
3. 更新前端配置

### Q: Electron环境下如何启动后端？

A: Electron应用通常会自动启动后端进程。如果失败，检查：
1. 后端可执行文件是否存在
2. 是否有启动权限
3. 查看Electron主进程日志

### Q: 开发环境端口是8081还是8082？

A: 默认开发环境是8081，生产环境是8082。可以通过环境变量 `VITE_BACKEND_PORT` 配置。

---

**文档版本**: v1.0  
**最后更新**: 2025-01-02

